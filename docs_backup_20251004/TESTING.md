# 五好伴学测试策略与质量保障指南 (TESTING)

Last Updated: 2025-09-29
适用范围：后端 0.1.x（文档重构阶段：初稿 / 待与实际测试代码核对）

---

## 1. 文档目的

本文件为项目测试与质量保障的统一基线，回答以下问题：

| 问题 | 快速去向 |
|------|----------|
| 我需要写哪些类型的测试？ | 第 3、4 节 |
| 如何在本地运行所有测试？ | 第 6 节 |
| 如何判断测试是否够用？ | 第 7 节（覆盖矩阵） |
| 如何为新功能补测试？ | 第 8 节（新增功能测试清单） |
| 如何设计 AI 相关测试？ | 第 5.5 节 |
| 覆盖率目标与分层要求是什么？ | 第 9 节 |
| 性能/负载测试怎么做？ | 第 10 节 |
| 如何处理非确定性 / 随机 / 依赖外部服务？ | 第 5.4 节 |
| 回归缺陷如何固化？ | 第 11 节 |
| 质量 Gate / PR 检查项有哪些？ | 第 12 节 |

---

## 2. 测试理念与策略原则

| 原则 | 说明 | 体现 |
|------|------|------|
| 分层测试优先 | 越靠近逻辑层的测试越稳定、成本低 | 单元 > 组件 > 集成 > 验收 |
| 可重复 | 测试不依赖不稳定外部条件 | 使用隔离数据 / Mock |
| 快速反馈 | 大部分测试应在 1 分钟内跑完 | 单元/轻量集成分离 |
| 精准失败 | 失败用例输出最小关键信息 | 自定义断言消息 |
| 有效覆盖 | 关注“路径 + 分支 + 边界”而非盲目追求 100% | 覆盖准线定义 |
| 数据最小 | 每个用例自己准备 / 不共享全局状态 | Fixture 作用域划分 |
| 防回归 | 每个修复的缺陷必须新增用例 | 缺陷用例命名规范 |
| 可演进 | AI / 性能 / 指标测试与体系解耦 | 采用标记分类 |
| 透明可见 | 测试结果反馈至文档/状态 | 将关键指标汇总到 STATUS.md（规划） |

---

## 3. 测试类型总览

| 层级 | 目标 | 覆盖范围 | 频率 | 是否进 CI |
|------|------|----------|------|-----------|
| 单元测试 (Unit) | 函数/类内部逻辑正确性 | 纯函数、仓储封装、服务方法 | 每次提交 | 是 |
| 组件/服务测试 (Service) | 业务组合流程正确 | Service 层（含仓储 mock/真实 DB 可切换） | 每次提交 | 是 |
| 集成测试 (Integration) | 系统内部模块协作 | API 路由 + DB（真实 schema） | 每次合并 / 每日 | 是 |
| 合同/契约测试 (Contract) | 保证 API 响应结构与约定保持 | 响应模型、错误结构 | 规划 | 规划 |
| 端到端 (E2E / API Flow) | 真实调用链完整闭环 | 关键业务 Scenario | 重要版本前 | 可选 |
| 性能/负载 (Performance) | 延迟 / 吞吐 / 资源行为 | 选定热点端点 | 发布前 / 定期 | 手动触发 |
| 安全回归 (Security Smoke) | 基础防护未破损 | 未授权访问、错误信息泄露 | 发布前 | 可选 |
| 迁移测试 (Migration) | DB 变更正确 | Alembic 迁移前后结构比对 | 每次迁移 | 是 |
| 数据一致性 (Data Consistency) | 约束、唯一性、关联正确 | 典型写入/回滚场景 | 关键模型变更 | 是 |
| 可观测性 (Observability Check) | 监控端点响应结构 | 健康、性能端点 | 每次合并 | 规划 |
| AI 逻辑测试 (AI Abstraction) | 回调包装层、失败分支 | Mock AI Provider | 每次提交 | 是 |
| 审计/合规（规划） | 关键操作被记录 | 审计钩子 | 规划 | 规划 |

---

## 4. 测试目录建议结构（示例规划）

```
tests/
├── unit/
│   ├── test_utils_xxx.py
│   ├── test_services_xxx.py
│   ├── test_repositories_base.py
│   └── conftest.py
├── integration/
│   ├── test_api_homework.py
│   ├── test_api_learning.py
│   ├── test_api_files.py
│   └── fixtures/
├── performance/
│   ├── test_load_basic.py
│   └── helpers.py
├── contracts/ (规划)
│   ├── test_response_envelope.py
│   └── schemas/
├── migration/
│   ├── test_migrations_structure.py
│   └── snapshots/
└── e2e/ (可选)
```

---

## 5. 分类型测试策略细节

### 5.1 单元测试 (Unit)
- 目标：每个函数/方法在输入→输出/副作用维度满足预期
- 特征：
  - 禁止访问真实网络 / 外部 API
  - 对外部依赖（DB/AI）做 Fake 或 Mock
- 优先覆盖：
  - 数据转换器 / 校验函数
  - 仓储基础方法行为（含分页/排序）
  - Service 内分支逻辑 + 异常路径

### 5.2 服务/仓储测试 (Service + Repository)
- 使用真实数据库（内存 SQLite 或临时 PostgreSQL）
- 验证事务行为 / 复杂查询（避免在 Unit 伪造过多假设）
- 检查：创建 → 更新 → 查询 → 删除 → 约束触发

### 5.3 集成测试 (Integration)
- 启动 FastAPI 应用实例（测试模式）
- 使用 TestClient / AsyncClient 调用端点
- 断言：
  - HTTP 状态码
  - 响应结构与模型一致（字段存在/类型合理）
  - 错误结构统一：`success=false` + `error.code`
- 场景示例：
  1. 创建模板 → 提交作业 → 获取批改（模拟）
  2. 启动会话 → 连续提问 → 历史查询
  3. 文件上传 → 列表 → 下载（若实现）

### 5.4 非确定性与外部依赖（AI/时间/随机）
| 类型 | 策略 |
|------|------|
| 时间相关 | 使用冻结时间或依赖注入 `datetime provider` |
| 随机 ID | 注入可预测 ID 生成器或断言“格式”而非具体值 |
| AI 返回 | 通过假实现（Fake）返回固定结构（含错误分支） |
| 重试/退避 | Mock 睡眠函数，检测调用次数/参数 |
| 限流测试 | 控制全局配置阈值为小值，加速触发路径 |

### 5.5 AI 功能测试
| 场景 | 测试策略 |
|------|----------|
| 成功回答 | Mock Provider 返回标准字段 |
| 超时 | 模拟超时异常 → 期待包装层转换为错误码 |
| 格式异常 | 返回无效 JSON → 校验降级/错误处理 |
| 限流受控 | 多次调用超阈值 → 验证 `429 + RATE_LIMIT_EXCEEDED` |
| 置信度字段 | 确保在缺省时使用默认值 (0.0) |

---

## 6. 运行测试（命令约定）

| 目的 | 命令（示意） |
|------|--------------|
| 全部测试 | `uv run pytest -q` |
| 单元测试 | `uv run pytest tests/unit -q` |
| 集成测试 | `uv run pytest tests/integration -q` |
| 性能测试（可选） | `uv run pytest tests/performance -k basic --durations=10` |
| 失败后快速退出 | `uv run pytest --maxfail=1` |
| 显示慢测试 | `uv run pytest --durations=10` |
| 覆盖率（规划） | `uv run pytest --cov=src --cov-report=term-missing` |

> 真实命令需结合实际目录结构调整；覆盖率插件未接入时命令会失败。

---

## 7. 覆盖目标矩阵（初稿）

| 模块 | 代码角色 | 覆盖指标（行/分支） | 说明 |
|------|----------|--------------------|------|
| 核心工具 (utils) | 纯函数 | ≥ 90% 行 | 易测试，要求高 |
| 配置 (config) | 环境加载 | 路径覆盖 | 分支场景（dev/test/prod） |
| 仓储 (repositories) | 数据访问 | CRUD + 错误路径 | 避免只测“成功路径” |
| 服务 (services) | 业务组合 | 主要分支 ≥ 80% | 包括异常 |
| API 路由 | 输入/输出 | 关键端点全测 | 参数校验 + 错误结构 |
| 监控/限流 | 中间件 | 核心阈值行为 | 限流触发 / 跳过条件 |
| AI 封装 | 外部抽象 | 成功/失败/异常 | 包含超时注入 |
| 性能模块 | 装饰/缓存 | 命中/失效/清理 | 高价值路径 |
| 安全头 | 中间件 | 最小断言 | 不需要高覆盖率 |
| 脚本 | 初始化/备份 | 关键路径 | 复杂脚本可挑核心逻辑提炼成函数测试 |

---

## 8. 新增功能测试清单（模板）

当新增一个业务功能（例如“学情分析统计”），应至少包含：

| 项 | 描述 | 状态 |
|----|------|------|
| 输入 Schema 测试 | 必填/可选/错误类型 |  |
| Service 逻辑测试 | 核心分支含异常 |  |
| 仓储查询测试 | 复杂 SQL / 聚合结果 |  |
| API 集成测试 | 端点响应结构与状态码 |  |
| 错误场景 | 缺资源 / 权限 / 校验失败 |  |
| 性能（可选） | 数据量边界（如 0 / 1000） |  |
| 可观测性 | 是否影响指标（若新增中间件） |  |
| 文档同步 | `api/endpoints.md` / `models.md` 更新 |  |
| 回归保障 | 是否覆盖已知类似缺陷模式 |  |

---

## 9. 覆盖率（Coverage）计划（阶段化）

| 阶段 | 全局行覆盖 | 关键模块 | 验证方式 |
|------|------------|----------|----------|
| 0.1.x | 基线统计（记录现状） | - | 手工运行 |
| 0.2.x | ≥ 60% | utils / services ≥ 80% | 覆盖率报告 |
| 0.3.x | ≥ 70% | repositories / api ≥ 75% | CI Gate（规划） |
| 0.4.x | ≥ 75% | 性能/监控逻辑补齐 | 阈值警告 |
| 1.0.0 | ≥ 80% | 所有核心模块 | 必须达标 |

说明：
- 不强制“追求 100%”，更关注“逻辑与风险区域”。
- 对低使用频率或未来可能重构模块，可适当降低优先级（需记录理由）。

---

## 10. 性能与负载测试策略（Performance）

| 目标 | 范围 | 说明 |
|------|------|------|
| 基线延迟 | 常用端点（问答 / 提交 / 查询） | p50/p95 采集 |
| 并发稳态 | 典型并发（如 20 / 50 / 100） | 观察错误率 |
| 限流策略验证 | 低阈值配置下触发路径 | 预期 429 位置正确 |
| 查询扩展性 | 列表接口分页多页访问 | 避免线性退化 |
| AI 调用压力（模拟） | Mock 模拟下游响应延迟 | 评估超时处理健壮性 |
| 缓存效果（规划） | 对热点访问接口 | 命中率差异对比 |

简易脚本建议：
- 使用异步客户端/线程池对端点循环压测
- 结果记录：总请求数 / 成功 / 失败 / p50 / p95 / p99 / max / 错误分类计数
- 输出 JSON → 后续可接入图表

---

## 11. 缺陷回归策略

| 类别 | 处理策略 | 示例命名 |
|------|----------|----------|
| 逻辑错误 | 新增用例重现 → 修复 → 断言 | `test_bugfix_issue123_logic_branch()` |
| 边界缺失 | 添加边界输入（空 / 极大 / 非法组合） | `test_edge_empty_payload()` |
| 并发/竞态 | 构造并行执行场景（必要时加锁模拟） | `test_race_condition_prevented()` |
| 错误映射不一致 | 补充错误码结构断言 | `test_error_structure_rate_limit()` |
| 数据一致性 | 修复后检查查询组合结果 | `test_consistency_after_update_flow()` |

所有回归用例：
1. 必须指明触发上下文
2. 关联 Issue/变更 ID（可注释标记）
3. 禁止删除（除非功能废弃，有迁移说明）

---

## 12. PR 质量 Gate（建议）

| 检查项 | 说明 |
|--------|------|
| 新增/修改核心逻辑是否带测试 | 否则标记为“缺测试”待补 |
| 失败测试是否因本变更引入 | 不允许“已存在失败”借口 |
| 运行基础测试总耗时 | 保持可接受（< 90 秒） |
| 覆盖率与主分支相比 | 不允许大幅下降（> -2%） |
| 响应/错误结构是否破坏 | 若破坏需同步文档 + 评审确认 |
| 新增依赖是否需要额外测试 | Mock 或隔离方案需说明 |
| 有无非显式超时等待 | 避免 `sleep` 固定等待（用轮询/条件） |
| 是否引入随机不稳定因素 | 需设置固定 Seed 或 Mock |

---

## 13. 数据与 Fixture 策略

| 问题 | 推荐方案 |
|------|----------|
| 全局共享状态污染 | 避免使用 module/global 变量保存测试数据 |
| 重复建数据 | 使用工厂函数（Factory 方法封装） |
| 初始化成本过高 | 精细化作用域：function / module / session |
| 自动生成字段 | 提供最小数据集，避免过拟合 |
| 清理 | 使用事务回滚或临时 DB 文件删除 |
| ID 生成 | 若断言结构，匹配格式（正则）而非具体值 |

---

## 14. 标记与分类（pytest -k / -m 规划）

| 标记 | 用途 |
|------|------|
| `unit` | 仅运行快速单元 |
| `integration` | 集成/真实依赖 |
| `slow` | >1s 的测试（需合理性说明） |
| `performance` | 性能/负载类 |
| `ai` | AI 相关分支（Mock） |
| `migration` | 数据库迁移验证 |
| `contract` | 响应结构契约 |
| `security` | 基础防护测试 |

> 后续可在配置文件中统一登记。

---

## 15. 错误断言与可读性

| 场景 | 断言方式（建议） | 反例 |
|------|------------------|------|
| 响应结构 | `assert resp["success"] is True` | 仅断言非空 |
| 错误码 | `assert err["error"]["code"] == "RESOURCE_NOT_FOUND"` | 断言 `status_code == 404` 但不检查 code |
| 浮点 | `pytest.approx(expected, rel=1e-3)` | 直接 `==` |
| 列表包含 | `assert any(x.id == target for x in items)` | `assert items[0].id == target`（假设顺序） |
| 异常 | `with pytest.raises(ExpectedError):` | try/except 手动 pass |

---

## 16. 常见薄弱点与专项补全计划（初稿）

| 风险点 | 当前状态 | 计划 |
|--------|----------|------|
| 限流软/硬路径覆盖 | 基本 | 增加多策略组合触发 |
| 异常包装一致性 | 部分 | 错误码表 + 自动检测 |
| 仓储复杂查询 | 部分 | 增加统计/分页边界用例 |
| 学情分析（规划模块） | 空 | 指标计算统一断言 |
| AI 包装超时 | 基本 | 加随机延迟模拟与重试策略验证 |
| 性能回归预警 | 手工 | 集成基础延迟基线比对脚本 |
| 迁移后回滚一致性 | 未系统化 | 添加迁移快照结构比对 |
| 文件上传边界 | 部分 | 大小边界 / 非法类型 / 空文件 |
| 健康端点演化 | 无结构测试 | 加 schema 断言（规划） |

---

## 17. 后续自动化扩展（Roadmap）

| 阶段 | 增补能力 | 说明 |
|------|----------|------|
| 0.2.x | 覆盖率统计引入 | 标记基线 |
| 0.3.x | Contract 测试生成（基于 OpenAPI） | 预防响应漂移 |
| 0.3.x | Prometheus 指标结构测试 | 健康/性能监控稳定性 |
| 0.4.x | 性能基线对比 | 运行 → 读取历史 → 判定 |
| 0.4.x | AI Mock 统一注入层 | 降低重复 |
| 0.5.x | 异常映射自动化对照（errors.md diff） | 提升一致性 |
| 0.5.x | 数据工厂 (Factory) 统一封装 | 减少样板代码 |
| 0.6.x | 回归缺陷统计面板 | 可视化缺陷来源 |
| 1.0.0 | 全面质量矩阵仪表 | 自动输出 STATUS.md 片段 |

---

## 18. FAQ（简版）

| 问题 | 回答 |
|------|------|
| 我是否需要为“看似简单的函数”写测试？ | 是，尤其是后续可能依赖的工具函数 |
| 集成测试很慢怎么办？ | 拆分：核心路径保留，边缘场景移到单元/服务层 |
| Mock 太多导致测试脆弱怎么办？ | 优先在真实层测试，Mock 仅隔离不稳定/外部资源 |
| AI 测试要不要调用真实服务？ | 不建议：成本 + 不确定性，用假实现模拟 |
| 覆盖率达标但仍出问题？ | 检查是否遗漏边界/数据驱动/分支复杂度高部分 |
| 是否可以并行执行测试？ | 可以，确保无共享全局状态（数据库隔离） |
| 脚本测试怎么做？ | 抽出纯函数逻辑，脚本主体最少验证（烟测） |

---

## 19. 文档 & 实现同步要求

| 触发事件 | 必须动作 |
|----------|----------|
| 新增端点 | 增加或更新对应的集成测试 |
| 新增错误码 | 补充错误断言或契约测试 |
| 重构仓储/查询 | 对关键统计/分页行为回归验证 |
| 引入外部依赖 | 增加失败/超时/降级模拟测试 |
| 性能调优 | 前后对比基线（记录前值） |
| 迁移脚本 | 添加结构/字段存在性测试 |
| 废弃字段 | 增测试确认旧字段不再出现 |

---

## 20. 变更记录（本文件）

| 日期 | 版本 | 描述 | 负责人 |
|------|------|------|--------|
| 2025-09-29 | draft-1 | 初稿：结构与策略基线 | 文档重构组 |
| (待填) | ... | ... | ... |

---

## 21. 反馈与改进

如发现：
- 测试缺失 / 冗余 / 不稳定
- 文档与实际测试目录或能力不符
- 新增模块未纳入测试策略
- 指标/性能回归未归档

请：
1. 提交 Issue（标签：testing）
2. 说明：问题场景 → 预期 → 实际 → 风险等级
3. 或直接提交 PR：同步文档 + 用例

---

_本文件为“活体文档”，任何测试策略与其不一致的改动需同步修订。_
（END）
