# AI å¤ä¹ è®¡åˆ’ç”ŸæˆåŠŸèƒ½ - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v1.1
**æ—¥æœŸ**: 2025-11-21
**çŠ¶æ€**: å¼€å‘ä¸­ (In Progress)
**ä¼˜å…ˆçº§**: ä¸­

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 éœ€æ±‚æè¿°

åœ¨å¾®ä¿¡å°ç¨‹åºå­¦ä¹ æŠ¥å‘Šé¡µé¢å¢åŠ "AI å¤ä¹ è®¡åˆ’"æ¨¡å—ï¼Œé€šè¿‡ä»¥ä¸‹æµç¨‹ä¸ºå­¦ç”Ÿç”Ÿæˆä¸ªæ€§åŒ–çš„å‘¨æœŸæ€§å¤ä¹ æŒ‡å¯¼ï¼š

```
é”™é¢˜æœ¬æ•°æ® â†’ å¯¼å‡º Markdown â†’ å¤§æ¨¡å‹åˆ†æ â†’ ç”Ÿæˆå¤ä¹ è®¡åˆ’ â†’ å¯¼å‡º PDF â†’ ä¸Šä¼ é˜¿é‡Œäº‘ OSS â†’ å°ç¨‹åºä¸‹è½½/é¢„è§ˆ
```

### 1.2 æ ¸å¿ƒä»·å€¼

| ç»´åº¦ | æ”¶ç›Š |
|------|------|
| **å­¦ç”Ÿä½“éªŒ** | è·å¾—ç³»ç»ŸåŒ–çš„å¤ä¹ ç­–ç•¥ï¼Œæ›¿ä»£ç¢ç‰‡åŒ–çš„å­¦ä¹  |
| **å­¦ä¹ æ•ˆæœ** | é’ˆå¯¹æ€§å¤ä¹ è–„å¼±çŸ¥è¯†ç‚¹ï¼Œæå‡æŒæ¡åº¦ |
| **å¹³å°å·®å¼‚** | ä¸ç«å“å·®å¼‚åŒ–åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ç²˜æ€§ |
| **æ•°æ®åº”ç”¨** | å……åˆ†åˆ©ç”¨ç°æœ‰é”™é¢˜æœ¬æ•°æ®ï¼Œæé«˜è½¬åŒ–ç‡ |

---

## äºŒã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RDS PostgreSQL â”‚
â”‚ (Mistake è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è·å–é”™é¢˜æœ¬ + å…ƒæ•°æ®              â”‚
â”‚     - æŒ‰çŸ¥è¯†ç‚¹åˆ†ç»„                   â”‚
â”‚     - æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰                â”‚
â”‚     - è®¡ç®—é”™è¯¯ç‡/é¢‘æ¬¡                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç”Ÿæˆ Markdown å¯¼å‡ºæ–‡æœ¬           â”‚
â”‚     - é”™é¢˜ç»Ÿè®¡æ±‡æ€»                   â”‚
â”‚     - åˆ†ç±»è¯¦æƒ…ï¼ˆé¢˜ç›®+è§£æ+å»ºè®®ï¼‰    â”‚
â”‚     - çŸ¥è¯†ç‚¹å…³è”å›¾                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è°ƒç”¨ç™¾ç‚¼å¤§æ¨¡å‹                   â”‚
â”‚     - ç³»ç»Ÿæç¤ºè¯ (Prompt)           â”‚
â”‚     - ç”¨æˆ·å­¦ä¹ èƒŒæ™¯ (Context)        â”‚
â”‚     - Markdown æ–‡æœ¬ (Content)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ç”Ÿæˆå¤ä¹ è®¡åˆ’ JSON                â”‚
â”‚     - å‘¨æœŸè§„åˆ’ï¼ˆ7å¤©/14å¤©/30å¤©ï¼‰     â”‚
â”‚     - æ¯æ—¥ä»»åŠ¡åˆ†è§£                   â”‚
â”‚     - å¤ä¹ é‡ç‚¹å’Œæ–¹æ³•                 â”‚
â”‚     - è¯„ä¼°æ ‡å‡†                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ç”Ÿæˆ PDF æ–‡æ¡£                    â”‚
â”‚     - æ ¼å¼åŒ–æ’ç‰ˆ                     â”‚
â”‚     - åµŒå…¥å›¾è¡¨                       â”‚
â”‚     - æ·»åŠ æ°´å°ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰          â”‚
â”‚     - ä¾èµ–: weasyprint + cairo      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ä¸Šä¼ è‡³é˜¿é‡Œäº‘ OSS                 â”‚
â”‚     - å­˜å‚¨è·¯å¾„: plans/{user_id}/    â”‚
â”‚     - è®¾ç½® Content-Type             â”‚
â”‚     - è·å–ç­¾å URL (å¦‚æœ‰éœ€è¦)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. è¿”å›ä¸‹è½½ URL                     â”‚
â”‚     - å°ç¨‹åºè°ƒç”¨ `wx.downloadFile`   â”‚
â”‚     - æ”¯æŒ `wx.openDocument` é¢„è§ˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç³»ç»Ÿç»„ä»¶

| ç»„ä»¶ | å±‚çº§ | åŠŸèƒ½ | æ–°å¢/ç°æœ‰ |
|------|------|------|---------|
| **MistakeDataService** | Service | é”™é¢˜æœ¬æ•°æ®èšåˆ & Markdown å¯¼å‡º | ç°æœ‰ + æ‰©å±• |
| **RevisionPlanService** | Service | å¤ä¹ è®¡åˆ’ç”Ÿæˆ & ç¼“å­˜ç®¡ç† | **æ–°å¢** |
| **PDFGeneratorService** | Service | PDF ç”Ÿæˆ (WeasyPrint) | **æ–°å¢** |
| **AliyunOSSService** | Service | æ–‡ä»¶ä¸Šä¼ ä¸ç®¡ç† | **æ–°å¢/æ‰©å±•** |
| **RevisionPlanRepository** | Repository | å¤ä¹ è®¡åˆ’æŒä¹…åŒ– (PostgreSQL) | **æ–°å¢** |
| **RevisionPlan æ¨¡å‹** | Model | å¤ä¹ è®¡åˆ’æ•°æ®ç»“æ„ | **æ–°å¢** |
| **/api/v1/revisions** | API | å¤ä¹ è®¡åˆ’ REST æ¥å£ | **æ–°å¢** |
| **å°ç¨‹åºå­¦ä¹ æŠ¥å‘Šé¡µ** | Frontend | UI å±•ç¤º & äº¤äº’ (WXML/TS) | **ç°æœ‰** æ”¹é€  |

---

## ä¸‰ã€åç«¯è®¾è®¡è¯¦è§£

### 3.1 æ•°æ®æ¨¡å‹

#### 3.1.1 RevisionPlan æ¨¡å‹ï¼ˆæ–°å¢ï¼‰

```python
# src/models/revision_plan.py

class RevisionPlan(BaseModel):
    """AI å¤ä¹ è®¡åˆ’"""
    
    id: UUID = Field(default_factory=uuid4, primary_key=True)
    user_id: UUID = Field(foreign_key="user.id")
    
    # å…ƒæ•°æ®
    title: str  # "2025å¹´1æœˆå­¦ä¹ å¤ä¹ è®¡åˆ’"
    description: str  # ç®€çŸ­æè¿°
    cycle_type: str  # "7days" | "14days" | "30days"
    status: str  # "draft" | "published" | "completed" | "expired"
    
    # æ•°æ®æ¥æº
    mistake_count: int  # åŒ…å«çš„é”™é¢˜æ•°
    knowledge_points: list[str]  # JSON: æ¶‰åŠçš„çŸ¥è¯†ç‚¹
    date_range: dict  # JSON: {"start": "2025-01-01", "end": "2025-01-15"}
    
    # å¤ä¹ è®¡åˆ’å†…å®¹ï¼ˆå­˜å‚¨ä¸º JSONBï¼‰
    plan_content: dict = Field(sa_column=Column(JSONB))  # ç»“æ„åŒ–çš„å¤ä¹ è®¡åˆ’æ•°æ®
    # {
    #   "overview": "...",
    #   "statistics": {...},
    #   "daily_tasks": [
    #     {
    #       "day": 1,
    #       "date": "2025-01-16",
    #       "tasks": [...],
    #       "estimated_hours": 1.5
    #     }
    #   ],
    #   "review_focus": [...],
    #   "assessment": {...}
    # }
    
    # æ–‡ä»¶ä¿¡æ¯
    pdf_url: str | None  # é˜¿é‡Œäº‘ OSS ä¸‹è½½é“¾æ¥
    pdf_size: int | None  # æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    markdown_url: str | None  # Markdown æºæ–‡ä»¶ï¼ˆå¯é€‰å­˜æ¡£ï¼‰
    
    # æ—¶é—´æˆ³
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    expired_at: datetime | None  # è®¡åˆ’è¿‡æœŸæ—¶é—´
    completed_at: datetime | None  # å®Œæˆæ—¶é—´
    
    # ä½¿ç”¨ç»Ÿè®¡
    download_count: int = 0
    view_count: int = 0
    is_shared: bool = False  # æ˜¯å¦åˆ†äº«è¿‡
    
    class Config:
        table_name = "revision_plans"
```

#### 3.1.2 RevisionPlanProgress æ¨¡å‹ï¼ˆå¯é€‰ï¼Œç”¨äºè¿½è¸ªå­¦ç”Ÿè¿›åº¦ï¼‰

```python
class RevisionPlanProgress(BaseModel):
    """å¤ä¹ è®¡åˆ’å®Œæˆè¿›åº¦"""
    
    id: UUID = Field(default_factory=uuid4, primary_key=True)
    revision_plan_id: UUID = Field(foreign_key="revision_plan.id")
    user_id: UUID = Field(foreign_key="user.id")
    
    completed_tasks: list[int]  # å·²å®Œæˆä»»åŠ¡ç´¢å¼•
    completion_rate: float  # 0-100
    last_reviewed_at: datetime
    notes: str | None  # ç”¨æˆ·ç¬”è®°
    
    created_at: datetime
    updated_at: datetime
```

### 3.2 Service å±‚è®¾è®¡

#### 3.2.1 RevisionPlanService (æ ¸å¿ƒ)

```python
# src/services/revision_plan_service.py

class RevisionPlanService:
    """å¤ä¹ è®¡åˆ’ç”ŸæˆæœåŠ¡"""
    
    def __init__(
        self,
        db: AsyncSession,
        mistake_service: MistakeService,
        bailian_service: BailianService,
        file_service: FileService,
    ):
        self.db = db
        self.mistake_service = mistake_service
        self.bailian_service = bailian_service
        self.file_service = file_service
        self.revision_repo = RevisionPlanRepository(db)
    
    async def generate_revision_plan(
        self,
        user_id: UUID,
        cycle_type: str = "7days",  # "7days" | "14days" | "30days"
        days_lookback: int = 30,  # å›é¡¾è¿‘Nå¤©çš„é”™é¢˜
        force_regenerate: bool = False,  # å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
    ) -> RevisionPlan:
        """
        ç”Ÿæˆä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’
        
        æµç¨‹ï¼š
        1. æ£€æŸ¥ç¼“å­˜ï¼ˆåŒä¸€å‘¨æœŸå†…å·²æœ‰æœªè¿‡æœŸè®¡åˆ’ï¼‰
        2. è·å–é”™é¢˜æœ¬æ•°æ®
        3. ç”Ÿæˆ Markdown æ–‡æœ¬
        4. è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆè®¡åˆ’
        5. ç”Ÿæˆ PDF
        6. ä¿å­˜åˆ°æ•°æ®åº“
        7. è¿”å›è®¡åˆ’å¯¹è±¡
        """
        
        # 1. ç¼“å­˜æ£€æŸ¥
        if not force_regenerate:
            cached_plan = await self._get_cached_plan(user_id, cycle_type)
            if cached_plan:
                logger.info(f"ä½¿ç”¨ç¼“å­˜å¤ä¹ è®¡åˆ’: {cached_plan.id}")
                return cached_plan
        
        # 2. è·å–é”™é¢˜æ•°æ®
        mistakes_data = await self.mistake_service.get_mistakes_for_revision(
            user_id=user_id,
            days_lookback=days_lookback,
        )
        
        if not mistakes_data["items"]:
            raise ServiceError("æ²¡æœ‰é”™é¢˜æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆå¤ä¹ è®¡åˆ’")
        
        # 3. ç”Ÿæˆ Markdown æ–‡æœ¬
        markdown_content = await self._generate_markdown_export(
            user_id=user_id,
            mistakes_data=mistakes_data,
        )
        
        # 4. è°ƒç”¨å¤§æ¨¡å‹
        plan_json = await self._call_ai_for_plan(
            user_id=user_id,
            markdown_content=markdown_content,
            cycle_type=cycle_type,
            mistakes_stats=mistakes_data["statistics"],
        )
        
        # 5. ç”Ÿæˆ PDF
        pdf_info = await self._generate_pdf(
            user_id=user_id,
            plan_json=plan_json,
            markdown_content=markdown_content,
        )
        
        # 6. ä¿å­˜åˆ°æ•°æ®åº“
        revision_plan = await self.revision_repo.create({
            "user_id": user_id,
            "title": plan_json["title"],
            "description": plan_json.get("description", ""),
            "cycle_type": cycle_type,
            "status": "published",
            "mistake_count": len(mistakes_data["items"]),
            "knowledge_points": mistakes_data["knowledge_points"],
            "date_range": mistakes_data["date_range"],
            "plan_content": plan_json,
            "pdf_url": pdf_info["url"],
            "pdf_size": pdf_info["size"],
            "expired_at": self._calculate_expiry(cycle_type),
        })
        
        logger.info(f"âœ… å¤ä¹ è®¡åˆ’ç”ŸæˆæˆåŠŸ: {revision_plan.id}")
        return revision_plan
    
    async def _get_cached_plan(
        self,
        user_id: UUID,
        cycle_type: str,
    ) -> RevisionPlan | None:
        """æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç¼“å­˜è®¡åˆ’"""
        # æŸ¥è¯¢æœ€è¿‘çš„åŒç±»å‹è®¡åˆ’
        # å¦‚æœå­˜åœ¨ä¸”æœªè¿‡æœŸï¼Œè¿”å›
        # å¦åˆ™è¿”å› None
        pass
    
    async def _generate_markdown_export(
        self,
        user_id: UUID,
        mistakes_data: dict,
    ) -> str:
        """å°†é”™é¢˜æœ¬å¯¼å‡ºä¸º Markdown æ–‡æœ¬"""
        # è°ƒç”¨ MistakeService çš„å¯¼å‡ºåŠŸèƒ½
        # è¿”å›æ ¼å¼åŒ–çš„ Markdown æ–‡æœ¬
        pass
    
    async def _call_ai_for_plan(
        self,
        user_id: UUID,
        markdown_content: str,
        cycle_type: str,
        mistakes_stats: dict,
    ) -> dict:
        """è°ƒç”¨ç™¾ç‚¼å¤§æ¨¡å‹ç”Ÿæˆå¤ä¹ è®¡åˆ’"""
        
        prompt = self._build_system_prompt(cycle_type)
        user_context = await self._build_user_context(user_id)
        
        messages = [
            {
                "role": "user",
                "content": f"""
è¯·æ ¹æ®ä»¥ä¸‹å­¦ç”Ÿçš„é”™é¢˜æ•°æ®ç”Ÿæˆä¸€ä»½è¯¦å°½çš„{cycle_type}å¤ä¹ è®¡åˆ’ã€‚

ã€å­¦ç”Ÿä¿¡æ¯ã€‘
{user_context}

ã€é”™é¢˜ç»Ÿè®¡ã€‘
{mistakes_stats}

ã€é”™é¢˜è¯¦æƒ…ã€‘
{markdown_content}

ã€è¦æ±‚ã€‘
1. åˆ¶å®šæ˜ç¡®çš„å­¦ä¹ ç›®æ ‡
2. åˆ†è§£ä¸ºæ¯æ—¥ä»»åŠ¡ï¼ˆå«æ—¶é—´ä¼°è®¡ï¼‰
3. æŒ‡å®šå¤ä¹ é‡ç‚¹å’Œæ–¹æ³•
4. æä¾›è‡ªæµ‹é¢˜å’Œè¯„ä¼°æ ‡å‡†
5. è€ƒè™‘å­¦ç”Ÿçš„å­¦ä¹ é£æ ¼å’Œè–„å¼±ç‚¹

è¯·ä»¥ JSON æ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- title: è®¡åˆ’æ ‡é¢˜
- description: ç®€çŸ­æè¿°
- overview: æ¦‚è¿°
- statistics: æ•°æ®ç»Ÿè®¡
- daily_tasks: æ¯æ—¥ä»»åŠ¡æ•°ç»„
- review_focus: é‡ç‚¹å¤ä¹ å†…å®¹
- assessment: è¯„ä¼°æ ‡å‡†
- tips: å­¦ä¹ å»ºè®®
"""
            }
        ]
        
        response = await self.bailian_service.call_api(
            messages=messages,
            system_prompt=prompt,
            temperature=0.7,
            max_tokens=4000,
        )
        
        # è§£æå¹¶éªŒè¯ JSON
        plan_json = self._parse_json_response(response)
        return plan_json
    
    async def _generate_pdf(
        self,
        user_id: UUID,
        plan_json: dict,
        markdown_content: str,
    ) -> dict:
        """ç”Ÿæˆ PDF æ–‡ä»¶å¹¶ä¸Šä¼ è‡³ OSS"""
        
        # è°ƒç”¨ PDFGeneratorService
        pdf_generator = PDFGeneratorService()
        pdf_buffer = await pdf_generator.generate(
            title=plan_json["title"],
            content=plan_json,
            metadata={
                "user_id": str(user_id),
                "generated_at": datetime.utcnow().isoformat(),
                "markdown_source": markdown_content,
            }
        )
        
        # ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS
        # è·¯å¾„æ ¼å¼: revision-plans/{user_id}/{YYYYMMDD_HHMMSS}.pdf
        file_key = f"revision-plans/{user_id}/{datetime.utcnow().strftime('%Y%m%d_%H%M%S')}.pdf"
        
        # ä½¿ç”¨ FileService (éœ€é…ç½®ä¸º Aliyun OSS backend)
        url = await self.file_service.save_file(
            file_buffer=pdf_buffer,
            file_key=file_key,
            content_type="application/pdf",
        )
        
        return {
            "url": url,
            "size": len(pdf_buffer.getvalue()),
        }
    
    def _build_system_prompt(self, cycle_type: str) -> str:
        """æ„å»ºç³»ç»Ÿæç¤ºè¯"""
        return f"""
ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„å­¦ä¹ è§„åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å­¦ç”Ÿçš„é”™é¢˜æ•°æ®ç”Ÿæˆä¸ªæ€§åŒ–çš„{cycle_type}å¤ä¹ è®¡åˆ’ã€‚

## è§„åˆ’åŸåˆ™
1. **æ•°æ®é©±åŠ¨**ï¼šåŸºäºé”™é¢˜é¢‘ç‡ã€é”™è¯¯ç±»å‹å†³å®šå¤ä¹ é‡ç‚¹
2. **å¾ªåºæ¸è¿›**ï¼šä»åŸºç¡€æ¦‚å¿µåˆ°ç»¼åˆåº”ç”¨
3. **æ—¶é—´åˆç†**ï¼šæ¯æ—¥ä»»åŠ¡æ—¶é—´æ§åˆ¶åœ¨ 1-3 å°æ—¶
4. **å¯æ‰§è¡Œæ€§**ï¼šå…·ä½“æ˜ç¡®ï¼ŒåŒ…å«å…·ä½“æ–¹æ³•å’Œèµ„æº
5. **åé¦ˆæœºåˆ¶**ï¼šåŒ…å«è‡ªæµ‹å’Œè¯„ä¼°æ ‡å‡†

## å¤ä¹ è®¡åˆ’ç»“æ„
- å‘¨æœŸï¼š{cycle_type}
- ç›®æ ‡ï¼šæå‡é”™é¢˜æ¶‰åŠçŸ¥è¯†ç‚¹çš„æŒæ¡åº¦
- è¯„ä¼°ï¼šåŒ…å«å‰æœŸã€ä¸­æœŸã€åæœŸè¯„ä¼°

## æ³¨æ„äº‹é¡¹
- è€ƒè™‘å­¦ç”Ÿçš„è®¤çŸ¥æ°´å¹³å’Œå­¦ä¹ è¿›åº¦
- é¿å…è¿‡åº¦å®‰æ’ï¼Œç•™å‡ºç¼“å†²æ—¶é—´
- æ¯æ—¥ä»»åŠ¡åº”åŒ…å«å…·ä½“çš„å­¦ä¹ æ–¹æ³•ï¼ˆä¸åªæ˜¯é¢˜ç›®ï¼‰
"""
    
    async def _build_user_context(self, user_id: UUID) -> str:
        """æ„å»ºç”¨æˆ·å­¦ä¹ èƒŒæ™¯ä¸Šä¸‹æ–‡"""
        # ä»æ•°æ®åº“è·å–ç”¨æˆ·çš„ï¼š
        # - å¹´çº§/ç§‘ç›®
        # - å¹³å‡å­¦ä¹ æ—¶é—´
        # - é”™é¢˜é¢‘ç‡
        # - è–„å¼±çŸ¥è¯†ç‚¹
        # è¿”å›æ ¼å¼åŒ–æ–‡æœ¬
        pass
    
    def _calculate_expiry(self, cycle_type: str) -> datetime:
        """è®¡ç®—è®¡åˆ’è¿‡æœŸæ—¶é—´"""
        days_map = {
            "7days": 7,
            "14days": 14,
            "30days": 30,
        }
        days = days_map.get(cycle_type, 7)
        return datetime.utcnow() + timedelta(days=days)
    
    async def get_revision_plan(
        self,
        user_id: UUID,
        plan_id: UUID,
    ) -> RevisionPlan:
        """è·å–å¤ä¹ è®¡åˆ’è¯¦æƒ…"""
        plan = await self.revision_repo.get_by_id(plan_id)
        
        if not plan or plan.user_id != user_id:
            raise ServiceError("è®¡åˆ’ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®")
        
        # æ›´æ–°è®¿é—®è®¡æ•°
        plan.view_count += 1
        await self.revision_repo.update(plan_id, {"view_count": plan.view_count})
        
        return plan
    
    async def list_revision_plans(
        self,
        user_id: UUID,
        limit: int = 10,
        offset: int = 0,
    ) -> dict:
        """è·å–å¤ä¹ è®¡åˆ’åˆ—è¡¨"""
        plans = await self.revision_repo.find(
            filters={"user_id": user_id},
            order_by="created_at DESC",
            limit=limit,
            offset=offset,
        )
        
        total = await self.revision_repo.count({"user_id": user_id})
        
        return {
            "total": total,
            "items": plans,
            "limit": limit,
            "offset": offset,
        }
    
    async def download_revision_plan(
        self,
        user_id: UUID,
        plan_id: UUID,
    ) -> str:
        """è®°å½•ä¸‹è½½ç»Ÿè®¡"""
        plan = await self.get_revision_plan(user_id, plan_id)
        
        # æ›´æ–°ä¸‹è½½è®¡æ•°
        plan.download_count += 1
        await self.revision_repo.update(plan_id, {"download_count": plan.download_count})
        
        return plan.pdf_url
    
    def _parse_json_response(self, response: str) -> dict:
        """ä» AI å“åº”ä¸­è§£æ JSON"""
        import json
        import re
        
        # å°è¯•æ‰¾åˆ° JSON å—
        match = re.search(r'\{[\s\S]*\}', response)
        if match:
            try:
                return json.loads(match.group())
            except json.JSONDecodeError:
                pass
        
        # å¦‚æœå¤±è´¥ï¼Œè¿”å›é»˜è®¤ç»“æ„
        logger.warning(f"æ— æ³•ä» AI å“åº”è§£æ JSONï¼Œå°†ä½¿ç”¨é»˜è®¤ç»“æ„")
        return self._generate_default_plan()
    
    def _generate_default_plan(self) -> dict:
        """ç”Ÿæˆé»˜è®¤å¤ä¹ è®¡åˆ’ç»“æ„"""
        return {
            "title": "ä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’",
            "description": "åŸºäºä½ çš„é”™é¢˜æ•°æ®ç”Ÿæˆçš„å¤ä¹ è®¡åˆ’",
            "overview": "...",
            "statistics": {},
            "daily_tasks": [],
            "review_focus": [],
            "assessment": {},
            "tips": [],
        }
```

#### 3.2.2 PDFGeneratorService (æ–°å¢)

```python
# src/services/pdf_generator_service.py

class PDFGeneratorService:
    """PDF ç”ŸæˆæœåŠ¡"""
    
    async def generate(
        self,
        title: str,
        content: dict,
        metadata: dict,
    ) -> BytesIO:
        """
        ç”Ÿæˆ PDF æ–‡ä»¶
        
        ä½¿ç”¨ reportlab + weasyprint ç»„åˆï¼š
        - reportlab: ç”¨äºç®€å•è¡¨æ ¼å’ŒåŸºç¡€æ’ç‰ˆ
        - weasyprint: ç”¨äºå¤æ‚ HTML æ¸²æŸ“
        
        âš ï¸ éƒ¨ç½²æ³¨æ„ï¼š
        åœ¨ Aliyun Linux ä¸Šéœ€è¦å®‰è£…ç³»ç»Ÿä¾èµ–ï¼š
        yum install -y pango cairo cairo-gobject libffi-devel
        
        Args:
            title: è®¡åˆ’æ ‡é¢˜
            content: å¤ä¹ è®¡åˆ’ JSON æ•°æ®
            metadata: å…ƒæ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ã€ç”Ÿæˆæ—¶é—´ç­‰ï¼‰
        
        Returns:
            PDF æ–‡ä»¶çš„ BytesIO å¯¹è±¡
        """
        
        # 1. å°† JSON è½¬æ¢ä¸º HTML
        html_content = self._build_html(title, content, metadata)
        
        # 2. ä½¿ç”¨ weasyprint ç”Ÿæˆ PDF
        pdf_bytes = self._render_html_to_pdf(html_content)
        
        return pdf_bytes
    
    def _build_html(self, title: str, content: dict, metadata: dict) -> str:
        """æ„å»º PDF HTML æ¨¡æ¿"""
        
        return f"""
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{title}</title>
    <style>
        @page {{
            size: A4;
            margin: 2cm;
        }}
        
        body {{
            font-family: 'SimSun', 'SimHei', sans-serif;
            line-height: 1.6;
            color: #333;
        }}
        
        .header {{
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }}
        
        .header h1 {{
            font-size: 28px;
            margin: 0 0 10px 0;
            color: #007bff;
        }}
        
        .metadata {{
            text-align: center;
            font-size: 12px;
            color: #666;
        }}
        
        .section {{
            margin-bottom: 25px;
        }}
        
        .section h2 {{
            font-size: 18px;
            color: #007bff;
            border-left: 4px solid #007bff;
            padding-left: 10px;
            margin-bottom: 15px;
        }}
        
        .overview {{
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }}
        
        .stats-grid {{
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }}
        
        .stat-card {{
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }}
        
        .stat-number {{
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }}
        
        .stat-label {{
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }}
        
        .daily-task {{
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            page-break-inside: avoid;
        }}
        
        .task-day {{
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }}
        
        .task-items {{
            margin-left: 20px;
            font-size: 13px;
        }}
        
        .task-item {{
            margin-bottom: 5px;
            line-height: 1.4;
        }}
        
        .focus-list {{
            list-style: none;
            padding-left: 0;
        }}
        
        .focus-list li {{
            padding-left: 25px;
            margin-bottom: 8px;
            position: relative;
        }}
        
        .focus-list li:before {{
            content: "â†’";
            position: absolute;
            left: 0;
            color: #007bff;
        }}
        
        .assessment {{
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }}
        
        .footer {{
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 10px;
            color: #999;
        }}
        
        .watermark {{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 100px;
            color: rgba(0, 123, 255, 0.1);
            z-index: -1;
            white-space: nowrap;
        }}
    </style>
</head>
<body>
    <div class="watermark">{metadata.get('user_id', 'äº”å¥½ä¼´å­¦')}</div>
    
    <div class="header">
        <h1>{title}</h1>
        <p style="margin: 10px 0; font-size: 14px; color: #666;">
            {content.get('description', '')}
        </p>
        <div class="metadata">
            <p>ç”Ÿæˆæ—¶é—´ï¼š{metadata.get('generated_at', '')}</p>
        </div>
    </div>
    
    <!-- æ¦‚è¿° -->
    <div class="section">
        <h2>ğŸ“‹ è®¡åˆ’æ¦‚è¿°</h2>
        <div class="overview">
            {content.get('overview', 'ä¸ªæ€§åŒ–å­¦ä¹ å¤ä¹ è®¡åˆ’')}
        </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="section">
        <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
        <div class="stats-grid">
            {self._render_stats_cards(content.get('statistics', {}))}
        </div>
    </div>
    
    <!-- æ¯æ—¥ä»»åŠ¡ -->
    <div class="section">
        <h2>ğŸ“… æ¯æ—¥ä»»åŠ¡è§„åˆ’</h2>
        {self._render_daily_tasks(content.get('daily_tasks', []))}
    </div>
    
    <!-- å¤ä¹ é‡ç‚¹ -->
    <div class="section">
        <h2>â­ å¤ä¹ é‡ç‚¹</h2>
        <ul class="focus-list">
            {self._render_focus_points(content.get('review_focus', []))}
        </ul>
    </div>
    
    <!-- è¯„ä¼°æ ‡å‡† -->
    <div class="section">
        <h2>âœ“ è¯„ä¼°æ ‡å‡†</h2>
        <div class="assessment">
            {self._render_assessment(content.get('assessment', {}))}
        </div>
    </div>
    
    <!-- å­¦ä¹ å»ºè®® -->
    {self._render_tips(content.get('tips', []))}
    
    <div class="footer">
        <p>Â© 2025 äº”å¥½ä¼´å­¦ | æ­¤æ–‡æ¡£ç”± AI ç”Ÿæˆï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒ</p>
    </div>
</body>
</html>
        """
    
    def _render_stats_cards(self, stats: dict) -> str:
        """æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡"""
        cards = []
        for key, value in stats.items():
            cards.append(f"""
                <div class="stat-card">
                    <div class="stat-number">{value}</div>
                    <div class="stat-label">{key}</div>
                </div>
            """)
        return "".join(cards)
    
    def _render_daily_tasks(self, tasks: list) -> str:
        """æ¸²æŸ“æ¯æ—¥ä»»åŠ¡"""
        tasks_html = []
        for task in tasks:
            items_html = "".join([
                f"<div class='task-item'>â€¢ {item}</div>"
                for item in task.get('tasks', [])
            ])
            tasks_html.append(f"""
                <div class="daily-task">
                    <div class="task-day">
                        ç¬¬ {task.get('day')} å¤© ({task.get('date')}) 
                        - é¢„è®¡ {task.get('estimated_hours', 1.5)} å°æ—¶
                    </div>
                    <div class="task-items">{items_html}</div>
                </div>
            """)
        return "".join(tasks_html)
    
    def _render_focus_points(self, focus: list) -> str:
        """æ¸²æŸ“é‡ç‚¹"""
        return "".join([f"<li>{point}</li>" for point in focus])
    
    def _render_assessment(self, assessment: dict) -> str:
        """æ¸²æŸ“è¯„ä¼°æ ‡å‡†"""
        html = []
        for criterion, details in assessment.items():
            html.append(f"<p><strong>{criterion}:</strong> {details}</p>")
        return "".join(html)
    
    def _render_tips(self, tips: list) -> str:
        """æ¸²æŸ“å­¦ä¹ å»ºè®®"""
        if not tips:
            return ""
        
        tips_html = "".join([f"<li>{tip}</li>" for tip in tips])
        return f"""
        <div class="section">
            <h2>ğŸ’¡ å­¦ä¹ å»ºè®®</h2>
            <ul class="focus-list">{tips_html}</ul>
        </div>
        """
    
    def _render_html_to_pdf(self, html: str) -> BytesIO:
        """ä½¿ç”¨ weasyprint å°† HTML æ¸²æŸ“ä¸º PDF"""
        from weasyprint import HTML, CSS
        
        pdf_bytes = BytesIO()
        HTML(string=html).write_pdf(pdf_bytes)
        pdf_bytes.seek(0)
        
        return pdf_bytes
```

### 3.3 API ç«¯ç‚¹è®¾è®¡

#### 3.3.1 è·¯ç”±å®šä¹‰

```python
# src/api/v1/endpoints/revisions.py

from fastapi import APIRouter, Depends, HTTPException, BackgroundTasks
from typing import Optional

router = APIRouter(prefix="/revisions", tags=["revisions"])

@router.post("/generate")
async def generate_revision_plan(
    cycle_type: str = Query("7days", regex="^(7days|14days|30days)$"),
    force_regenerate: bool = Query(False),
    user_id: UUID = Depends(get_current_user),
    service: RevisionPlanService = Depends(get_revision_plan_service),
) -> dict:
    """
    ç”Ÿæˆå¤ä¹ è®¡åˆ’
    
    - **cycle_type**: è®¡åˆ’å‘¨æœŸ (7days|14days|30days)
    - **force_regenerate**: æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
    
    è¿”å›ï¼šå¤ä¹ è®¡åˆ’å¯¹è±¡ + PDF ä¸‹è½½é“¾æ¥
    
    âš ï¸ è€—æ—¶æ“ä½œï¼ˆå¯èƒ½ 30-60 ç§’ï¼‰ï¼Œå»ºè®®å‰ç«¯æ˜¾ç¤ºè¿›åº¦æ¡
    """
    try:
        plan = await service.generate_revision_plan(
            user_id=user_id,
            cycle_type=cycle_type,
            force_regenerate=force_regenerate,
        )
        
        return {
            "status": "success",
            "data": {
                "id": str(plan.id),
                "title": plan.title,
                "cycle_type": plan.cycle_type,
                "pdf_url": plan.pdf_url,
                "plan_content": plan.plan_content,
                "created_at": plan.created_at.isoformat(),
            }
        }
    except ServiceError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"ç”Ÿæˆå¤ä¹ è®¡åˆ’å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯")


@router.get("/{plan_id}")
async def get_revision_plan(
    plan_id: UUID,
    user_id: UUID = Depends(get_current_user),
    service: RevisionPlanService = Depends(get_revision_plan_service),
) -> dict:
    """è·å–å¤ä¹ è®¡åˆ’è¯¦æƒ…"""
    try:
        plan = await service.get_revision_plan(user_id, plan_id)
        
        return {
            "status": "success",
            "data": {
                "id": str(plan.id),
                "title": plan.title,
                "description": plan.description,
                "cycle_type": plan.cycle_type,
                "status": plan.status,
                "mistake_count": plan.mistake_count,
                "knowledge_points": plan.knowledge_points,
                "plan_content": plan.plan_content,
                "pdf_url": plan.pdf_url,
                "view_count": plan.view_count,
                "download_count": plan.download_count,
                "created_at": plan.created_at.isoformat(),
                "expired_at": plan.expired_at.isoformat() if plan.expired_at else None,
            }
        }
    except ServiceError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.get("")
async def list_revision_plans(
    limit: int = Query(10, ge=1, le=50),
    offset: int = Query(0, ge=0),
    user_id: UUID = Depends(get_current_user),
    service: RevisionPlanService = Depends(get_revision_plan_service),
) -> dict:
    """è·å–å¤ä¹ è®¡åˆ’åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰"""
    result = await service.list_revision_plans(user_id, limit, offset)
    
    return {
        "status": "success",
        "data": {
            "total": result["total"],
            "items": [
                {
                    "id": str(p.id),
                    "title": p.title,
                    "cycle_type": p.cycle_type,
                    "status": p.status,
                    "mistake_count": p.mistake_count,
                    "created_at": p.created_at.isoformat(),
                    "expired_at": p.expired_at.isoformat() if p.expired_at else None,
                    "view_count": p.view_count,
                }
                for p in result["items"]
            ],
            "limit": limit,
            "offset": offset,
        }
    }


@router.get("/{plan_id}/download")
async def download_revision_plan(
    plan_id: UUID,
    user_id: UUID = Depends(get_current_user),
    service: RevisionPlanService = Depends(get_revision_plan_service),
):
    """
    è·å– PDF ä¸‹è½½é“¾æ¥
    
    è¿”å›ï¼šPDF æ–‡ä»¶çš„ OSS ç­¾åé“¾æ¥ (Signed URL)
    
    å‰ç«¯ (å°ç¨‹åº) å¤„ç†æµç¨‹ï¼š
    1. è°ƒç”¨æ­¤æ¥å£è·å– url
    2. ä½¿ç”¨ `wx.downloadFile({ url: res.data.pdf_url })` ä¸‹è½½
    3. ä½¿ç”¨ `wx.openDocument()` é¢„è§ˆ
    """
    try:
        pdf_url = await service.download_revision_plan(user_id, plan_id)
        
        return {
            "status": "success",
            "data": {
                "pdf_url": pdf_url,
            }
        }
    except ServiceError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.delete("/{plan_id}")
async def delete_revision_plan(
    plan_id: UUID,
    user_id: UUID = Depends(get_current_user),
    service: RevisionPlanService = Depends(get_revision_plan_service),
) -> dict:
    """åˆ é™¤å¤ä¹ è®¡åˆ’"""
    try:
        await service.delete_revision_plan(user_id, plan_id)
        
        return {
            "status": "success",
            "message": "è®¡åˆ’å·²åˆ é™¤"
        }
    except ServiceError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

---

## å››ã€å‰ç«¯è®¾è®¡

### 4.1 UI ç»„ä»¶ç»“æ„

#### 4.1.1 å­¦ä¹ æŠ¥å‘Šé¡µé¢æ”¹é€ 

```
å­¦ä¹ æŠ¥å‘Šé¡µé¢ (pages/analytics æˆ– pages/report)
â”‚
â”œâ”€ ç»Ÿè®¡æ¦‚è§ˆï¼ˆç°æœ‰ï¼‰
â”‚  â”œâ”€ å­¦ä¹ æ—¶é—´
â”‚  â”œâ”€ é—®é¢˜æ•°é‡
â”‚  â””â”€ é”™é¢˜æ•°
â”‚
â”œâ”€ ğŸ“‹ AI å¤ä¹ è®¡åˆ’ï¼ˆæ–°å¢æ¨¡å—ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ çŠ¶æ€å±•ç¤ºåŒº
â”‚  â”‚  â”œâ”€ æœ€æ–°è®¡åˆ’å¡ç‰‡
â”‚  â”‚  â”‚  â”œâ”€ æ ‡é¢˜
â”‚  â”‚  â”‚  â”œâ”€ å‘¨æœŸï¼ˆ7/14/30å¤©ï¼‰
â”‚  â”‚  â”‚  â”œâ”€ æ¶‰åŠé”™é¢˜æ•°
â”‚  â”‚  â”‚  â””â”€ ç”Ÿæˆæ—¶é—´
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ è®¡åˆ’å†å²åˆ—è¡¨
â”‚  â”‚
â”‚  â”œâ”€ æ“ä½œæŒ‰é’®åŒº
â”‚  â”‚  â”œâ”€ "ç”Ÿæˆæ–°è®¡åˆ’" æŒ‰é’®
â”‚  â”‚  â”œâ”€ å‘¨æœŸé€‰æ‹©å™¨ï¼ˆ7/14/30å¤©ï¼‰
â”‚  â”‚  â”œâ”€ "åˆ·æ–°" æŒ‰é’®ï¼ˆé‡æ–°ç”Ÿæˆï¼‰
â”‚  â”‚  â””â”€ "ä¸‹è½½ PDF" æŒ‰é’®
â”‚  â”‚
â”‚  â”œâ”€ è®¡åˆ’å†…å®¹é¢„è§ˆ
â”‚  â”‚  â”œâ”€ æ¦‚è¿°
â”‚  â”‚  â”œâ”€ æ¯æ—¥ä»»åŠ¡æ‘˜è¦ï¼ˆå‰3å¤©ï¼‰
â”‚  â”‚  â””â”€ "æŸ¥çœ‹è¯¦æƒ…" é“¾æ¥
â”‚  â”‚
â”‚  â””â”€ åŠ è½½/é”™è¯¯çŠ¶æ€
â”‚     â”œâ”€ ç”Ÿæˆä¸­åŠ¨ç”»
â”‚     â”œâ”€ è¿›åº¦æ¡
â”‚     â””â”€ é”™è¯¯æç¤º
```

#### 4.1.2 æ–°å¢å­é¡µé¢

```
å¤ä¹ è®¡åˆ’è¯¦æƒ…é¡µ (pages/revision-detail)
â”‚
â”œâ”€ é¡¶éƒ¨
â”‚  â”œâ”€ æ ‡é¢˜ + å‘¨æœŸæ ‡ç­¾
â”‚  â”œâ”€ ç”Ÿæˆæ—¶é—´ + è¿‡æœŸæ—¶é—´
â”‚  â””â”€ åˆ†äº« + åˆ é™¤æŒ‰é’®
â”‚
â”œâ”€ æ ‡ç­¾é¡µåˆ‡æ¢
â”‚  â”œâ”€ æ¦‚è§ˆæ ‡ç­¾
â”‚  â”‚  â”œâ”€ è®¡åˆ’æè¿°
â”‚  â”‚  â”œâ”€ æ•°æ®ç»Ÿè®¡å¡ç‰‡
â”‚  â”‚  â””â”€ å­¦ä¹ å»ºè®®
â”‚  â”‚
â”‚  â”œâ”€ æ¯æ—¥ä»»åŠ¡æ ‡ç­¾
â”‚  â”‚  â”œâ”€ æ—¥æœŸç­›é€‰å™¨
â”‚  â”‚  â””â”€ ä»»åŠ¡åˆ—è¡¨ï¼ˆå¯æ”¶èµ·ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ é‡ç‚¹å¤ä¹ æ ‡ç­¾
â”‚  â”‚  â””â”€ çŸ¥è¯†ç‚¹åˆ—è¡¨
â”‚  â”‚
â”‚  â””â”€ è¯„ä¼°æ ‡ç­¾
â”‚     â””â”€ è¯„ä¼°æ ‡å‡†å’Œè‡ªæµ‹é¢˜
â”‚
â””â”€ åº•éƒ¨
   â”œâ”€ ä¸‹è½½ PDF æŒ‰é’®
   â”œâ”€ åˆ†äº«è®¡åˆ’
   â””â”€ è¿”å›æŒ‰é’®
```

### 4.2 å°ç¨‹åºç«¯ä»£ç ç¤ºä¾‹

```typescript
// miniprogram/pages/revision-plan/index.wxml

<view class="revision-plan-container">
  <!-- æ ‡é¢˜ -->
  <view class="header">
    <text class="title">ğŸ“‹ AI å¤ä¹ è®¡åˆ’</text>
    <text class="subtitle">åŸºäºä½ çš„é”™é¢˜æ•°æ®ï¼Œæ™ºèƒ½ç”Ÿæˆä¸ªæ€§åŒ–å¤ä¹ æŒ‡å¯¼</text>
  </view>

  <!-- çŠ¶æ€æ˜¾ç¤º -->
  <view class="status-section" wx:if="{{!loading && !error}}">
    <!-- æœ€æ–°è®¡åˆ’å¡ç‰‡ -->
    <view class="plan-card" wx:if="{{currentPlan}}">
      <view class="plan-header">
        <text class="plan-title">{{currentPlan.title}}</text>
        <view class="plan-meta">
          <text class="tag">{{cycleTypeLabel}}</text>
          <text class="time">{{formatDate(currentPlan.created_at)}}</text>
        </view>
      </view>
      
      <view class="plan-stats">
        <view class="stat">
          <text class="stat-number">{{currentPlan.mistake_count}}</text>
          <text class="stat-label">æ¶‰åŠé”™é¢˜</text>
        </view>
        <view class="stat">
          <text class="stat-number">{{currentPlan.knowledge_points.length}}</text>
          <text class="stat-label">çŸ¥è¯†ç‚¹</text>
        </view>
        <view class="stat">
          <text class="stat-number">{{cycleType === '7days' ? 7 : cycleType === '14days' ? 14 : 30}}</text>
          <text class="stat-label">å¤©æ•°</text>
        </view>
      </view>

      <view class="plan-preview">
        <text class="preview-title">è®¡åˆ’é¢„è§ˆ</text>
        <text class="preview-text">{{currentPlan.plan_content.overview}}</text>
      </view>

      <view class="plan-actions">
        <button class="btn btn-primary" bindtap="onViewDetail">æŸ¥çœ‹è¯¦æƒ…</button>
        <button class="btn btn-secondary" bindtap="onDownloadPDF">ä¸‹è½½ PDF</button>
      </view>
    </view>

    <!-- æ— è®¡åˆ’æç¤º -->
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ“­</view>
      <text class="empty-text">è¿˜æ²¡æœ‰å¤ä¹ è®¡åˆ’</text>
      <text class="empty-hint">ç”Ÿæˆç¬¬ä¸€ä¸ªå¤ä¹ è®¡åˆ’ï¼Œå¼€å¯æ™ºèƒ½å­¦ä¹ ä¹‹æ—…</text>
    </view>
  </view>

  <!-- ç”Ÿæˆæ§åˆ¶åŒº -->
  <view class="control-section">
    <view class="cycle-selector">
      <text class="selector-label">é€‰æ‹©è®¡åˆ’å‘¨æœŸï¼š</text>
      <view class="cycle-options">
        <view class="option {{cycleType === '7days' ? 'active' : ''}}"
              bindtap="onSelectCycle"
              data-cycle="7days">
          7å¤©
        </view>
        <view class="option {{cycleType === '14days' ? 'active' : ''}}"
              bindtap="onSelectCycle"
              data-cycle="14days">
          14å¤©
        </view>
        <view class="option {{cycleType === '30days' ? 'active' : ''}}"
              bindtap="onSelectCycle"
              data-cycle="30days">
          30å¤©
        </view>
      </view>
    </view>

    <button class="btn btn-large {{generating ? 'disabled' : 'btn-primary'}}"
            bindtap="onGeneratePlan"
            disabled="{{generating}}">
      <text wx:if="{{!generating}}">ğŸš€ ç”Ÿæˆå¤ä¹ è®¡åˆ’</text>
      <text wx:else>ç”Ÿæˆä¸­... {{progress}}%</text>
    </button>

    <button class="btn btn-secondary" 
            bindtap="onRefresh"
            disabled="{{generating}}">
      åˆ·æ–°ï¼ˆé‡æ–°ç”Ÿæˆï¼‰
    </button>
  </view>

  <!-- å†å²åˆ—è¡¨ -->
  <view class="history-section" wx:if="{{plans.length > 1}}">
    <text class="section-title">è®¡åˆ’å†å²</text>
    <view class="plan-list">
      <view class="plan-item {{plan.id === currentPlan.id ? 'active' : ''}}"
            wx:for="{{plans}}"
            wx:key="id"
            bindtap="onSelectPlan"
            data-plan-id="{{plan.id}}">
        <view class="item-header">
          <text class="item-title">{{plan.title}}</text>
          <view class="item-meta">
            <text class="status {{plan.status}}">{{formatStatus(plan.status)}}</text>
            <text class="date">{{formatDate(plan.created_at)}}</text>
          </view>
        </view>
        <text class="item-desc">{{plan.mistake_count}} ä¸ªé”™é¢˜ â€¢ {{plan.knowledge_points.length}} ä¸ªçŸ¥è¯†ç‚¹</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>æ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’...</text>
    <view class="progress-bar">
      <view class="progress" style="width: {{progress}}%"></view>
    </view>
  </view>

  <!-- é”™è¯¯å¤„ç† -->
  <view class="error-message" wx:if="{{error}}">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="btn btn-secondary" bindtap="onRetry">é‡è¯•</button>
  </view>
</view>
```

```typescript
// miniprogram/pages/revision-plan/index.ts

import { api } from '@/utils/api'
import { toast } from '@/utils/toast'

Page({
  data: {
    // çŠ¶æ€
    loading: false,
    generating: false,
    error: null,
    progress: 0,

    // æ•°æ®
    cycleType: '7days',
    currentPlan: null,
    plans: [],

    // UI
    tabActive: 0,
  },

  onLoad() {
    this.loadPlans()
  },

  onShow() {
    // é‡æ–°åŠ è½½ï¼ˆé˜²æ­¢é¡µé¢åˆ‡æ¢åæ•°æ®è¿‡æœŸï¼‰
    this.loadPlans()
  },

  async loadPlans() {
    this.setData({ loading: true })
    try {
      const res = await api.revisions.listPlans({
        limit: 10,
        offset: 0,
      })

      const plans = res.data.items || []
      this.setData({
        plans,
        currentPlan: plans[0] || null,
      })
    } catch (err) {
      toast.error('åŠ è½½å¤ä¹ è®¡åˆ’å¤±è´¥')
      logger.error('loadPlans failed:', err)
    } finally {
      this.setData({ loading: false })
    }
  },

  async onGeneratePlan() {
    if (this.data.generating) return

    this.setData({ generating: true, progress: 0, error: null })

    try {
      // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°ï¼ˆå®é™…ç”±åç«¯æ¨é€æˆ–å‰ç«¯è½®è¯¢ï¼‰
      const progressInterval = setInterval(() => {
        const current = this.data.progress
        if (current < 90) {
          this.setData({ progress: current + Math.random() * 20 })
        }
      }, 1000)

      const res = await api.revisions.generatePlan({
        cycle_type: this.data.cycleType,
        force_regenerate: false,
      })

      clearInterval(progressInterval)
      this.setData({ progress: 100 })

      // æ›´æ–° UI
      const newPlan = res.data
      const plans = [newPlan, ...this.data.plans]
      this.setData({
        currentPlan: newPlan,
        plans: plans.slice(0, 10), // åªä¿ç•™æœ€è¿‘10ä¸ª
      })

      toast.success('å¤ä¹ è®¡åˆ’ç”ŸæˆæˆåŠŸï¼')

      // 1ç§’åéšè—åŠ è½½çŠ¶æ€
      setTimeout(() => {
        this.setData({ generating: false, progress: 0 })
      }, 1000)
    } catch (err: any) {
      this.setData({
        generating: false,
        error: err.message || 'ç”Ÿæˆå¤ä¹ è®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•',
      })
      logger.error('generatePlan failed:', err)
    }
  },

  onSelectCycle(e: any) {
    const cycle = e.currentTarget.dataset.cycle
    this.setData({ cycleType: cycle })
  },

  onRefresh() {
    // å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
    this.setData({ cycleType: this.data.cycleType }, () => {
      this.onGeneratePlan()
    })
  },

  async onDownloadPDF() {
    if (!this.data.currentPlan?.pdf_url) {
      toast.error('PDF æ–‡ä»¶ä¸å¯ç”¨')
      return
    }

    try {
      toast.loading('å‡†å¤‡ä¸‹è½½...')

      const res = await api.revisions.downloadPlan(this.data.currentPlan.id)
      const pdf_url = res.data.pdf_url

      // è®°å½•ä¸‹è½½
      wx.downloadFile({
        url: pdf_url,
        success: (res) => {
          // ä¿å­˜åˆ°ç›¸å†Œæˆ–æœ¬åœ°
          wx.saveFile({
            tempFilePath: res.tempFilePath,
            success: () => {
              toast.success('ä¸‹è½½å®Œæˆï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°')
            },
          })
        },
        fail: (err) => {
          toast.error('ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ')
          logger.error('downloadFile failed:', err)
        },
      })
    } catch (err) {
      toast.error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥')
      logger.error('downloadPlan failed:', err)
    }
  },

  onViewDetail() {
    if (!this.data.currentPlan) return

    wx.navigateTo({
      url: `/pages/revision-detail/index?plan_id=${this.data.currentPlan.id}`,
    })
  },

  onSelectPlan(e: any) {
    const planId = e.currentTarget.dataset.planId
    const plan = this.data.plans.find(p => p.id === planId)
    if (plan) {
      this.setData({ currentPlan: plan })
    }
  },

  onRetry() {
    this.setData({ error: null })
    this.onGeneratePlan()
  },

  formatDate(date: string) {
    // æ ¼å¼åŒ–æ—¶é—´
    return new Date(date).toLocaleDateString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    })
  },

  formatStatus(status: string) {
    const statusMap: any = {
      draft: 'è‰ç¨¿',
      published: 'å·²å‘å¸ƒ',
      completed: 'å·²å®Œæˆ',
      expired: 'å·²è¿‡æœŸ',
    }
    return statusMap[status] || status
  },
})
```

---

## äº”ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 5.1 å¤§æ¨¡å‹æç¤ºè¯ä¼˜åŒ–

#### 5.1.1 æ ¸å¿ƒæç¤ºè¯æ¨¡æ¿

```
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å­¦ä¹ è§„åˆ’å¸ˆå’Œæ•™è‚²é¡¾é—®ã€‚

## ç”¨æˆ·èƒŒæ™¯
- å¹´çº§/ç§‘ç›®ï¼š[ç”¨æˆ·ä¿¡æ¯]
- å­¦ä¹ é£æ ¼ï¼š[å­¦ä¹ é£æ ¼åˆ†æ]
- å½“å‰çŠ¶æ€ï¼š[å­¦ä¹ è¿›åº¦]

## ä»»åŠ¡
åŸºäºä»¥ä¸‹é”™é¢˜æ•°æ®ï¼Œä¸ºå­¦ç”Ÿåˆ¶å®šä¸€ä»½[å‘¨æœŸ]çš„ä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’ã€‚

## é”™é¢˜åˆ†æ
[Markdown æ ¼å¼çš„é”™é¢˜æ•°æ®]

## è¦æ±‚
1. **ç›®æ ‡æ˜ç¡®**ï¼šæ˜ç¡®æŒ‡å‡ºé€šè¿‡æœ¬è®¡åˆ’è¦è¾¾æˆçš„å­¦ä¹ ç›®æ ‡
2. **è®¡åˆ’ç»†è‡´**ï¼šåˆ†è§£ä¸ºå…·ä½“çš„æ¯æ—¥ä»»åŠ¡ï¼Œæ¯é¡¹ä»»åŠ¡åº”åŒ…å«ï¼š
   - å­¦ä¹ å†…å®¹
   - å­¦ä¹ æ–¹æ³•ï¼ˆä¸ä»…æ˜¯é¢˜ç›®ï¼Œè¦æœ‰æŠ€å·§ï¼‰
   - é¢„æœŸè€—æ—¶
   - è‡ªæ£€æ ‡å‡†

3. **éš¾åº¦é€’è¿›**ï¼šç¬¬ä¸€å‘¨åŸºç¡€å·©å›ºï¼Œåç»­é€æ­¥æå‡
4. **å¯æ‰§è¡Œæ€§**ï¼šæ¯æ—¥ä»»åŠ¡æ—¶é—´åˆç†ï¼ˆ1-3å°æ—¶ï¼‰ï¼Œæœ‰å…·ä½“å­¦ä¹ èµ„æºå»ºè®®
5. **åé¦ˆæœºåˆ¶**ï¼šæä¾›æ¯å‘¨æ£€æŸ¥ç‚¹å’Œæœˆæœ«è¯„ä¼°æ ‡å‡†
6. **æ¿€åŠ±æ€§**ï¼šåŒ…å«ç§¯æçš„å­¦ä¹ å»ºè®®å’Œé¼“åŠ±è¯­è¨€

## è¾“å‡ºæ ¼å¼
è¿”å› JSONï¼ŒåŒ…å«ï¼š
{
  "title": "æ ‡é¢˜",
  "description": "ç®€è¿°",
  "overview": "è®¡åˆ’æ¦‚è¿°æ–‡å­—ï¼ˆ200å­—å·¦å³ï¼‰",
  "statistics": {
    "é”™é¢˜æ€»æ•°": XX,
    "æ¶‰åŠçŸ¥è¯†ç‚¹": XX,
    ...
  },
  "daily_tasks": [
    {
      "day": 1,
      "date": "2025-01-16",
      "tasks": ["ä»»åŠ¡1", "ä»»åŠ¡2", ...],
      "estimated_hours": 1.5
    }
  ],
  "review_focus": ["é‡ç‚¹1", "é‡ç‚¹2", ...],
  "assessment": {
    "ç¬¬ä¸€å‘¨æ£€æŸ¥": "...",
    "æœˆæœ«è¯„ä¼°": "..."
  },
  "tips": ["å»ºè®®1", "å»ºè®®2", ...]
}
```

### 5.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 5.2.1 ç¼“å­˜æœºåˆ¶

```python
# ç¼“å­˜ç­–ç•¥
- åŒä¸€ç”¨æˆ·ã€åŒä¸€å‘¨æœŸå†… 24 å°æ—¶å†…çš„è®¡åˆ’è§†ä¸ºæœ‰æ•ˆç¼“å­˜
- æ–°å¢é”™é¢˜åï¼Œç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
- ç”¨æˆ·å¯æ‰‹åŠ¨å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰

# ç¼“å­˜å­˜å‚¨
- ä½¿ç”¨ Redisï¼ˆæ¨èï¼‰
- Key æ ¼å¼ï¼šrevision_plan:{user_id}:{cycle_type}
- TTLï¼š24 å°æ—¶
```

#### 5.2.2 å¼‚æ­¥å¤„ç†

```python
# åç«¯ä½¿ç”¨åå°ä»»åŠ¡
- å¤§æ¨¡å‹è°ƒç”¨ï¼ˆè€—æ—¶ 30-60sï¼‰
- PDF ç”Ÿæˆï¼ˆè€—æ—¶ 10-20sï¼‰
- ä½¿ç”¨ Celery/APScheduler å¼‚æ­¥å¤„ç†
- å‰ç«¯è½®è¯¢æŸ¥è¯¢çŠ¶æ€æˆ–ä½¿ç”¨ WebSocket æ¨é€

# å‰ç«¯æ˜¾ç¤ºè¿›åº¦
- æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼ˆ0-90%ï¼‰
- å®Œæˆåè·³è½¬åˆ°è¯¦æƒ…é¡µ
- æ”¯æŒåå°ç”Ÿæˆï¼Œç”¨æˆ·å¯å…ˆç¦»å¼€
```

### 5.3 æˆæœ¬æ§åˆ¶

| æ–¹æ¡ˆ | æˆæœ¬ | ç‰¹ç‚¹ |
|------|------|------|
| **æŒ‰æ¬¡è®¡è´¹** | ~Â¥0.1-0.5/æ¬¡ | é¢‘ç‡æ§åˆ¶ï¼ˆ24hç¼“å­˜ï¼‰ï¼Œç”¨æˆ·é‡å¤§æ—¶æ€»æˆæœ¬å¯æ§ |
| **åŒ…æœˆå¥—é¤** | ~Â¥1000/æœˆ | ç™¾ç‚¼åŒ…å¹´åŒ…æœˆæ–¹æ¡ˆï¼Œé€‚åˆç”¨æˆ·è§„æ¨¡ > 1000 |
| **å…è´¹é¢åº¦** | ~3000æ¬¡/æœˆ | åˆæœŸä½¿ç”¨ï¼Œæ»¡è¶³å°è§„æ¨¡ç”¨æˆ· |

### 5.4 æ–‡ä»¶å­˜å‚¨

```python
# å­˜å‚¨é€‰é¡¹
1. **æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ**
   - ç®€å•ï¼Œæ— é¢å¤–æˆæœ¬
   - é£é™©ï¼šæœåŠ¡å™¨ç¡¬ç›˜å®¹é‡æœ‰é™
   - é€‚åˆï¼šåˆæœŸæµ‹è¯•

2. **é˜¿é‡Œäº‘ OSS**ï¼ˆæ¨èï¼‰
   - URL å¯ç›´æ¥åˆ†äº«
   - è‡ªåŠ¨è¿‡æœŸæ¸…ç†
   - æˆæœ¬ï¼š~Â¥0.12/GB/æœˆ

3. **ä¸ƒç‰›äº‘**
   - å›½å†… CDNï¼ŒåŠ è½½å¿«
   - æˆæœ¬ç›¸ä¼¼

é…ç½®ï¼š
- å­˜å‚¨ä½ç½®ï¼šrevision-plans/{user_id}/{timestamp}.pdf
- è®¿é—®æƒé™ï¼šç§æœ‰ + é¢„ç­¾å URLï¼ˆ1å°æ—¶æœ‰æ•ˆæœŸï¼‰
- è‡ªåŠ¨åˆ é™¤ï¼š30å¤©æ— è®¿é—®è‡ªåŠ¨æ¸…ç†
```

---

## å…­ã€æ•°æ®åº“è¿ç§»

### 6.1 æ–°å¢è¡¨

```sql
-- revision_plans è¡¨
CREATE TABLE revision_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    title VARCHAR(255) NOT NULL,
    description TEXT,
    cycle_type VARCHAR(20) NOT NULL, -- 7days|14days|30days
    status VARCHAR(20) NOT NULL DEFAULT 'draft', -- draft|published|completed|expired
    
    mistake_count INT NOT NULL DEFAULT 0,
    knowledge_points JSONB NOT NULL DEFAULT '[]',
    date_range JSONB NOT NULL,
    
    plan_content JSONB NOT NULL,
    pdf_url VARCHAR(500),
    pdf_size INT,
    markdown_url VARCHAR(500),
    
    download_count INT NOT NULL DEFAULT 0,
    view_count INT NOT NULL DEFAULT 0,
    is_shared BOOLEAN NOT NULL DEFAULT FALSE,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_revision_plans_user_id ON revision_plans(user_id);
CREATE INDEX idx_revision_plans_created_at ON revision_plans(created_at DESC);
CREATE INDEX idx_revision_plans_expired_at ON revision_plans(expired_at);

-- revision_plan_progress è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE revision_plan_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    revision_plan_id UUID NOT NULL REFERENCES revision_plans(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    completed_tasks JSONB NOT NULL DEFAULT '[]',
    completion_rate NUMERIC(5, 2) NOT NULL DEFAULT 0,
    last_reviewed_at TIMESTAMP,
    notes TEXT,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_progress_revision_plan_id ON revision_plan_progress(revision_plan_id);
CREATE INDEX idx_progress_user_id ON revision_plan_progress(user_id);
```

### 6.2 è¿ç§»è„šæœ¬

```bash
# alembic/versions/XXX_add_revision_plans.py

def upgrade():
    op.create_table(
        'revision_plans',
        sa.Column('id', sa.UUID(), nullable=False),
        sa.Column('user_id', sa.UUID(), nullable=False),
        sa.Column('title', sa.String(255), nullable=False),
        # ... å…¶ä»–å­—æ®µ ...
        sa.ForeignKeyConstraint(['user_id'], ['users.id']),
        sa.PrimaryKeyConstraint('id')
    )
    
    op.create_index('idx_revision_plans_user_id', 'revision_plans', ['user_id'])

def downgrade():
    op.drop_table('revision_plans')
```

---

## ä¸ƒã€é›†æˆæ£€æŸ¥æ¸…å•

### 7.1 åç«¯é›†æˆ

- [x] åˆ›å»º RevisionPlan æ•°æ®æ¨¡å‹
- [x] åˆ›å»º RevisionPlanRepository
- [x] å®ç° RevisionPlanService
- [x] å®ç° PDFGeneratorService
- [ ] æ·»åŠ  /api/v1/revisions è·¯ç”±
- [x] æ·»åŠ å¤§æ¨¡å‹æç¤ºè¯é…ç½® (é›†æˆåœ¨ Service ä¸­)
- [x] é…ç½® PDF æ–‡ä»¶å­˜å‚¨ï¼ˆOSS/æœ¬åœ°ï¼‰
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] å¼‚æ­¥ä»»åŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
- [ ] æ—¥å¿—å’Œç›‘æ§

### 7.2 å‰ç«¯é›†æˆ

- [ ] åœ¨å­¦ä¹ æŠ¥å‘Šé¡µæ·»åŠ "AI å¤ä¹ è®¡åˆ’"æ¨¡å—
- [ ] å®ç°å¤ä¹ è®¡åˆ’ä¸»é¡µé¢
- [ ] å®ç°å¤ä¹ è®¡åˆ’è¯¦æƒ…é¡µé¢
- [ ] å®ç° PDF ä¸‹è½½åŠŸèƒ½
- [ ] æ·»åŠ  API è°ƒç”¨ï¼ˆapi.revisionsï¼‰
- [ ] é”™è¯¯å¤„ç†å’Œæç¤º
- [ ] åŠ è½½çŠ¶æ€å’Œè¿›åº¦æ¡
- [ ] ç¼“å­˜ç®¡ç†
- [ ] å•å…ƒæµ‹è¯•
-