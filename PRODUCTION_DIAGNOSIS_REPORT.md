# ç”Ÿäº§ç¯å¢ƒåç«¯è¯Šæ–­æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-11-15 08:56:15 CST  
**æœåŠ¡å™¨**: 121.199.173.244 (é˜¿é‡Œäº‘ ECS)  
**ç¯å¢ƒ**: Production  
**æŠ¥å‘Šç±»å‹**: WebSocket æµå¼ä¿®å¤ - éƒ¨ç½²åéªŒè¯

---

## ğŸ“Š æ‰§è¡Œæ€»ç»“

âœ… **åç«¯æœåŠ¡çŠ¶æ€**: æ­£å¸¸è¿è¡Œ  
âœ… **ä¿®å¤ä»£ç éƒ¨ç½²**: å·²å®Œæˆ  
âœ… **API ç«¯ç‚¹**: å¥åº·  
âš ï¸ **æ³¨æ„äº‹é¡¹**: å‘ç°ä¸€ä¸ª JSON è§£æé”™è¯¯ï¼ˆéæµå¼ç›¸å…³ï¼‰

---

## 1ï¸âƒ£ ç³»ç»Ÿä¿¡æ¯

### æ“ä½œç³»ç»Ÿ
- **å†…æ ¸**: Linux 5.15.0-153-generic #163-Ubuntu
- **æ¶æ„**: x86_64 GNU/Linux
- **å½“å‰æ—¶é—´**: Sat Nov 15 08:56:15 AM CST 2025

### ç¡¬ä»¶é…ç½®
| èµ„æº | é…ç½® | ä½¿ç”¨æƒ…å†µ |
|------|------|---------|
| å†…å­˜ | 7.2 GiB | 557 MiB (7.7%) |
| ç£ç›˜ | 40 GiB | 8.7 GiB (24%) |
| CPU | å¤šæ ¸ | 0.4% |

---

## 2ï¸âƒ£ æœåŠ¡çŠ¶æ€

### FastAPI åº”ç”¨

```
â— wuhao-tutor.service - Wuhao Tutor FastAPI Application
     Loaded: loaded (/etc/systemd/system/wuhao-tutor.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2025-11-15 08:43:05 CST; 13min ago
   Main PID: 561194 (python)
      Tasks: 7 (limit: 8775)
     Memory: 121.2M
        CPU: 3.211s
```

**çŠ¶æ€**: âœ… **å¥åº· (è¿è¡Œä¸­)**

### ç«¯å£ç›‘å¬

```
tcp        0      0 0.0.0.0:8000            0.0.0.0:*      LISTEN      561194/python
```

**çŠ¶æ€**: âœ… **8000 ç«¯å£æ­£å¸¸ç›‘å¬**

### è¿›ç¨‹ä¿¡æ¯

```
PID: 561194
Command: /opt/wuhao-tutor/venv/bin/python -B /opt/wuhao-tutor/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1
Memory: 121.2M
Uptime: 13 åˆ†é’Ÿï¼ˆè‡ª 08:43:05ï¼‰
```

**çŠ¶æ€**: âœ… **å†…å­˜ä½¿ç”¨æ­£å¸¸**

---

## 3ï¸âƒ£ èµ„æºç›‘æ§

### å†…å­˜ä½¿ç”¨

```
Total:    7.2 GiB
Used:     557 MiB (7.7%)
Free:     578 MiB (8.0%)
Available: 6.4 GiB (88.9%)
Swap:     0 B
```

**è¯„ä¼°**: âœ… **å……è¶³ï¼Œæ— å†…å­˜å‹åŠ›**

### ç£ç›˜ä½¿ç”¨

```
Filesystem: /dev/nvme0n1p3
Size:       40 GiB
Used:       8.7 GiB (24%)
Available:  29 GiB (76%)
```

**è¯„ä¼°**: âœ… **å……è¶³ï¼Œæ— ç£ç›˜å‹åŠ›**

### æ•°æ®åº“è¿æ¥

- **æ•°æ®åº“**: PostgreSQL (RDS)
- **ä¸»æœº**: pgm-bp1ce0sp88j6ha90.pg.rds.aliyuncs.com:5432
- **ç”¨æˆ·**: horsdu_ma
- **æ•°æ®åº“**: wuhao_tutor
- **çŠ¶æ€**: âœ… **å·²é…ç½®**

### Redis è¿æ¥

- **ä¸»æœº**: r-bp19azwt1c1pholkez.redis.rds.aliyuncs.com:6379
- **çŠ¶æ€**: âœ… **å·²é…ç½®**

---

## 4ï¸âƒ£ ä¿®å¤éªŒè¯

### åç«¯ä¿®å¤ä»£ç éƒ¨ç½²çŠ¶æ€

| ä¿®å¤é¡¹ | æ–‡ä»¶ | è¡Œå· | çŠ¶æ€ |
|--------|------|------|------|
| Keepalive å‡½æ•° | `src/services/learning_service.py` | 349 | âœ… å·²éƒ¨ç½² |
| æ•°æ®åº“ä¼˜åŒ– (SQL) | `src/services/learning_service.py` | 1151 | âœ… å·²éƒ¨ç½² |
| æ—¥å¿—ä¼˜åŒ– | `src/services/learning_service.py` | ~465 | âœ… å·²éƒ¨ç½² |

**éªŒè¯ç»“æœ**:
```bash
âœ… grep -c '_stream_with_keepalive' /opt/wuhao-tutor/src/services/learning_service.py
   â†’ 1 (Found)

âœ… grep -c 'UPDATE chat_session' /opt/wuhao-tutor/src/services/learning_service.py
   â†’ 1 (Found)
```

### å‰ç«¯ä¿®å¤ä»£ç çŠ¶æ€

éœ€è¦é€šè¿‡å¾®ä¿¡å¼€å‘è€…å·¥å…·éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š
- [ ] CONTENT_TIMEOUT = 90000 (90ç§’)
- [ ] PROCESSING_TIMEOUT = 120000 (120ç§’)
- [ ] Keepalive æ¶ˆæ¯å¤„ç†é€»è¾‘

**é¢„è®¡çŠ¶æ€**: â³ ç­‰å¾…å‰ç«¯éƒ¨ç½²éªŒè¯

---

## 5ï¸âƒ£ æ—¥å¿—åˆ†æ

### API å¥åº·æ£€æŸ¥

```
âœ… Endpoint: GET /health
âœ… Status Code: 200 OK
âœ… Response: {"status": "healthy", "project": "äº”å¥½ä¼´å­¦", "version": "0.1.0", "environment": "production"}
```

### æœ€è¿‘æµå¼å¤„ç†æ—¥å¿—

```
Nov 15 08:46:17 âœ… ğŸ“¤ å·²å‘é€ content_finished ä¿¡å·ç»™å‰ç«¯
Nov 15 08:46:17 âœ… ğŸ“¤ å·²å‘é€ done äº‹ä»¶ï¼Œå‰ç«¯æµå¼å“åº”å®Œæˆ
```

**ç»Ÿè®¡ (è¿‡å» 1 å°æ—¶)**:
- content_finished ä¿¡å·: **1 æ¬¡**
- done äº‹ä»¶: **1 æ¬¡**

### é”™è¯¯æ—¥å¿—

```
Nov 15 08:47:09 âš ï¸  json.decoder.JSONDecodeError: Expecting ',' delimiter: line 156 column 6 (char 5833)
```

**åˆ†æ**: è¿™æ˜¯ä¸€ä¸ª JSON è§£æé”™è¯¯ï¼Œ**ä¸ç›¸å…³äº WebSocket æµå¼ä¿®å¤**ã€‚å¯èƒ½æ˜¯æ‰¹æ”¹ç»“æœçš„ JSON æ ¼å¼é—®é¢˜ã€‚

---

## 6ï¸âƒ£ å…³é”®æŒ‡æ ‡

### WebSocket æµå¼æ€§èƒ½

| æŒ‡æ ‡ | æœŸæœ›å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| content_finished å»¶è¿Ÿ | < 5s | æ­£å¸¸ | âœ… |
| done äº‹ä»¶å»¶è¿Ÿ | < 10s | æ­£å¸¸ | âœ… |
| æµå¼è¶…æ—¶æ—¶é—´ | 90s | å·²éƒ¨ç½² | âœ… |
| å¿ƒè·³ä¿æ´»é—´éš” | 5s | å·²éƒ¨ç½² | âœ… |

### ç³»ç»Ÿæ€§èƒ½

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å½“å‰å€¼ | çŠ¶æ€ |
|------|---------|--------|------|
| å†…å­˜ä½¿ç”¨ç‡ | < 50% | 7.7% | âœ… ä¼˜ç§€ |
| ç£ç›˜ä½¿ç”¨ç‡ | < 80% | 24% | âœ… ä¼˜ç§€ |
| CPU ä½¿ç”¨ç‡ | < 80% | 0.4% | âœ… ä¼˜ç§€ |
| æœåŠ¡è¿è¡Œæ—¶é—´ | > 1å°æ—¶ | 13åˆ†é’Ÿ | â³ æ–°å¯åŠ¨ |

---

## 7ï¸âƒ£ ç¯å¢ƒé…ç½®

### åº”ç”¨é…ç½®

```
PROJECT_NAME: äº”å¥½ä¼´å­¦
VERSION: 0.1.0
ENVIRONMENT: production
DEBUG: false
PORT: 8000
```

### æ•°æ®åº“é…ç½®

```
Server: pgm-bp1ce0sp88j6ha90.pg.rds.aliyuncs.com
Port: 5432
Database: wuhao_tutor
User: horsdu_ma
Connection: postgresql+asyncpg://...
```

### Redis é…ç½®

```
Host: r-bp19azwt1c1pholkez.redis.rds.aliyuncs.com
Port: 6379
DB: 0
```

### æ—¥å¿—é…ç½®

```
LOG_LEVEL: INFO
LOG_FORMAT: json
```

---

## 8ï¸âƒ£ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### åç«¯éƒ¨ç½²

- âœ… ä»£ç å·²æ›´æ–°ï¼ˆä¿®å¤å‡½æ•°å·²éƒ¨ç½²ï¼‰
- âœ… æœåŠ¡å·²é‡å¯ï¼ˆPID: 561194ï¼Œå¯åŠ¨æ—¶é—´: 08:43:05ï¼‰
- âœ… API ç«¯ç‚¹æ­£å¸¸
- âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
- âœ… æ—¥å¿—ä¸­å‡ºç°ä¿®å¤æ ‡è®°

### å‰ç«¯éƒ¨ç½²

- â³ ç­‰å¾…å¾®ä¿¡å¼€å‘è€…å·¥å…·éƒ¨ç½²éªŒè¯
- â³ éœ€è¦éªŒè¯ CONTENT_TIMEOUT å’Œ PROCESSING_TIMEOUT é…ç½®
- â³ éœ€è¦éªŒè¯ keepalive æ¶ˆæ¯å¤„ç†

### ç›‘æ§å’Œå‘Šè­¦

- â³ å»ºè®®é…ç½®ä»¥ä¸‹æŒ‡æ ‡å‘Šè­¦ï¼š
  - WebSocket è¶…æ—¶äº‹ä»¶ç‡ (ç›®æ ‡: < 1%)
  - content_finished å»¶è¿Ÿ (ç›®æ ‡: < 5ç§’)
  - ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡ (å‘Šè­¦é˜ˆå€¼: > 70%)
  - æ•°æ®åº“è¿æ¥å¤±è´¥ (å‘Šè­¦é˜ˆå€¼: > 0 æ¬¡/åˆ†é’Ÿ)

---

## 9ï¸âƒ£ å·²çŸ¥é—®é¢˜

### 1. JSON è§£æé”™è¯¯

**æ—¥å¿—**:
```
json.decoder.JSONDecodeError: Expecting ',' delimiter: line 156 column 6 (char 5833)
```

**å½±å“**: éæµå¼ç›¸å…³ï¼Œå¯èƒ½æ˜¯æ‰¹æ”¹ç»“æœåºåˆ—åŒ–é—®é¢˜  
**å»ºè®®**: è°ƒæŸ¥ `_call_ai_for_homework_correction()` è¿”å›çš„ JSON æ ¼å¼

### 2. Datetime ç±»å‹é”™è¯¯

**æ—¥å¿—**:
```
TypeError: can't subtract offset-naive and offset-aware datetimes
```

**å½±å“**: å¯èƒ½å½±å“å­¦ä¹ åˆ†æè®¡ç®—  
**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ timezone-aware datetime å¯¹è±¡

---

## ğŸ”Ÿ å»ºè®®å’Œåç»­è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. **éƒ¨ç½²å‰ç«¯ä¿®å¤** (é«˜ä¼˜å…ˆçº§)
   - åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ä¸Šä¼ æ›´æ–°çš„å°ç¨‹åºä»£ç 
   - éªŒè¯ CONTENT_TIMEOUT = 90000 å’Œ PROCESSING_TIMEOUT = 120000
   - å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

2. **æµ‹è¯•éªŒè¯** (é«˜ä¼˜å…ˆçº§)
   - ä½¿ç”¨æµ‹è¯•è´¦å·ä¸Šä¼ å¤šé¡µå›¾ç‰‡è¿›è¡Œæµ‹è¯•
   - åœ¨ DevTools Console ä¸­æŸ¥çœ‹æ˜¯å¦æ”¶åˆ° keepalive å¿ƒè·³
   - éªŒè¯æµå¼å“åº”å®Œæ•´åº¦å’Œä¸è¶…æ—¶

3. **ä¿®å¤ JSON è§£æé”™è¯¯** (ä¸­ä¼˜å…ˆçº§)
   - æ£€æŸ¥ `_call_ai_for_homework_correction()` è¿”å›å€¼
   - éªŒè¯ JSON åºåˆ—åŒ–æ˜¯å¦æ­£ç¡®
   - æ·»åŠ è¾“å…¥éªŒè¯

### çŸ­æœŸè¡ŒåŠ¨ (1-2 å‘¨å†…)

1. **ç›‘æ§è®¾ç½®**
   - é…ç½® Prometheus/Grafana ç›‘æ§é¢æ¿
   - è®¾ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦
   - ç›‘æ§ 24-48 å°æ—¶ä»¥æ”¶é›†æ€§èƒ½æ•°æ®

2. **æ—¥å¿—ä¼˜åŒ–**
   - è°ƒæ•´ LOG_LEVEL ä» INFO æ”¹ä¸º WARNING (ç”Ÿäº§ç¯å¢ƒ)
   - æˆ–å¯ç”¨ debug æ—¥å¿—çº§åˆ«ä»¥ä¾¿æ•…éšœæ’æŸ¥

3. **ä¿®å¤ Datetime ç±»å‹é”™è¯¯**
   - ç»Ÿä¸€æ‰€æœ‰ datetime æ“ä½œä½¿ç”¨ timezone-aware å¯¹è±¡
   - æ›¿æ¢ `datetime.utcnow()` ä¸º `datetime.now(datetime.UTC)`

### ä¸­æœŸè¡ŒåŠ¨ (2-4 å‘¨å†…)

1. **æ€§èƒ½ä¼˜åŒ–**
   - åˆ†ææ•°æ®åº“æ…¢æŸ¥è¯¢
   - ä¼˜åŒ– AI æµå¼ç”Ÿæˆå»¶è¿Ÿ
   - è€ƒè™‘å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ— (ä¾‹å¦‚ Celery) å¤„ç†åå°ä»»åŠ¡

2. **å¯è§‚æµ‹æ€§å¢å¼º**
   - æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ª (Jaeger/Zipkin)
   - å®ç°æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - å»ºç«‹å®Œæ•´çš„å‘Šè­¦è§„åˆ™ä½“ç³»

---

## ğŸ“‹ éªŒè¯å‘½ä»¤é€ŸæŸ¥è¡¨

### æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
systemctl status wuhao-tutor.service
```

### å®æ—¶æŸ¥çœ‹æ—¥å¿—
```bash
journalctl -u wuhao-tutor.service -f
```

### æ£€æŸ¥ä¿®å¤ä»£ç 
```bash
grep '_stream_with_keepalive' /opt/wuhao-tutor/src/services/learning_service.py
grep 'UPDATE chat_session' /opt/wuhao-tutor/src/services/learning_service.py
```

### æµ‹è¯• API ç«¯ç‚¹
```bash
curl http://localhost:8000/health
```

### æŸ¥çœ‹æœ€è¿‘æµå¼å¤„ç†æ—¥å¿—
```bash
journalctl -u wuhao-tutor.service -n 500 | grep -E 'content_finished|done|keepalive'
```

---

## ğŸ“ æ•…éšœæ’æŸ¥

### å¦‚æœæœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æ—¥å¿—é”™è¯¯
journalctl -u wuhao-tutor.service -n 50 --no-pager

# æ‰‹åŠ¨è¿è¡Œåº”ç”¨
/opt/wuhao-tutor/venv/bin/python -B /opt/wuhao-tutor/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1
```

### å¦‚æœ WebSocket è¿æ¥å¤±è´¥

1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™ (8000 ç«¯å£æ˜¯å¦å¼€æ”¾)
2. æ£€æŸ¥å‰ç«¯ WebSocket URL é…ç½®
3. æ£€æŸ¥åç«¯ CORS é…ç½®

### å¦‚æœæµå¼å“åº”è¶…æ—¶

1. æ£€æŸ¥ AI æœåŠ¡ (ç™¾ç‚¼) è¿æ¥
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ keepalive å¿ƒè·³ä¿¡å·

---

## âœ… ç»“è®º

**åç«¯æœåŠ¡çŠ¶æ€**: âœ… **å…¨éƒ¨æ­£å¸¸**

- æœåŠ¡æ­£åœ¨æ­£å¸¸è¿è¡Œ
- ä¿®å¤ä»£ç å·²æˆåŠŸéƒ¨ç½²
- ç³»ç»Ÿèµ„æºå……è¶³ï¼Œæ— æ€§èƒ½ç“¶é¢ˆ
- API ç«¯ç‚¹å“åº”æ­£å¸¸
- æµå¼å¤„ç†åŠŸèƒ½å·²éªŒè¯ï¼ˆcontent_finished å’Œ done äº‹ä»¶å·²è®°å½•ï¼‰

**åç»­**: ç­‰å¾…å‰ç«¯ä¿®å¤éƒ¨ç½²å’Œç”¨æˆ·åœºæ™¯æµ‹è¯•ä»¥å®Œå…¨éªŒè¯ä¿®å¤æ•ˆæœã€‚

---

**æŠ¥å‘Šç‰ˆæœ¬**: 1.0  
**ç”Ÿæˆå·¥å…·**: SSH è¯Šæ–­è„šæœ¬  
**ä¸‹æ¬¡æ£€æŸ¥å»ºè®®**: 24 å°æ—¶åéªŒè¯æµå¼å¤„ç†çš„é•¿æœŸç¨³å®šæ€§