# é”™é¢˜çŸ¥è¯†å›¾è°±å¼€å‘è®¡åˆ’

> **é¡¹ç›®**: äº”å¥½ä¼´å­¦ K12 æ™ºèƒ½å­¦ä¹ å¹³å°  
> **æ¨¡å—**: é”™é¢˜çŸ¥è¯†å›¾è°±ä¸ä¸ªæ€§åŒ–å­¦æƒ…åˆ†æç³»ç»Ÿ  
> **ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¶é—´**: 2025-11-03  
> **é¢„è®¡å·¥æœŸ**: 3 å‘¨ (15 ä¸ªå·¥ä½œæ—¥)

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
- [äºŒã€æ ¸å¿ƒç›®æ ‡](#äºŒæ ¸å¿ƒç›®æ ‡)
- [ä¸‰ã€æŠ€æœ¯æ¶æ„](#ä¸‰æŠ€æœ¯æ¶æ„)
- [å››ã€æ•°æ®åº“è®¾è®¡](#å››æ•°æ®åº“è®¾è®¡)
- [äº”ã€åç«¯å¼€å‘è®¡åˆ’](#äº”åç«¯å¼€å‘è®¡åˆ’)
- [å…­ã€å°ç¨‹åºç«¯å¼€å‘è®¡åˆ’](#å…­å°ç¨‹åºç«¯å¼€å‘è®¡åˆ’)
- [ä¸ƒã€å®æ–½è·¯çº¿å›¾](#ä¸ƒå®æ–½è·¯çº¿å›¾)
- [å…«ã€æµ‹è¯•ä¸éªŒæ”¶](#å…«æµ‹è¯•ä¸éªŒæ”¶)
- [ä¹ã€é£é™©ç®¡ç†](#ä¹é£é™©ç®¡ç†)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 èƒŒæ™¯

ç°æœ‰é”™é¢˜æœ¬åŠŸèƒ½ä»…è®°å½•é”™é¢˜å’ŒçŸ¥è¯†ç‚¹åˆ—è¡¨,ç¼ºå°‘æ·±åº¦å…³è”åˆ†æã€‚å¤§æ¨¡å‹ AI æ¯æ¬¡åˆ†æç›¸äº’ç‹¬ç«‹,æ— æ³•åˆ©ç”¨ç”¨æˆ·å†å²å­¦æƒ…æä¾›ä¸ªæ€§åŒ–è¾…å¯¼ã€‚æœ¬é¡¹ç›®æ—¨åœ¨æ„å»º**ç”¨æˆ·çº§çŸ¥è¯†å›¾è°±**,å®ç° AI å­¦æƒ…æ„ŸçŸ¥å’Œæ™ºèƒ½å¤ä¹ æ¨èã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- âœ… **AI å­¦æƒ…æ„ŸçŸ¥**: å¤§æ¨¡å‹äº†è§£æ¯ä¸ªå­¦ç”Ÿçš„çŸ¥è¯†æŒæ¡çŠ¶æ€
- âœ… **çŸ¥è¯†ç‚¹ç²¾å‡†å…³è”**: ä» JSON åˆ—è¡¨å‡çº§ä¸ºç»“æ„åŒ–å…³ç³»ç½‘ç»œ
- âœ… **è–„å¼±é“¾è¯Šæ–­**: è‡ªåŠ¨è¯†åˆ«çŸ¥è¯†é“¾ä¸­çš„è–„å¼±ç¯èŠ‚
- âœ… **æ™ºèƒ½å¤ä¹ æ¨è**: åŸºäºå›¾è°±çš„ä¸ªæ€§åŒ–å¤ä¹ è·¯å¾„

### 1.3 è®¾è®¡åŸåˆ™

- **é›¶ UI å¤§æ”¹**: åœ¨ç°æœ‰å°ç¨‹åºé¡µé¢æ¡†æ¶å†…å¢å¼ºåŠŸèƒ½
- **æ¸è¿›å¼å®æ–½**: åˆ†é˜¶æ®µè¿­ä»£,æ¯å‘¨äº¤ä»˜å¯ç”¨åŠŸèƒ½
- **æ•°æ®é©±åŠ¨**: åç«¯æä¾›çŸ¥è¯†å›¾è°±,å‰ç«¯è½»é‡å±•ç¤º
- **å‘ä¸‹å…¼å®¹**: ä¸ç ´åç°æœ‰åŠŸèƒ½,å¹³æ»‘å‡çº§

---

## äºŒã€æ ¸å¿ƒç›®æ ‡

### 2.1 åŠŸèƒ½ç›®æ ‡

| ç›®æ ‡           | æè¿°                                        | ä¼˜å…ˆçº§ |
| -------------- | ------------------------------------------- | ------ |
| çŸ¥è¯†ç‚¹ç²¾å‡†å…³è” | é”™é¢˜ä¸çŸ¥è¯†ç‚¹å¤šå¯¹å¤šå…³è”,è®°å½•ç›¸å…³æ€§å’Œé”™è¯¯ç±»å‹ | P0     |
| AI å­¦æƒ…ä¸Šä¸‹æ–‡  | AI åˆ†ææ—¶æ³¨å…¥ç”¨æˆ·çŸ¥è¯†å›¾è°±å¿«ç…§               | P0     |
| çŸ¥è¯†å›¾è°±æ„å»º   | æ„å»ºç”¨æˆ·çº§çŸ¥è¯†ç½‘ç»œ,è®¡ç®—æŒæ¡åº¦               | P1     |
| è–„å¼±é“¾è¯†åˆ«     | åˆ†æçŸ¥è¯†ç‚¹å‰ç½®å…³ç³»,æ‰¾å‡ºè–„å¼±é“¾               | P1     |
| æ™ºèƒ½å¤ä¹ æ¨è   | åŸºäºå›¾è°±çš„ä¼˜å…ˆçº§ç®—æ³•æ¨èå¤ä¹ é¡ºåº            | P1     |
| å°ç¨‹åºç«¯æ•´åˆ   | åœ¨é”™é¢˜æœ¬å’Œå­¦ä¹ æŠ¥å‘Šé¡µé¢å±•ç¤ºå›¾è°±æ•°æ®          | P1     |

### 2.2 æŠ€æœ¯ç›®æ ‡

- æ•°æ®åº“è¿ç§»é›¶åœæœº
- API å“åº”æ—¶é—´ < 500ms (P95)
- çŸ¥è¯†å›¾è°±å¿«ç…§æ¯æ—¥è‡ªåŠ¨æ›´æ–°
- æ”¯æŒ 5000+çŸ¥è¯†ç‚¹è§„æ¨¡

### 2.3 éåŠŸèƒ½ç›®æ ‡

- ä»£ç è¦†ç›–ç‡ > 80%
- API æ–‡æ¡£å®Œæ•´æ›´æ–°
- ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„

### 3.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®ä¿¡å°ç¨‹åºç«¯    â”‚
â”‚ - é”™é¢˜æœ¬æ¨¡å—     â”‚
â”‚ - å­¦ä¹ æŠ¥å‘Šæ¨¡å—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPS/JWT
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway   â”‚
â”‚  (FastAPI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service â”‚ â”‚ Knowledge    â”‚
â”‚ Layer   â”‚ â”‚ Graph Serviceâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚
     â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Repository Layer      â”‚
â”‚ - MistakeRepository     â”‚
â”‚ - KnowledgeRepository   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database Layer        â”‚
â”‚ - PostgreSQL (ç”Ÿäº§)     â”‚
â”‚ - SQLite (å¼€å‘)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI Service            â”‚
â”‚ - é˜¿é‡Œäº‘ç™¾ç‚¼             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµ

```
é”™é¢˜æäº¤ â†’ AIåˆ†æ(å¸¦å­¦æƒ…ä¸Šä¸‹æ–‡) â†’ çŸ¥è¯†ç‚¹æå– â†’ å…³è”è¡¨å†™å…¥
    â†“
çŸ¥è¯†å›¾è°±æ›´æ–° â†’ æŒæ¡åº¦è®¡ç®— â†’ è–„å¼±é“¾åˆ†æ â†’ å­¦æƒ…å¿«ç…§ç”Ÿæˆ
    â†“
å°ç¨‹åºè¯·æ±‚ â†’ APIè¿”å› â†’ é¡µé¢æ¸²æŸ“
```

### 3.3 æŠ€æœ¯æ ˆ

**åç«¯**:

- FastAPI 0.104+
- SQLAlchemy 2.x (Async ORM)
- Pydantic v2
- Python 3.11+

**å‰ç«¯**:

- å¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ¡†æ¶
- Vant Weapp UI ç»„ä»¶åº“

**æ•°æ®åº“**:

- PostgreSQL 14+ (ç”Ÿäº§)
- SQLite (å¼€å‘)

**AI æœåŠ¡**:

- é˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“
- é€šä¹‰åƒé—®æ¨¡å‹

---

## å››ã€æ•°æ®åº“è®¾è®¡

### 4.1 æ–°å¢è¡¨ç»“æ„

#### 4.1.1 é”™é¢˜-çŸ¥è¯†ç‚¹å…³è”è¡¨

```sql
-- mistake_knowledge_points (é”™é¢˜çŸ¥è¯†ç‚¹å…³è”è¡¨)
CREATE TABLE mistake_knowledge_points (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mistake_id UUID NOT NULL REFERENCES mistake_records(id) ON DELETE CASCADE,
    knowledge_point_id UUID NOT NULL REFERENCES knowledge_nodes(id) ON DELETE CASCADE,

    -- å…³è”å¼ºåº¦
    relevance_score NUMERIC(3,2) NOT NULL DEFAULT 0.5,  -- 0.0-1.0
    is_primary BOOLEAN NOT NULL DEFAULT false,

    -- é”™è¯¯åˆ†æ
    error_type VARCHAR(50) NOT NULL,  -- concept/calculation/application/comprehension
    error_reason TEXT,

    -- æŒæ¡åº¦è¿½è¸ª
    mastery_before NUMERIC(3,2),
    mastery_after NUMERIC(3,2),

    -- æ”¹è¿›å»ºè®®
    improvement_notes TEXT,

    -- å…ƒæ•°æ®
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE(mistake_id, knowledge_point_id)
);

CREATE INDEX idx_mkp_mistake ON mistake_knowledge_points(mistake_id);
CREATE INDEX idx_mkp_knowledge_point ON mistake_knowledge_points(knowledge_point_id);
CREATE INDEX idx_mkp_primary ON mistake_knowledge_points(is_primary) WHERE is_primary = true;
```

#### 4.1.2 ç”¨æˆ·çŸ¥è¯†å›¾è°±å¿«ç…§è¡¨

```sql
-- user_knowledge_graph_snapshots (ç”¨æˆ·çŸ¥è¯†å›¾è°±å¿«ç…§)
CREATE TABLE user_knowledge_graph_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    subject VARCHAR(20) NOT NULL,
    snapshot_date TIMESTAMP WITH TIME ZONE NOT NULL,

    -- å›¾è°±æ•°æ®
    knowledge_points JSON NOT NULL,  -- [{id, name, mastery, mistake_count, ...}]
    weak_chains JSON,                -- [{chain, avg_mastery, bottleneck, ...}]
    strong_areas JSON,               -- [{name, mastery, ...}]

    -- å­¦æƒ…æ‘˜è¦
    learning_profile TEXT,           -- AIç”Ÿæˆçš„å­¦æƒ…ç”»åƒ
    ai_recommendations TEXT,         -- AIå»ºè®®

    -- ç»Ÿè®¡æŒ‡æ ‡
    total_mistakes INTEGER DEFAULT 0,
    average_mastery NUMERIC(3,2) DEFAULT 0.0,
    improvement_trend VARCHAR(20),   -- up/stable/down

    -- å…ƒæ•°æ®
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE(user_id, subject, snapshot_date)
);

CREATE INDEX idx_ukgs_user_subject ON user_knowledge_graph_snapshots(user_id, subject);
CREATE INDEX idx_ukgs_date ON user_knowledge_graph_snapshots(snapshot_date DESC);
```

#### 4.1.3 çŸ¥è¯†ç‚¹å­¦ä¹ è½¨è¿¹è¡¨

```sql
-- knowledge_point_learning_tracks (çŸ¥è¯†ç‚¹å­¦ä¹ è½¨è¿¹)
CREATE TABLE knowledge_point_learning_tracks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    knowledge_point_id UUID NOT NULL REFERENCES knowledge_nodes(id) ON DELETE CASCADE,

    -- è½¨è¿¹æ•°æ®
    learning_events JSON,            -- [{date, event_type, mastery_change, trigger, ...}]
    mastery_curve JSON,              -- [{date, mastery_level}]

    -- å…³é”®èŠ‚ç‚¹
    first_learned_at TIMESTAMP WITH TIME ZONE,
    first_mastered_at TIMESTAMP WITH TIME ZONE,
    last_forgotten_at TIMESTAMP WITH TIME ZONE,

    -- ç»Ÿè®¡
    total_attempts INTEGER DEFAULT 0,
    total_mistakes INTEGER DEFAULT 0,
    review_efficiency NUMERIC(3,2) DEFAULT 0.0,

    -- å…ƒæ•°æ®
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE(user_id, knowledge_point_id)
);

CREATE INDEX idx_kplt_user ON knowledge_point_learning_tracks(user_id);
CREATE INDEX idx_kplt_kp ON knowledge_point_learning_tracks(knowledge_point_id);
```

### 4.2 ç°æœ‰è¡¨å­—æ®µæ‰©å±•

#### 4.2.1 mistake_records è¡¨

```sql
-- æ–°å¢å­—æ®µ
ALTER TABLE mistake_records ADD COLUMN IF NOT EXISTS
    knowledge_graph_snapshot JSON;  -- è®°å½•åˆ›å»ºæ—¶çš„çŸ¥è¯†å›¾è°±çŠ¶æ€å¿«ç…§
```

#### 4.2.2 knowledge_mastery è¡¨

```sql
-- æ–°å¢å­—æ®µ
ALTER TABLE knowledge_mastery ADD COLUMN IF NOT EXISTS
    related_mistakes JSON;  -- å…³è”çš„é”™é¢˜IDåˆ—è¡¨
```

### 4.3 æ•°æ®è¿ç§»ç­–ç•¥

**è¿ç§»è„šæœ¬**: `alembic/versions/20251103_add_knowledge_graph_tables.py`

**æ­¥éª¤**:

1. åˆ›å»ºæ–°è¡¨ (mistake_knowledge_points, user_knowledge_graph_snapshots, knowledge_point_learning_tracks)
2. è¿ç§»ç°æœ‰æ•°æ®: ä» mistake_records.knowledge_points (JSON) æå–çŸ¥è¯†ç‚¹
3. åˆ›å»ºåˆå§‹å…³è”å…³ç³»
4. ç”Ÿæˆé¦–ä¸ªçŸ¥è¯†å›¾è°±å¿«ç…§
5. éªŒè¯æ•°æ®å®Œæ•´æ€§

**å›æ»šæ–¹æ¡ˆ**:

- ä¿ç•™ mistake_records.knowledge_points å­—æ®µ,ä½œä¸ºé™çº§å¤‡ä»½
- æ–°è¡¨åˆ é™¤ä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## äº”ã€åç«¯å¼€å‘è®¡åˆ’

### 5.1 æ•°æ®æ¨¡å‹å±‚ (Model Layer)

#### 5.1.1 æ–°å¢æ¨¡å‹æ–‡ä»¶

**æ–‡ä»¶**: `src/models/knowledge_graph.py`

```python
"""çŸ¥è¯†å›¾è°±ç›¸å…³æ¨¡å‹"""
from sqlalchemy import Column, ForeignKey, Integer, Numeric, String, Text, JSON, Boolean
from sqlalchemy.dialects.postgresql import UUID
from .base import BaseModel

class MistakeKnowledgePoint(BaseModel):
    """é”™é¢˜-çŸ¥è¯†ç‚¹å…³è”æ¨¡å‹"""
    __tablename__ = "mistake_knowledge_points"
    # ... (è¯¦è§æ•°æ®åº“è®¾è®¡)

class UserKnowledgeGraphSnapshot(BaseModel):
    """ç”¨æˆ·çŸ¥è¯†å›¾è°±å¿«ç…§"""
    __tablename__ = "user_knowledge_graph_snapshots"
    # ...

class KnowledgePointLearningTrack(BaseModel):
    """çŸ¥è¯†ç‚¹å­¦ä¹ è½¨è¿¹"""
    __tablename__ = "knowledge_point_learning_tracks"
    # ...
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/models/knowledge_graph.py`
- [ ] å®šä¹‰ 3 ä¸ªæ–°æ¨¡å‹ç±»
- [ ] åœ¨ `src/models/__init__.py` ä¸­å¯¼å‡º
- [ ] ç¼–å†™æ¨¡å‹å•å…ƒæµ‹è¯•

### 5.2 Repository å±‚

#### 5.2.1 æ–°å¢ Repository

**æ–‡ä»¶**: `src/repositories/knowledge_graph_repository.py`

```python
"""çŸ¥è¯†å›¾è°±æ•°æ®è®¿é—®å±‚"""
from typing import List, Dict, Optional
from uuid import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from .base import BaseRepository
from src.models.knowledge_graph import (
    MistakeKnowledgePoint,
    UserKnowledgeGraphSnapshot,
    KnowledgePointLearningTrack
)

class MistakeKnowledgePointRepository(BaseRepository[MistakeKnowledgePoint]):
    """é”™é¢˜-çŸ¥è¯†ç‚¹å…³è” Repository"""

    async def find_by_mistake(self, mistake_id: UUID) -> List[MistakeKnowledgePoint]:
        """æŸ¥è¯¢é”™é¢˜çš„çŸ¥è¯†ç‚¹å…³è”"""
        pass

    async def find_by_knowledge_point(self, kp_id: UUID) -> List[MistakeKnowledgePoint]:
        """æŸ¥è¯¢çŸ¥è¯†ç‚¹å…³è”çš„é”™é¢˜"""
        pass

    async def batch_create(self, associations: List[Dict]) -> List[MistakeKnowledgePoint]:
        """æ‰¹é‡åˆ›å»ºå…³è”"""
        pass

class UserKnowledgeGraphSnapshotRepository(BaseRepository[UserKnowledgeGraphSnapshot]):
    """çŸ¥è¯†å›¾è°±å¿«ç…§ Repository"""

    async def get_latest(self, user_id: UUID, subject: str) -> Optional[UserKnowledgeGraphSnapshot]:
        """è·å–æœ€æ–°å¿«ç…§"""
        pass

    async def create_snapshot(self, snapshot_data: Dict) -> UserKnowledgeGraphSnapshot:
        """åˆ›å»ºå¿«ç…§"""
        pass

class KnowledgePointLearningTrackRepository(BaseRepository[KnowledgePointLearningTrack]):
    """å­¦ä¹ è½¨è¿¹ Repository"""

    async def get_or_create(self, user_id: UUID, kp_id: UUID) -> KnowledgePointLearningTrack:
        """è·å–æˆ–åˆ›å»ºè½¨è¿¹"""
        pass

    async def append_event(self, track_id: UUID, event: Dict):
        """è¿½åŠ å­¦ä¹ äº‹ä»¶"""
        pass
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/repositories/knowledge_graph_repository.py`
- [ ] å®ç° 3 ä¸ª Repository ç±»åŠæ ¸å¿ƒæ–¹æ³•
- [ ] ç¼–å†™ Repository å•å…ƒæµ‹è¯•

#### 5.2.2 æ‰©å±•ç°æœ‰ Repository

**æ–‡ä»¶**: `src/repositories/mistake_repository.py`

**æ–°å¢æ–¹æ³•**:

```python
async def get_knowledge_point_list(
    self, user_id: UUID, subject: Optional[str] = None
) -> Dict[str, int]:
    """è·å–ç”¨æˆ·çš„çŸ¥è¯†ç‚¹åˆ—è¡¨åŠé”™é¢˜æ•°é‡"""
    pass

async def get_by_knowledge_point(
    self, user_id: UUID, knowledge_point: str, page: int = 1, page_size: int = 20
) -> Tuple[List[MistakeRecord], int]:
    """æŒ‰çŸ¥è¯†ç‚¹ç­›é€‰é”™é¢˜"""
    pass
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åœ¨ `mistake_repository.py` æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰æ–¹æ³•
- [ ] æ›´æ–°ç›¸å…³æµ‹è¯•ç”¨ä¾‹

### 5.3 Service å±‚

#### 5.3.1 æ–°å¢ KnowledgeGraphService

**æ–‡ä»¶**: `src/services/knowledge_graph_service.py`

```python
"""çŸ¥è¯†å›¾è°±æœåŠ¡"""
from typing import List, Dict, Optional
from uuid import UUID
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import AsyncSession

class KnowledgeGraphService:
    """çŸ¥è¯†å›¾è°±ç®¡ç†æœåŠ¡"""

    def __init__(self, db: AsyncSession):
        self.db = db
        self.mkp_repo = MistakeKnowledgePointRepository(...)
        self.snapshot_repo = UserKnowledgeGraphSnapshotRepository(...)
        self.track_repo = KnowledgePointLearningTrackRepository(...)

    async def build_user_knowledge_graph(
        self, user_id: UUID, subject: str
    ) -> Dict:
        """æ„å»ºç”¨æˆ·çŸ¥è¯†å›¾è°±

        Returns:
            {
                "knowledge_points": [...],
                "weak_chains": [...],
                "strong_areas": [...],
                "total_points": int,
                "mastered_points": int
            }
        """
        # 1. è·å–ç”¨æˆ·æ‰€æœ‰é”™é¢˜çš„çŸ¥è¯†ç‚¹
        # 2. è®¡ç®—æ¯ä¸ªçŸ¥è¯†ç‚¹çš„æŒæ¡åº¦
        # 3. åˆ†æçŸ¥è¯†ç‚¹å…³ç³»
        # 4. è¯†åˆ«è–„å¼±é“¾
        # 5. è¯†åˆ«ä¼˜åŠ¿é¢†åŸŸ
        pass

    async def analyze_weak_chains(
        self, user_id: UUID, knowledge_points: List[Dict]
    ) -> List[Dict]:
        """åˆ†æè–„å¼±çŸ¥è¯†é“¾

        ç®—æ³•:
        1. ä»knowledge_nodesè·å–çŸ¥è¯†ç‚¹çš„å‰ç½®å…³ç³»
        2. DFSéå†çŸ¥è¯†ç‚¹ç½‘ç»œ
        3. æ‰¾å‡ºå¹³å‡æŒæ¡åº¦<0.5çš„é“¾è·¯
        4. è¯†åˆ«é“¾è·¯ä¸­çš„ç“¶é¢ˆèŠ‚ç‚¹
        """
        pass

    async def generate_learning_profile(
        self, user_id: UUID, days: int = 30
    ) -> str:
        """ç”Ÿæˆå­¦æƒ…ç”»åƒ

        ç»“åˆ:
        - çŸ¥è¯†ç‚¹æŒæ¡åº¦åˆ†å¸ƒ
        - é”™é¢˜æ•°é‡å’Œéš¾åº¦
        - å­¦ä¹ æ—¶é•¿å’Œé¢‘ç‡
        - å¤ä¹ æ•ˆæœ

        ä½¿ç”¨AIæ¶¦è‰²ç”Ÿæˆè‡ªç„¶è¯­è¨€æè¿°
        """
        pass

    async def create_snapshot(
        self, user_id: UUID, subject: str
    ) -> UserKnowledgeGraphSnapshot:
        """åˆ›å»ºçŸ¥è¯†å›¾è°±å¿«ç…§"""
        graph = await self.build_user_knowledge_graph(user_id, subject)
        profile = await self.generate_learning_profile(user_id)

        snapshot_data = {
            "user_id": user_id,
            "subject": subject,
            "snapshot_date": datetime.now(),
            "knowledge_points": graph["knowledge_points"],
            "weak_chains": graph["weak_chains"],
            "strong_areas": graph["strong_areas"],
            "learning_profile": profile,
            # ...
        }

        return await self.snapshot_repo.create_snapshot(snapshot_data)

    async def recommend_review_path(
        self, user_id: UUID, subject: str
    ) -> List[Dict]:
        """æ¨èå¤ä¹ è·¯å¾„

        ä¼˜å…ˆçº§ç®—æ³•:
        priority = (
            (1 - mastery_level) * 0.4 +      # æŒæ¡åº¦ä½çš„ä¼˜å…ˆ
            prerequisite_weight * 0.3 +      # å‰ç½®çŸ¥è¯†ç‚¹ä¼˜å…ˆ
            forgetting_risk * 0.2 +          # é—å¿˜é£é™©é«˜çš„ä¼˜å…ˆ
            related_chain_weak * 0.1         # å…³è”é“¾è–„å¼±çš„ä¼˜å…ˆ
        )
        """
        pass
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/services/knowledge_graph_service.py`
- [ ] å®ç°æ ¸å¿ƒæ–¹æ³•
- [ ] ç¼–å†™ Service å•å…ƒæµ‹è¯•

#### 5.3.2 å¢å¼º MistakeService

**æ–‡ä»¶**: `src/services/mistake_service.py`

**ä¿®æ”¹æ–¹æ³•**:

```python
async def analyze_mistake_with_ai(
    self, mistake_id: UUID, user_id: UUID
) -> Dict:
    """å¢å¼ºAIåˆ†æ - åŠ å…¥å­¦æƒ…ä¸Šä¸‹æ–‡"""

    # 1. è·å–ç”¨æˆ·æœ€æ–°çŸ¥è¯†å›¾è°±å¿«ç…§
    snapshot = await knowledge_graph_service.snapshot_repo.get_latest(
        user_id, mistake.subject
    )

    # 2. æ„é€ ä¸Šä¸‹æ–‡æç¤ºè¯
    context_prompt = f"""
ã€å­¦ç”Ÿå­¦æƒ…ç”»åƒã€‘
{snapshot.learning_profile if snapshot else 'æš‚æ— å†å²å­¦æƒ…'}

ã€å½“å‰çŸ¥è¯†å›¾è°±çŠ¶æ€ã€‘
è–„å¼±çŸ¥è¯†é“¾: {snapshot.weak_chains if snapshot else []}
ä¼˜åŠ¿é¢†åŸŸ: {snapshot.strong_areas if snapshot else []}
æ•´ä½“æŒæ¡åº¦: {snapshot.average_mastery if snapshot else 0}

ã€æœ¬æ¬¡é”™é¢˜åˆ†æä»»åŠ¡ã€‘
è¯·æ ¹æ®å­¦ç”Ÿå½“å‰å­¦æƒ…,åˆ†æä»¥ä¸‹é”™é¢˜,æå–çŸ¥è¯†ç‚¹å¹¶ç»™å‡ºå»ºè®®...
"""

    # 3. è°ƒç”¨ç™¾ç‚¼AI (å¸¦ä¸Šä¸‹æ–‡)
    messages = [
        {"role": "system", "content": context_prompt},
        {"role": "user", "content": analysis_prompt}
    ]

    response = await self.bailian_service.chat_completion(messages, ...)

    # 4. è§£æAIè¿”å›çš„çŸ¥è¯†ç‚¹
    analysis_result = self._parse_ai_response(response)

    # 5. åˆ›å»ºçŸ¥è¯†ç‚¹å…³è”è®°å½•
    await self._create_knowledge_associations(
        mistake_id, analysis_result["knowledge_points"]
    )

    # 6. æ›´æ–°çŸ¥è¯†ç‚¹æŒæ¡åº¦
    await self._update_mastery_levels(user_id, ...)

    # 7. è§¦å‘å¿«ç…§æ›´æ–° (å¼‚æ­¥ä»»åŠ¡)
    asyncio.create_task(
        knowledge_graph_service.create_snapshot(user_id, mistake.subject)
    )

    return analysis_result

async def _create_knowledge_associations(
    self, mistake_id: UUID, knowledge_points: List[Dict]
):
    """åˆ›å»ºçŸ¥è¯†ç‚¹å…³è”"""
    associations = []
    for kp in knowledge_points:
        # æŸ¥æ‰¾æˆ–åˆ›å»ºKnowledgeNode
        kp_node = await self._get_or_create_knowledge_node(kp["name"])

        associations.append({
            "mistake_id": mistake_id,
            "knowledge_point_id": kp_node.id,
            "relevance_score": kp["relevance_score"],
            "is_primary": kp["is_primary"],
            "error_type": kp["error_type"],
            "error_reason": kp["error_reason"]
        })

    await mkp_repo.batch_create(associations)
```

**ä»»åŠ¡æ¸…å•**:

- [ ] ä¿®æ”¹ `analyze_mistake_with_ai` æ–¹æ³•
- [ ] æ·»åŠ  `_create_knowledge_associations` æ–¹æ³•
- [ ] æ·»åŠ  `_update_mastery_levels` æ–¹æ³•
- [ ] æ›´æ–°ç›¸å…³æµ‹è¯•ç”¨ä¾‹

### 5.4 API å±‚

#### 5.4.1 æ–°å¢ API ç«¯ç‚¹

**æ–‡ä»¶**: `src/api/v1/endpoints/knowledge_graph.py`

```python
"""çŸ¥è¯†å›¾è°±APIç«¯ç‚¹"""
from fastapi import APIRouter, Depends
from uuid import UUID
from src.api.v1.endpoints.auth import get_current_user_id
from src.services.knowledge_graph_service import KnowledgeGraphService

router = APIRouter(prefix="/knowledge-graph", tags=["knowledge-graph"])

@router.get("/", response_model=KnowledgeGraphResponse)
async def get_knowledge_graph(
    subject: str,
    days: int = 30,
    user_id: UUID = Depends(get_current_user_id),
    db: AsyncSession = Depends(get_db)
):
    """è·å–ç”¨æˆ·çŸ¥è¯†å›¾è°±"""
    service = KnowledgeGraphService(db)
    return await service.build_user_knowledge_graph(user_id, subject)

@router.get("/learning-profile", response_model=LearningProfileResponse)
async def get_learning_profile(
    days: int = 30,
    user_id: UUID = Depends(get_current_user_id),
    db: AsyncSession = Depends(get_db)
):
    """è·å–å­¦æƒ…ç”»åƒ"""
    service = KnowledgeGraphService(db)
    profile = await service.generate_learning_profile(user_id, days)
    return {"learning_profile": profile, ...}
```

**æ–‡ä»¶**: `src/api/v1/endpoints/mistakes.py` (æ‰©å±•)

```python
@router.get("/knowledge-points", response_model=KnowledgePointListResponse)
async def get_knowledge_point_list(
    subject: Optional[str] = None,
    user_id: UUID = Depends(get_current_user_id),
    db: AsyncSession = Depends(get_db)
):
    """è·å–çŸ¥è¯†ç‚¹åˆ—è¡¨(ç”¨äºç­›é€‰)"""
    service = MistakeService(db)
    return await service.get_knowledge_point_list(user_id, subject)

@router.get("/{mistake_id}/knowledge-analysis", response_model=KnowledgeAnalysisResponse)
async def get_knowledge_analysis(
    mistake_id: UUID,
    user_id: UUID = Depends(get_current_user_id),
    db: AsyncSession = Depends(get_db)
):
    """è·å–é”™é¢˜çš„çŸ¥è¯†ç‚¹åˆ†æ"""
    # è¿”å›ä¸»è¦çŸ¥è¯†ç‚¹ã€å…³è”çŸ¥è¯†ç‚¹ã€æŒæ¡åº¦ã€è–„å¼±é“¾æç¤º
    pass
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/api/v1/endpoints/knowledge_graph.py`
- [ ] åœ¨ `mistakes.py` æ·»åŠ çŸ¥è¯†ç‚¹ç›¸å…³ç«¯ç‚¹
- [ ] å®šä¹‰å¯¹åº”çš„ Pydantic Schema
- [ ] ç¼–å†™ API é›†æˆæµ‹è¯•

#### 5.4.2 Schema å®šä¹‰

**æ–‡ä»¶**: `src/schemas/knowledge_graph.py`

```python
"""çŸ¥è¯†å›¾è°±Schema"""
from pydantic import BaseModel, Field
from typing import List, Optional
from uuid import UUID

class KnowledgePointItem(BaseModel):
    """çŸ¥è¯†ç‚¹é¡¹"""
    id: UUID
    name: str
    mastery: float = Field(ge=0, le=1)
    mistake_count: int
    last_reviewed: Optional[str] = None

class WeakChainItem(BaseModel):
    """è–„å¼±çŸ¥è¯†é“¾"""
    id: str
    chain_name: str
    path: str
    avg_mastery: float
    bottleneck: str

class KnowledgeGraphResponse(BaseModel):
    """çŸ¥è¯†å›¾è°±å“åº”"""
    subjects: List[str]
    total_points: int
    mastered_points: int
    knowledge_points: List[KnowledgePointItem]
    weak_chains: List[WeakChainItem]
    strong_areas: List[dict]

class KnowledgeAnalysisResponse(BaseModel):
    """çŸ¥è¯†ç‚¹åˆ†æå“åº”"""
    primary_point: str
    related_points: List[dict]
    mastery_status: dict
    weak_chain: Optional[dict] = None

class LearningProfileResponse(BaseModel):
    """å­¦æƒ…ç”»åƒå“åº”"""
    learning_profile: str
    ai_recommendations: Optional[str] = None
    next_review_tasks: List[dict] = []
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/schemas/knowledge_graph.py`
- [ ] å®šä¹‰æ‰€æœ‰å“åº” Schema

### 5.5 å®šæ—¶ä»»åŠ¡

#### 5.5.1 çŸ¥è¯†å›¾è°±å¿«ç…§ç”Ÿæˆä»»åŠ¡

**æ–‡ä»¶**: `src/tasks/knowledge_graph_tasks.py`

```python
"""çŸ¥è¯†å›¾è°±å®šæ—¶ä»»åŠ¡"""
from celery import shared_task
from sqlalchemy import select
from src.core.database import get_db
from src.models.user import User
from src.services.knowledge_graph_service import KnowledgeGraphService

@shared_task
async def generate_daily_snapshots():
    """æ¯æ—¥ç”Ÿæˆæ‰€æœ‰ç”¨æˆ·çš„çŸ¥è¯†å›¾è°±å¿«ç…§"""
    async with get_db() as db:
        service = KnowledgeGraphService(db)

        # è·å–æœ‰é”™é¢˜è®°å½•çš„ç”¨æˆ·
        users = await db.execute(
            select(User.id).join(MistakeRecord).distinct()
        )

        for user_id in users.scalars():
            subjects = ["math", "chinese", "english", ...]
            for subject in subjects:
                await service.create_snapshot(user_id, subject)

# é…ç½®: æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
# CELERY_BEAT_SCHEDULE = {
#     'generate-daily-snapshots': {
#         'task': 'src.tasks.knowledge_graph_tasks.generate_daily_snapshots',
#         'schedule': crontab(hour=3, minute=0),
#     },
# }
```

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º `src/tasks/knowledge_graph_tasks.py`
- [ ] é…ç½® Celery å®šæ—¶ä»»åŠ¡
- [ ] æµ‹è¯•ä»»åŠ¡æ‰§è¡Œ

---

## å…­ã€å°ç¨‹åºç«¯å¼€å‘è®¡åˆ’

### 6.1 é”™é¢˜åˆ—è¡¨é¡µå¢å¼º

**æ–‡ä»¶**: `miniprogram/pages/mistakes/list/index.js`

**æ–°å¢æ•°æ®**:

```javascript
data: {
  // ... ç°æœ‰æ•°æ®
  selectedKnowledgePoint: '',
  knowledgePointOptions: [],
  knowledgePointStats: {}
}
```

**æ–°å¢æ–¹æ³•**:

```javascript
async loadKnowledgePointOptions() {
  const response = await mistakesApi.getKnowledgePointList({
    subject: this.data.selectedSubject
  });
  this.setData({
    knowledgePointOptions: response.knowledge_points,
    knowledgePointStats: response.stats
  });
}

onKnowledgePointSelect(e) {
  const { kp } = e.currentTarget.dataset;
  this.setData({ selectedKnowledgePoint: kp });
}
```

**WXML ä¿®æ”¹**: åœ¨ç­›é€‰å¼¹çª—ä¸­æ·»åŠ çŸ¥è¯†ç‚¹é€‰é¡¹

**WXSS æ ·å¼**: æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰æ ·å¼

**ä»»åŠ¡æ¸…å•**:

- [ ] ä¿®æ”¹ `index.js` æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰é€»è¾‘
- [ ] ä¿®æ”¹ `index.wxml` æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰ UI
- [ ] ä¿®æ”¹ `index.wxss` æ·»åŠ æ ·å¼
- [ ] æ›´æ–° `api/mistakes.js` æ·»åŠ  `getKnowledgePointList` æ–¹æ³•

### 6.2 é”™é¢˜å¡ç‰‡ç»„ä»¶å¢å¼º

**æ–‡ä»¶**: `miniprogram/components/mistake-card/index.wxml`

**æ–°å¢ UI**: æ˜¾ç¤ºçŸ¥è¯†ç‚¹æ ‡ç­¾

```xml
<view class="knowledge-points" wx:if="{{mistake.knowledge_points && mistake.knowledge_points.length}}">
  <view class="kp-tag primary" wx:if="{{mistake.primary_knowledge_point}}">
    {{mistake.primary_knowledge_point}}
  </view>
  <view class="kp-tag" wx:for="{{mistake.secondary_knowledge_points}}" wx:key="*this">
    {{item}}
  </view>
</view>
```

**ä»»åŠ¡æ¸…å•**:

- [ ] ä¿®æ”¹ `mistake-card/index.wxml`
- [ ] ä¿®æ”¹ `mistake-card/index.wxss` æ·»åŠ æ ‡ç­¾æ ·å¼
- [ ] ä¿®æ”¹ `mistake-card/index.js` å¤„ç†çŸ¥è¯†ç‚¹æ•°æ®

### 6.3 é”™é¢˜è¯¦æƒ…é¡µå¢å¼º

**æ–‡ä»¶**: `miniprogram/pages/mistakes/detail/index.js`

**æ–°å¢æ•°æ®**:

```javascript
data: {
  // ... ç°æœ‰æ•°æ®
  knowledgeAnalysis: {
    primary_point: '',
    related_points: [],
    mastery_status: {},
    weak_chain: null
  }
}
```

**æ–°å¢æ–¹æ³•**:

```javascript
async loadKnowledgeAnalysis() {
  const response = await mistakesApi.getKnowledgeAnalysis(this.data.mistakeId);
  this.setData({ knowledgeAnalysis: response });
}

onKnowledgePointTap(e) {
  const kp = e.currentTarget.dataset.kp;
  wx.navigateTo({
    url: `/pages/mistakes/list/index?knowledge_point=${kp}`
  });
}

onReviewWeakChain(e) {
  const chain = this.data.knowledgeAnalysis.weak_chain;
  wx.navigateTo({
    url: `/pages/mistakes/list/index?knowledge_point=${chain.bottleneck}`
  });
}
```

**WXML æ–°å¢**: çŸ¥è¯†ç‚¹åˆ†æå¡ç‰‡ + AI å»ºè®®å¡ç‰‡

**ä»»åŠ¡æ¸…å•**:

- [ ] ä¿®æ”¹ `detail/index.js` æ·»åŠ çŸ¥è¯†ç‚¹åˆ†æé€»è¾‘
- [ ] ä¿®æ”¹ `detail/index.wxml` æ·»åŠ åˆ†æå¡ç‰‡ UI
- [ ] ä¿®æ”¹ `detail/index.wxss` æ·»åŠ æ ·å¼
- [ ] æ›´æ–° `api/mistakes.js` æ·»åŠ  `getKnowledgeAnalysis` æ–¹æ³•

### 6.4 å­¦ä¹ æŠ¥å‘Šé¡µæ•´åˆ

**æ–‡ä»¶**: `miniprogram/pages/analysis/report/index.js`

**æ–°å¢æ•°æ®**:

```javascript
data: {
  // ... ç°æœ‰æ•°æ®
  knowledgeGraph: {
    subjects: [],
    total_points: 0,
    mastered_points: 0,
    knowledge_points: [],
    weak_chains: [],
    strong_areas: []
  },
  selectedGraphSubject: 'math'
}
```

**æ–°å¢æ–¹æ³•**:

```javascript
async loadKnowledgeGraph() {
  const response = await api.analysis.getKnowledgeGraph({
    subject: this.data.selectedGraphSubject,
    days: this.getTimeRangeDays()
  });
  this.setData({ knowledgeGraph: response });
}

onGraphSubjectChange(e) {
  this.setData({ selectedGraphSubject: e.detail });
  this.loadKnowledgeGraph();
}

onWeakChainTap(e) {
  const chain = e.currentTarget.dataset.chain;
  wx.navigateTo({
    url: `/pages/mistakes/list/index?knowledge_point=${chain.bottleneck}`
  });
}

onGotoReview() {
  wx.navigateTo({
    url: '/pages/mistakes/today-review/index'
  });
}
```

**WXML æ–°å¢**: çŸ¥è¯†å›¾è°±æ¿å— + å­¦æƒ…ç”»åƒæ¿å—

**ä»»åŠ¡æ¸…å•**:

- [ ] ä¿®æ”¹ `report/index.js` æ·»åŠ çŸ¥è¯†å›¾è°±é€»è¾‘
- [ ] ä¿®æ”¹ `report/index.wxml` æ·»åŠ å›¾è°±å±•ç¤º UI
- [ ] ä¿®æ”¹ `report/index.wxss` æ·»åŠ æ ·å¼
- [ ] æ›´æ–° `api/analysis.js` æ·»åŠ  `getKnowledgeGraph` æ–¹æ³•

### 6.5 API å®¢æˆ·ç«¯æ‰©å±•

**æ–‡ä»¶**: `miniprogram/api/mistakes.js`

**æ–°å¢æ–¹æ³•**:

```javascript
/**
 * è·å–çŸ¥è¯†ç‚¹åˆ—è¡¨
 */
async function getKnowledgePointList(params) {
  return request.get('/mistakes/knowledge-points', params)
}

/**
 * è·å–é”™é¢˜çš„çŸ¥è¯†ç‚¹åˆ†æ
 */
async function getKnowledgeAnalysis(mistakeId) {
  return request.get(`/mistakes/${mistakeId}/knowledge-analysis`)
}

module.exports = {
  // ... ç°æœ‰æ–¹æ³•
  getKnowledgePointList,
  getKnowledgeAnalysis,
}
```

**æ–‡ä»¶**: `miniprogram/api/analysis.js`

**æ–°å¢æ–¹æ³•**:

```javascript
/**
 * è·å–çŸ¥è¯†å›¾è°±
 */
async function getKnowledgeGraph(params) {
  return request.get('/knowledge-graph', params)
}

/**
 * è·å–å­¦æƒ…ç”»åƒ
 */
async function getLearningProfile(params) {
  return request.get('/knowledge-graph/learning-profile', params)
}

module.exports = {
  // ... ç°æœ‰æ–¹æ³•
  getKnowledgeGraph,
  getLearningProfile,
}
```

**ä»»åŠ¡æ¸…å•**:

- [ ] æ›´æ–° `api/mistakes.js`
- [ ] æ›´æ–° `api/analysis.js`
- [ ] æµ‹è¯• API è°ƒç”¨

---

## ä¸ƒã€å®æ–½è·¯çº¿å›¾

### Week 1: çŸ¥è¯†ç‚¹ç²¾å‡†å…³è” (5 å¤©)

**Day 1-2: æ•°æ®åº“è®¾è®¡ä¸è¿ç§»**

- [ ] è®¾è®¡å¹¶è¯„å®¡æ•°æ®åº“è¡¨ç»“æ„
- [ ] ç¼–å†™ Alembic è¿ç§»è„šæœ¬
- [ ] å¼€å‘ç¯å¢ƒæ‰§è¡Œè¿ç§»å¹¶éªŒè¯
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬(ä» JSON æå–çŸ¥è¯†ç‚¹)

**Day 3-4: åç«¯åŸºç¡€å®ç°**

- [ ] åˆ›å»ºæ•°æ®æ¨¡å‹ (knowledge_graph.py)
- [ ] å®ç° Repository å±‚ (çŸ¥è¯†ç‚¹å…³è” CRUD)
- [ ] å¢å¼º MistakeService (AI åˆ†æå¸¦å­¦æƒ…ä¸Šä¸‹æ–‡)
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**Day 5: API ç«¯ç‚¹ä¸å°ç¨‹åºç«¯**

- [ ] æ–°å¢ API ç«¯ç‚¹ (çŸ¥è¯†ç‚¹åˆ—è¡¨ã€çŸ¥è¯†ç‚¹åˆ†æ)
- [ ] å°ç¨‹åºç«¯: é”™é¢˜åˆ—è¡¨æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰
- [ ] å°ç¨‹åºç«¯: é”™é¢˜å¡ç‰‡æ˜¾ç¤ºçŸ¥è¯†ç‚¹æ ‡ç­¾
- [ ] è”è°ƒæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:

- âœ… é”™é¢˜åˆ›å»ºæ—¶,AI èƒ½æå–çŸ¥è¯†ç‚¹å¹¶åˆ›å»ºå…³è”è®°å½•
- âœ… å°ç¨‹åºé”™é¢˜åˆ—è¡¨å¯æŒ‰çŸ¥è¯†ç‚¹ç­›é€‰
- âœ… é”™é¢˜å¡ç‰‡æ˜¾ç¤ºä¸»è¦çŸ¥è¯†ç‚¹æ ‡ç­¾
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

### Week 2: çŸ¥è¯†å›¾è°±æ„å»º (5 å¤©)

**Day 6-7: KnowledgeGraphService å®ç°**

- [ ] å®ç° `build_user_knowledge_graph` æ–¹æ³•
- [ ] å®ç° `analyze_weak_chains` æ–¹æ³•
- [ ] å®ç° `generate_learning_profile` æ–¹æ³•
- [ ] å®ç° `create_snapshot` æ–¹æ³•
- [ ] ç¼–å†™ Service å±‚æµ‹è¯•

**Day 8: çŸ¥è¯†å›¾è°± API**

- [ ] æ–°å¢çŸ¥è¯†å›¾è°± API ç«¯ç‚¹
- [ ] æ–°å¢å­¦æƒ…ç”»åƒ API ç«¯ç‚¹
- [ ] å®šä¹‰å“åº” Schema
- [ ] ç¼–å†™ API é›†æˆæµ‹è¯•

**Day 9-10: å°ç¨‹åºç«¯æ•´åˆ**

- [ ] å­¦ä¹ æŠ¥å‘Šé¡µ: æ·»åŠ çŸ¥è¯†å›¾è°±æ¿å—
- [ ] å­¦ä¹ æŠ¥å‘Šé¡µ: æ·»åŠ å­¦æƒ…ç”»åƒæ¿å—
- [ ] é”™é¢˜è¯¦æƒ…é¡µ: æ·»åŠ çŸ¥è¯†ç‚¹åˆ†æå¡ç‰‡
- [ ] é”™é¢˜è¯¦æƒ…é¡µ: æ·»åŠ  AI å»ºè®®å¡ç‰‡
- [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:

- âœ… èƒ½æ„å»ºç”¨æˆ·çŸ¥è¯†å›¾è°±,åŒ…å«çŸ¥è¯†ç‚¹ã€æŒæ¡åº¦ã€è–„å¼±é“¾
- âœ… å­¦ä¹ æŠ¥å‘Šé¡µå±•ç¤ºçŸ¥è¯†å›¾è°±å¯è§†åŒ–
- âœ… é”™é¢˜è¯¦æƒ…é¡µæ˜¾ç¤ºçŸ¥è¯†ç‚¹åˆ†æå’Œ AI å»ºè®®
- âœ… è–„å¼±é“¾å¯è·³è½¬åˆ°ç›¸å…³é”™é¢˜

---

### Week 3: AI èƒ½åŠ›å¢å¼ºä¸ä¼˜åŒ– (5 å¤©)

**Day 11-12: AI ä¸Šä¸‹æ–‡ä¼˜åŒ–**

- [ ] ä¼˜åŒ– AI æç¤ºè¯å·¥ç¨‹
- [ ] å®ç°å­¦æƒ…å¿«ç…§æ³¨å…¥é€»è¾‘
- [ ] ä¼˜åŒ–çŸ¥è¯†ç‚¹æå–å‡†ç¡®ç‡
- [ ] AI å»ºè®®è´¨é‡æµ‹è¯•

**Day 13: æ™ºèƒ½å¤ä¹ æ¨è**

- [ ] å®ç° `recommend_review_path` æ–¹æ³•
- [ ] ä¼˜åŒ–å¤ä¹ ä¼˜å…ˆçº§ç®—æ³•
- [ ] åœ¨é”™é¢˜è¯¦æƒ…é¡µå±•ç¤ºæ¨èè·¯å¾„
- [ ] ä»Šæ—¥å¤ä¹ é¡µé›†æˆæ¨èé€»è¾‘

**Day 14: å®šæ—¶ä»»åŠ¡ä¸æ€§èƒ½ä¼˜åŒ–**

- [ ] å®ç°çŸ¥è¯†å›¾è°±å¿«ç…§å®šæ—¶ç”Ÿæˆä»»åŠ¡
- [ ] æ·»åŠ  Redis ç¼“å­˜æœºåˆ¶
- [ ] ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½(ç´¢å¼•ã€N+1 æŸ¥è¯¢)
- [ ] å‹åŠ›æµ‹è¯•

**Day 15: æµ‹è¯•ä¸éƒ¨ç½²**

- [ ] å®Œæ•´åŠŸèƒ½å›å½’æµ‹è¯•
- [ ] ç”Ÿäº§æ•°æ®åº“è¿ç§»æ¼”ç»ƒ
- [ ] ç”Ÿäº§ç¯å¢ƒç°åº¦éƒ¨ç½²
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

**éªŒæ”¶æ ‡å‡†**:

- âœ… AI èƒ½æ ¹æ®å­¦æƒ…æä¾›ä¸ªæ€§åŒ–å»ºè®®
- âœ… æ¨èå¤ä¹ è·¯å¾„ç¬¦åˆé€»è¾‘
- âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
- âœ… API å“åº”æ—¶é—´ < 500ms (P95)
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ

---

## å…«ã€æµ‹è¯•ä¸éªŒæ”¶

### 8.1 å•å…ƒæµ‹è¯•

**è¦†ç›–èŒƒå›´**:

- Model å±‚: æ•°æ®æ¨¡å‹åŸºç¡€åŠŸèƒ½
- Repository å±‚: CRUD æ“ä½œ
- Service å±‚: ä¸šåŠ¡é€»è¾‘
- ç›®æ ‡è¦†ç›–ç‡: > 80%

**æµ‹è¯•æ–‡ä»¶**:

```
tests/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ test_knowledge_graph_models.py
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ test_knowledge_graph_repository.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ test_knowledge_graph_service.py
â”‚   â””â”€â”€ test_mistake_service_enhanced.py
â””â”€â”€ api/
    â””â”€â”€ test_knowledge_graph_api.py
```

### 8.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:

1. ç”¨æˆ·æäº¤é”™é¢˜ â†’ AI åˆ†æ â†’ åˆ›å»ºçŸ¥è¯†ç‚¹å…³è” â†’ æ›´æ–°æŒæ¡åº¦ â†’ ç”Ÿæˆå¿«ç…§
2. ç”¨æˆ·æŸ¥è¯¢å­¦ä¹ æŠ¥å‘Š â†’ è¿”å›çŸ¥è¯†å›¾è°± â†’ å±•ç¤ºè–„å¼±é“¾
3. ç”¨æˆ·æŸ¥çœ‹é”™é¢˜è¯¦æƒ… â†’ è¿”å›çŸ¥è¯†ç‚¹åˆ†æ â†’ æ˜¾ç¤º AI å»ºè®®
4. å®šæ—¶ä»»åŠ¡ç”Ÿæˆå¿«ç…§ â†’ æ‰€æœ‰ç”¨æˆ·å¿«ç…§æ›´æ–°æˆåŠŸ

### 8.3 æ€§èƒ½æµ‹è¯•

**æŒ‡æ ‡**:

- API å“åº”æ—¶é—´ (P50/P95/P99)
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- å¹¶å‘ç”¨æˆ·æ•°æ”¯æŒ
- å†…å­˜å’Œ CPU ä½¿ç”¨ç‡

**å·¥å…·**: JMeter / Locust

### 8.4 éªŒæ”¶æ¸…å•

**åŠŸèƒ½éªŒæ”¶**:

- [ ] é”™é¢˜åˆ›å»ºæ—¶è‡ªåŠ¨æå–çŸ¥è¯†ç‚¹
- [ ] çŸ¥è¯†ç‚¹å…³è”æ•°æ®æ­£ç¡®
- [ ] çŸ¥è¯†å›¾è°±æ„å»ºå‡†ç¡®
- [ ] è–„å¼±é“¾è¯†åˆ«æœ‰æ•ˆ
- [ ] AI å»ºè®®ä¸ªæ€§åŒ–ä¸”æœ‰ä»·å€¼
- [ ] å°ç¨‹åºç«¯ UI æ­£å¸¸å±•ç¤º
- [ ] ç­›é€‰ã€è·³è½¬äº¤äº’æµç•…

**æ€§èƒ½éªŒæ”¶**:

- [ ] API å“åº”æ—¶é—´ < 500ms (P95)
- [ ] æ”¯æŒ 1000+å¹¶å‘ç”¨æˆ·
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–(æ—  N+1)
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 70%

**å®‰å…¨éªŒæ”¶**:

- [ ] æ•°æ®æƒé™æ ¡éªŒ
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] XSS é˜²æŠ¤
- [ ] æ•æ„Ÿæ•°æ®è„±æ•

---

## ä¹ã€é£é™©ç®¡ç†

### 9.1 æŠ€æœ¯é£é™©

| é£é™©                 | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½                                       |
| -------------------- | ---- | ---- | ---------------------------------------------- |
| AI æå–çŸ¥è¯†ç‚¹ä¸å‡†ç¡®  | ä¸­   | é«˜   | 1. ä¼˜åŒ–æç¤ºè¯ 2. Few-shot å­¦ä¹  3. äººå·¥å®¡æ ¸æœºåˆ¶ |
| çŸ¥è¯†å›¾è°±æ„å»ºæ€§èƒ½ç“¶é¢ˆ | ä¸­   | ä¸­   | 1. å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— 2. å¢é‡æ›´æ–° 3. Redis ç¼“å­˜      |
| æ•°æ®è¿ç§»å¤±è´¥         | ä½   | é«˜   | 1. å¤‡ä»½æ•°æ®åº“ 2. ç°åº¦è¿ç§» 3. å¯å›æ»šæ–¹æ¡ˆ        |
| å‰ç«¯ UI å…¼å®¹æ€§é—®é¢˜   | ä½   | ä½   | 1. å¤šè®¾å¤‡æµ‹è¯• 2. é™çº§æ–¹æ¡ˆ                      |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™©         | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½                                          |
| ------------ | ---- | ---- | ------------------------------------------------- |
| ç”¨æˆ·ä½“éªŒä¸‹é™ | ä¸­   | é«˜   | 1. æ¸è¿›å¼å‘å¸ƒ 2. A/B æµ‹è¯• 3. ç”¨æˆ·åé¦ˆæ”¶é›†         |
| æ•°æ®éšç§åˆè§„ | ä½   | é«˜   | 1. æ•°æ®è„±æ• 2. æƒé™æ§åˆ¶ 3. ç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ |
| ç”Ÿäº§ç¯å¢ƒæ•…éšœ | ä½   | é«˜   | 1. ç°åº¦å‘å¸ƒ 2. ç›‘æ§å‘Šè­¦ 3. å¿«é€Ÿå›æ»š               |

### 9.3 è¿›åº¦é£é™©

| é£é™©         | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½                                  |
| ------------ | ---- | ---- | ----------------------------------------- |
| å¼€å‘è¿›åº¦å»¶æœŸ | ä¸­   | ä¸­   | 1. è°ƒæ•´ä¼˜å…ˆçº§ 2. å¢åŠ èµ„æº 3. ç®€åŒ–éœ€æ±‚     |
| æµ‹è¯•ä¸å……åˆ†   | ä¸­   | é«˜   | 1. è‡ªåŠ¨åŒ–æµ‹è¯• 2. é¢„ç•™æµ‹è¯•æ—¶é—´ 3. ä¸“é¡¹æµ‹è¯• |
| ä¾èµ–æœåŠ¡å»¶è¿Ÿ | ä½   | ä¸­   | 1. æå‰æ²Ÿé€š 2. æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•               |

---

## åã€é™„å½•

### 10.1 ä»£ç è§„èŒƒ

- **Python**: PEP 8 + Black æ ¼å¼åŒ–
- **JavaScript**: ESLint + Prettier
- **SQL**: ç»Ÿä¸€å‘½åè§„èŒƒ(snake_case)
- **æ³¨é‡Š**: å…³é”®é€»è¾‘å¿…é¡»æ³¨é‡Š,å¤æ‚ç®—æ³•è¯´æ˜æ—¶ç©ºå¤æ‚åº¦

### 10.2 Git æäº¤è§„èŒƒ

```
ç±»å‹(èŒƒå›´): ç®€æ´æè¿°

feat(knowledge-graph): æ·»åŠ çŸ¥è¯†å›¾è°±æ„å»ºæœåŠ¡
fix(mistake-service): ä¿®å¤AIåˆ†æä¸Šä¸‹æ–‡æ³¨å…¥é—®é¢˜
docs(readme): æ›´æ–°å¼€å‘è®¡åˆ’æ–‡æ¡£
test(knowledge-graph): æ·»åŠ çŸ¥è¯†å›¾è°±å•å…ƒæµ‹è¯•
refactor(repository): é‡æ„çŸ¥è¯†ç‚¹å…³è”æŸ¥è¯¢é€»è¾‘
```

### 10.3 å…³é”®æ–‡ä»¶æ¸…å•

**åç«¯**:

```
src/
â”œâ”€â”€ models/knowledge_graph.py          # æ–°å¢
â”œâ”€â”€ repositories/knowledge_graph_repository.py  # æ–°å¢
â”œâ”€â”€ services/knowledge_graph_service.py  # æ–°å¢
â”œâ”€â”€ services/mistake_service.py        # ä¿®æ”¹
â”œâ”€â”€ api/v1/endpoints/knowledge_graph.py  # æ–°å¢
â”œâ”€â”€ api/v1/endpoints/mistakes.py       # ä¿®æ”¹
â”œâ”€â”€ schemas/knowledge_graph.py         # æ–°å¢
â””â”€â”€ tasks/knowledge_graph_tasks.py     # æ–°å¢

alembic/versions/
â””â”€â”€ 20251103_add_knowledge_graph_tables.py  # æ–°å¢

tests/
â”œâ”€â”€ services/test_knowledge_graph_service.py  # æ–°å¢
â””â”€â”€ api/test_knowledge_graph_api.py    # æ–°å¢
```

**å°ç¨‹åºç«¯**:

```
miniprogram/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ mistakes/
â”‚   â”‚   â”œâ”€â”€ list/index.js             # ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ list/index.wxml           # ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ list/index.wxss           # ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ detail/index.js           # ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ detail/index.wxml         # ä¿®æ”¹
â”‚   â”‚   â””â”€â”€ detail/index.wxss         # ä¿®æ”¹
â”‚   â””â”€â”€ analysis/
â”‚       â””â”€â”€ report/index.js           # ä¿®æ”¹
â”‚       â””â”€â”€ report/index.wxml         # ä¿®æ”¹
â”‚       â””â”€â”€ report/index.wxss         # ä¿®æ”¹
â”œâ”€â”€ components/
â”‚   â””â”€â”€ mistake-card/
â”‚       â”œâ”€â”€ index.wxml                # ä¿®æ”¹
â”‚       â””â”€â”€ index.wxss                # ä¿®æ”¹
â””â”€â”€ api/
    â”œâ”€â”€ mistakes.js                   # ä¿®æ”¹
    â””â”€â”€ analysis.js                   # ä¿®æ”¹
```

### 10.4 ç¯å¢ƒå˜é‡é…ç½®

**å¼€å‘ç¯å¢ƒ** (.env.development):

```bash
# çŸ¥è¯†å›¾è°±é…ç½®
KNOWLEDGE_GRAPH_CACHE_TTL=3600  # å¿«ç…§ç¼“å­˜æ—¶é—´(ç§’)
KNOWLEDGE_GRAPH_SNAPSHOT_ENABLED=true  # æ˜¯å¦å¯ç”¨å¿«ç…§
KNOWLEDGE_GRAPH_AUTO_UPDATE=true  # è‡ªåŠ¨æ›´æ–°å¿«ç…§

# AIé…ç½®
BAILIAN_CONTEXT_MAX_LENGTH=2000  # å­¦æƒ…ä¸Šä¸‹æ–‡æœ€å¤§é•¿åº¦
```

**ç”Ÿäº§ç¯å¢ƒ** (.env.production):

```bash
KNOWLEDGE_GRAPH_CACHE_TTL=7200
KNOWLEDGE_GRAPH_SNAPSHOT_ENABLED=true
KNOWLEDGE_GRAPH_AUTO_UPDATE=true
BAILIAN_CONTEXT_MAX_LENGTH=1500
```

---

## ğŸ¯ æ€»ç»“

æœ¬å¼€å‘è®¡åˆ’é‡‡ç”¨**æ¸è¿›å¼è¿­ä»£**ç­–ç•¥,åˆ† 3 å‘¨å®Œæˆé”™é¢˜çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„å¼€å‘ã€‚æ ¸å¿ƒæ€è·¯æ˜¯:

1. **Week 1**: å¿«é€ŸéªŒè¯ AI å­¦æƒ…æ„ŸçŸ¥æ•ˆæœ(çŸ¥è¯†ç‚¹å…³è”)
2. **Week 2**: æ„å»ºå®Œæ•´çŸ¥è¯†å›¾è°±ä½“ç³»(å›¾è°±æ„å»º+å¯è§†åŒ–)
3. **Week 3**: æå‡ AI èƒ½åŠ›å’Œç³»ç»Ÿæ€§èƒ½(æ™ºèƒ½æ¨è+ä¼˜åŒ–)

æ¯å‘¨éƒ½æœ‰æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†,ç¡®ä¿åŠŸèƒ½å¯ç”¨ã€‚å°ç¨‹åºç«¯**æ— å¤§å¹… UI æ”¹åŠ¨**,åœ¨ç°æœ‰é¡µé¢æ¡†æ¶å†…è‡ªç„¶æ‰©å±•,ç”¨æˆ·æ— æ„ŸçŸ¥å‡çº§ã€‚

å…³é”®æˆåŠŸå› ç´ :

- âœ… æ•°æ®åº“è¿ç§»ç¨³å¦¥(å¤‡ä»½+ç°åº¦)
- âœ… AI æç¤ºè¯ä¼˜åŒ–(å‡†ç¡®æå–çŸ¥è¯†ç‚¹)
- âœ… æ€§èƒ½ä¼˜åŒ–åˆ°ä½(ç¼“å­˜+ç´¢å¼•)
- âœ… å……åˆ†æµ‹è¯•(å•å…ƒ+é›†æˆ+æ€§èƒ½)

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘è¿‡ç¨‹ä¸­å¦‚æœ‰è°ƒæ•´,åŠæ—¶æ›´æ–°æœ¬è®¡åˆ’æ–‡æ¡£  
**æ²Ÿé€šæœºåˆ¶**: æ¯å‘¨äº” Review è¿›åº¦,å‘¨ä¸€åˆ¶å®šä¸‹å‘¨è®¡åˆ’  
**é—®é¢˜è¿½è¸ª**: ä½¿ç”¨ Issue è·Ÿè¸ªé—®é¢˜å’Œéœ€æ±‚å˜æ›´

---

_æœ€åæ›´æ–°: 2025-11-03_  
_æ–‡æ¡£ç‰ˆæœ¬: v1.0_
