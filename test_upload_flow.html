<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª å›¾ç‰‡ä¸Šä¼ å’ŒAIè¯†åˆ«æµ‹è¯•</h1>

    <div class="section">
      <h2>1. ç™»å½•Token</h2>
      <input
        type="text"
        id="token"
        placeholder="ç²˜è´´ä½ çš„Bearer Token"
        style="width: 100%; padding: 8px"
      />
      <p>
        <small
          >ä»æµè§ˆå™¨localStorageä¸­è·å–ï¼šæ‰“å¼€Consoleï¼Œè¾“å…¥
          <code>localStorage.getItem('token')</code></small
        >
      </p>
    </div>

    <div class="section">
      <h2>2. é€‰æ‹©å›¾ç‰‡</h2>
      <input type="file" id="imageFile" accept="image/*" />
    </div>

    <div class="section">
      <h2>3. æµ‹è¯•æµç¨‹</h2>
      <button onclick="testUpload()">ğŸ“¤ æµ‹è¯•ä¸Šä¼ å›¾ç‰‡</button>
      <button onclick="testAskWithImage()">ğŸ’¬ æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆä¸Šä¼ +æé—®ï¼‰</button>
    </div>

    <div class="section">
      <h2>ğŸ“‹ æ—¥å¿—</h2>
      <div id="log"></div>
    </div>

    <script>
      const API_BASE = 'https://121.199.173.244/api/v1'

      function log(message, type = 'info') {
        const logDiv = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : ''
        logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`
        console.log(message)
      }

      async function testUpload() {
        const token = document.getElementById('token').value.trim()
        const fileInput = document.getElementById('imageFile')

        if (!token) {
          log('âŒ è¯·å…ˆè¾“å…¥Token', 'error')
          return
        }

        if (!fileInput.files[0]) {
          log('âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error')
          return
        }

        log('ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')

        const formData = new FormData()
        formData.append('file', fileInput.files[0])

        try {
          const response = await fetch(`${API_BASE}/files/upload-for-ai`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          })

          log(`   çŠ¶æ€ç : ${response.status}`)

          if (response.ok) {
            const data = await response.json()
            log(`âœ… ä¸Šä¼ æˆåŠŸï¼`, 'success')
            log(`   å›¾ç‰‡URL: ${data.ai_accessible_url}`)
            log(`<pre>${JSON.stringify(data, null, 2)}</pre>`)

            // ä¿å­˜URLä¾›åç»­ä½¿ç”¨
            window.uploadedImageUrl = data.ai_accessible_url
          } else {
            const error = await response.text()
            log(`âŒ ä¸Šä¼ å¤±è´¥: ${error}`, 'error')
          }
        } catch (error) {
          log(`âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error')
        }
      }

      async function testAskWithImage() {
        const token = document.getElementById('token').value.trim()

        if (!token) {
          log('âŒ è¯·å…ˆè¾“å…¥Token', 'error')
          return
        }

        if (!window.uploadedImageUrl) {
          log('âš ï¸ è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error')
          return
        }

        log('ğŸ’¬ å‘é€é—®é¢˜ç»™AI...')

        const payload = {
          content: 'è§£ç­”å›¾ç‰‡ä¸­çš„ç‰©ç†é¢˜',
          question_type: 'problem_solving',
          image_urls: [window.uploadedImageUrl],
          use_context: false,
          include_history: false,
          max_history: 0,
        }

        log(`<pre>è¯·æ±‚payload: ${JSON.stringify(payload, null, 2)}</pre>`)

        try {
          const response = await fetch(`${API_BASE}/learning/ask`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          })

          log(`   çŠ¶æ€ç : ${response.status}`)

          if (response.ok) {
            const data = await response.json()
            log(`âœ… AIå“åº”æˆåŠŸï¼`, 'success')

            // æ£€æŸ¥AIæ˜¯å¦æåˆ°æ— æ³•æŸ¥çœ‹å›¾ç‰‡
            if (data.answer.includes('æ— æ³•') && data.answer.includes('å›¾ç‰‡')) {
              log(`âš ï¸ AIè¯´æ— æ³•æŸ¥çœ‹å›¾ç‰‡ï¼š`, 'error')
            } else {
              log(`âœ… AIæˆåŠŸåˆ†æäº†å›¾ç‰‡ï¼`, 'success')
            }

            log(`<pre>AIå›ç­”:\n${data.answer}</pre>`)
          } else {
            const error = await response.text()
            log(`âŒ æé—®å¤±è´¥: ${error}`, 'error')
          }
        } catch (error) {
          log(`âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error')
        }
      }
    </script>
  </body>
</html>
