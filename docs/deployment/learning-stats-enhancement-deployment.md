# å­¦ä¹ ç»Ÿè®¡ API å¢å¼ºéƒ¨ç½²è®°å½•

**éƒ¨ç½²æ—¥æœŸ**: 2025-10-20  
**éƒ¨ç½²ç‰ˆæœ¬**: v2.1.0  
**éƒ¨ç½²ç¯å¢ƒ**: é˜¿é‡Œäº‘ç”Ÿäº§ç¯å¢ƒ  
**éƒ¨ç½²äºº**: liguoma

---

## ğŸ“‹ éƒ¨ç½²å†…å®¹æ¦‚è¦

### ä¸»è¦å˜æ›´

**åŠŸèƒ½å¢å¼º**: å­¦ä¹ æŠ¥å‘Šé¡µé¢æ•°æ®çœŸå®åŒ–

**ä¿®æ”¹æ¨¡å—**:

- `src/services/analytics_service.py` - åç«¯å­¦æƒ…åˆ†ææœåŠ¡

**æ–°å¢åŠŸèƒ½**:

1. âœ… ç»Ÿè®¡å­¦ä¹ ä¼šè¯æ•°ï¼ˆ`total_sessions`ï¼‰
2. âœ… ç»Ÿè®¡å¹³å‡è¯„åˆ†å’Œå¥½è¯„ç‡ï¼ˆ`avg_rating`, `positive_feedback_rate`ï¼‰
3. âœ… æŒ‰å­¦ç§‘ç»Ÿè®¡é—®é¢˜æ•°å’Œè¯„åˆ†ï¼ˆ`subject_stats`ï¼‰
4. âœ… åˆ†æå­¦ä¹ æ¨¡å¼ï¼ˆ`learning_pattern`ï¼‰

---

## ğŸ”„ æŠ€æœ¯å®ç°

### 1. æ–°å¢ç»Ÿè®¡æ–¹æ³•

#### `_count_sessions()`

```python
ç»Ÿè®¡ç”¨æˆ·çš„å­¦ä¹ ä¼šè¯æ€»æ•°
æ•°æ®æ¥æº: ChatSession è¡¨
æŸ¥è¯¢æ¡ä»¶: user_id + æ—¶é—´èŒƒå›´è¿‡æ»¤
```

#### `_get_rating_stats()`

```python
ç»Ÿè®¡è¯„åˆ†ç›¸å…³æ•°æ®
æ•°æ®æ¥æº: Answer.user_rating å­—æ®µï¼ˆ1-5åˆ†ï¼‰
è¿”å›:
  - avg_rating: å¹³å‡è¯„åˆ†
  - positive_rate: å¥½è¯„ç‡ï¼ˆè¯„åˆ†â‰¥4çš„æ¯”ä¾‹ï¼‰
```

#### `_get_subject_stats()`

```python
æŒ‰å­¦ç§‘ç»Ÿè®¡å­¦ä¹ æ•°æ®
æ•°æ®æ¥æº: Question è¡¨æŒ‰ subject åˆ†ç»„
è¿”å›: æ¯ä¸ªå­¦ç§‘çš„é—®é¢˜æ•°å’Œå¹³å‡è¯„åˆ†
```

#### `_analyze_learning_pattern()`

```python
åˆ†æå­¦ä¹ ä¹ æƒ¯å’Œæ¨¡å¼
æ•°æ®æ¥æº: Question.created_atã€difficulty_level
è¿”å›:
  - most_active_hour: æœ€æ´»è·ƒæ—¶æ®µï¼ˆå°æ—¶ï¼‰
  - most_active_day: æœ€æ´»è·ƒæ—¥ï¼ˆ0-6ï¼Œå‘¨æ—¥-å‘¨å…­ï¼‰
  - avg_session_length: å¹³å‡ä¼šè¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  - preferred_difficulty: åå¥½éš¾åº¦ï¼ˆeasy/medium/hardï¼‰
```

### 2. ä¿®æ”¹è¿”å›æ•°æ®ç»“æ„

**æ—§æ ¼å¼** (ä»…åç«¯ä½¿ç”¨):

```json
{
  "total_study_days": 10,
  "total_questions": 50,
  "total_homework": 8,
  "avg_score": 85.5,
  "knowledge_points": [],
  "study_trend": []
}
```

**æ–°æ ¼å¼** (å…¼å®¹å°ç¨‹åºå‰ç«¯):

```json
{
  // å°ç¨‹åºéœ€è¦çš„å­—æ®µ
  "total_questions": 50,
  "total_sessions": 12,
  "total_study_days": 10,
  "avg_rating": 4.2,
  "positive_feedback_rate": 85.5,
  "subject_stats": [
    {
      "subject": "math",
      "subject_name": "æ•°å­¦",
      "question_count": 20,
      "avg_rating": 4.5
    }
  ],
  "learning_pattern": {
    "most_active_hour": 20,
    "most_active_day": 6,
    "avg_session_length": 25,
    "preferred_difficulty": "medium"
  },

  // ä¿ç•™åŸæœ‰å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
  "total_homework": 8,
  "avg_score": 85.5,
  "knowledge_points": [],
  "study_trend": [],
  "time_range": "30d",
  "generated_at": "2025-10-20T13:14:50.123Z"
}
```

---

## ğŸ“Š æ•°æ®åº“ä¾èµ–

### ä½¿ç”¨çš„è¡¨å’Œå­—æ®µ

| è¡¨                 | å­—æ®µ                                                                 | ç”¨é€”                         |
| ------------------ | -------------------------------------------------------------------- | ---------------------------- |
| `chat_sessions`    | `user_id`, `created_at`                                              | ç»Ÿè®¡ä¼šè¯æ•°                   |
| `questions`        | `user_id`, `session_id`, `created_at`, `subject`, `difficulty_level` | é—®é¢˜ç»Ÿè®¡ã€å­¦ç§‘åˆ†å¸ƒã€å­¦ä¹ æ¨¡å¼ |
| `learning_answers` | `question_id`, `user_rating`                                         | è¯„åˆ†ç»Ÿè®¡                     |

### æ•°æ®è´¨é‡è¦æ±‚

- âœ… `Answer.user_rating`: 1-5 æ•´æ•°ï¼Œå…è®¸ NULL
- âœ… `Question.created_at`: ISO 8601 æ ¼å¼æˆ– datetime å¯¹è±¡
- âœ… `Question.subject`: å­¦ç§‘ä»£ç ï¼ˆmath/chinese/english ç­‰ï¼‰
- âœ… `Question.difficulty_level`: 1-5 æ•´æ•°

---

## ğŸš€ éƒ¨ç½²è¿‡ç¨‹

### 1. ä»£ç æäº¤

```bash
git commit -m "feat(analytics): å¢å¼ºå­¦ä¹ ç»Ÿè®¡APIï¼Œæ”¯æŒä¼šè¯æ•°/è¯„åˆ†/å­¦ç§‘ç»Ÿè®¡/å­¦ä¹ æ¨¡å¼åˆ†æ"
git push origin main
```

**æäº¤å“ˆå¸Œ**: `7e6ac61`

### 2. ç”Ÿäº§éƒ¨ç½²

```bash
chmod +x scripts/deploy_to_production.sh
./scripts/deploy_to_production.sh
```

**éƒ¨ç½²æ­¥éª¤**:

1. âœ… æœ¬åœ°ä»£ç æ£€æŸ¥ï¼ˆpre_deploy_check.shï¼‰
2. âœ… å‰ç«¯æ„å»ºï¼ˆbuild_frontend.shï¼‰
3. âœ… æ–‡ä»¶åŒæ­¥åˆ°æœåŠ¡å™¨ï¼ˆrsyncï¼‰
4. âœ… æ›´æ–°åç«¯ä¾èµ–ï¼ˆpip installï¼‰
5. âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•
6. âœ… é‡å¯æœåŠ¡ï¼ˆsystemctl restart wuhao-tutorï¼‰
7. âœ… Nginx é‡è½½é…ç½®

### 3. éªŒè¯ç»“æœ

```bash
# å¥åº·æ£€æŸ¥
curl -k https://121.199.173.244/api/v1/files/health
# âœ… å“åº”: {"status":"healthy"}

# æœåŠ¡çŠ¶æ€
ssh root@121.199.173.244 'systemctl status wuhao-tutor'
# âœ… çŠ¶æ€: active (running)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### API æµ‹è¯•

**ç«¯ç‚¹**: `GET /api/v1/analytics/learning-stats?time_range=30d`

**æµ‹è¯•åœºæ™¯**:

1. âœ… æ— æ•°æ®ç”¨æˆ·ï¼šè¿”å› 0 å€¼ï¼Œä¸æŠ¥é”™
2. âœ… æœ‰æ•°æ®ç”¨æˆ·ï¼šæ­£ç¡®è®¡ç®—ç»Ÿè®¡å€¼
3. âœ… ä¸åŒæ—¶é—´èŒƒå›´ï¼š7d/30d/90d å‚æ•°æ­£ç¡®è¿‡æ»¤
4. âœ… å¼‚å¸¸å¤„ç†ï¼šç¼ºå¤±å­—æ®µè¿”å›é»˜è®¤å€¼

### å°ç¨‹åºæµ‹è¯•

**é¡µé¢**: `pages/analysis/report/index`

**éªŒè¯ç‚¹**:

1. âœ… å­¦ä¹ æ¦‚è§ˆæ˜¾ç¤ºçœŸå®æ•°æ®ï¼ˆä¸å†æ˜¯ 0ï¼‰
2. âœ… å­¦ä¹ æ¨¡å¼æ˜¾ç¤ºå…·ä½“æ—¶æ®µå’Œæ—¥æœŸï¼ˆä¸å†æ˜¯"æœªçŸ¥"ï¼‰
3. âœ… è¯„åˆ†å’Œå¥½è¯„ç‡æ­£ç¡®æ˜¾ç¤º
4. âœ… æ—¶é—´èŒƒå›´åˆ‡æ¢æ­£å¸¸

---

## ğŸ“ é…ç½®å˜æ›´

### æ— éœ€é…ç½®å˜æ›´

æ­¤æ¬¡éƒ¨ç½²**ä¸éœ€è¦ä¿®æ”¹ä»»ä½•é…ç½®æ–‡ä»¶**ï¼Œå› ä¸ºï¼š

- ä½¿ç”¨ç°æœ‰æ•°æ®åº“è¡¨å’Œå­—æ®µ
- ä¸éœ€è¦æ–°çš„ç¯å¢ƒå˜é‡
- API ç«¯ç‚¹ä¸å˜ï¼ˆåªæ”¹è¿”å›æ•°æ®ç»“æ„ï¼‰

---

## ğŸ” ç›‘æ§æŒ‡æ ‡

### å…³é”®æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡           | æœŸæœ›å€¼ | å®é™…å€¼ | çŠ¶æ€ |
| -------------- | ------ | ------ | ---- |
| API å“åº”æ—¶é—´   | <500ms | å¾…æµ‹é‡ | â³   |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | <200ms | å¾…æµ‹é‡ | â³   |
| é”™è¯¯ç‡         | <0.1%  | å¾…æµ‹é‡ | â³   |
| æœåŠ¡å¯ç”¨æ€§     | >99.9% | å¾…æµ‹é‡ | â³   |

### æ—¥å¿—ç›‘æ§

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
ssh root@121.199.173.244 'journalctl -u wuhao-tutor -f'

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
ssh root@121.199.173.244 'journalctl -u wuhao-tutor -p err -n 50'
```

---

## ğŸ› å·²çŸ¥é—®é¢˜

### æ— å·²çŸ¥é—®é¢˜

å½“å‰ç‰ˆæœ¬æœªå‘ç°å·²çŸ¥é—®é¢˜ã€‚

### æ½œåœ¨ä¼˜åŒ–ç‚¹

1. **æ€§èƒ½ä¼˜åŒ–**: å¦‚æœç”¨æˆ·æ•°æ®é‡å¤§ï¼Œå¯ä»¥è€ƒè™‘ï¼š

   - æ·»åŠ  Redis ç¼“å­˜ï¼ˆTTL=5 åˆ†é’Ÿï¼‰
   - å¼‚æ­¥è®¡ç®—ç»Ÿè®¡æ•°æ®
   - å¢åŠ æ•°æ®åº“ç´¢å¼•

2. **æ•°æ®å‡†ç¡®æ€§**:
   - `avg_session_length` ç›®å‰æ˜¯ä¼°ç®—å€¼ï¼ˆé—®é¢˜æ•°\*5 åˆ†é’Ÿï¼‰
   - å¯ä»¥è€ƒè™‘è®°å½•å®é™…ä¼šè¯æ—¶é•¿

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### å¦‚éœ€å›æ»š

```bash
# 1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git revert 7e6ac61

# 2. æˆ–è€…å›é€€åˆ°ç‰¹å®šæäº¤
git reset --hard e83c131

# 3. é‡æ–°éƒ¨ç½²
./scripts/deploy_to_production.sh
```

### å›æ»šå½±å“

- âœ… å‰ç«¯å°ç¨‹åºï¼šä¼šæ˜¾ç¤ºä¸º"æš‚æ— æ•°æ®"ï¼ˆå› ä¸ºå­—æ®µä¸åŒ¹é…ï¼‰
- âœ… åç«¯ APIï¼šä»ç„¶æ­£å¸¸å·¥ä½œï¼ˆè¿”å›æ—§æ ¼å¼æ•°æ®ï¼‰
- âœ… æ•°æ®åº“ï¼šæ— å½±å“ï¼ˆæ²¡æœ‰æ•°æ®å˜æ›´ï¼‰

---

## ğŸ“ è”ç³»æ–¹å¼

**éƒ¨ç½²è´Ÿè´£äºº**: liguoma  
**æŠ€æœ¯æ”¯æŒ**: GitHub Issues  
**ç´§æ€¥è”ç³»**: è§é¡¹ç›® README

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å­¦ä¹ ç»Ÿè®¡ API æ–‡æ¡£](../api/analytics.md)
- [å°ç¨‹åºå¼€å‘æ–‡æ¡£](../miniprogram/)
- [éƒ¨ç½²æµç¨‹æ–‡æ¡£](./deployment-guide.md)
- [Git æäº¤å†å²](https://github.com/hordu-ma/wuhao-tutor/commit/7e6ac61)

---

**éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ  
**æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œä¸­  
**æœ€åæ›´æ–°**: 2025-10-20 13:14:50 CST
