# 五好伴学数据库迁移与演进指南 (MIGRATION)

Last Updated: 2025-09-29
适用版本：后端 0.1.x（文档重构阶段初稿）

---

## 1. 文档目的

本文件为数据库结构（Schema）与数据演进的权威流程说明，目标：

| 目标 | 说明 |
|------|------|
| 一致性 | 任何结构/约束/索引变更均统一通过迁移脚本（Alembic） |
| 可审计 | 迁移脚本具备明确意图、描述与回滚策略 |
| 可回滚 | 每次迁移需定义“安全回退”方式（即使代价为手工步骤） |
| 降风险 | 避免直接在生产手动执行 DDL |
| 可自动化 | 支撑脚本化初始化、升级、备份、验证 |
| 渐进演进 | 支持结构调整、字段重命名、数据更正、性能优化 |

---

## 2. 迁移体系概览

| 组件 / 目录 | 作用 | 说明 |
|-------------|------|------|
| Alembic | Schema 版本管理 | 维护版本链（heads → base） |
| `alembic/versions/` | 单个迁移脚本目录 | 按时间+摘要命名 |
| `scripts/init_database.py` | 从零初始化 + 首次运行迁移 | 可在新的环境执行 |
| `scripts/manage_db.py` | 集成入口（migrate / status / backup 等） | 封装常用操作 |
| `scripts/db_backup.py` | 备份与恢复 | 回退前置条件 |
| `scripts/test_database.py` | 结构与 CRUD 验证 | 迁移后验证 |
| `scripts/sql/` | 手写扩展 / 索引优化 SQL | 不直接替代迁移，需引用或说明 |

---

## 3. 迁移类型分类

| 类型 | 示例 | 风险级 | 特殊处理 |
|------|------|--------|----------|
| 结构新增 | 新表 / 新列（可空） | 低 | 标注默认值策略 |
| 结构修改 | 改列类型 / 非空约束 / 重命名 | 中 | 需数据清理或 backfill |
| 结构删除 | 删列 / 删表 | 高 | 必须确认无引用；优先软删除策略 |
| 约束/索引 | 增加唯一、外键、索引 | 低~中 | 大表加索引需在线策略 |
| 数据修复 | 填充默认值 / 纠正脏数据 | 中 | 明确幂等性与回滚方式 |
| 大规模变更 | 分表 / 重构关系 | 高 | 分阶段 / 影子结构方案 |
| 性能优化 | 新索引 / 分区 / 统计刷新 | 中 | 验证统计效果 |
| 重命名迁移 | 列或表 rename | 中 | 避免中途读写不一致 |
| 语义拆分 | 拆分枚举 / 规范化 | 中 | 逐步复制 + 切换 + 清理 |

---

## 4. 命名与脚本规范

| 规则 | 示例 |
|------|------|
| 文件名 | `YYYYMMDD_HHMM_<short_action>_<target>.py` |
| revision ID | 自动生成（保持唯一） |
| message 描述 | 简洁 + 主动语态：“add homework correction table” |
| 函数顺序 | `upgrade()` / `downgrade()`（必要时含安全注释） |
| 数据迁移块 | 与 DDL 分离，注释“# --- data migration ---” |
| 大体积操作 | 分批循环，不一次性加载 > N 行 |
| 幂等注释 | 明确“重复执行是否安全” |

---

## 5. 新增迁移流程（标准操作）

1. 确认变更目的：功能 / 性能 / 修复 / 重构
2. 在本地最新 schema 状态基础上更新模型（`src/models/`）
3. 生成迁移草稿：
   ```bash
   alembic revision --autogenerate -m "add xxxx table"
   ```
4. 打开生成脚本：
   - 核对差异（确认未引入无关修改）
   - 必要时补充：显式服务器默认 / 兼容旧数据填充
5. 若涉及不兼容变更（如非空列新增）：
   - 分为两步：添加可空列 → backfill → 改为非空
6. 编写 `downgrade()` （若无法真实回滚，明确注释 WHY & 手工步骤）
7. 本地应用：
   ```bash
   alembic upgrade head
   ```
8. 运行验证：
   ```bash
   uv run python scripts/test_database.py --quick
   ```
9. 如为生产影响较大：
   - 评估迁移时间（EXPLAIN / 索引构建耗时）
   - 写入“执行前检查 / 监控项”注释
10. 提交 PR：附迁移说明（参考第 6 节模板）
11. 合并后：统一在部署脚本/流水线执行 `alembic upgrade head`

---

## 6. 迁移说明（PR 描述模板）

```
[迁移目的]
- 新增 / 修改 / 删除 / 性能优化 / 数据修复

[涉及对象]
- 表/列/索引：...

[变更内容摘要]
- 新增列 xxx (nullable -> 填充 -> set NOT NULL)
- 创建索引 idx_xxx_y (WHERE status='active')

[影响评估]
- 预估执行耗时：
- 是否锁表：是/否（说明）
- 写入/读取影响：...

[回滚策略]
- downgrade() 是否安全：是/否
- 若否：人工步骤（如恢复备份 / DROP 临时列）

[验证步骤]
- 升级后：字段存在 + 约束生效 + 旧功能正常
- 性能：索引命中率指标观察

[风险与缓解]
- 风险：大表扫描
- 缓解：离峰执行 / 提前加只读窗口

[附加备注]
- 与任务 / Issue 关联：#123
```

---

## 7. 环境与差异处理

| 环境 | 特性 | 注意事项 |
|------|------|----------|
| development | SQLite / PostgreSQL | 某些类型（JSON / UUID）兼容性差异需注意 |
| testing | 内存或临时 DB | 避免依赖生产特性（分区/扩展） |
| staging（规划） | 近似生产 | 预热索引 / 回放流量候选 |
| production | PostgreSQL + 扩展 | 需启用备份、锁风险评估 |

---

## 8. 数据兼容与平滑策略

| 场景 | 推荐做法 | 示例 |
|------|----------|------|
| 新增非空列 | 1) 可空添加 2) backfill 3) 置非空 | `created_by` |
| 重命名列 | 新列 + 复制数据 + 更新读写层 + 删除旧列（延迟一版） | `old_status` → `status` |
| 枚举拆分 | 新字段并行写 → 数据迁移 → 切读 → 清旧 | 角色字段多值化 |
| 大表索引 | `CONCURRENTLY`（若支持）或离峰执行 | 上线前评估锁等待 |
| 拆分表 | 影子表写入 + 双写校验 + 切读 | 学情分析归档 |
| 删除列 | 标记废弃 → 代码不引用 → 延后 N 版本 drop | 减少立即风险 |

---

## 9. 回滚策略分类

| 类型 | 可自动 downgrade | 推荐策略 |
|------|------------------|----------|
| 简单新增表/列 | 是 | 直接删除结构 |
| 非空约束添加 | 条件（慎用） | 审查是否必需回滚；保留步骤记录 |
| 数据修复迁移 | 通常否 | 依赖备份恢复或逆向脚本 |
| 删除列/表 | 否（高风险） | 优先避免，采用软弃用周期 |
| 批量数据重构 | 否 | 迁移前全量备份（逻辑 or 物理） |
| 索引/约束 | 是（DROP） | 可直接回滚 |

> 如果 `downgrade()` 实现会导致数据丢失，需在函数顶端注释：
> `# WARNING: destructive downgrade; use backup restore instead.`

---

## 10. 迁移前后验证清单

| 检查项 | 升级前 | 升级后 |
|--------|--------|--------|
| 备份完成 | ✅ | - |
| 连接数 / 锁等待正常 | ✅ | 无异常增加 |
| 迁移脚本语法 | ✅ `alembic upgrade --sql head` 预览 | - |
| schema 版本 | 记录当前 `alembic_version` | 显示新版本 ID |
| 新结构存在 | - | DESCRIBE / \d+ 确认 |
| 数据 backfill 结果 | - | 目标列空值为 0 |
| 索引使用 | - | 通过 `EXPLAIN` 验证 |
| 业务功能 | 基础操作通过 | 不出现 500 / 回归行为 |
| 指标监控 | QPS / 延迟基线记录 | 波动在容忍范围 |
| 错误日志 | 基线 | 无持续新错误码 |

---

## 11. 常见风险与缓解

| 风险 | 场景 | 缓解措施 |
|------|------|----------|
| 长事务阻塞 | 大表全量更新 | 拆批 / 尽量避免行锁范围扩大 |
| 锁超时 | 索引创建高峰期 | 离峰执行 / 使用在线算法 |
| 空值约束失败 | backfill 不完整 | 增加临时校验查询 |
| 回滚失败 | 破坏性修改 | 迁移前备份 + 双人评审 |
| 读写不一致 | 重命名/拆分中途 | 双写阶段 + 比对脚本 |
| 性能下降 | 新增触发器/索引错误选择 | 执行前 `EXPLAIN` 验证 |
| SQLite 差异 | Dev 环境行为正常 Prod 异常 | 尽早在 PostgreSQL 环境复测 |

---

## 12. 数据迁移（内容层）建议模式

| 模式 | 适用场景 | 实施要点 |
|------|----------|----------|
| 直接 SQL 更新 | 小规模、确定性 | 限制行数 + 幂等校验 |
| 分批迁移 | 大表字段填充 | LIMIT + ORDER + LOOP（避免长锁） |
| 影子列迁移 | 重命名 / 类型重构 | 新/旧列并行，业务切换后清理 |
| 对照验证 | 高风险重构 | 旧数据 vs 新数据聚合统计比对 |
| 脚本复用 | 多环境一致 | 将数据逻辑放函数/脚本调用 |

---

## 13. 工具命令速查

| 场景 | 命令示例 |
|------|----------|
| 创建迁移 | `alembic revision -m "add homework table"` |
| 自动生成 | `alembic revision --autogenerate -m "..."` |
| 升级到最新 | `alembic upgrade head` |
| 回退一版本 | `alembic downgrade -1` |
| 查看当前版本 | `alembic current` |
| 仅生成 SQL | `alembic upgrade head --sql > mig.sql` |
| 初始化数据库（脚本） | `uv run python scripts/init_database.py` |
| 管理工具 | `uv run python scripts/manage_db.py migrate` |
| 备份 | `uv run python scripts/db_backup.py create` |
| 恢复 | `uv run python scripts/db_backup.py restore <file>` |

---

## 14. 性能与索引策略简述

| 类别 | 原则 | 说明 |
|------|------|------|
| 新索引 | 仅针对高频过滤/连接字段 | 避免“预先”索引未使用列 |
| 复合索引 | 前缀列基数尽量高 | 避免 (a,b) 无需 (a) 冗余 |
| 条件索引（部分索引） | 针对特定状态热数据 | 如：`WHERE status='active'` |
| 全文索引 | 需要特定扩展（pg_trgm） | 评估吞吐与写入成本 |
| 统计刷新 | 大量导入后手动 ANALYZE | 提升查询计划准确性 |
| 覆盖索引 | SELECT 仅用索引列 | 减少回表 |
| 迁移顺序 | 先结构后索引 | 大表索引延迟执行可选 |

---

## 15. 废弃字段与清理流程

| 阶段 | 动作 | 说明 |
|------|------|------|
| 标记阶段 | 代码中不再读取/写入；模型注明注释 | 迁移不立即删除 |
| 观察阶段 | 保留 1~2 次小版本 | 确认未引用（日志/报错） |
| 删除迁移 | 编写删除脚本 | 确认无依赖（视图/函数/索引） |
| 历史记录 | CHANGELOG + MIGRATION 说明 | 可追溯 |

---

## 16. 特殊主题（高级用法占位）

| 主题 | 说明 | 状态 |
|------|------|------|
| 零停机迁移 | 通过双写/影子表避免写阻塞 | 规划 |
| 分区表 | 大体量时间序列数据 | 暂不需要 |
| 多租户隔离 | 逻辑分库/Schema 分离 | 未启用 |
| 审计日志表 | 行级操作追踪 | 规划（安全文档） |
| 变更模拟 | 预执行对比执行计划 | 可接入 |
| 校验脚本自动化 | 比对模型 vs 真实表差异 | 规划 |

---

## 17. 迁移脚本代码片段示例（占位）

```python
# 示例：添加可空列 + 回填 + 设置非空
def upgrade():
    # 1. Add nullable column
    op.add_column("homework_submission",
        sa.Column("reviewed_by", sa.String(length=36), nullable=True)
    )

    # 2. Backfill (small table example)
    conn = op.get_bind()
    conn.execute(sa.text("""
        UPDATE homework_submission
        SET reviewed_by = 'system'
        WHERE reviewed_by IS NULL
    """))

    # 3. Alter to NOT NULL
    op.alter_column("homework_submission", "reviewed_by",
        existing_type=sa.String(length=36),
        nullable=False
    )


def downgrade():
    # WARNING: dropping column will lose data
    op.drop_column("homework_submission", "reviewed_by")
```

---

## 18. 常见问题 (FAQ)

| 问题 | 解答 |
|------|------|
| 为什么自动生成的迁移包含奇怪差异？ | 可能是模型元数据未正确导入或默认值表达方式差异，需手工编辑。 |
| SQLite 下测试通过，PostgreSQL 报错？ | 类型/约束实现存在差异（如 JSON/日期），需在真实数据库测试。 |
| 可以跳跃多版本直接升级吗？ | 可以（线性链），但需确认中间迁移不依赖环境状态。 |
| 如何处理大型历史数据清理？ | 先归档（插入归档表 / 导出），再分批删除以避免长事务。 |
| downgrade 必须实现吗？ | 若无法安全执行，可注释解释并要求备份恢复，保持显式。 |
| 多人同时生成迁移冲突？ | 合并前 rebase，让后生成者调整 revision 依赖。 |
| 是否需要测试每个 downgrade？ | 高危迁移需；低风险可记录“未演练”并说明原因。 |

---

## 19. 改进路线 (Roadmap Draft)

| 阶段 | 目标 | 事项 |
|------|------|------|
| 0.2.x | 基础质量指标 | 校验脚本：模型 vs 表结构差异 |
| 0.3.x | 安全增强 | 自动备份钩子 + 迁移风险分级 |
| 0.4.x | 数据演进 | 引入影子列迁移示例模板 |
| 0.5.x | 可观测 | 迁移执行耗时指标化 |
| 0.6.x | 自动化 | 在 CI 中 dry-run 迁移并检测异常 |
| ≥ 1.0 | 成熟体系 | 加分区/归档策略文档化 |

---

## 20. 变更记录（本文件）

| 日期 | 版本 | 变更 | 说明 |
|------|------|------|------|
| 2025-09-29 | draft-1 | 初稿 | 建立结构与核心流程 |
| (待填) | ... | ... | ... |

---

## 21. 反馈

如发现：
- 实际迁移流程与本文不一致
- downgrade 不安全或文档缺失
- 需要新增“高级迁移模式”范式
- 迁移执行风险评估遗漏

请创建 Issue（标签：migration），包含：
1. 背景与链接（PR / Issue）
2. 当前行为 vs 预期
3. 影响范围与风险等级
4. 建议修复或补充方案

---

_本文件为活体文档，所有迁移相关改动需在 24 小时内同步。_

（END）
