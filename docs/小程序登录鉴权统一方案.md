# 小程序登录鉴权统一方案

## 需求背景

**产品设计理念**: 五好伴学小程序是一个完全基于注册登录用户的服务平台,所有功能必须登录后才能使用。

## 当前问题分析

### 底部导航栏(TabBar)五个页面的登录逻辑不统一

| 页面         | 当前路径                      | 当前登录逻辑             | 问题描述                             |
| ------------ | ----------------------------- | ------------------------ | ------------------------------------ |
| **首页**     | `pages/index/index`           | 可不登录访问             | ✅ 符合预期,作为入口页面             |
| **错题本**   | `pages/mistakes/list/index`   | 点击提示登录             | ✅ 符合预期,使用 `createGuardedPage` |
| **作业问答** | `pages/learning/index/index`  | 点击提示无权限但实际可用 | ❌ 提示不友好,未统一跳转登录         |
| **学习报告** | `pages/analysis/report/index` | 另一种形式的提示登录     | ❌ 提示方式与其他页面不统一          |
| **我的**     | `pages/profile/index/index`   | 点击直接跳转登录         | ✅ 符合预期,使用 `routeGuard`        |

## 目标效果

**统一登录拦截逻辑**:

1. **首页** - 保持现状,允许游客浏览,但功能按钮引导登录
2. **其他四个 TabBar 页面** - 未登录状态下访问:
   - ✅ **立即重定向到登录页面**
   - ✅ **登录成功后返回首页**(因为 TabBar 页面不能用 redirectTo 返回)
   - ✅ **提示信息统一友好**

## 技术方案

### 方案 1: 增强现有 `createGuardedPage` (推荐)

#### 优点

- ✅ 使用现有的 `enhanced-page-guard.js` 工具
- ✅ 统一的权限管理系统
- ✅ 易于维护和扩展

#### 实现步骤

1. **修改 `enhanced-page-guard.js` 的 `handleLoginRequired` 方法**
2. **将四个需要登录的 TabBar 页面都使用 `createGuardedPage` 包装**
3. **统一跳转到登录页,登录成功后返回首页**

### 方案 2: app.js 全局拦截 (不推荐)

#### 缺点

- ❌ 会拦截所有页面跳转,增加复杂度
- ❌ TabBar 切换机制特殊,难以精确控制返回逻辑
- ❌ 不符合微信小程序最佳实践

## 实施方案(方案 1 详细设计)

### 1. 修改登录拦截逻辑

**文件**: `/miniprogram/utils/enhanced-page-guard.js`

**修改 `handleLoginRequired` 方法**:

```javascript
/**
 * 处理登录要求 - 统一跳转逻辑
 */
handleLoginRequired(pagePath) {
  console.log(`页面 ${pagePath} 需要登录，跳转到登录页`);

  // 判断是否是 TabBar 页面
  const isTabBarPage = this.isTabBarPage(pagePath);

  wx.showModal({
    title: '需要登录',
    content: '此功能需要登录后才能使用，是否前往登录？',
    confirmText: '去登录',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        // TabBar页面登录后返回首页,其他页面返回原页面
        const returnPath = isTabBarPage ? '/pages/index/index' : pagePath;

        wx.redirectTo({
          url: `/pages/login/index?returnPath=${encodeURIComponent(returnPath)}`,
          fail: () => {
            wx.reLaunch({
              url: '/pages/login/index'
            });
          }
        });
      } else {
        // 用户取消,返回首页
        wx.switchTab({
          url: '/pages/index/index'
        });
      }
    }
  });
}

/**
 * 判断是否是 TabBar 页面
 */
isTabBarPage(pagePath) {
  const tabBarPages = [
    'pages/index/index',
    'pages/mistakes/list/index',
    'pages/learning/index/index',
    'pages/analysis/report/index',
    'pages/profile/index/index'
  ];

  return tabBarPages.some(tabPath => pagePath.includes(tabPath));
}
```

### 2. 统一四个需要登录的 TabBar 页面

#### 2.1 错题本页面 (已使用 `createGuardedPage`)

**文件**: `/miniprogram/pages/mistakes/list/index.js`

**当前状态**: ✅ 已正确使用

```javascript
const { createGuardedPage } = require('../../../utils/enhanced-page-guard.js')

const pageObject = {
  // ... 页面逻辑
}

// 使用守卫包装
Page(createGuardedPage(pageObject, 'pages/mistakes/list/index'))
```

#### 2.2 作业问答页面 (需要修改)

**文件**: `/miniprogram/pages/learning/index/index.js`

**当前代码** (Line 1-11):

```javascript
// pages/chat/index/index.js - AI问答对话页面

const { routeGuard } = require('../../../utils/route-guard.js');
const { authManager } = require('../../../utils/auth.js');
const { permissionManager } = require('../../../utils/permission-manager.js');
// ... 其他导入

Page({
  data: {
    // ... 数据
  },
```

**修改后**:

```javascript
// pages/chat/index/index.js - AI问答对话页面

const { createGuardedPage } = require('../../../utils/enhanced-page-guard.js')
const { authManager } = require('../../../utils/auth.js')
const { permissionManager } = require('../../../utils/permission-manager.js')
// ... 其他导入

const pageObject = {
  data: {
    // ... 数据
  },

  async onLoad(options) {
    // 移除手动的登录检查代码
    // ❌ 删除这些代码:
    // const isLoggedIn = await authManager.isLoggedIn();
    // if (!isLoggedIn) { ... }

    // 直接执行页面初始化逻辑
    console.log('AI问答页面加载', options)
    try {
      await this.initUserInfo()
      await this.initPermissions()
      await this.initSession()
      // ...
    } catch (error) {
      console.error('页面初始化失败:', error)
      this.showError('页面加载失败')
    }
  },

  // ... 其他方法
}

// 使用守卫包装
Page(createGuardedPage(pageObject, 'pages/learning/index/index'))
```

#### 2.3 学习报告页面 (需要修改)

**文件**: `/miniprogram/pages/analysis/report/index.js`

**当前代码** (Line 87-110):

```javascript
async onLoad(options) {
  console.log('学习报告页面加载');

  // 检查登录状态
  const isLoggedIn = await authManager.isLoggedIn();
  if (!isLoggedIn) {
    console.log('用户未登录，跳转到登录页面');
    wx.showModal({
      title: '需要登录',
      content: '查看学习报告需要先登录账户',
      success(res) {
        if (res.confirm) {
          wx.navigateTo({
            url: '/pages/login/index',
          });
        } else {
          // 用户取消，返回首页
          wx.switchTab({
            url: '/pages/index/index',
          });
        }
      },
    });
    return;
  }

  this.loadAnalyticsData();
},
```

**修改后**:

```javascript
const { createGuardedPage } = require('../../../utils/enhanced-page-guard.js')
const api = require('../../../api/index.js')
const { authManager } = require('../../../utils/auth.js')

const pageObject = {
  data: {
    // ... 数据
  },

  async onLoad(options) {
    console.log('学习报告页面加载')

    // 移除手动的登录检查,由 createGuardedPage 统一处理
    this.loadAnalyticsData()
  },

  // ... 其他方法
}

// 使用守卫包装
Page(createGuardedPage(pageObject, 'pages/analysis/report/index'))
```

#### 2.4 我的页面 (已使用 `routeGuard`)

**文件**: `/miniprogram/pages/profile/index/index.js`

**当前代码** (Line 1-49):

```javascript
const { routeGuard } = require('../../../utils/route-guard.js')
const { authManager } = require('../../../utils/auth.js')

Page({
  async onLoad(options) {
    // 执行路由守卫检查
    const guardResult = await routeGuard.checkPageAuth()
    if (!guardResult.success) {
      return
    }

    await this.initPage()
  },
  // ...
})
```

**修改后** (统一使用 `createGuardedPage`):

```javascript
const { createGuardedPage } = require('../../../utils/enhanced-page-guard.js')
const { authManager } = require('../../../utils/auth.js')

const pageObject = {
  data: {
    // ... 数据
  },

  async onLoad(options) {
    console.log('个人信息页面加载', options)

    // 移除手动的守卫检查,由 createGuardedPage 统一处理
    await this.initPage()
  },

  // ... 其他方法
}

// 使用守卫包装
Page(createGuardedPage(pageObject, 'pages/profile/index/index'))
```

### 3. 登录页面返回逻辑

**文件**: `/miniprogram/pages/login/index.js`

**确保登录成功后的跳转逻辑**:

```javascript
async onLoginSuccess(userInfo) {
  console.log('登录成功:', userInfo);

  // 保存用户信息
  await authManager.saveUserInfo(userInfo);

  // 获取返回路径
  const returnPath = this.data.returnPath || '/pages/index/index';

  wx.showToast({
    title: '登录成功',
    icon: 'success',
    duration: 1500,
    success: () => {
      setTimeout(() => {
        // 判断返回路径是否是TabBar页面
        const isTabBarPage = this.isTabBarPage(returnPath);

        if (isTabBarPage) {
          // TabBar页面使用switchTab
          wx.switchTab({
            url: returnPath,
            fail: () => {
              wx.switchTab({ url: '/pages/index/index' });
            }
          });
        } else {
          // 非TabBar页面使用redirectTo
          wx.redirectTo({
            url: returnPath,
            fail: () => {
              wx.switchTab({ url: '/pages/index/index' });
            }
          });
        }
      }, 1500);
    }
  });
}

isTabBarPage(path) {
  const tabBarPages = [
    '/pages/index/index',
    '/pages/mistakes/list/index',
    '/pages/learning/index/index',
    '/pages/analysis/report/index',
    '/pages/profile/index/index'
  ];

  return tabBarPages.some(tabPath => path.includes(tabPath));
}
```

### 4. 配置页面权限

**文件**: `/miniprogram/utils/enhanced-page-guard.js`

**确保 `PAGE_PERMISSION_CONFIG` 中的配置正确**:

```javascript
const PAGE_PERMISSION_CONFIG = {
  // 错题本 - 需要登录
  'pages/mistakes/list/index': {
    permissions: ['mistakes.view'],
    roles: ['student', 'parent', 'teacher'],
    requireLogin: true,
    description: '错题列表页面',
  },

  // 作业问答 - 需要登录
  'pages/learning/index/index': {
    permissions: ['chat.ask'],
    roles: ['student', 'parent', 'teacher'],
    requireLogin: true,
    description: 'AI问答页面',
  },

  // 学习报告 - 需要登录
  'pages/analysis/report/index': {
    permissions: ['analysis.view_self'],
    roles: ['student', 'parent', 'teacher'],
    requireLogin: true,
    description: '学习报告页面',
  },

  // 我的 - 需要登录
  'pages/profile/index/index': {
    permissions: ['profile.view_self'],
    roles: ['student', 'parent', 'teacher'],
    requireLogin: true,
    description: '个人信息页面',
  },

  // 首页 - 不需要登录
  'pages/index/index': {
    permissions: [],
    roles: [],
    requireLogin: false,
    description: '首页',
  },
}
```

## 用户体验流程

### 场景 1: 未登录用户点击"错题本"

```
1. 用户点击底部"错题本"按钮
2. 系统检测到未登录
3. 弹出提示框: "需要登录 - 此功能需要登录后才能使用，是否前往登录？"
   - [取消] 按钮 → 返回首页
   - [去登录] 按钮 → 跳转登录页
4. 用户登录成功
5. 自动返回首页(因为错题本是TabBar页面)
6. 用户可以再次点击"错题本"进入
```

### 场景 2: 未登录用户点击"作业问答"

```
1. 用户点击底部"作业问答"按钮
2. 系统检测到未登录
3. 弹出提示框: "需要登录 - 此功能需要登录后才能使用，是否前往登录？"
4. 用户选择登录
5. 登录成功后返回首页
6. 用户再次点击"作业问答"进入
```

### 场景 3: 未登录用户点击"学习报告"

```
1. 用户点击底部"学习报告"按钮
2. 系统检测到未登录
3. 统一提示登录
4. 登录成功后返回首页
```

### 场景 4: 未登录用户点击"我的"

```
1. 用户点击底部"我的"按钮
2. 系统检测到未登录
3. 统一提示登录
4. 登录成功后返回首页
```

## 代码修改清单

### 1. 核心工具修改

- [x] `/miniprogram/utils/enhanced-page-guard.js`
  - 修改 `handleLoginRequired` 方法
  - 添加 `isTabBarPage` 方法

### 2. 页面文件修改

- [x] `/miniprogram/pages/learning/index/index.js`

  - 移除手动登录检查
  - 改用 `createGuardedPage` 包装

- [x] `/miniprogram/pages/analysis/report/index.js`

  - 移除手动登录检查
  - 改用 `createGuardedPage` 包装

- [x] `/miniprogram/pages/profile/index/index.js`

  - 从 `routeGuard` 改为 `createGuardedPage`

- [x] `/miniprogram/pages/mistakes/list/index.js`
  - 保持现状 (已使用 `createGuardedPage`)

### 3. 登录页面修改

- [x] `/miniprogram/pages/login/index.js`
  - 完善登录成功后的返回逻辑
  - 区分 TabBar 页面和普通页面的跳转方式

## 测试用例

### 功能测试

| 测试场景           | 操作步骤                             | 预期结果       |
| ------------------ | ------------------------------------ | -------------- |
| 未登录点击错题本   | 1. 退出登录<br>2. 点击底部"错题本"   | 弹出登录提示框 |
| 未登录点击作业问答 | 1. 退出登录<br>2. 点击底部"作业问答" | 弹出登录提示框 |
| 未登录点击学习报告 | 1. 退出登录<br>2. 点击底部"学习报告" | 弹出登录提示框 |
| 未登录点击我的     | 1. 退出登录<br>2. 点击底部"我的"     | 弹出登录提示框 |
| 登录成功返回       | 1. 点击"去登录"<br>2. 完成登录       | 返回首页       |
| 取消登录返回       | 1. 点击"取消"                        | 返回首页       |
| 已登录访问         | 1. 登录状态<br>2. 点击任意 TabBar    | 正常进入页面   |

### 边界测试

| 测试场景   | 操作步骤                                   | 预期结果                      |
| ---------- | ------------------------------------------ | ----------------------------- |
| Token 过期 | 1. 登录后等待 Token 过期<br>2. 切换 TabBar | 自动刷新 Token 或提示重新登录 |
| 网络异常   | 1. 断网情况下访问                          | 友好的错误提示                |
| 角色切换   | 1. 切换角色<br>2. 访问不同页面             | 权限正确校验                  |

## 优点总结

✅ **统一体验**: 所有需要登录的功能提示方式一致  
✅ **代码复用**: 使用统一的 `createGuardedPage` 工具  
✅ **易于维护**: 权限逻辑集中在 `enhanced-page-guard.js`  
✅ **扩展性好**: 新增页面只需添加配置即可  
✅ **用户友好**: 清晰的提示和合理的返回逻辑

## 风险评估

⚠️ **TabBar 特殊性**: 微信小程序 TabBar 页面只能用 `switchTab` 跳转,需要特殊处理  
⚠️ **返回逻辑**: TabBar 页面登录后统一返回首页,用户需要再次点击目标页面  
⚠️ **兼容性**: 需要确保所有页面都正确使用 `createGuardedPage`

## 实施建议

1. **优先修改工具类** - 先完善 `enhanced-page-guard.js` 的核心逻辑
2. **逐个修改页面** - 按照清单依次修改各个页面文件
3. **充分测试** - 完成后进行全面的功能和边界测试
4. **灰度发布** - 建议先在开发环境验证,再发布到生产

---

**文档版本**: v1.0  
**创建时间**: 2025-10-19  
**适用版本**: 五好伴学小程序 v2.0+
