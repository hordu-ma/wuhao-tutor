# 五好伴学可观测性与运维指标规范 (OBSERVABILITY)

Last Updated: 2025-09-29
适用范围：后端 0.1.x（文档重构阶段，指标体系“初始落地 + 结构预留”）

---

## 1. 文档目的

本文件定义项目的“可观测性基线”，聚焦：
1. 当前已实现的监控/诊断能力（请求性能、限流状态、系统健康、慢查询追踪）
2. 指标与日志的命名规范（便于后续 Prometheus / Grafana / APM 接入）
3. 待引入的可视化、告警与追踪能力（Tracing / AI 调用统计 / 缓存命中率）
4. 开发新增指标时的流程与质量约束

该文档旨在让开发、运维、前端、测试在性能、容量、安全与用户体验问题上有共同诊断语言。

---

## 2. 可观测性组成 (三支柱 + 增补)

| 维度 | 当前状态 | 说明 | 规划增强 |
|------|----------|------|----------|
| Metrics（指标） | 已有内存级采集（请求耗时、分位数、限流、慢查询） | JSON 输出 | Prometheus Export |
| Logs（日志） | 控制台/文件（结构级未完全） | 可人工 grep / 分析 | 结构化 + 多目标输出 |
| Traces（调用链） | 未实现 | 无跨组件追踪 | OpenTelemetry SDK 接入 |
| Events（关键事件） | 部分（限流触发/AI失败） | 未统一格式 | 事件总线或分类日志 |
| Profiling（性能剖析） | 人工/临时 | 无持续工具化 | 采样式分析（Pyinstrument等） |
| Audit（审计） | 未落地 | 安全与合规不足 | 行为+配置变更记录 |

---

## 3. 指标采集总览现状

| 类别 | 已采集 | 数据源 | 说明 |
|------|--------|--------|------|
| 请求计数 | ✓ | 中间件 | 总次数 / 端点分布 |
| 请求耗时 | ✓ | 中间件 | 平均 / p95 / p99 |
| 慢端点列表 | ✓ | 内部内存结构 | 超阈值记录 |
| 限流计数 | ✓ | 限流器 | scope 粒度 |
| 限流事件详情 | ✓ | 限流器 | 当前窗口统计 |
| 系统 CPU/内存（基础） | ✓ | psutil | 定期采样 |
| 数据库慢查询 | ✓ | SQLAlchemy 监听 | 哈希+耗时 |
| 缓存命中率 | ✗ | - | 结构预留 |
| AI 调用统计 | 部分 | Service 包装 | 尚未统一指标格式 |
| 队列/任务调度 | ✗ | - | 未引入异步任务框架 |
| 错误率（按 code） | 部分 | 响应包装 | 尚未外显为指标 |
| Token/成本统计 | ✗ | - | AI 成本控制必需 |
| 进程资源（FD/线程数） | ✗ | - | 运维期增强 |
| GC 周期/延迟 | ✗ | - | 高性能阶段考虑 |

---

## 4. 核心监控端点

| 端点 | 功能 | 是否需鉴权 | 使用场景 | 规划外显格式 |
|------|------|------------|----------|--------------|
| `/health` | 基础健康（活性快速判断） | 否（生产可限制） | 负载均衡探活 | 简易 JSON |
| `/health/live` | 活性探针 | 否 | 容器编排 | 纯布尔/标记 |
| `/health/ready` | 就绪探针（依赖检查） | 否 / 内网 | 滚动发布判定 | 结构化 JSON |
| `/api/v1/health/performance` | 性能指标实时快照 | 是（可选开放） | 性能调试/压测 | JSON 聚合 |
| `/api/v1/health/rate-limits` | 当前限流状态 | 是 | 调试限流策略 | JSON 表格化 |
| `/api/v1/health/metrics` | 综合指标（系统+性能+限流） | 是 | 运维巡检 | JSON |
| `/api/v1/health/version` | 版本/构建信息（规划） | 否 | 部署审计 | JSON（含 commit） |
| `/metrics` (规划) | Prometheus 暴露 | 是（内网） | 指标采集 | 文本 exposition |

---

## 5. 指标命名规范（预设）

| 原则 | 说明 | 示例 |
|------|------|------|
| 全小写 + 下划线 | 统一风格 | `http_request_total` |
| 动词避免 | 多用资源+语义 | ✅ `db_slow_queries_total` |
| 计数器后缀 `_total` | Prometheus 约定 | `rate_limit_exceeded_total` |
| Gauge 不加后缀 | 可增减值 | `process_memory_bytes` |
| 直方图/分位 | `_seconds`/`_ms` 明确单位 | `request_latency_ms`（内部） |
| 标签精简 | 避免高基数 | `endpoint`, `method`, `status_class` |
| 避免用户级 label | 防爆炸 | 不做 `user_id` 标签 |
| 统一时间单位 | ms 作为内部展示 / 导出时转换 | p95 / p99 统一 ms |

---

## 6. 请求级指标定义（当前内存 + 规划导出）

| 指标 | 类型 | 描述 | 标签（规划） | 备注 |
|------|------|------|--------------|------|
| request_count_total | Counter | 总请求数 | method, endpoint, status_class | endpoint 可用归一化路径 |
| request_latency_ms | Summary/Histogram | 请求耗时 (ms) | method, endpoint | 维护 p50/p95/p99 |
| request_errors_total | Counter | 非 2xx/3xx 数量 | method, endpoint, status_code | 与错误码聚合区分 |
| request_in_progress | Gauge | 当前处理中的请求 | - | 并发分析 |
| request_slow_total | Counter | 超阈值（如 >500ms prod） | endpoint | 定制度调优 |
| response_size_bytes (规划) | Histogram | 响应体大小 | endpoint | 评估带宽压力 |

---

## 7. 限流指标

| 指标 | 类型 | 描述 | 标签 | 说明 |
|------|------|------|------|------|
| rate_limit_requests_total | Counter | 进入限流检查的请求 | scope | scope: ip/user/ai/login |
| rate_limit_exceeded_total | Counter | 被拒绝的请求 | scope | 监控误杀/攻击趋势 |
| rate_limit_current_counters | Gauge | 活跃计数器数量 | scope | 指标健康度 |
| rate_limit_reset_seconds (规划) | Gauge | 下次窗口重置剩余秒数 | scope | 仅在复杂调度需要 |
| soft_limit_warnings_total (规划) | Counter | 软限告警次数 | scope | 提前告警行为 |

---

## 8. 数据库与查询指标

| 指标 | 类型 | 描述 | 标签 | 说明 |
|------|------|------|------|------|
| db_queries_total | Counter | 所有执行查询数 | type (select/insert/update/delete) | 解析语句前缀获取 |
| db_query_latency_ms | Histogram | 单条查询耗时 | type | p95 用于识别 |
| db_slow_queries_total | Counter | 超阈值（prod≥500ms）查询次数 | type | 与慢查询日志联动 |
| db_active_connections | Gauge | 当前活跃连接 | - | 连接池健康 |
| db_pool_in_use (规划) | Gauge | 使用中的连接数 | - | 监控耗尽风险 |
| db_pool_idle (规划) | Gauge | 空闲连接数 | - | 调优参考 |
| db_pool_wait_seconds (规划) | Histogram | 获取连接等待时间 | - | 高则需扩容或优化查询 |

> 慢查询详细记录结构：`{hash, sql_excerpt, duration_ms, first_seen, last_seen, count}`

---

## 9. AI 调用指标（需补全）

| 指标 | 类型 | 描述 | 标签 | 说明 |
|------|------|------|------|------|
| ai_calls_total | Counter | AI 总调用次数 | model / operation | 区分问答 / 批改 |
| ai_latency_ms | Histogram | 单次 AI 调用耗时 | model | 观测性能 |
| ai_failures_total | Counter | 调用失败次数 | model / reason | reason: timeout/error/invalid |
| ai_tokens_prompt_total (规划) | Counter | 输入 tokens | model | 成本控制 |
| ai_tokens_completion_total (规划) | Counter | 输出 tokens | model | 成本聚合 |
| ai_cost_estimated (规划) | Counter | 估算费用（货币单位） | model | 单位：分/元 |

---

## 10. 缓存（预留）

| 指标 | 类型 | 描述 | 标签 | 说明 |
|------|------|------|------|------|
| cache_hits_total | Counter | 缓存命中次数 | cache_type | cache_type: query/session |
| cache_misses_total | Counter | 未命中次数 | cache_type | 用于命中率计算 |
| cache_evictions_total | Counter | 主动/过期剔除次数 | cache_type | 有助于调参 |
| cache_size_entries | Gauge | 当前缓存条目数 | cache_type | 监控溢出风险 |
| cache_hit_ratio (计算) | Derived | hits / (hits+misses) | cache_type | 展示层计算 |

---

## 11. 日志分类（建议基线）

| 分类 | 内容 | 级别建议 | 结构化字段 |
|------|------|----------|------------|
| access | 基础请求/响应摘要 | INFO | ts, method, path, status, latency_ms |
| performance | 慢端点 / 慢查询 | WARNING | ts, category, key, duration_ms |
| error | 未捕获异常 / 业务错误 | ERROR | ts, code, message, trace_id |
| security | 限流 / 非法访问 | WARNING | ts, ip, scope, action |
| ai | AI 调用轨迹（不含敏感 prompt） | INFO | ts, model, latency_ms, status |
| audit（规划） | 用户角色/配置变更 | INFO | ts, actor, action, target |
| startup | 应用启动配置摘要 | INFO | ts, version, env, components |

> 后续统一采用 JSON 行格式，字段避免层级过深。

---

## 12. 调用链追踪（Tracing 规划）

| 目标 | 描述 | 优先级 |
|------|------|--------|
| Trace-ID 贯通 | 每请求生成 trace_id 并注入日志 | P1 |
| 跨组件传播 | AI 调用 / DB 查询附加 trace_id | P2 |
| OpenTelemetry SDK | 快速集成 + 导出 OTLP | P2 |
| 采样策略 | 仅采样慢请求 / 错误请求 | P2 |
| 跨语言互操作 | 前端 / 反向代理 透传 header | P3 |

Header 约定（规划）：`X-Request-ID` / `X-Trace-ID`
生成方式：优先使用高性能随机（如 `uuid4` 或 64-bit 随机 + Base16）

---

## 13. 告警设计（初稿方案）

| 告警场景 | 触发条件示例（生产） | 优先级 | 行动建议 |
|----------|---------------------|--------|----------|
| 高错误率 | 5 分钟窗口 error_rate > 3% | 高 | 检查最近部署/依赖 |
| 慢查询激增 | 每分钟 slow_queries > 阈值（如 50） | 中 | 分析新发布 SQL |
| 限流异常 | rate_limit_exceeded_total 激增且 scope=per_user 分布集中 | 中 | 判断攻击或错误循环 |
| AI 失败率 | ai_failures_total / ai_calls_total > 10% | 高 | 降级/熔断 AI 功能 |
| 请求延迟上升 | p95_latency_ms > 2 * 基线 | 高 | 检查数据库/外部依赖 |
| CPU/内存 | memory_usage > 85% 持续 10 分钟 | 中 | 排查泄漏/负载 |
| 磁盘空间 | 剩余空间 < 15% | 中 | 清理归档/扩容 |
| 连接池耗尽 | 获取连接等待时间 > 200ms 中位 | 高 | 优化查询/增加池限制 |
| 缓存命中率下降 | hit_ratio < 40% (稳定态) | 低 | 分析热点失配 |

---

## 14. 仪表板建议布局（Dashboard Blueprint）

模块 1 - 总览（Overview）
- QPS（请求曲线）
- p50/p95/p99 延迟
- 错误率堆叠（4xx vs 5xx）
- 资源占用（CPU / 内存 / 连接）

模块 2 - API 性能
- Top N 慢端点
- 端点耗时排名（柱状）
- 端点调用分布（饼图 / TreeMap）
- 状态码分布

模块 3 - 数据库
- 查询类型分布 (select/update/…)
- 慢查询列表（表名/耗时）
- 连接池使用率（in_use / idle）
- 查询耗时直方图

模块 4 - AI
- 调用次数 / 失败率
- 耗时分位趋势
- 模型调用占比
- Tokens 消耗（规划）

模块 5 - 限流/安全
- 限流触发趋势（按 scope）
- 失败请求突增对比
- 可疑 IP 分布（规划）
- API 攻击模式（规划）

模块 6 - 系统内核
- CPU / 内存 / 磁盘
- GC 次数（规划）
- 进程 FD 使用（规划）
- 队列长度（未来异步任务）

---

## 15. 性能基线与对标（示例基线，可调整）

| 指标 | 当前估测（示例） | 基线目标（初版） | 警戒阈值（告警） |
|------|-----------------|------------------|------------------|
| 平均请求耗时 | 90–130ms | < 200ms | > 350ms |
| p95 请求耗时 | ~280ms | < 500ms | > 800ms |
| 错误率 | < 0.5% | < 1% | > 3% |
| 慢查询比例 | < 1% | < 2% | > 5% |
| AI 平均耗时 | 0.8–1.5s | < 2.5s | > 4s |
| AI 失败率 | < 2% | < 5% | > 10% |
| 限流命中率 | < 0.1% | < 0.5% | > 2% |
| 内存使用 | 稳定 | < 70% | > 85% |
| 连接池等待 | 低 | < 50ms | > 200ms |

> 后续建议建立“动态基线”：基于近 7 日滑动窗口计算自适应阈值。

---

## 16. 采样与保留策略（规划）

| 数据类型 | 保留策略 | 说明 |
|----------|----------|------|
| 原始高频请求指标 | 不长期保留（实时 + 近时窗口） | 聚合后持久化 |
| 分位延迟 | 5 分钟粒度保留 7–30 天 | 用于趋势分析 |
| 慢查询记录 | Top 500 按最近出现排序 | 淘汰策略 LRU |
| 限流事件 | 聚合统计（不保留单条） | 减少存储 |
| AI 调用统计 | 按日聚合（模型+操作类型） | 成本管理 |
| 日志（结构化） | INFO 7–14 天 / ERROR 30 天 | 视合规要求调整 |
| 审计日志（规划） | ≥180 天 | 角色/策略变更 |

---

## 17. 新增指标流程

| 步骤 | 动作 | 产出 |
|------|------|------|
| 1 | 评估是否已有等价指标 | 减少重复 | 说明文档 |
| 2 | 定义名称+类型+标签 | 遵循命名规范 | 指标声明 |
| 3 | 实现采集 | 中间件 / 钩子 / 监听器 | 代码提交 |
| 4 | 性能影响评估 | 是否高频锁/聚合导致开销 | 简要记录 |
| 5 | 更新文档（本文件） | 指标表格新增条目 | PR 说明 |
| 6 | 补测试（如适用） | 单元/集成 | 通过 CI |
| 7 | 观察期 | 初期观测指标稳定性 | 调整频率 |
| 8 | 接入可视化/告警 | Dashboard 与规则 | 运维联动 |

---

## 18. 反模式与禁止事项

| 反模式 | 危害 | 替代 |
|--------|------|------|
| 每请求内部打印详细日志 | IO 开销巨大 | 仅打印摘要，错误分支详尽 |
| 指标标签使用用户 ID | 高基数 / 泄露风险 | 聚合字段 |
| 为偶发 debug 添加永久指标 | 增维护成本 | 使用临时统计或日志 |
| 在热点路径重型统计锁 | 性能退化 | 无锁累加/采样 |
| 直接导出超大 JSON（上万条慢查询） | 占用内存/传输慢 | 限制条数/分页 |
| 用指标替代事件日志（反之亦然） | 不便于查询 | 区分用途：指标=趋势，日志=上下文 |
| 指标单位未记录 | 歧义 | 名称或文档标明单位 |
| 逻辑态状态码混淆（200 + 错误语义） | 统计失真 | 合规使用 4xx/5xx |

---

## 19. 当前缺口（Gap Analysis）

| Gap | 影响 | 优先级 | 解决思路 |
|-----|------|--------|----------|
| 无 Prometheus Export | 无法接入通用监控平台 | 高 | 增 `/metrics` 端点 |
| 缺 trace_id 贯通 | 跨模块问题定位困难 | 高 | 请求中间件生成/透传 |
| AI tokens 未统计 | 成本不可见 | 高 | 服务封装记录 tokens 字段 |
| 缓存指标缺失 | 缓存策略优化缺依据 | 中 | 接入统一缓存包装 |
| 错误码统计未结构化 | 告警粒度粗 | 中 | 记录 `error_code` Counter |
| 审计日志缺失 | 风险追溯困难 | 中 | 统一写入专属 Channel |
| 日志非结构化 | 分析、聚合困难 | 中 | JSON 行日志 |
| 资源基线无趋势持久化 | 容量预测困难 | 低 | 定期快照存储 |
| 自动基线 / 动态告警缺失 | 告警噪音 | 低 | 引入滑动窗口算法 |

---

## 20. 路线图 (Roadmap)

| 版本阶段 | 目标 | 核心事项 |
|----------|------|----------|
| 0.2.x | 指标对外导出 | Prometheus `/metrics` |
| 0.3.x | Trace & Tokens | OpenTelemetry(最小集) + AI tokens |
| 0.4.x | 缓存与错误细化 | Cache 指标 + error_code Counter |
| 0.5.x | 审计与可视化 | 审计日志 + 仪表板模板 |
| 0.6.x | 动态告警 | 自适应阈值算法 |
| 1.0.0 | 稳定成熟 | 完整三支柱融合与回归测试 |

---

## 21. FAQ

| 问题 | 回答 |
|------|------|
| 指标会显著增加性能开销吗？ | 当前为轻量内存聚合，不写磁盘，影响可控。 |
| 为什么暂不引入全链路追踪？ | 现阶段调用链较浅，先完善指标与错误归类。 |
| 是否需要引入 APM（如 Jaeger/Tempo）？ | 等异步任务 / 多外部依赖扩张后评估。 |
| 指标是否会内存膨胀？ | 有定期清理策略（超时窗口 / Top-N 截断）。 |
| 预期分位统计算法？ | 初期手动计算/简单存储，后期交给 Prometheus Histogram。 |
| 更新本文件的时机？ | 新增/移除指标、发布前评审、性能策略调整。 |
| 可以临时打印调试信息吗？ | 可以，但需在合并前移除或受 DEBUG 配置控制。 |
| 如何判断指标是否“值得”加入？ | 是否可驱动决策 / 是否高价值复用 / 是否可低成本获取。 |

---

## 22. 变更日志（本文件）

| 日期 | 版本 | 变更 | 描述 |
|------|------|------|------|
| 2025-09-29 | draft-1 | 初稿 | 架构化骨架与现状盘点 |
| (待填) | ... | ... | ... |

---

## 23. 维护与反馈

如遇：
- 指标含义不清 / 重名 / 数据异常
- 文档与实际实现不一致
- 需要新增或废弃指标
- 告警噪音或缺失

请：
1. 建 Issue（标签：observability）
2. 填写：背景 → 影响 → 现状数据截图/示例 → 建议方案
3. 变更后更新本文件对应章节

---

## 24. 附录：采集层示意（当前 → 目标）

```
┌──────────────────────────────────────────┐
│ Incoming Request                         │
└───────────────┬─────────────────────────┘
                │
        ┌───────▼─────────┐
        │  监控中间件      │  统计: 请求耗时/计数
        └───────┬─────────┘
                │
        ┌───────▼─────────┐
        │   业务逻辑       │  调用：DB / AI / Cache
        └───┬────────┬────┘
            │        │
   ┌────────▼───┐ ┌──▼────────┐
   │ DB 监听层  │ │ AI 包装层 │ 记录 SQL/AI 指标
   └────┬───────┘ └────┬──────┘
        │              │
   ┌────▼───────┐ ┌────▼───────┐
   │ 内存聚合器 │ │ 日志渠道   │
   └────┬───────┘ └────┬───────┘
        │              │
   ┌────▼────────────────────────────┐
   │ /api/v1/health/* JSON 输出      │
   │ /metrics (规划) Prometheus Export│
   └─────────────────────────────────┘
```

---

## 25. 行动优先建议（立即可执行）

| 优先级 | 任务 | 说明 |
|--------|------|------|
| P0 | 明确定义“慢请求阈值”在配置中 | 便于动态调整与环境差异 |
| P0 | 增加 error_code 计数器聚合 | 支撑错误趋势分析 |
| P1 | 统一 trace_id 注入日志与响应头 | 便捷跨层跟踪 |
| P1 | 拆分导出 Prometheus 基础指标 | 建立仪表统一接口 |
| P2 | AI tokens 统计字段接入 | 成本/优化决策数据 |
| P2 | 缓存模块加命中率指标（占位实现） | 为缓存策略迭代准备 |
| P3 | Dashboard 原型文档生成 | 降低运维接入成本 |
| P3 | 引入慢查询自动归类（表级聚合） | 提升调优效率 |

---

_本文件为“活体文档”，任何与其不一致的实现需在合并前或合并后 24 小时内同步更新。_

（END）
