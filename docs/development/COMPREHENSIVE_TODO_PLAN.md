# 五好伴学 - 全链条对齐开发补齐计划

> **生成时间**: 2025-10-05  
> **基于文档**: CODE_ALIGNMENT_ANALYSIS.md  
> **项目版本**: 0.4.x  
> **总工时预估**: 198 小时（约 25 个工作日）

---

## 🎯 总体目标

基于代码对齐分析报告，完成**文档计划 → 后端代码 → 后端 API → 前端 API → 前端页面**的全链条对齐，解决当前**70%对齐度**中的关键缺失项，最终达到**90%+整体对齐度**。

---

## 🔥 P0 - 立即修复（必须完成，本周内）

### 1. MCP 上下文服务开发 [TD-006] ✅ **已完成 85%**

**优先级**: 🔥 最高 | **工时**: 16h | **截止**: Week 2 | **实际完成**: 13.5h

#### 1.1 创建 KnowledgeContextBuilder 服务类 ✅ **已完成**

- [x] 在`src/services/`下创建`knowledge_context_builder.py` ✅
- [x] 设计`build_context(user_id, subject, session_type)`方法签名 ✅
- [x] 定义上下文数据结构 Schema（薄弱知识点、学习偏好、错题统计等） ✅
- [x] 实现基础的依赖注入和异步初始化 ✅
- [x] 编写基础单元测试框架 ✅

#### 1.2 实现薄弱知识点分析算法 ✅ **已完成**

- [x] 查询用户历史答题记录，计算各知识点错误率 ✅
- [x] 实现时间衰减权重算法（近期错误权重更高） ✅
- [x] 筛选错误率<60%的薄弱知识点，按严重程度排序 ✅
- [x] 集成知识图谱关系，分析知识点前置依赖 ✅
- [x] 编写薄弱知识点分析的单元测试 ✅

#### 1.3 实现学习偏好分析 ✅ **已完成**

- [x] 统计用户各学科学习时长和活跃度 ✅
- [x] 分析用户偏好的题目难度分布 ✅
- [x] 统计用户学习时间段偏好（上午/下午/晚上） ✅
- [x] 分析用户互动偏好（文字/图片/语音等） ✅
- [x] 生成个性化学习偏好画像 ✅

#### 1.4 集成到现有服务 ✅ **已完成**

- [x] 在`LearningService.ask_question()`中集成 MCP 上下文 ✅
- [x] 在`HomeworkService.create_submission()`中集成学情上下文 ✅
- [x] 修改 AI 服务调用，传入个性化上下文参数 ✅
- [x] 更新相关 API 响应格式，包含上下文使用情况 ✅
- [x] 进行端到端集成测试 ✅

#### 1.5 性能优化和缓存 ⏸️ **暂时跳过，留待P1优先级**

- [ ] ⏸️ 实现上下文结果缓存机制（Redis）
- [ ] ⏸️ 优化数据库查询性能（确保<50ms）
- [ ] ⏸️ 实现异步上下文构建，避免阻塞用户请求
- [ ] ⏸️ 添加监控指标和性能日志
- [ ] ⏸️ 压力测试和性能基准测试

**🎉 TD-006 核心功能已完成！已实现：**
- ✅ KnowledgeContextBuilder 完整服务实现
- ✅ 薄弱知识点分析算法（时间衰减+严重性评分）
- ✅ 学习偏好提取（5个维度分析）
- ✅ 上下文摘要生成
- ✅ LearningService 和 HomeworkService 集成
- ✅ 完整单元测试覆盖（21个测试全部通过）
- ✅ 真实环境集成验证通过

### 2. 作业批改查询 API 重构

**优先级**: 🔥 高 | **工时**: 8h | **截止**: Week 2

#### 2.1 重构 submissions 查询端点

- [ ] 修改`GET /homework/submissions`，移除硬编码示例数据
- [ ] 实现真实的数据库查询，支持分页、筛选、排序
- [ ] 添加提交状态、批改状态、创建时间等筛选条件
- [ ] 实现批改结果摘要信息返回
- [ ] 编写查询功能的单元测试

#### 2.2 重构 submission 详情端点

- [ ] 修改`GET /homework/submissions/{id}`，返回真实数据
- [ ] 实现完整的提交详情查询，包含 OCR 结果、批改结果
- [ ] 添加权限验证，确保用户只能查看自己的提交
- [ ] 优化查询性能，减少 N+1 查询问题
- [ ] 添加详情查询的集成测试

#### 2.3 重构批改结果端点

- [ ] 修改`GET /homework/submissions/{id}/correction`
- [ ] 返回真实的批改详情、逐题分析、知识点评估
- [ ] 实现批改结果的格式化输出（支持 markdown）
- [ ] 添加批改质量评分和改进建议
- [ ] 实现批改结果的缓存机制

#### 2.4 重构统计数据端点

- [ ] 修改`GET /homework/stats`，返回真实统计数据
- [ ] 实现用户作业完成率、正确率、学科分布统计
- [ ] 添加时间段统计（日、周、月）
- [ ] 实现对比分析（与历史数据、平均水平对比）
- [ ] 添加统计数据的定时更新机制

#### 2.5 前端页面适配

- [ ] 更新`Homework.vue`，移除模拟数据展示逻辑
- [ ] 实现真实的作业历史列表展示
- [ ] 添加加载状态、错误处理、空状态展示
- [ ] 实现批改详情的完整展示功能
- [ ] 添加用户友好的错误提示和重试机制

### 3. 前端 API 错误处理修复

**优先级**: 🔥 高 | **工时**: 2h | **截止**: Week 2

#### 3.1 修复 Promise.reject 导致的崩溃

- [ ] 修改`frontend/src/api/analytics.ts`中的 6 个 reject 方法
- [ ] 将所有`Promise.reject`改为返回合理的默认值
- [ ] 统一错误处理格式，返回标准的 API 响应结构
- [ ] 添加 console.warn 提示功能开发中
- [ ] 测试所有修改的 API 方法，确保不会导致页面崩溃

#### 3.2 统一 API 错误处理机制

- [ ] 创建统一的`unavailableAPI`错误处理函数
- [ ] 定义标准的"功能开发中"响应格式
- [ ] 替换所有 TODO 标记的 API 方法
- [ ] 实现前端友好的错误提示组件
- [ ] 添加 API 状态监控和错误收集

#### 3.3 前端容错性增强

- [ ] 在所有使用 analytics API 的组件中添加错误边界
- [ ] 实现数据为空时的友好展示界面
- [ ] 添加重试机制和手动刷新按钮
- [ ] 优化加载状态和错误状态的用户体验
- [ ] 进行前端错误处理的全面测试

---

## 🟡 P1 - 高优先级（核心功能，Week 3-5）

### 4. 流式响应实现 [TD-007]

**优先级**: 🟡 高 | **工时**: 12h | **截止**: Week 3

#### 4.1 后端 SSE 服务开发

- [ ] 创建`StreamingService`类，实现 Server-Sent Events
- [ ] 修改`LearningService.ask_question()`支持流式输出
- [ ] 实现流式 AI 服务调用，分块返回生成内容
- [ ] 添加流式响应的错误处理和连接管理
- [ ] 创建流式响应的 API 端点和中间件

#### 4.2 前端 EventSource 集成

- [ ] 在`Learning.vue`中实现 EventSource 连接管理
- [ ] 创建流式消息接收和展示组件
- [ ] 实现打字机效果和实时内容更新
- [ ] 添加连接断开重连机制
- [ ] 优化流式响应的用户交互体验

#### 4.3 流式响应优化

- [ ] 实现流式响应的取消机制
- [ ] 添加流式响应进度指示器
- [ ] 优化大文本流式输出的性能
- [ ] 实现流式响应的缓存策略
- [ ] 进行流式响应的压力测试

### 5. 请求缓存机制 [TD-008]

**优先级**: 🟡 高 | **工时**: 8h | **截止**: Week 3

#### 5.1 相似度算法实现

- [ ] 实现问题文本相似度计算算法（TF-IDF/余弦相似度）
- [ ] 创建问题特征提取和向量化服务
- [ ] 实现快速相似度检索算法
- [ ] 设定相似度阈值和缓存策略
- [ ] 添加相似度算法的单元测试

#### 5.2 缓存存储和管理

- [ ] 设计缓存数据结构（Redis）
- [ ] 实现缓存的增删改查操作
- [ ] 添加缓存过期策略和 LRU 淘汰机制
- [ ] 实现缓存命中率监控
- [ ] 优化缓存性能和内存使用

#### 5.3 集成到 AI 服务

- [ ] 在`BailianService`中集成缓存检查
- [ ] 实现缓存命中时的快速响应
- [ ] 添加缓存 miss 时的正常 AI 调用
- [ ] 实现缓存结果的后处理和个性化调整
- [ ] 测试缓存对 AI 服务性能的提升效果

### 6. 基础学情分析 API 开发

**优先级**: 🟡 高 | **工时**: 8h | **截止**: Week 4

#### 6.1 学习进度 API 实现

- [ ] 创建`GET /analytics/learning-progress`端点
- [ ] 实现学习时长、完成率、正确率趋势分析
- [ ] 支持不同时间粒度的进度查询（日/周/月）
- [ ] 实现学科维度的进度对比分析
- [ ] 添加进度预测和目标达成分析

#### 6.2 知识点掌握 API 实现

- [ ] 创建`GET /analytics/knowledge-points`端点
- [ ] 实现知识点掌握度统计和分析
- [ ] 支持学科筛选和掌握度排序
- [ ] 实现知识点关联分析和推荐
- [ ] 添加知识点掌握趋势分析

#### 6.3 学科统计 API 实现

- [ ] 创建`GET /analytics/subject-stats`端点
- [ ] 实现各学科学习时长、题目数量统计
- [ ] 计算学科平均分、提升趋势
- [ ] 实现学科对比分析和排行
- [ ] 添加学科推荐和学习建议

### 7. 错题本功能完整实现 [TD-009]

**优先级**: 🟡 高 | **工时**: 16h | **截止**: Week 4

#### 7.1 错题数据模型设计

- [ ] 创建`ErrorQuestion`模型，包含题目、错误类型、知识点
- [ ] 设计错题分类体系（计算错误、概念理解、解题方法等）
- [ ] 实现错题与知识点的关联关系
- [ ] 添加错题复习记录和掌握状态跟踪
- [ ] 创建数据库迁移和初始化脚本

#### 7.2 错题收集服务

- [ ] 创建`ErrorNotebookService`错题本服务
- [ ] 实现从作业批改结果自动收集错题
- [ ] 实现从学习问答中手动收集错题
- [ ] 添加错题分类和标签功能
- [ ] 实现错题去重和合并算法

#### 7.3 错题分析算法

- [ ] 实现错题类型自动识别算法
- [ ] 开发错题知识点关联分析
- [ ] 实现错题难度评估和分级
- [ ] 创建错题复习优先级算法
- [ ] 添加错题学习效果评估

#### 7.4 错题 API 端点开发

- [ ] 创建错题 CRUD API 端点
- [ ] 实现错题查询、筛选、分页功能
- [ ] 添加错题统计和分析 API
- [ ] 实现错题复习记录 API
- [ ] 创建错题导出和分享功能

#### 7.5 前端错题本页面

- [ ] 创建错题本主页面和路由
- [ ] 实现错题列表展示和筛选功能
- [ ] 添加错题详情查看和编辑功能
- [ ] 实现错题复习和练习模式
- [ ] 添加错题统计图表和分析展示

---

## 🟢 P2 - 中优先级（进阶功能，Week 6-9）

### 8. 学习目标管理系统

**优先级**: 🟢 中 | **工时**: 12h | **截止**: Week 7

#### 8.1 目标模型和服务开发

- [ ] 创建`LearningGoal`模型（目标类型、期限、达成条件）
- [ ] 实现目标 CRUD 服务和 API 端点
- [ ] 添加目标进度计算和跟踪算法
- [ ] 实现目标推荐和智能建议功能
- [ ] 创建目标提醒和通知机制

#### 8.2 前端目标管理界面

- [ ] 创建目标设定向导和表单
- [ ] 实现目标列表和进度展示
- [ ] 添加目标编辑和完成功能
- [ ] 实现目标统计和成就展示
- [ ] 优化目标管理的用户体验

### 9. 成就系统开发

**优先级**: 🟢 中 | **工时**: 16h | **截止**: Week 8

#### 9.1 成就系统设计

- [ ] 设计成就分类体系（学习时长、答题正确率、连续学习等）
- [ ] 创建`Achievement`和`UserAchievement`模型
- [ ] 实现成就解锁条件判断算法
- [ ] 设计成就等级和奖励机制
- [ ] 创建成就数据初始化脚本

#### 9.2 成就服务和 API

- [ ] 创建`AchievementService`成就服务
- [ ] 实现成就检查和自动解锁功能
- [ ] 创建成就查询和统计 API
- [ ] 实现成就排行榜功能
- [ ] 添加成就分享和展示功能

#### 9.3 前端成就展示

- [ ] 创建成就展示页面和组件
- [ ] 实现成就解锁动画和提示
- [ ] 添加成就排行榜和对比功能
- [ ] 实现成就分享和社交功能
- [ ] 优化成就系统的视觉设计

### 10. 学习日历和提醒

**优先级**: 🟢 中 | **工时**: 12h | **截止**: Week 9

#### 10.1 学习日历功能

- [ ] 创建学习日历数据模型
- [ ] 实现学习计划制定和管理
- [ ] 添加学习热力图生成算法
- [ ] 实现日程冲突检测和建议
- [ ] 创建学习统计和分析功能

#### 10.2 智能提醒系统

- [ ] 创建`StudyReminder`模型和服务
- [ ] 实现提醒规则设定和管理
- [ ] 添加智能提醒推荐算法
- [ ] 实现多渠道提醒（邮件、站内信）
- [ ] 创建提醒效果统计和优化

#### 10.3 前端日历界面

- [ ] 创建学习日历展示组件
- [ ] 实现日程安排和编辑功能
- [ ] 添加提醒设置和管理界面
- [ ] 实现学习热力图可视化
- [ ] 优化日历的交互体验

### 11. 数据导出功能

**优先级**: 🟢 中 | **工时**: 8h | **截止**: Week 9

#### 11.1 数据导出服务

- [ ] 创建`DataExportService`导出服务
- [ ] 实现 PDF 学习报告生成功能
- [ ] 添加 CSV 数据表格导出功能
- [ ] 实现 JSON 原始数据导出功能
- [ ] 创建导出任务队列和进度跟踪

#### 11.2 报告生成优化

- [ ] 设计 PDF 报告模板和样式
- [ ] 实现数据图表的 PDF 嵌入
- [ ] 添加报告个性化定制功能
- [ ] 优化大数据量的导出性能
- [ ] 实现导出结果的下载管理

#### 11.3 前端导出界面

- [ ] 创建数据导出向导界面
- [ ] 实现导出进度显示和下载功能
- [ ] 添加导出历史和管理功能
- [ ] 实现导出格式预览功能
- [ ] 优化导出功能的用户体验

---

## ⚪ P3 - 低优先级（RAG 增强，Week 10-14）

### 12. RAG 向量检索系统 [TD-012~015]

**优先级**: ⚪ 低 | **工时**: 48h | **截止**: Week 14

#### 12.1 PGVector 集成 [TD-012]

- [ ] 安装和配置 PostgreSQL PGVector 扩展
- [ ] 为相关表添加向量列（answers, questions 等）
- [ ] 创建向量索引（IVFFLAT/HNSW）
- [ ] 实现向量相似度查询功能
- [ ] 优化向量查询性能

#### 12.2 Embedding 服务对接 [TD-013]

- [ ] 集成通义千问 Embedding API
- [ ] 实现文本向量化服务
- [ ] 添加批量向量化功能
- [ ] 实现历史数据向量化迁移
- [ ] 优化向量化性能和成本

#### 12.3 语义检索服务 [TD-014]

- [ ] 实现相似错题检索功能
- [ ] 添加历史问答语义检索
- [ ] 创建知识文档语义检索
- [ ] 实现多模态内容检索
- [ ] 优化检索精度和召回率

#### 12.4 混合检索策略 [TD-015]

- [ ] 实现 MCP 精确查询+RAG 语义检索融合
- [ ] 创建重排序算法（时间衰减+相似度）
- [ ] 实现 A/B 测试框架
- [ ] 添加检索效果评估指标
- [ ] 优化混合检索性能

#### 12.5 RAG 系统测试

- [ ] 创建 RAG 系统的端到端测试
- [ ] 进行性能基准测试
- [ ] 实现用户体验验证
- [ ] 优化系统稳定性
- [ ] 部署生产环境配置

---

## 📊 开发进度跟踪

### 工时分布

- **P0 立即修复**: 26 小时（3-4 天）
- **P1 高优先级**: 60 小时（7-8 天）
- **P2 中优先级**: 64 小时（8 天）
- **P3 低优先级**: 48 小时（6 天）
- **总计**: 198 小时（约 25 个工作日）

### 里程碑节点

- **Week 2 (10/06-10/12)**: P0 任务全部完成，系统基础功能稳定
- **Week 5 (10/27-11/02)**: P1 任务全部完成，核心功能完整
- **Week 9 (11/24-11/30)**: P2 任务全部完成，进阶功能可用
- **Week 14 (12/29-01/05)**: P3 任务全部完成，RAG 系统上线

### 验收标准

- **功能完整性**: 所有计划功能正常工作
- **性能指标**: API 响应时间 P95<200ms，数据库查询 P95<50ms
- **代码质量**: 单元测试覆盖率>80%，代码 Review 通过
- **用户体验**: 前端页面交互流畅，错误处理完善
- **整体对齐度**: 达到 90%+的全链条对齐度

---

## 🛠️ 开发工具和规范

### 开发环境

- **后端**: Python 3.11+ + FastAPI + SQLAlchemy 2.x
- **前端**: Vue 3.4+ + TypeScript + Element Plus
- **数据库**: PostgreSQL 14+ (生产) / SQLite (开发)
- **缓存**: Redis 6+
- **AI 服务**: 阿里云百炼智能体

### 代码规范

- **提交格式**: `type(scope): description`
- **分支策略**: feature/task-id-description
- **测试要求**: 核心功能单元测试覆盖率 80%+
- **性能要求**: API 响应时间<200ms，数据库查询<50ms

### 质量控制

- **代码 Review**: 每个 PR 需要 Review 通过
- **自动化测试**: CI/CD 流水线自动运行测试
- **性能监控**: 实时监控关键指标
- **用户反馈**: 定期收集和处理用户反馈

---

**创建时间**: 2025-10-05  
**维护者**: AI Agent  
**联系方式**: maliguo@outlook.com  
**文档版本**: v1.0
