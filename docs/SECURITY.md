# 五好伴学安全与合规基线 (SECURITY)

Last Updated: 2025-09-29
适用范围：后端 0.1.x（未发布稳定版，安全策略处于“基础可控 + 渐进强化”阶段）

---

## 1. 文档目的

本文件定义项目当前的安全基线、控制措施、风险清单与未来演进路线，确保：
- 最小可行防护可被持续执行
- 安全策略“可读、可审、可验证”
- 开发、运维、前端与测试在“统一语义”下协同
- 后续增强有清晰优先级与路径

> 注意：生产部署前，需执行本文件第 15 节《上线前安全核对清单》。

---

## 2. 安全目标与范围

| 目标 | 描述 | 当前状态 |
|------|------|----------|
| 机密性 | 不泄露敏感凭证、用户数据 | 基础措施已落地 |
| 完整性 | 防止请求篡改与错误写入 | 依赖校验与基础验证 |
| 可用性 | 防滥用 / 防过载 / 可降级 | 已有多维限流；降级策略规划中 |
| 可追溯性 | 关键操作可审计 & 重放分析 | 日志结构化规划中（初级） |
| 最小暴露 | 仅暴露必须端点与信息 | 健康与监控端点待权限分层 |
| 渐进演进 | 支持迭代增强而不破坏现状 | 文档化路线已列出 |

---

## 3. 自上而下威胁概览 (Threat Model Snapshot)

| 威胁类别 | 典型场景 | 当前控制 | 风险级 | 后续增强 |
|----------|----------|----------|--------|----------|
| API 滥用 | 高频调用、刷接口 | 限流 (IP/用户/AI/登录) | 中 | 加速率自适应、行为画像 |
| 凭证泄露 | 环境变量/日志暴露 | 环境模板 + 不打印敏感信息 | 中 | 引入密钥轮换策略自动化 |
| 注入类攻击 | 拼接 SQL / 序列化风险 | ORM + 参数绑定 | 低 | 增加查询审计 |
| 异常信息外泄 | 返回堆栈 / 内部路径 | 统一错误包装 | 低 | 增强统一异常层测试 |
| 文件上传风险 | 恶意脚本 / 特殊格式伪装 | 大小/扩展名初筛 | 中 | MIME 深检 + 隔离扫描 |
| DoS/资源耗尽 | 嵌套调用 / AI 慢响应堆积 | 限流 + 超时 | 中 | 加入全局并发阈值与熔断 |
| 横向权限越界 | 访问他人资源 | DAO 维度校验待全面覆盖 | 中 | 授权拦截器（资源级） |
| AI 滥用/越界 | Prompt 注入 / 滥用调用 | 限流 + 请求最小化传递 | 中 | Prompt 过滤 + 输出合规扫描 |
| 敏感配置漂移 | 环境不一致 / 手工改动 | env 脚本 + 模板化 | 中 | 配置完整性哈希校验 |
| 数据一致性破坏 | 部分写入失败 | 异步较少；事务封装 | 低 | 增幂等与写入日志缓冲 |
| 日志敏感数据 | Token/密钥写入 | 明确禁止输出 | 中 | 日志过滤器+检测工具 |
| 过期会话复用 | Token 长生命周期 | 认证未完成（规划中） | 高 | 引入 JWT + TTL + 刷新机制 |

---

## 4. 安全设计原则

| 原则 | 说明 | 实施要点 |
|------|------|----------|
| 最小权限 (Least Privilege) | 组件、身份只拥有必要权限 | 独立 DB 用户 / 读写分离规划 |
| 显式拒绝 (Explicit Deny) | 未明示允许即拒绝 | CORS 白名单 / Host 校验 |
| 防御纵深 (Defense in Depth) | 分层隔离，单点失守不致命 | Nginx / 中间件 / ORM / 统一错误 |
| 可观测 (Observable) | 安全事件可度量与追踪 | 限流 / 失败率 / 依赖探针 |
| 安全默认 (Secure by Default) | 默认选择安全配置 | 生产环境强制 HTTPS/HSTS |
| 失败安全 (Fail-Safe) | 失败偏向“关闭”而非“放行” | 依赖不可用时禁止高危操作 |
| 不信任输入 (Zero Trust Input) | 所有外部输入严格验证 | Pydantic 模型 + 类型限制 |

---

## 5. 环境与边界控制

| 层级 | 控制措施 | 说明 |
|------|----------|------|
| 外层 (Reverse Proxy) | Nginx：TLS、基本限流、静态缓存、安全头备份 | 生产强制启用 |
| 应用服务 | FastAPI 中间件：安全头 / 限流 / 性能监控 / Host | 本层执行逻辑隔离 |
| 数据层 | PostgreSQL 最小权限账号 | 不使用超级用户 |
| 缓存层 | Redis（后续加入 AUTH）| 规划加 ACL 与命名空间 |
| 文件存储 | 当前本地 / 规划对象存储 | 需补访问隔离与清理策略 |
| 脚本执行 | 脚本 ID/权限分离 | 防误操作同环境执行 |

---

## 6. 身份认证与授权（当前与规划）

| 方面 | 当前 | 风险 | 规划 |
|------|------|------|------|
| 用户认证 | 尚未正式 JWT / Session 实现 | 所有端点视为内测场景 | 引入 JWT Access + Refresh |
| 授权模型 | 粗粒度（默认允许） | 不能区分角色 | 角色: student / teacher / admin |
| 资源绑定 | 需要调用处手工校验 | 漏判风险 | 统一装饰器/依赖注入校验资源属主 |
| Token 存储 | 规划 | - | HS256/JWE + 旋转策略 |
| 会话撤销 | 未实现 | 无法主动失效 | 加黑名单/版本戳 (token version) |
| 密码策略 | 未启用 | - | 最低长度+哈希 (bcrypt/argon2) |
| 多因素认证 | 不支持 | - | 后期可扩展 (TOTP/WebAuthn) |

---

## 7. 访问控制与限流策略

| 限流类别 | 说明 | 默认 (dev) | 默认 (prod 规划) | 响应 |
|----------|------|-----------|------------------|------|
| per_ip | 单 IP 每分钟请求阈值 | 1000 | 60–120 | 429 |
| per_user | 鉴权用户每分钟请求 | 500 | 30–60 | 429 |
| ai_service | AI 调用频率 | 100 | 10–20 | 429 |
| login | 登录尝试 | 30 | 5 | 429 + Trace |
| 重置策略 | 滑动窗口/令牌桶双机制 | 是 | 是 | - |
| Header 反馈 | （规划）X-RateLimit-* | 部分 | 全量 | 可用于前端提示 |

后续：
- 熔断：连续外部依赖失败 → 暂时拒绝 AI 类调用
- 软限（警告模式）：接近阈值返回提示头，不立即阻断

---

## 8. 输入与输出安全

| 关注点 | 措施 | 备注 |
|--------|------|------|
| JSON 注入 | Pydantic 严格校验 | 不接受未定义字段（可配置） |
| SQL 注入 | 使用 ORM + 参数绑定 | 禁止拼接原始 SQL 字符串 |
| 路径/ID 校验 | UUID 格式约束 | 不接受自由文本 ID |
| HTML 注入 | 当前返回均为纯文本 | 前端显示时执行转义 |
| 序列化泄露 | 输出层用响应模型裁剪 | 不返回 ORM 直接对象 |
| 错误信息 | 统一包装结构 | 不含堆栈/绝对路径 |
| 日志注入 | 对外部输入日志字段做最小必要 | 未来加日志清洗 |

---

## 9. 安全头 (HTTP Security Headers)

| Header | 状态 | 生产策略示例 | 说明 |
|--------|------|--------------|------|
| Strict-Transport-Security | ✅ | max-age=31536000; includeSubDomains; preload | 强制 HTTPS |
| Content-Security-Policy | ✅ | default-src 'self'; script-src 'self'; object-src 'none'; frame-ancestors 'none' | 防 XSS/Clickjacking |
| X-Content-Type-Options | ✅ | nosniff | 防 MIME 混淆 |
| X-Frame-Options | ✅ | DENY | 防 iframe 嵌套 |
| Referrer-Policy | ✅ | no-referrer | 限制来源泄露 |
| Permissions-Policy | ✅ | camera=(), geolocation=(), microphone=() | 最小暴露硬件能力 |
| Cache-Control (敏感) | 部分 | no-store / private | 认证端点响应 |
| Cross-Origin-Opener-Policy | 规划 | same-origin | 隔离浏览上下文 |
| Cross-Origin-Resource-Policy | 规划 | same-origin | 资源隔离 |

---

## 10. CORS 策略

| 环境 | 策略 | 说明 |
|------|------|------|
| 开发 | 允许 localhost / 127.0.0.1 | 便于调试 |
| 生产 | 白名单：`https://wuhao-tutor.com`, `https://admin.wuhao-tutor.com` | 禁止 `*` |
| 预检缓存 | 可设 `Access-Control-Max-Age` | 减少预检次数 |
| 禁止 | 带认证头时第三方未授权来源 | 保障凭证不外泄 |

---

## 11. 密钥与敏感信息管理

| 项目 | 当前 | 风险 | 增强计划 |
|------|------|------|----------|
| 环境变量管理 | 模板 + 脚本生成 | 手工编辑差异 | 增加一致性验证脚本 |
| 密钥存储 | 文件 + 权限 600 | 暂无轮换 | 轮换脚本 + 版本戳 |
| 数据库凭据 | 单一账号 | 超权限风险 | 读写分离 / 限权 |
| Redis 密码 | 规划 | 未设置认证 | 设置 requirepass |
| JWT 签名 | 规划 | 未启用认证 | 秘钥强度 ≥ 256 bits |
| API Key | BAILIAN_API_KEY | 泄露风险 | 限制最小权限 / 周期轮换 |
| 文件权限 | 脚本赋权 | 改动未检测 | 差异扫描 (CI) |
| 证书管理 | 自签名（内部） | 生产风险 | Let's Encrypt 自动更新 |

---

## 12. 日志与监控 (Security Observability)

| 日志类别 | 内容 | 敏感处理 |
|----------|------|----------|
| 访问日志 | 路径/耗时/状态码/IP | 不记录完整 Token |
| 限流触发 | scope / user / ip / endpoint | 聚合级别，不逐条输出敏感 |
| 错误日志 | code / trace_id / 摘要 | 不含 stack 到响应 |
| AI 失败 | provider / latency / failure_type | 便于诊断 |
| DB 慢查询 | 语句摘要 / 时间 | 不写入敏感字面值 |
| 审计（规划） | 角色变更 / 管理操作 | 专用 Channel/索引 |
| 告警（规划） | 错误率异常 / 限流高占比 | 推送/仪表板 |

---

## 13. 文件上传与处理安全

| 风险 | 当前措施 | 后续增强 |
|------|----------|----------|
| 大文件 DoS | 限制大小 | 分片/断点策略防绕过 |
| 恶意文件类型 | 扩展名白名单 | MIME 深度探测 |
| 可执行内容 | 当前不自动执行 | 沙箱扫描（ClamAV / 云服务） |
| 路径穿越 | 存储名随机 | 加强统一路径拼接防护 |
| 敏感信息滥存 | 无自动识别 | 敏感内容检测（规划） |
| 临时文件清理 | 需人工处理 | 定时清理任务 |

---

## 14. AI 服务集成安全考量

| 风险 | 控制 | 说明 |
|------|------|------|
| Prompt 注入 | 不拼接未过滤用户元指令 | 增加输入清洗 |
| 反向提示泄露 | 不返回系统 prompt | 响应裁剪 |
| 滥用调用 | 限流 + 未来配额 | 增加用户级配额 |
| 敏感输出 | 目前不做 NLP 过滤 | 增加输出审查（关键词/分类器） |
| 成本失控 | 未统计 tokens | 增 tokens 计量与预算阈值 |
| 数据回流 | 不发送用户私密未必要字段 | 加“最少必要上下文”策略 |

---

## 15. 上线前安全核对清单 (Pre-Production Checklist)

| 项 | 状态(✔/✘) | 说明 |
|----|-----------|------|
| 强制 HTTPS (HSTS) |  | Nginx 已配置 |
| CORS 白名单 |  | 确认无 `*` |
| 安全头齐全 |  | 与第 9 节对照 |
| 默认账户禁用 |  | 无硬编码测试用户 |
| 依赖升级扫描 |  | 运行一次 vulnerability scan |
| 数据库账号最小权限 |  | 无超级账号 |
| 日志不含敏感值 |  | 抽样检测 |
| 限流阈值符合规划 |  | 覆盖高频端点 |
| 监控端点鉴权 |  | 生产不可匿名访问敏感指标 |
| 备份策略验证 |  | 执行恢复演练 |
| Secrets 权限 600 |  | 核对生成文件权限 |
| Token 过期策略定义 |  | 文档化 + 实现验证 |
| 异常统一 |  | 无直接堆栈返回 |
| 文件清理任务 |  | 临时/过期文件处理 |
| 版本与变更登记 |  | CHANGELOG / STATUS 更新 |
| 审计日志初步 |  | 关键操作是否记录 |

---

## 16. 当前已知风险 (Risk Register)

| 编号 | 描述 | 等级 | 缓解计划 | ETA |
|------|------|------|----------|-----|
| R-S1 | 未上线正式认证体系 | 高 | JWT + Role/Scope 模型 | 0.2.x |
| R-S2 | 文件 MIME 校验不完整 | 中 | 引入 python-magic 或后端服务 | 0.3.x |
| R-S3 | 无敏感输出过滤 | 中 | 输出审查钩子 | 0.3.x |
| R-S4 | 缺少审计日志框架 | 中 | 设计统一审计层 | 0.4.x |
| R-S5 | Tokens 未计量成本 | 中 | 统计字段与告警 | 0.3.x |
| R-S6 | Redis 未启用认证 | 中 | 启用 + 轮换 | 0.2.x |
| R-S7 | 配置漂移检测缺失 | 低 | 基线哈希 + 对比脚本 | 0.4.x |
| R-S8 | 无全局请求并发控制 | 中 | 入口连接限流/队列 | 0.4.x |

---

## 17. 中短期安全路线图

| 阶段 | 目标 | 关键交付物 |
|------|------|------------|
| 0.2.x | 基础认证授权落地 | JWT + 角色 + 路由保护 |
| 0.3.x | AI/文件安全增强 | MIME 校验 + AI 输出审查 + tokens 计量 |
| 0.4.x | 审计与观测强化 | 审计日志 + Prometheus 安全指标导出 |
| 0.5.x | 防护深化 | 配额 / 自适应限流 / 幂等键 |
| 0.6.x | 运营成熟化 | 密钥轮换自动化 + 安全扫描集成 |
| ≥1.0 | 稳定安全基线 | 全面合规审计（可选） |

---

## 18. 安全测试策略 (Testing Strategy)

| 测试类型 | 范畴 | 工具/手法 |
|----------|------|-----------|
| 单元测试 | 认证/授权/限流逻辑 | Pytest |
| 集成测试 | 整体调用链安全行为 | HTTP 客户端模拟 |
| Fuzz 测试 | JSON 输入、枚举边界 | fastjsonschema/faker |
| 依赖漏洞扫描 | 第三方包 | pip-audit / safety（规划） |
| 静态检查 | 潜在危险调用 | ruff / 自定义规则（规划） |
| 手工渗透（轻量） | 常见 OWASP 风险验证 | 内部流程 |
| 上传文件攻击验证 | 恶意扩展 / 超尺寸 | 构造样本 |
| 限流绕过 | 并发+快速重试 | 自建脚本 |

---

## 19. 角色与分工 (RACI 简表)

| 安全事项 | Owner | Reviewer | 执行工具 |
|----------|-------|----------|----------|
| 密钥生成/轮换 | DevOps | 安全负责人 | env/secrets 脚本 |
| 依赖升级与漏洞处理 | 后端开发 | DevOps | pip-audit |
| 限流阈值调整 | 后端开发 | 架构/安全负责人 | 配置 + 监控对比 |
| 审计日志设计 | 后端开发 | 架构负责人 | 自定义实现 |
| 认证授权演进 | 后端开发 | 架构负责人 | JWT/策略模块 |
| 监控告警配置 | DevOps | 开发负责人 | Prometheus/Grafana（规划） |

---

## 20. 术语（安全相关子集）

| 术语 | 解释 |
|------|------|
| CSP | Content Security Policy 内容安全策略 |
| HSTS | 强制浏览器使用 HTTPS |
| 漏洞扫描 | 自动检测依赖已知安全问题 |
| 速率限制 | 限制单位时间内请求次数 |
| 配额 (Quota) | 更长周期（天/月）的使用上限 |
| 审计日志 | 记录敏感/关键操作与上下文 |
| 幂等 | 同一请求重复执行不改变结果 |
| Zero Trust Input | 不信任任何外部输入，按协议验证 |
| 软限 | 提醒接近限值，不立即阻断 |
| 熔断 (Circuit Breaker) | 外部依赖失效时快速失败避免放大 |

---

## 21. 未来增强候选（Backlog）

| 项 | 优先级 | 说明 |
|----|--------|------|
| 安全扫描整合 CI | 高 | 每次合并提示高危依赖 |
| 安全基线脚本 | 高 | 一键检测：头/限流/权限/版本 |
| Token 黑名单 | 高 | 主动撤销能力 |
| 输入污点分析（静态） | 中 | 防潜在注入 |
| API 签名机制（可选） | 中 | 防中间人重放（部分场景） |
| WAF 集成 | 中 | 云端策略联合 |
| 双 Token + 滑动刷新 | 中 | 提升会话安全性 |
| 行为序列模型 | 低 | 异常行为识别 |
| 加密存储 (PII) | 低 | 如需处理敏感学生数据 |
| DLP（数据防泄漏） | 低 | 与输出流控制联动 |

---

## 22. 变更记录 (Changelog Snapshot)

| 日期 | 变更 | 描述 | 版本 |
|------|------|------|------|
| 2025-09-29 | 初稿建立 | 安全基线文档骨架 | 0.1.x |
| (待填) | ... | ... | ... |

---

## 23. 反馈机制

发现以下任一情况请立即登记：
- 误返回敏感字段 / 系统异常堆栈外泄
- 限流逻辑异常（误杀或无效）
- 文档与行为不一致
- 需要新增安全策略或调整优先级

反馈渠道：
1. 创建 Issue（标签：`security`）
2. 重大风险请同步维护者（邮件或即时通道）
3. 变更完成后更新本文件相关章节与变更记录

---

## 24. 快速审阅摘要（给新成员/评审）

| 问题 | 答案 |
|------|------|
| 是否有统一错误结构？ | 有（success/data/error），不返回内部堆栈 |
| 是否具备限流？ | 有（IP / 用户 / AI / 登录） |
| 是否强制 HTTPS？ | 生产计划中（HSTS 启用） |
| 是否有敏感信息输出防护？ | 已禁止日志中输出密钥；需继续抽查 |
| 是否支持认证与授权？ | 认证体系规划中（高优） |
| 文件上传是否安全？ | 基础限制，有改进空间（MIME/扫描未实装） |
| AI 调用是否受控？ | 有限流，无成本统计（近期规划） |
| 是否可快速定位安全事件？ | 监控部分具备，审计日志待强化 |

---

## 25. 总结

当前安全基线满足“内测/受控团队使用”最小要求，但要达到“外部受众/教育场景正式发布”，必须优先完成：
1. 认证授权体系落地（JWT + 角色）
2. 文件与 AI 输出风险强化
3. 监控与审计闭环（错误 / 限流 / 行为集中分析）
4. 密钥轮换与依赖扫描自动化
5. 访问控制策略与资源属主校验一致性

该文档为持续维护对象，每周或关键版本前应复核更新；未更新的安全文档本身即为潜在风险。

---

（END）
