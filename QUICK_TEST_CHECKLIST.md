# 公式渲染修复 - 快速验证清单

> ⏱️ 预计耗时: 15分钟
> 🎯 目标: 验证小程序公式渲染修复是否成功

---

## ✅ 验证步骤

### Step 1: 启动后端 (2分钟)

```bash
cd /Users/liguoma/my-devs/python/wuhao-tutor

# 启动开发服务器
make dev
# 或
uv run python src/main.py
```

**等待成功提示:**
```
✅ INFO:     Application startup complete.
✅ INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

### Step 2: 启动小程序 (2分钟)

1. ✅ 打开**微信开发者工具**
2. ✅ 导入项目: `/Users/liguoma/my-devs/python/wuhao-tutor/miniprogram`
3. ✅ 点击**编译**
4. ✅ 打开**控制台**标签页（查看日志）

---

### Step 3: 测试公式渲染 (5分钟)

#### 测试用例 1: 块级公式 ⭐

**操作:**
1. 进入"作业问答"页面
2. 输入: `球的体积公式是什么?`
3. 点击发送

**验证检查:**
- [ ] 控制台输出: `📐 收到公式增强内容`
- [ ] 控制台输出: `✅ 公式增强内容已应用到UI`
- [ ] 聊天界面显示**公式图片**（不是 `$$...$$` 文本）
- [ ] 公式图片清晰可见

**预期效果:**
```
AI回复: 球的体积公式为: [V = 4/3 πr³ 图片]
```

#### 测试用例 2: 行内公式

**操作:**
输入: `圆的面积公式是什么?`

**验证检查:**
- [ ] 公式嵌入在文本中显示为小图片
- [ ] 图片与文字对齐良好

#### 测试用例 3: 复杂公式

**操作:**
输入: `二次方程的求根公式是什么?`

**验证检查:**
- [ ] 分数、根号等符号正确渲染
- [ ] 公式完整显示

---

### Step 4: 检查后端日志 (2分钟)

```bash
# 新开终端窗口
cd /Users/liguoma/my-devs/python/wuhao-tutor

# 查看公式相关日志
tail -f logs/app.log | grep -E "formula|公式"
```

**期望看到:**
```
✅ 进入公式增强流程
✅ 公式增强成功，内容长度: XXX
📤 已发送公式增强内容给前端
```

---

### Step 5: 查看监控指标 (2分钟)

```bash
curl http://localhost:8000/api/v1/health/formula-metrics
```

**验证指标:**
```json
{
  "metrics": {
    "total_requests": 3,        // ✅ 应该 > 0
    "render_success": 3,        // ✅ 应该 > 0
    "cache_hits": 0,           // 首次渲染为0正常
    "errors": {
      "total": 0               // ✅ 应该 = 0
    }
  }
}
```

---

## 🎯 成功标准

全部通过表示修复成功:

- [x] 后端成功启动
- [x] 小程序成功加载
- [x] 控制台看到 `📐 收到公式增强内容`
- [x] 控制台看到 `✅ 公式增强内容已应用到UI`
- [x] 聊天界面显示**公式图片**（不是LaTeX文本）
- [x] 后端日志显示 `📤 已发送公式增强内容给前端`
- [x] 监控指标 `render_success > 0`

---

## ❌ 失败场景

### 场景1: 未收到 formula_enhanced 事件

**症状:** 控制台没有 `📐 收到公式增强内容` 日志

**检查:**
```bash
tail -f logs/app.log | grep "formula_enhanced"
```

**可能原因:**
- 后端代码未生效（需要重启）
- 公式服务未启用
- QuickLaTeX API失败

**解决:**
```bash
# 重启后端
Ctrl+C
make dev
```

---

### 场景2: 公式仍显示为 LaTeX

**症状:** 界面显示 `$$V = \frac{4}{3} \pi r^3$$`

**检查:**
- 前端代码是否已重新编译
- 控制台是否有JavaScript错误

**解决:**
```bash
# 微信开发者工具:
1. 点击"清除缓存"
2. 点击"重新编译"
3. 刷新页面
```

---

### 场景3: 图片加载失败

**症状:** 显示破损图标或占位符

**检查:**
```bash
curl http://localhost:8000/api/v1/health/formula-metrics
```

**查看 errors.quicklatex 是否 > 0**

**解决:**
- QuickLaTeX服务可能不可用，等待重试
- 或查看后端日志详细错误

---

## 🚀 自动化测试（可选）

如果手动测试通过，可运行自动化脚本验证:

```bash
uv run python scripts/verify_formula_fix.py
```

**预期输出:**
```
✅ 收到 formula_enhanced 事件!
✅ 内容包含公式图片标签
✅ 测试通过: 公式已正确增强并包含图片标签
🎉 所有测试通过!
```

---

## 📋 验证结果

**日期:** _______________

**验证人:** _______________

**结果:**
- [ ] ✅ 全部通过
- [ ] ⚠️ 部分通过（填写问题描述）
- [ ] ❌ 失败（填写问题描述）

**问题描述:**
```
（如有问题，请详细描述）
```

**截图:**
（可附上成功/失败的截图）

---

## 📞 需要帮助?

查看详细文档:
- 📄 [修复总结](FORMULA_FIX_SUMMARY.md)
- 📄 [完整文档](docs/solutions/formula-rendering-fix.md)

---

**最后更新:** 2025-01-XX
**预计验证时间:** 15分钟
