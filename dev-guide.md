# äº”å¥½ä¼´å­¦ï¼ˆwuhao-tutorï¼‰å¼€å‘æŒ‡å—

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: äº”å¥½ä¼´å­¦
**è‹±æ–‡åç§°**: wuhao-tutor
**é¡¹ç›®ç±»å‹**: åŸºäºé˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“çš„K12å­¦æƒ…ç®¡ç†ç³»ç»Ÿ
**æŠ€æœ¯æ ˆ**: Python + FastAPI + PostgreSQL + Redis + é˜¿é‡Œäº‘ç™¾ç‚¼ + Vue3 + å¾®ä¿¡å°ç¨‹åº

### é¡¹ç›®æ„¿æ™¯

æ„å»ºä¸€ä¸ªåŸºäºé˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“çš„å­¦æƒ…ç®¡ç†å¹³å°ï¼Œé€šè¿‡ç»Ÿä¸€çš„AIæœåŠ¡å¸®åŠ©K12å­¦ç”Ÿï¼š

- ğŸ¯ **æ™ºèƒ½ä½œä¸šæ‰¹æ”¹** - åŸºäºç™¾ç‚¼æ™ºèƒ½ä½“çš„è‡ªåŠ¨æ‰¹æ”¹å’Œåˆ†æ
- ğŸ“Š **ä¸ªæ€§åŒ–å­¦æƒ…åˆ†æ** - æ™ºèƒ½è¯†åˆ«çŸ¥è¯†è–„å¼±ç‚¹å’Œå­¦ä¹ æ¨¡å¼
- ğŸ”„ **æ™ºèƒ½å­¦ä¹ é—®ç­”** - åŸºäºå­¦æƒ…æ•°æ®çš„ä¸ªæ€§åŒ–AIäº¤äº’åŠ©æ•™
- ğŸ¤– **ç»Ÿä¸€AIæœåŠ¡** - æ‰€æœ‰AIåŠŸèƒ½é€šè¿‡ç™¾ç‚¼æ™ºèƒ½ä½“ç»Ÿä¸€æä¾›

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- **ç»Ÿä¸€AIæœåŠ¡** - æ‰€æœ‰å¤§æ¨¡å‹è°ƒç”¨é€šè¿‡é˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“å®Œæˆ
- **å¤šæ¨¡æ€è¾“å…¥æ”¯æŒ** - æ–‡å­—ã€è¯­éŸ³ã€å›¾åƒä¸‰ç§äº¤äº’æ–¹å¼
- **ä¸ªæ€§åŒ–å­¦æƒ…åˆ†æ** - åŸºäºä½œä¸šæ‰¹æ”¹ç»“æœçš„æ™ºèƒ½åˆ†æ
- **ç®€åŒ–æ¶æ„è®¾è®¡** - å‡å°‘AIæœåŠ¡å¤æ‚åº¦ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§

---

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Webç«¯(Vue3)      â”‚    å¾®ä¿¡å°ç¨‹åºç«¯        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¥å£å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              FastAPI Gateway               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœåŠ¡å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·æœåŠ¡  â”‚  ä½œä¸šæœåŠ¡  â”‚  å­¦æƒ…æœåŠ¡  â”‚ ç™¾ç‚¼AIæœåŠ¡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    PostgreSQL     â”‚      Redisç¼“å­˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AIæœåŠ¡å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“ "äº”å¥½-ä¼´å­¦K12"        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¤–éƒ¨æœåŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    å¾®ä¿¡API     â”‚    OSSå­˜å‚¨    â”‚   çŸ­ä¿¡æœåŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ä¼˜åŒ–è°ƒæ•´

#### æ ¸å¿ƒè°ƒæ•´è¯´æ˜

1. **ç»Ÿä¸€AIæœåŠ¡**: æ‰€æœ‰AIåŠŸèƒ½ï¼ˆä½œä¸šæ‰¹æ”¹ã€å­¦ä¹ é—®ç­”ã€å­¦æƒ…åˆ†æï¼‰ç»Ÿä¸€è°ƒç”¨ç™¾ç‚¼æ™ºèƒ½ä½“
2. **ç®€åŒ–æœåŠ¡å±‚**: ç§»é™¤å¤šä¸ªç‹¬ç«‹çš„AIæœåŠ¡æ¨¡å—ï¼Œæ•´åˆä¸ºå•ä¸€çš„ç™¾ç‚¼AIæœåŠ¡
3. **é…ç½®é›†ä¸­åŒ–**: ç™¾ç‚¼æ™ºèƒ½ä½“çš„é…ç½®ä¿¡æ¯ç»Ÿä¸€ç®¡ç†
4. **æ¥å£æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„AIæœåŠ¡è°ƒç”¨æ¥å£å’Œå“åº”æ ¼å¼

#### åˆ†å±‚æ¶æ„è¯¦è§£

##### 1. è¡¨ç°å±‚ (Presentation Layer)

- **Webç«¯**: Vue3 + TypeScript + Vite
- **å°ç¨‹åºç«¯**: å¾®ä¿¡å°ç¨‹åºåŸç”Ÿå¼€å‘
- **èŒè´£**: ç”¨æˆ·äº¤äº’ã€é¡µé¢å±•ç¤ºã€çŠ¶æ€ç®¡ç†

##### 2. APIå±‚ (API Layer)

- **æ¡†æ¶**: FastAPI + Pydantic
- **ç‰ˆæœ¬ç®¡ç†**: `/api/v1/` è·¯å¾„å‰ç¼€
- **èŒè´£**: è¯·æ±‚è·¯ç”±ã€å‚æ•°éªŒè¯ã€å“åº”æ ¼å¼åŒ–

##### 3. ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)

- **æ ¸å¿ƒæœåŠ¡æ¨¡å—**:
    - ç”¨æˆ·ç®¡ç†æœåŠ¡ (UserService)
    - ä½œä¸šç®¡ç†æœåŠ¡ (HomeworkService) - å¤„ç†ä½œä¸šä¸Šä¼ ã€å­˜å‚¨
    - å­¦æƒ…åˆ†ææœåŠ¡ (AnalyticsService) - åŸºäºAIç»“æœè¿›è¡Œæ•°æ®åˆ†æ
    - ç™¾ç‚¼AIæœåŠ¡ (BailianService) - ç»Ÿä¸€çš„AIè°ƒç”¨æœåŠ¡
- **èŒè´£**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†ã€AIæœåŠ¡è°ƒç”¨

##### 4. æ•°æ®è®¿é—®å±‚ (Data Access Layer)

- **ORM**: SQLAlchemy 2.0+ (å¼‚æ­¥)
- **ä»“å‚¨æ¨¡å¼**: Repository Pattern
- **èŒè´£**: æ•°æ®åº“æ“ä½œã€ç¼“å­˜ç®¡ç†ã€æ•°æ®æ¨¡å‹æ˜ å°„

##### 5. æ•°æ®å­˜å‚¨å±‚ (Data Storage Layer)

- **ä¸»æ•°æ®åº“**: PostgreSQL (ç”¨æˆ·æ•°æ®ã€ä½œä¸šæ•°æ®ã€å­¦æƒ…æ•°æ®)
- **ç¼“å­˜å±‚**: Redis (ä¼šè¯ã€ä¸´æ—¶æ•°æ®ã€AIå“åº”ç¼“å­˜)
- **æ–‡ä»¶å­˜å‚¨**: é˜¿é‡Œäº‘OSS (ä½œä¸šå›¾ç‰‡ã€éŸ³é¢‘æ–‡ä»¶)

---

## é˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“é›†æˆ

### æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯

```python
# ç™¾ç‚¼æ™ºèƒ½ä½“é…ç½®
BAILIAN_CONFIG = {
    "name": "äº”å¥½-ä¼´å­¦K12",
    "application_id": "db9f923dc3ae48dd9127929efa5eb108",
    "api_key": "sk-7f591a92e1cd4f4d9ed2f94761f0c1db",
    "base_url": "https://dashscope.aliyuncs.com/api/v1",
    "timeout": 30,
    "max_retries": 3
}
```

### AIæœåŠ¡ç»Ÿä¸€æ¥å£è®¾è®¡

#### 1. ä½œä¸šæ‰¹æ”¹æœåŠ¡

```python
@dataclass
class HomeworkCorrectionRequest:
    """ä½œä¸šæ‰¹æ”¹è¯·æ±‚"""
    user_id: str
    subject: str           # å­¦ç§‘
    grade_level: int       # å¹´çº§
    homework_text: str     # OCRè¯†åˆ«çš„é¢˜ç›®æ–‡æœ¬
    answer_text: str       # å­¦ç”Ÿç­”æ¡ˆ
    image_urls: List[str]  # ä½œä¸šå›¾ç‰‡URL

@dataclass
class HomeworkCorrectionResponse:
    """ä½œä¸šæ‰¹æ”¹å“åº”"""
    correction_id: str
    is_correct: bool
    score: float           # åˆ†æ•° (0-100)
    corrections: List[str] # æ‰¹æ”¹æ„è§
    knowledge_points: List[str]  # æ¶‰åŠçŸ¥è¯†ç‚¹
    difficulty_level: str  # éš¾åº¦ç­‰çº§
    suggestions: List[str] # å­¦ä¹ å»ºè®®
    error_analysis: Optional[str]  # é”™è¯¯åˆ†æ
```

#### 2. å­¦ä¹ é—®ç­”æœåŠ¡

```python
@dataclass
class StudyQARequest:
    """å­¦ä¹ é—®ç­”è¯·æ±‚"""
    user_id: str
    question: str          # å­¦ç”Ÿé—®é¢˜
    context: str           # ä¸Šä¸‹æ–‡ï¼ˆå­¦æƒ…æ•°æ®ï¼‰
    subject: str           # å­¦ç§‘
    grade_level: int       # å¹´çº§

@dataclass
class StudyQAResponse:
    """å­¦ä¹ é—®ç­”å“åº”"""
    answer: str            # AIå›ç­”
    knowledge_points: List[str]  # ç›¸å…³çŸ¥è¯†ç‚¹
    difficulty_level: str  # é—®é¢˜éš¾åº¦
    follow_up_questions: List[str]  # å»¶ä¼¸é—®é¢˜
    learning_resources: List[str]   # æ¨èå­¦ä¹ èµ„æº
```

#### 3. å­¦æƒ…åˆ†ææœåŠ¡

```python
@dataclass
class LearningAnalysisRequest:
    """å­¦æƒ…åˆ†æè¯·æ±‚"""
    user_id: str
    time_range: str        # åˆ†ææ—¶é—´èŒƒå›´
    subjects: List[str]    # åˆ†æå­¦ç§‘
    analysis_type: str     # åˆ†æç±»å‹: weekly/monthly/term

@dataclass
class LearningAnalysisResponse:
    """å­¦æƒ…åˆ†æå“åº”"""
    analysis_report: str   # åˆ†ææŠ¥å‘Š
    strengths: List[str]   # ä¼˜åŠ¿çŸ¥è¯†ç‚¹
    weaknesses: List[str]  # è–„å¼±çŸ¥è¯†ç‚¹
    study_suggestions: List[str]  # å­¦ä¹ å»ºè®®
    progress_trend: Dict   # è¿›æ­¥è¶‹åŠ¿æ•°æ®
    next_review_plan: List[Dict]  # å¤ä¹ è®¡åˆ’
```

---

## é¡¹ç›®ç»“æ„

```
wuhao-tutor/
â”œâ”€â”€ src/                        # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ api/                    # APIè·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ v1/                # v1ç‰ˆæœ¬API
â”‚   â”‚   â”‚   â”œâ”€â”€ endpoints/     # å„æ¨¡å—ç«¯ç‚¹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py        # è®¤è¯ç›¸å…³
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ homework.py    # ä½œä¸šç›¸å…³
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ learning.py    # å­¦ä¹ é—®ç­”
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ analytics.py   # å­¦æƒ…åˆ†æ
â”‚   â”‚   â”‚   â””â”€â”€ dependencies/  # APIä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé…ç½®å’Œå·¥å…·
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ logging.py         # æ—¥å¿—é…ç½®
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨ç›¸å…³
â”‚   â”‚   â””â”€â”€ database.py        # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ models/                 # SQLAlchemyæ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ homework.py        # ä½œä¸šæ¨¡å‹
â”‚   â”‚   â””â”€â”€ analytics.py       # å­¦æƒ…æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/                # Pydanticæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·Schema
â”‚   â”‚   â”œâ”€â”€ homework.py        # ä½œä¸šSchema
â”‚   â”‚   â”œâ”€â”€ bailian.py         # ç™¾ç‚¼AI Schema
â”‚   â”‚   â””â”€â”€ common.py          # é€šç”¨Schema
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ user_service.py    # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ homework_service.py # ä½œä¸šç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ analytics_service.py # å­¦æƒ…åˆ†ææœåŠ¡
â”‚   â”‚   â””â”€â”€ bailian_service.py # ç™¾ç‚¼AIæœåŠ¡ [æ ¸å¿ƒ]
â”‚   â”œâ”€â”€ repositories/           # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ user_repository.py # ç”¨æˆ·ä»“å‚¨
â”‚   â”‚   â”œâ”€â”€ homework_repository.py # ä½œä¸šä»“å‚¨
â”‚   â”‚   â””â”€â”€ base_repository.py # åŸºç¡€ä»“å‚¨
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ocr.py             # OCRå·¥å…·
â”‚   â”‚   â”œâ”€â”€ file_upload.py     # æ–‡ä»¶ä¸Šä¼ å·¥å…·
â”‚   â”‚   â””â”€â”€ cache.py           # ç¼“å­˜å·¥å…·
â”‚   â””â”€â”€ main.py                # åº”ç”¨å…¥å£
â”œâ”€â”€ tests/                      # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ unit/                  # å•å…ƒæµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_bailian_service.py # ç™¾ç‚¼æœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ integration/           # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ fixtures/              # æµ‹è¯•æ•°æ®
â”œâ”€â”€ scripts/                    # è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ init/                  # åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ dev/                   # å¼€å‘å·¥å…·è„šæœ¬
â”œâ”€â”€ docs/                       # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ api/                   # APIæ–‡æ¡£
â”‚   â””â”€â”€ bailian/               # ç™¾ç‚¼é›†æˆæ–‡æ¡£
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ .env.example               # ç¯å¢ƒé…ç½®æ¨¡æ¿
â”œâ”€â”€ pyproject.toml             # é¡¹ç›®é…ç½®
â””â”€â”€ Makefile                   # è‡ªåŠ¨åŒ–ä»»åŠ¡
```

---

## å¼€å‘ç¯å¢ƒæ­å»º

### ç¯å¢ƒè¦æ±‚

- **Python**: >= 3.11
- **Node.js**: >= 18.0 (å‰ç«¯å¼€å‘)
- **PostgreSQL**: >= 14
- **Redis**: >= 6.0
- **é˜¿é‡Œäº‘è´¦å·**: ç”¨äºç™¾ç‚¼æ™ºèƒ½ä½“è®¿é—®

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd wuhao-tutor
```

### 2. Pythonç¯å¢ƒé…ç½®

```bash
# ä½¿ç”¨ uv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
uv sync

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate  # macOS/Linux
```

### 3. ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œé‡ç‚¹é…ç½®ç™¾ç‚¼æ™ºèƒ½ä½“
vim .env
```

**å…³é”®ç¯å¢ƒå˜é‡**:

```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql+asyncpg://user:password@localhost/wuhao_tutor_dev
REDIS_URL=redis://localhost:6379

# é˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“é…ç½®
BAILIAN_APPLICATION_ID=db9f923dc3ae48dd9127929efa5eb108
BAILIAN_API_KEY=sk-7f591a92e1cd4f4d9ed2f94761f0c1db
BAILIAN_BASE_URL=https://dashscope.aliyuncs.com/api/v1
BAILIAN_TIMEOUT=30
BAILIAN_MAX_RETRIES=3

# æ–‡ä»¶å­˜å‚¨é…ç½®
OSS_BUCKET_NAME=wuhao-tutor-files
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
```

### 4. æ•°æ®åº“åˆå§‹åŒ–

```bash
# å¯åŠ¨PostgreSQLå’ŒRedis
brew services start postgresql
brew services start redis

# åˆ›å»ºæ•°æ®åº“
createdb wuhao_tutor_dev

# è¿è¡Œæ•°æ®åº“è¿ç§»
make db-init
```

### 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¯åŠ¨åç«¯æœåŠ¡
make dev

# æˆ–ç›´æ¥ä½¿ç”¨Python
python -m uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### 6. éªŒè¯ç¯å¢ƒ

è®¿é—® http://localhost:8000/docs æŸ¥çœ‹APIæ–‡æ¡£

---

## å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒ

#### Pythonä»£ç è§„èŒƒ

- **æ ¼å¼åŒ–å·¥å…·**: Black (line-length=88)
- **ç±»å‹æ£€æŸ¥**: MyPy
- **ä»£ç æ£€æŸ¥**: Flake8
- **å¯¼å…¥æ’åº**: isort

```bash
# ä»£ç æ ¼å¼åŒ–
make format

# ä»£ç æ£€æŸ¥
make lint

# ç±»å‹æ£€æŸ¥
make type-check
```

#### ç™¾ç‚¼AIæœåŠ¡è°ƒç”¨è§„èŒƒ

```python
# æ­£ç¡®çš„æœåŠ¡è°ƒç”¨æ–¹å¼
from src.services.bailian_service import BailianService

class HomeworkService:
    def __init__(self):
        self.bailian_service = BailianService()

    async def correct_homework(self, request: HomeworkCorrectionRequest) -> HomeworkCorrectionResponse:
        """ä½œä¸šæ‰¹æ”¹"""
        try:
            # æ„å»ºAIè¯·æ±‚
            ai_prompt = self._build_correction_prompt(request)

            # è°ƒç”¨ç™¾ç‚¼æ™ºèƒ½ä½“
            ai_response = await self.bailian_service.chat_completion(
                messages=[{"role": "user", "content": ai_prompt}],
                context={
                    "user_id": request.user_id,
                    "subject": request.subject,
                    "grade_level": request.grade_level
                }
            )

            # è§£æAIå“åº”
            return self._parse_correction_response(ai_response)

        except Exception as e:
            logger.error(f"ä½œä¸šæ‰¹æ”¹å¤±è´¥: {e}")
            raise HomeworkCorrectionError(f"æ‰¹æ”¹å¤±è´¥: {str(e)}")
```

### APIè®¾è®¡è§„èŒƒ

#### RESTful APIè®¾è®¡

```python
# ä½œä¸šç›¸å…³API
POST   /api/v1/homework/upload          # ä¸Šä¼ ä½œä¸š
GET    /api/v1/homework/{homework_id}   # è·å–ä½œä¸šè¯¦æƒ…
POST   /api/v1/homework/{homework_id}/correct  # æ‰¹æ”¹ä½œä¸š

# å­¦ä¹ é—®ç­”API
POST   /api/v1/learning/ask             # å­¦ä¹ æé—®
GET    /api/v1/learning/history         # é—®ç­”å†å²

# å­¦æƒ…åˆ†æAPI
GET    /api/v1/analytics/report         # è·å–å­¦æƒ…æŠ¥å‘Š
POST   /api/v1/analytics/analyze        # ç”Ÿæˆåˆ†æ
```

#### AIæœåŠ¡ç»Ÿä¸€å“åº”æ ¼å¼

```json
// æˆåŠŸå“åº”
{
  "code": "SUCCESS",
  "message": "AIå¤„ç†æˆåŠŸ",
  "data": {
    "ai_result": {
      // å…·ä½“AIå“åº”æ•°æ®
    },
    "processing_time": 1.23,
    "tokens_used": 150
  }
}

// é”™è¯¯å“åº”
{
  "code": "AI_SERVICE_ERROR",
  "message": "ç™¾ç‚¼æ™ºèƒ½ä½“è°ƒç”¨å¤±è´¥",
  "details": {
    "error_type": "RATE_LIMIT_EXCEEDED",
    "retry_after": 60
  }
}
```

### æäº¤è§„èŒƒ

#### Gitæäº¤æ¶ˆæ¯æ ¼å¼

```
<type>(<scope>): <description>

<body>

<footer>
```

#### æäº¤ç±»å‹

- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼åŒ–
- `refactor`: é‡æ„
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨
- `ai`: AIæœåŠ¡ç›¸å…³è°ƒæ•´

#### ç¤ºä¾‹

```bash
feat(bailian): é›†æˆé˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“ä½œä¸šæ‰¹æ”¹åŠŸèƒ½

- å®ç°ç»Ÿä¸€çš„ç™¾ç‚¼AIæœåŠ¡è°ƒç”¨
- æ·»åŠ ä½œä¸šæ‰¹æ”¹APIæ¥å£
- å®Œå–„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

Closes #123
```

---

## æµ‹è¯•ç­–ç•¥

### ç™¾ç‚¼AIæœåŠ¡æµ‹è¯•

#### 1. å•å…ƒæµ‹è¯•

```python
# tests/unit/test_bailian_service.py
import pytest
from unittest.mock import AsyncMock, patch
from src.services.bailian_service import BailianService

@pytest.mark.asyncio
async def test_chat_completion_success():
    """æµ‹è¯•ç™¾ç‚¼æ™ºèƒ½ä½“è°ƒç”¨æˆåŠŸ"""
    service = BailianService()

    with patch.object(service, '_call_bailian_api') as mock_call:
        mock_call.return_value = {
            "choices": [{"message": {"content": "æµ‹è¯•å“åº”"}}],
            "usage": {"total_tokens": 100}
        }

        result = await service.chat_completion([
            {"role": "user", "content": "æµ‹è¯•é—®é¢˜"}
        ])

        assert result.content == "æµ‹è¯•å“åº”"
        assert result.tokens_used == 100

@pytest.mark.asyncio
async def test_homework_correction():
    """æµ‹è¯•ä½œä¸šæ‰¹æ”¹åŠŸèƒ½"""
    service = BailianService()

    request = HomeworkCorrectionRequest(
        user_id="test_user",
        subject="æ•°å­¦",
        grade_level=8,
        homework_text="è§£æ–¹ç¨‹: 2x + 3 = 7",
        answer_text="x = 2"
    )

    result = await service.correct_homework(request)
    assert result.is_correct == True
    assert result.score >= 0
    assert len(result.corrections) >= 0
```

#### 2. é›†æˆæµ‹è¯•

```python
# tests/integration/test_homework_api.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_homework_correction_flow(client: AsyncClient):
    """æµ‹è¯•ä½œä¸šæ‰¹æ”¹å®Œæ•´æµç¨‹"""
    # ä¸Šä¼ ä½œä¸š
    response = await client.post("/api/v1/homework/upload",
        files={"image": ("test.jpg", test_image_bytes, "image/jpeg")},
        data={"subject": "æ•°å­¦", "grade_level": 8}
    )
    assert response.status_code == 201
    homework_id = response.json()["data"]["homework_id"]

    # æ‰¹æ”¹ä½œä¸š
    response = await client.post(f"/api/v1/homework/{homework_id}/correct")
    assert response.status_code == 200

    result = response.json()["data"]
    assert "is_correct" in result
    assert "corrections" in result
    assert "knowledge_points" in result
```

### æµ‹è¯•é…ç½®

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡ŒAIæœåŠ¡ç›¸å…³æµ‹è¯•
make test-ai

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
make test-coverage
```

---

## æ•°æ®åº“è®¾è®¡è°ƒæ•´

### æ–°å¢ä½œä¸šç›¸å…³è¡¨

```sql
-- ä½œä¸šè®°å½•è¡¨
CREATE TABLE homework_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject VARCHAR(50) NOT NULL,
    grade_level INTEGER NOT NULL,
    original_images JSON,  -- åŸå§‹ä½œä¸šå›¾ç‰‡URLs
    ocr_text TEXT,        -- OCRè¯†åˆ«æ–‡æœ¬
    student_answers JSON,  -- å­¦ç”Ÿç­”æ¡ˆ
    ai_corrections JSON,   -- AIæ‰¹æ”¹ç»“æœ
    knowledge_points JSON, -- æ¶‰åŠçŸ¥è¯†ç‚¹
    score DECIMAL(5,2),   -- å¾—åˆ†
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å­¦ä¹ é—®ç­”è®°å½•è¡¨
CREATE TABLE qa_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    context JSON,         -- é—®ç­”ä¸Šä¸‹æ–‡
    knowledge_points JSON, -- ç›¸å…³çŸ¥è¯†ç‚¹
    satisfaction_rating INTEGER, -- æ»¡æ„åº¦è¯„åˆ†
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- AIè°ƒç”¨è®°å½•è¡¨ (ç”¨äºç›‘æ§å’Œåˆ†æ)
CREATE TABLE ai_call_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    service_type VARCHAR(50) NOT NULL, -- homework_correction, qa, analysis
    request_data JSON,
    response_data JSON,
    tokens_used INTEGER,
    processing_time DECIMAL(6,3),
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## éƒ¨ç½²æ–¹æ¡ˆ

### å®¹å™¨åŒ–éƒ¨ç½²

#### Dockeré…ç½®

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ– (OCRç›¸å…³)
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

COPY pyproject.toml uv.lock ./
RUN pip install uv && uv sync --frozen

COPY . .

EXPOSE 8000
CMD ["python", "-m", "uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### Docker Compose

```yaml
# docker-compose.yml
version: "3.8"
services:
    web:
        build: .
        ports:
            - "8000:8000"
        environment:
            - ENVIRONMENT=production
            - BAILIAN_APPLICATION_ID=${BAILIAN_APPLICATION_ID}
            - BAILIAN_API_KEY=${BAILIAN_API_KEY}
        depends_on:
            - postgres
            - redis

    postgres:
        image: postgres:15
        environment:
            POSTGRES_DB: wuhao_tutor
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        volumes:
            - postgres_data:/var/lib/postgresql/data

    redis:
        image: redis:7-alpine
        command: redis-server --appendonly yes
        volumes:
            - redis_data:/data

volumes:
    postgres_data:
    redis_data:
```

---

## åŠŸèƒ½å¼€å‘è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼šç™¾ç‚¼AIæœåŠ¡é›†æˆ (1-2å‘¨)

- [ ] åˆ›å»ºç™¾ç‚¼AIæœåŠ¡åŸºç¡€æ¡†æ¶
- [ ] å®ç°ç»Ÿä¸€çš„AIè°ƒç”¨æ¥å£
- [ ] å®Œæˆä½œä¸šæ‰¹æ”¹åŠŸèƒ½é›†æˆ
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] ç¼–å†™AIæœåŠ¡å•å…ƒæµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼šä½œä¸šç®¡ç†æ ¸å¿ƒåŠŸèƒ½ (2-3å‘¨)

- [ ] ä½œä¸šå›¾ç‰‡ä¸Šä¼ å’Œå­˜å‚¨
- [ ] OCRæ–‡æœ¬è¯†åˆ«é›†æˆ
- [ ] ä½œä¸šæ‰¹æ”¹APIå®ç°
- [ ] ä½œä¸šè®°å½•ç®¡ç†
- [ ] æ‰¹æ”¹ç»“æœå¯è§†åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼šå­¦ä¹ é—®ç­”åŠŸèƒ½ (1-2å‘¨)

- [ ] å­¦ä¹ é—®ç­”APIå®ç°
- [ ] ä¸Šä¸‹æ–‡ç®¡ç†å’Œå­¦æƒ…å…³è”
- [ ] é—®ç­”å†å²è®°å½•
- [ ] æ™ºèƒ½æ¨èé—®é¢˜

### ç¬¬å››é˜¶æ®µï¼šå­¦æƒ…åˆ†æä¼˜åŒ– (2å‘¨)

- [ ] åŸºäºAIåˆ†æçš„å­¦æƒ…æŠ¥å‘Š
- [ ] çŸ¥è¯†ç‚¹æŒæ¡åº¦ç»Ÿè®¡
- [ ] å­¦ä¹ è¿›åº¦è·Ÿè¸ª
- [ ] ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®

### ç¬¬äº”é˜¶æ®µï¼šå‰ç«¯ç•Œé¢å’Œç”¨æˆ·ä½“éªŒ (2-3å‘¨)

- [ ] Webç«¯ä½œä¸šä¸Šä¼ ç•Œé¢
- [ ] æ‰¹æ”¹ç»“æœå±•ç¤ºé¡µé¢
- [ ] å­¦æƒ…åˆ†æä»ªè¡¨æ¿
- [ ] å¾®ä¿¡å°ç¨‹åºæ ¸å¿ƒåŠŸèƒ½

### ç¬¬å…­é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–å’Œéƒ¨ç½² (1å‘¨)

- [ ] AIæœåŠ¡æ€§èƒ½ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥å®Œå–„
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] ç›‘æ§å’Œæ—¥å¿—å®Œå–„

---

## å¸¸è§é—®é¢˜ FAQ

### Q: ç™¾ç‚¼æ™ºèƒ½ä½“è°ƒç”¨å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ

A:

1. æ£€æŸ¥API Keyå’ŒApplication IDé…ç½®
2. ç¡®è®¤ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
3. æŸ¥çœ‹AIè°ƒç”¨æ—¥å¿—: `tail -f logs/ai_calls.log`
4. æ£€æŸ¥é…é¢ä½¿ç”¨æƒ…å†µå’Œé™åˆ¶
5. ä½¿ç”¨é‡è¯•æœºåˆ¶å’Œé™çº§ç­–ç•¥

### Q: å¦‚ä½•ä¼˜åŒ–AIæœåŠ¡è°ƒç”¨æ€§èƒ½ï¼Ÿ

A:

1. ä½¿ç”¨Redisç¼“å­˜ç›¸ä¼¼è¯·æ±‚ç»“æœ
2. å®ç°è¯·æ±‚æ‰¹å¤„ç†æœºåˆ¶
3. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
4. ä½¿ç”¨å¼‚æ­¥è°ƒç”¨é¿å…é˜»å¡
5. ç›‘æ§Tokenä½¿ç”¨é‡æ§åˆ¶æˆæœ¬

### Q: ä½œä¸šå›¾ç‰‡å¤„ç†çš„æœ€ä½³å®è·µï¼Ÿ

A:

1. å›¾ç‰‡ä¸Šä¼ å‰è¿›è¡Œæ ¼å¼å’Œå¤§å°æ£€æŸ¥
2. ä½¿ç”¨OSSå­˜å‚¨ï¼ŒCDNåŠ é€Ÿè®¿é—®
3. OCRå‰å¯¹å›¾ç‰‡è¿›è¡Œé¢„å¤„ç†ï¼ˆå»å™ªã€çŸ«æ­£ï¼‰
4. ç¼“å­˜OCRç»“æœé¿å…é‡å¤è¯†åˆ«

### Q: å¦‚ä½•ç¡®ä¿AIåˆ†æç»“æœçš„å‡†ç¡®æ€§ï¼Ÿ

A:

1. è®¾è®¡åˆç†çš„æç¤ºè¯æ¨¡æ¿
2. å¯¹AIå“åº”è¿›è¡Œç»“æ„åŒ–éªŒè¯
3. å»ºç«‹äººå·¥å®¡æ ¸æœºåˆ¶
4. æ”¶é›†ç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ–

---

## ç›‘æ§å’Œæ—¥å¿—

### AIæœåŠ¡ç›‘æ§æŒ‡æ ‡

```python
# å…³é”®ç›‘æ§æŒ‡æ ‡
AI_METRICS = {
    "call_success_rate": "AIè°ƒç”¨æˆåŠŸç‡",
    "average_response_time": "å¹³å‡å“åº”æ—¶é—´",
    "tokens_usage": "Tokenä½¿ç”¨é‡",
    "error_rate_by_type": "åˆ†ç±»å‹é”™è¯¯ç‡",
    "daily_costs": "æ¯æ—¥è°ƒç”¨æˆæœ¬"
}
```

### æ—¥å¿—é…ç½®

```python
# ç™¾ç‚¼AIæœåŠ¡ä¸“ç”¨æ—¥å¿—
LOGGING_CONFIG = {
    "loggers": {
        "bailian_service": {
            "handlers": ["ai_file"],
            "level": "INFO",
            "propagate": False
        }
    },
    "handlers": {
        "ai_file": {
            "class": "logging.handlers.RotatingFileHandler",
            "filename": "logs/ai_calls.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5
        }
    }
}
```

---

## è”ç³»æ–¹å¼

**é¡¹ç›®ç»´æŠ¤è€…**: Liguo Ma
**é‚®ç®±**: maliguo@outlook.com
**é¡¹ç›®åœ°å€**: [GitHub Repository]
**ç™¾ç‚¼æ™ºèƒ½ä½“**: äº”å¥½-ä¼´å­¦K12

---

_æœ€åæ›´æ–°æ—¶é—´: 2025-01-27_
_æ¶æ„è°ƒæ•´: é›†æˆé˜¿é‡Œäº‘ç™¾ç‚¼æ™ºèƒ½ä½“ç»Ÿä¸€AIæœåŠ¡_
