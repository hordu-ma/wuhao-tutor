<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>五好伴学 - 用户管理</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 20px;
      }
      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .stats-card i {
        font-size: 2rem;
        color: #667eea;
      }
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-admin {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
      }
      .btn-admin:hover {
        opacity: 0.9;
        color: white;
      }
      .password-display {
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
        font-weight: bold;
        color: #dc3545;
        background: #fff3cd;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
      }
      .badge-active {
        background-color: #28a745;
      }
      .badge-inactive {
        background-color: #6c757d;
      }
      .login-form {
        max-width: 400px;
        margin: 100px auto;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- 登录表单 -->
    <div id="loginSection" class="container">
      <div class="login-form">
        <h3 class="text-center mb-4">
          <i class="bi bi-shield-lock-fill text-primary"></i> 管理员登录
        </h3>
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">手机号</label>
            <input type="text" class="form-control" id="loginPhone" required />
          </div>
          <div class="mb-3">
            <label class="form-label">密码</label>
            <input type="password" class="form-control" id="loginPassword" required />
          </div>
          <button type="submit" class="btn btn-admin w-100">登录</button>
        </form>
      </div>
    </div>

    <!-- 管理界面 -->
    <div id="adminSection" style="display: none">
      <!-- 头部 -->
      <div class="admin-header">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2><i class="bi bi-people-fill"></i> 用户管理系统</h2>
              <p class="mb-0">五好伴学管理后台</p>
            </div>
            <div>
              <span id="adminName" class="me-3"></span>
              <button class="btn btn-light btn-sm" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> 退出
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <!-- 统计卡片 -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="stats-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 id="totalUsers" class="mb-0">0</h3>
                  <p class="text-muted mb-0">总用户数</p>
                </div>
                <i class="bi bi-people"></i>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stats-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 id="activeUsers" class="mb-0">0</h3>
                  <p class="text-muted mb-0">活跃用户</p>
                </div>
                <i class="bi bi-person-check"></i>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stats-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 id="newUsersToday" class="mb-0">0</h3>
                  <p class="text-muted mb-0">今日新增</p>
                </div>
                <i class="bi bi-person-plus"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- 操作栏 -->
        <div class="table-container mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-table"></i> 用户列表</h5>
            <div>
              <button
                class="btn btn-admin btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#createUserModal"
              >
                <i class="bi bi-plus-circle"></i> 创建用户
              </button>
            </div>
          </div>

          <!-- 搜索栏 -->
          <div class="row mb-3">
            <div class="col-md-6">
              <input
                type="text"
                class="form-control"
                id="searchInput"
                placeholder="搜索姓名、手机号、昵称..."
              />
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-primary w-100" onclick="searchUsers()">
                <i class="bi bi-search"></i> 搜索
              </button>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100" onclick="resetSearch()">
                <i class="bi bi-arrow-clockwise"></i> 重置
              </button>
            </div>
          </div>

          <!-- 用户表格 -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>手机号</th>
                  <th>学校</th>
                  <th>年级</th>
                  <th>班级</th>
                  <th>登录次数</th>
                  <th>最后登录</th>
                  <th>状态</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr>
                  <td colspan="9" class="text-center text-muted">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <nav>
            <ul class="pagination justify-content-center" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- 创建用户模态框 -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> 创建新用户</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="createUserForm">
              <div class="mb-3">
                <label class="form-label">手机号 <span class="text-danger">*</span></label>
                <input
                  type="tel"
                  class="form-control"
                  id="createPhone"
                  pattern="1[3-9]\d{9}"
                  required
                />
                <div class="form-text">11位手机号，将作为登录用户名</div>
              </div>
              <div class="mb-3">
                <label class="form-label">姓名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="createName" maxlength="50" required />
              </div>
              <div class="mb-3">
                <label class="form-label">学校</label>
                <input type="text" class="form-control" id="createSchool" maxlength="100" />
              </div>
              <div class="mb-3">
                <label class="form-label">年级</label>
                <select class="form-select" id="createGrade">
                  <option value="">请选择</option>
                  <option value="primary_1">一年级</option>
                  <option value="primary_2">二年级</option>
                  <option value="primary_3">三年级</option>
                  <option value="primary_4">四年级</option>
                  <option value="primary_5">五年级</option>
                  <option value="primary_6">六年级</option>
                  <option value="junior_1">七年级（初一）</option>
                  <option value="junior_2">八年级（初二）</option>
                  <option value="junior_3">九年级（初三）</option>
                  <option value="senior_1">高一</option>
                  <option value="senior_2">高二</option>
                  <option value="senior_3">高三</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">班级</label>
                <input
                  type="text"
                  class="form-control"
                  id="createClass"
                  maxlength="50"
                  placeholder="如：1班"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-admin" onclick="createUser()">创建</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 显示密码模态框 -->
    <div class="modal fade" id="passwordModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-triangle-fill"></i> 重要：请记录密码
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-info-circle-fill"></i> 密码仅显示一次，请立即告知用户并妥善保管！
            </div>
            <div class="mb-3">
              <label class="form-label">用户信息</label>
              <div class="border rounded p-3 bg-light">
                <p class="mb-1"><strong>姓名：</strong><span id="pwdUserName"></span></p>
                <p class="mb-0"><strong>手机号：</strong><span id="pwdUserPhone"></span></p>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">登录密码</label>
              <div class="password-display" id="userPassword"></div>
            </div>
            <button class="btn btn-outline-primary w-100" onclick="copyPassword()">
              <i class="bi bi-clipboard"></i> 复制密码
            </button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">我已记录</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 重置密码确认模态框 -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="bi bi-shield-exclamation"></i> 确认重置密码</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>确定要重置用户 <strong id="resetUserName"></strong> 的密码吗？</p>
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle-fill"></i> 此操作将：
              <ul class="mb-0 mt-2">
                <li>生成新的随机密码</li>
                <li>撤销该用户所有登录会话</li>
                <li>用户需使用新密码重新登录</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-danger" onclick="confirmResetPassword()">
              确认重置
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 配置
      const API_BASE = window.location.origin + '/api/v1'
      let currentPage = 1
      let currentSearch = ''
      let resetUserId = null

      // 工具函数
      function getToken() {
        return localStorage.getItem('admin_token')
      }

      function setToken(token) {
        localStorage.setItem('admin_token', token)
      }

      function clearToken() {
        localStorage.removeItem('admin_token')
        localStorage.removeItem('admin_name')
      }

      async function apiCall(url, options = {}) {
        const token = getToken()
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers,
        }

        if (token) {
          headers['Authorization'] = `Bearer ${token}`
        }

        try {
          const response = await fetch(API_BASE + url, {
            ...options,
            headers,
          })

          if (response.status === 401) {
            clearToken()
            showLogin()
            throw new Error('登录已过期')
          }

          const data = await response.json()

          if (!response.ok) {
            throw new Error(data.detail || '请求失败')
          }

          return data
        } catch (error) {
          alert('错误: ' + error.message)
          throw error
        }
      }

      // 登录相关
      function showLogin() {
        document.getElementById('loginSection').style.display = 'block'
        document.getElementById('adminSection').style.display = 'none'
      }

      function showAdmin() {
        document.getElementById('loginSection').style.display = 'none'
        document.getElementById('adminSection').style.display = 'block'
        document.getElementById('adminName').textContent = localStorage.getItem('admin_name') || ''
        loadUsers()
      }

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const phone = document.getElementById('loginPhone').value
        const password = document.getElementById('loginPassword').value

        try {
          const data = await apiCall('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ phone, password }),
          })

          setToken(data.access_token)
          localStorage.setItem('admin_name', data.user.name)
          showAdmin()
        } catch (error) {
          // 错误已在 apiCall 中处理
        }
      })

      function logout() {
        if (confirm('确定要退出吗？')) {
          clearToken()
          showLogin()
        }
      }

      // 用户列表
      async function loadUsers(page = 1, search = '') {
        currentPage = page
        currentSearch = search

        try {
          const params = new URLSearchParams({
            page: page,
            size: 20,
          })
          if (search) params.append('search', search)

          const data = await apiCall(`/admin/users?${params}`)

          updateStats(data)
          renderTable(data.items)
          renderPagination(data.total, data.page, data.size)
        } catch (error) {
          document.getElementById('userTableBody').innerHTML =
            '<tr><td colspan="9" class="text-center text-danger">加载失败</td></tr>'
        }
      }

      function updateStats(data) {
        document.getElementById('totalUsers').textContent = data.total
        const activeCount = data.items.filter((u) => u.is_active).length
        document.getElementById('activeUsers').textContent = activeCount

        const today = new Date().toISOString().split('T')[0]
        const newToday = data.items.filter((u) => u.created_at.startsWith(today)).length
        document.getElementById('newUsersToday').textContent = newToday
      }

      function renderTable(users) {
        const tbody = document.getElementById('userTableBody')

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>'
          return
        }

        tbody.innerHTML = users
          .map(
            (user) => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${user.school || '-'}</td>
                    <td>${user.grade_level || '-'}</td>
                    <td>${user.class_name || '-'}</td>
                    <td>${user.login_count || 0}</td>
                    <td>${user.last_login_at ? new Date(user.last_login_at).toLocaleDateString() : '从未登录'}</td>
                    <td>
                        <span class="badge ${user.is_active ? 'badge-active' : 'badge-inactive'}">
                            ${user.is_active ? '正常' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning" onclick="resetPassword('${user.id}', '${user.name}')" title="重置密码">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-${user.is_active ? 'danger' : 'success'}" 
                                onclick="toggleUserStatus('${user.id}', ${!user.is_active})" title="${user.is_active ? '禁用' : '启用'}">
                            <i class="bi bi-${user.is_active ? 'x-circle' : 'check-circle'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}', '${user.name}')" title="删除用户">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join('')
      }

      function renderPagination(total, page, size) {
        const totalPages = Math.ceil(total / size)
        const pagination = document.getElementById('pagination')

        if (totalPages <= 1) {
          pagination.innerHTML = ''
          return
        }

        let html = ''

        // 上一页
        html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadUsers(${page - 1}, '${currentSearch}'); return false;">上一页</a>
            </li>`

        // 页码
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
            html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadUsers(${i}, '${currentSearch}'); return false;">${i}</a>
                    </li>`
          } else if (i === page - 3 || i === page + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>'
          }
        }

        // 下一页
        html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadUsers(${page + 1}, '${currentSearch}'); return false;">下一页</a>
            </li>`

        pagination.innerHTML = html
      }

      // 搜索
      function searchUsers() {
        const search = document.getElementById('searchInput').value.trim()
        loadUsers(1, search)
      }

      function resetSearch() {
        document.getElementById('searchInput').value = ''
        loadUsers(1, '')
      }

      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchUsers()
      })

      // 创建用户
      async function createUser() {
        const phone = document.getElementById('createPhone').value
        const name = document.getElementById('createName').value
        const school = document.getElementById('createSchool').value
        const grade_level = document.getElementById('createGrade').value
        const class_name = document.getElementById('createClass').value

        try {
          const data = await apiCall('/admin/users', {
            method: 'POST',
            body: JSON.stringify({
              phone,
              name,
              school: school || null,
              grade_level: grade_level || null,
              class_name: class_name || null,
            }),
          })

          // 关闭创建模态框
          bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide()
          document.getElementById('createUserForm').reset()

          // 显示密码
          document.getElementById('pwdUserName').textContent = data.user.name
          document.getElementById('pwdUserPhone').textContent = data.user.phone
          document.getElementById('userPassword').textContent = data.password
          new bootstrap.Modal(document.getElementById('passwordModal')).show()

          // 刷新列表
          loadUsers(currentPage, currentSearch)
        } catch (error) {
          // 错误已处理
        }
      }

      // 重置密码
      function resetPassword(userId, userName) {
        resetUserId = userId
        document.getElementById('resetUserName').textContent = userName
        new bootstrap.Modal(document.getElementById('resetPasswordModal')).show()
      }

      async function confirmResetPassword() {
        if (!resetUserId) return

        try {
          const data = await apiCall(`/admin/users/${resetUserId}/reset-password`, {
            method: 'POST',
          })

          // 关闭确认框
          bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide()

          // 显示新密码
          document.getElementById('pwdUserName').textContent = data.name
          document.getElementById('pwdUserPhone').textContent = data.phone
          document.getElementById('userPassword').textContent = data.password
          new bootstrap.Modal(document.getElementById('passwordModal')).show()

          resetUserId = null
        } catch (error) {
          // 错误已处理
        }
      }

      // 启用/禁用用户
      async function toggleUserStatus(userId, isActive) {
        const action = isActive ? '启用' : '禁用'
        if (!confirm(`确定要${action}该用户吗？`)) return

        try {
          await apiCall(`/admin/users/${userId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ is_active: isActive }),
          })

          loadUsers(currentPage, currentSearch)
        } catch (error) {
          // 错误已处理
        }
      }

      // 删除用户
      async function deleteUser(userId, userName) {
        if (
          !confirm(
            `确定要删除用户 "${userName}" 吗？\n\n此操作将永久删除该用户的所有数据，不可恢复！`
          )
        )
          return

        // 二次确认
        if (!confirm(`再次确认：真的要删除用户 "${userName}" 吗？`)) return

        try {
          await apiCall(`/admin/users/${userId}`, {
            method: 'DELETE',
          })

          alert('用户删除成功')
          loadUsers(currentPage, currentSearch)
        } catch (error) {
          // 错误已处理
        }
      }

      // 复制密码
      function copyPassword() {
        const password = document.getElementById('userPassword').textContent
        navigator.clipboard.writeText(password).then(() => {
          alert('密码已复制到剪贴板')
        })
      }

      // 初始化
      if (getToken()) {
        showAdmin()
      } else {
        showLogin()
      }
    </script>
  </body>
</html>
