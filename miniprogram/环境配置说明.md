# 五好伴学小程序 - 环境配置说明

## 📋 快速切换环境

小程序支持三种运行环境，可通过修改 `config/index.js` 文件快速切换。

### 1. 生产环境（Production）- **当前配置** ✅

适用于：正式用户访问、生产环境测试

```javascript
// config/index.js
const config = {
  environment: 'production',
  api: {
    baseUrl: 'https://wuhao.maliguo.xyz', // 生产服务器
    version: 'v1',
  },
  debug: false, // 关闭调试模式
};
```

**特点**：

- 🔒 关闭调试日志
- 🚀 使用生产API地址
- 📊 降低性能采样（减少资源消耗）
- ❌ 隐藏错误详情

### 2. 开发环境（Development）

适用于：本地开发、功能调试

```javascript
const config = {
  environment: 'development',
  api: {
    baseUrl: 'http://localhost:8000', // 本地开发服务器
    version: 'v1',
  },
  debug: true, // 启用调试模式
};
```

**特点**：

- 🔍 完整调试日志
- 💻 连接本地服务器
- 📈 详细错误信息
- ⚡ 完整性能监控

### 3. 预发布环境（Staging）

适用于：上线前测试、UAT测试

```javascript
const config = {
  environment: 'staging',
  api: {
    baseUrl: 'https://staging.wuhao-tutor.com', // 预发布服务器
    version: 'v1',
  },
  debug: false,
};
```

## 🔧 环境切换步骤

### 方法 1：修改主配置文件（推荐）

1. **打开配置文件**：`miniprogram/config/index.js`

2. **修改环境变量**：

   ```javascript
   environment: 'production',  // 改为 'development' 或 'staging'
   ```

3. **修改 API 地址**：

   ```javascript
   api: {
     baseUrl: 'https://wuhao.maliguo.xyz',  // 生产环境
     // baseUrl: 'http://localhost:8000',  // 本地开发
   }
   ```

4. **重新编译**：在微信开发者工具中点击"编译"

### 方法 2：使用环境配置文件

如需更复杂的配置，可以：

1. 修改 `config/environments/production.js`（生产环境专用配置）
2. 修改 `config/environments/development.js`（开发环境专用配置）
3. 修改 `config/environments/staging.js`（预发布环境专用配置）

## 🌐 API 地址配置

### 当前可用地址

| 环境       | API 地址                          | 说明                       |
| ---------- | --------------------------------- | -------------------------- |
| 生产环境   | `https://wuhao.maliguo.xyz`       | 正式服务器（**当前使用**） |
| 开发环境   | `http://localhost:8000`           | 本地开发服务器             |
| 预发布环境 | `https://staging.wuhao-tutor.com` | UAT测试服务器              |

### 常见问题

#### Q1: 为什么看不到 `/api/v1/` 前缀？

A: 系统会自动添加，无需手动配置。URL 构建规则：

```javascript
完整URL = baseUrl + '/api/' + version + path;
// 例如：https://wuhao.maliguo.xyz/api/v1/auth/wechat-login
```

#### Q2: 如何验证当前环境？

A: 查看微信开发者工具控制台，会显示：

```
🚀 运行于生产环境模式: https://wuhao.maliguo.xyz
```

#### Q3: 切换环境后需要清除缓存吗？

A: 建议清除：

1. 点击微信开发者工具 "Clear Cache"
2. 重新编译

## 🐛 问题排查

### 问题：请求返回 `ERR_CONNECTION_REFUSED`

**原因**：配置的服务器地址无法连接

**解决方案**：

1. 检查 `baseUrl` 配置是否正确
2. 如果是本地开发，确保后端服务已启动：
   ```bash
   cd /Users/liguoma/my-devs/python/wuhao-tutor
   ./scripts/start-dev.sh
   ```
3. 如果是生产环境，检查服务器是否正常运行

### 问题：URL 中出现重复的 `/api/v1/api/v1/`

**原因**：旧版本 bug，已修复

**解决方案**：确保使用最新版本的 `utils/api.js`

### 问题：无法登录或 Token 失效

**原因**：环境切换后 Token 不匹配

**解决方案**：

1. 清除存储：微信开发者工具 → 存储 → 清除缓存
2. 重新登录

## 📝 开发建议

### 生产环境测试建议

**您当前的工作模式**：直接在生产环境测试 ✅

**优点**：

- 无需启动本地服务器
- 测试真实生产环境
- 快速验证功能

**建议**：

1. 使用测试账号（避免影响真实用户数据）
2. 关键操作前先在预发布环境验证
3. 定期查看生产环境日志

### 切换到开发环境

如需使用本地开发环境：

1. 启动后端服务：

   ```bash
   ./scripts/start-dev.sh
   ```

2. 修改配置：

   ```javascript
   environment: 'development',
   api: { baseUrl: 'http://localhost:8000' }
   ```

3. 清除缓存并重新编译

## 🔒 安全提示

⚠️ **重要**：

- 生产环境配置文件不要提交到代码仓库
- 敏感信息（AppID、密钥）使用环境变量
- 生产环境关闭 `debug` 模式

## 📞 技术支持

如有问题，请联系：

- 邮箱：maliguo@outlook.com
- GitHub Issues：[项目地址]

---

**最后更新**：2025-10-14  
**当前环境**：Production（生产环境）  
**API 地址**：https://wuhao.maliguo.xyz
