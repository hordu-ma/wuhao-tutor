<!--pages/knowledge-graph/index.wxml-->
<wxs module="utils">
  var toPercent = function(value) {
    if (!value) return 0;
    return Math.round(value * 100);
  };
  
  var getProgressColor = function(mastery) {
    if (mastery >= 0.7) return '#52c41a';
    if (mastery >= 0.4) return '#faad14';
    return '#f5222d';
  };
  
  module.exports = {
    toPercent: toPercent,
    getProgressColor: getProgressColor
  };
</wxs>

<view class="knowledge-graph-container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="top-bar">
    <!-- ç§‘ç›®é€‰æ‹©å™¨ -->
    <view class="subject-selector">
      <van-dropdown-menu>
        <van-dropdown-item 
          value="{{selectedSubject}}" 
          options="{{subjectOptions}}" 
          bind:change="onSubjectChange" />
      </van-dropdown-menu>
    </view>

    <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
    <view class="view-toggle" bindtap="onViewModeChange">
      <van-icon name="{{viewMode === 'list' ? 'apps-o' : 'bars'}}"
                size="20px" color="#1890ff" />
      <text class="toggle-text">{{viewMode === 'list' ? 'å›¾è°±' : 'åˆ—è¡¨'}}</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <loading wx:if="{{snapshotLoading && !snapshot}}" />

  <!-- é”™è¯¯æç¤º -->
  <view class="error-tip" wx:if="{{error && !snapshot}}">
    <van-icon name="warning-o" size="40px" color="#faad14" />
    <text class="error-text">{{error}}</text>
    <van-button type="primary" size="small" bindtap="loadData">é‡è¯•</van-button>
  </view>

  <!-- çŸ¥è¯†å›¾è°±å†…å®¹ -->
  <scroll-view class="kg-scroll" scroll-y="{{true}}" wx:if="{{!snapshotLoading || snapshot}}">
    
    <!-- ========== åˆ—è¡¨è§†å›¾ ========== -->
    <view wx:if="{{viewMode === 'list'}}">
      <!-- æ•´ä½“ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-card" wx:if="{{snapshot}}">
      <view class="card-title">ğŸ“Š å­¦æƒ…æ¦‚è§ˆ</view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{snapshot.total_mistakes || 0}}</text>
          <text class="stat-label">é”™é¢˜æ€»æ•°</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{snapshot.knowledge_points ? snapshot.knowledge_points.length : 0}}</text>
          <text class="stat-label">æ¶‰åŠçŸ¥è¯†ç‚¹</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{utils.toPercent(snapshot.average_mastery)}}%</text>
          <text class="stat-label">å¹³å‡æŒæ¡åº¦</text>
        </view>
      </view>
    </view>

    <!-- è–„å¼±çŸ¥è¯†é“¾ -->
    <view class="weak-chains-card" wx:if="{{weakChains.length > 0}}">
      <view class="card-title">âš ï¸ éœ€è¦é‡ç‚¹å…³æ³¨</view>
      <view class="weak-chains-list">
        <view class="weak-chain-item" 
              wx:for="{{weakChains}}" 
              wx:key="knowledge_point"
              bindtap="onKnowledgePointTap"
              data-knowledge-point="{{item.knowledge_point}}">
          <view class="chain-header">
            <text class="chain-name">{{item.knowledge_point}}</text>
            <van-tag type="danger" plain>å¾…åŠ å¼º</van-tag>
          </view>
          <view class="chain-info">
            <view class="info-item">
              <van-icon name="warning-o" size="14px" />
              <text>é”™é¢˜æ•°: {{item.mistake_count}}</text>
            </view>
            <view class="info-item" wx:if="{{item.avg_mastery_level !== undefined}}">
              <van-icon name="chart-trending-o" size="14px" />
              <text>æŒæ¡åº¦: {{utils.toPercent(item.avg_mastery_level)}}%</text>
            </view>
          </view>
          <view class="chain-reason" wx:if="{{item.common_error_type}}">
            <text class="reason-label">å¸¸è§é”™è¯¯:</text>
            <text class="reason-text">{{item.common_error_type}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- çŸ¥è¯†ç‚¹æŒæ¡åº¦åˆ—è¡¨ -->
    <view class="knowledge-points-card" wx:if="{{snapshot && snapshot.knowledge_points}}">
      <view class="card-title">ğŸ“š çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ</view>
      <view class="kp-list">
        <view class="kp-item" 
              wx:for="{{snapshot.knowledge_points}}" 
              wx:key="name"
              bindtap="onKnowledgePointTap"
              data-knowledge-point="{{item.name}}">
          <view class="kp-main">
            <text class="kp-name">{{item.name}}</text>
            <view class="kp-mastery">
              <van-tag 
                type="{{item.mastery_level >= 0.7 ? 'success' : item.mastery_level >= 0.4 ? 'warning' : 'danger'}}" 
                plain>
                {{utils.toPercent(item.mastery_level)}}%
              </van-tag>
            </view>
          </view>
          <view class="kp-details">
            <text class="detail-text">é”™é¢˜ {{item.mistake_count}} é¢˜</text>
            <text class="detail-text" wx:if="{{item.last_practiced}}">
              æœ€è¿‘ç»ƒä¹ : {{item.last_practiced}}
            </text>
          </view>
          <!-- æŒæ¡åº¦è¿›åº¦æ¡ -->
          <view class="kp-progress">
            <view class="progress-bar" 
                  style="width: {{utils.toPercent(item.mastery_level)}}%; background-color: {{utils.getProgressColor(item.mastery_level)}};"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-wrapper" wx:if="{{!snapshot && !snapshotLoading}}">
      <empty-state 
        type="default"
        text="æš‚æ— æ•°æ®"
        description="è¯¥ç§‘ç›®è¿˜æ²¡æœ‰é”™é¢˜è®°å½•,èµ¶å¿«å»å­¦ä¹ é—®ç­”åˆ›å»ºä¸€äº›é”™é¢˜å§~" />
      
      <!-- å‹å¥½æç¤º -->
      <view class="empty-tips">
        <text class="tips-title">ğŸ’¡ å¦‚ä½•æ„å»ºçŸ¥è¯†å›¾è°±?</text>
        <view class="tips-list">
          <text class="tips-item">1. åœ¨å­¦ä¹ é—®ç­”ä¸­æé—®é¢˜</text>
          <text class="tips-item">2. AIä¼šè‡ªåŠ¨è¯†åˆ«é”™é¢˜å¹¶åˆ†æçŸ¥è¯†ç‚¹</text>
          <text class="tips-item">3. ç³»ç»Ÿä¼šå®šæœŸç”ŸæˆçŸ¥è¯†å›¾è°±å¿«ç…§</text>
        </view>
      </view>
    </view>

      <!-- åº•éƒ¨æ“ä½œåŒº -->
      <view class="bottom-actions" wx:if="{{snapshot}}">
        <van-button type="primary" block bindtap="onViewRecommendations">
          æŸ¥çœ‹æ™ºèƒ½å¤ä¹ æ¨è
        </van-button>
      </view>
    </view>

    <!-- ========== å›¾è°±è§†å›¾ ========== -->
    <view wx:if="{{viewMode === 'graph'}}" class="graph-view">
      <!-- å›¾è°±è¯´æ˜ -->
      <view class="graph-tips" wx:if="{{snapshot}}">
        <van-icon name="info-o" size="16px" color="#1890ff" />
        <text class="tips-text">èŠ‚ç‚¹é¢œè‰²ä»£è¡¨æŒæ¡åº¦ï¼šç»¿è‰²(å·²æŒæ¡) é»„è‰²(å­¦ä¹ ä¸­) çº¢è‰²(å¾…åŠ å¼º)</text>
      </view>

      <!-- ECharts å›¾è°±(å§‹ç»ˆæ¸²æŸ“,é¿å…æŸ¥æ‰¾å¤±è´¥) -->
      <view class="graph-container">
        <ec-canvas 
          id="knowledge-graph" 
          canvas-id="knowledge-graph" 
          ec="{{ec}}"
          style="width: 100%; height: 400px;"
        ></ec-canvas>
      </view>

      <!-- å›¾è°±ç©ºçŠ¶æ€ -->
      <view class="graph-empty" wx:if="{{!snapshot}}">
        <van-icon name="chart-trending-o" size="48px" color="#ccc" />
        <text class="empty-text">æš‚æ— å…³è”å…³ç³»æ•°æ®</text>
        <text class="empty-hint">ç»§ç»­å­¦ä¹ ,ç³»ç»Ÿä¼šè‡ªåŠ¨æ„å»ºçŸ¥è¯†å›¾è°±</text>
      </view>
    </view>
  </scroll-view>
</view>
