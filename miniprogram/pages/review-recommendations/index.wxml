<!--pages/review-recommendations/index.wxml-->
<wxs module="utils">
  var toPercent = function(value) {
    if (!value) return 0;
    return Math.round(value * 100);
  };
  
  module.exports = {
    toPercent: toPercent
  };
</wxs>

<view class="review-recommendations-container">
  <!-- ç§‘ç›®é€‰æ‹©å™¨ -->
  <view class="subject-selector">
    <van-dropdown-menu>
      <van-dropdown-item 
        value="{{selectedSubject}}" 
        options="{{subjectOptions}}" 
        bind:change="onSubjectChange" />
    </van-dropdown-menu>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <loading wx:if="{{loading && !recommendations.length}}" />

  <!-- é”™è¯¯æç¤º -->
  <view class="error-tip" wx:if="{{error && !recommendations.length}}">
    <van-icon name="warning-o" size="40px" color="#faad14" />
    <text class="error-text">{{error}}</text>
    <van-button type="primary" size="small" bindtap="loadRecommendations">é‡è¯•</van-button>
  </view>

  <!-- æ¨èåˆ—è¡¨ -->
  <scroll-view class="recommendations-scroll" scroll-y="{{true}}" wx:if="{{!loading || recommendations.length}}">
    
    <!-- æç¤ºè¯´æ˜ -->
    <view class="tips-card" wx:if="{{recommendations.length > 0}}">
      <van-icon name="bulb-o" size="20px" color="#1890ff" />
      <text class="tips-text">åŸºäºé—å¿˜æ›²çº¿å’ŒçŸ¥è¯†ç‚¹å…³è”åº¦ï¼Œä¸ºä½ æ¨èä»¥ä¸‹å¤ä¹ å†…å®¹</text>
    </view>

    <!-- æ¨èé¡¹åˆ—è¡¨ -->
    <view class="recommendations-list">
      <view class="recommendation-item" 
            wx:for="{{recommendations}}" 
            wx:key="knowledge_point"
            bindtap="onKnowledgePointTap"
            data-knowledge-point="{{item.knowledge_point}}">
        
        <!-- ä¼˜å…ˆçº§æ ‡ç­¾ -->
        <view class="priority-badge" style="background-color: {{getPriorityLevel(item.priority).color}}">
          {{index + 1}}
        </view>

        <view class="item-content">
          <!-- æ ‡é¢˜æ  -->
          <view class="item-header">
            <text class="kp-name">{{item.knowledge_point}}</text>
            <van-tag type="{{getPriorityLevel(item.priority).type}}" plain>
              {{getPriorityLevel(item.priority).text}}
            </van-tag>
          </view>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <view class="item-stats">
            <view class="stat-chip">
              <van-icon name="chart-trending-o" size="14px" />
              <text>æŒæ¡åº¦ {{utils.toPercent(item.mastery_level)}}%</text>
            </view>
            <view class="stat-chip">
              <van-icon name="warning-o" size="14px" />
              <text>é”™é¢˜ {{item.mistake_count}} é“</text>
            </view>
            <view class="stat-chip" wx:if="{{item.forgetting_risk > 0.5}}">
              <van-icon name="clock-o" size="14px" />
              <text>é—å¿˜é£é™©é«˜</text>
            </view>
          </view>

          <!-- æ¨èåŸå›  -->
          <view class="item-reasons">
            <view class="reason-item" wx:if="{{item.mastery_level < 0.4}}">
              ğŸ“Œ æŒæ¡åº¦è¾ƒä½ï¼Œéœ€è¦é‡ç‚¹åŠ å¼º
            </view>
            <view class="reason-item" wx:if="{{item.has_prerequisite}}">
              ğŸ”— æ˜¯å…¶ä»–çŸ¥è¯†ç‚¹çš„å‰ç½®åŸºç¡€
            </view>
            <view class="reason-item" wx:if="{{item.forgetting_risk > 0.5}}">
              â° è·ä¸Šæ¬¡ç»ƒä¹ æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®å°½å¿«å¤ä¹ 
            </view>
            <view class="reason-item" wx:if="{{item.related_weak_count > 0}}">
              ğŸ¯ å…³è”äº† {{item.related_weak_count}} ä¸ªè–„å¼±çŸ¥è¯†ç‚¹
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="item-action">
            <van-button type="primary" size="small" plain>
              æŸ¥çœ‹ç›¸å…³é”™é¢˜
            </van-button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!loading && recommendations.length === 0}}" class="empty-container">
      <empty-state 
        type="default"
        text="æš‚æ— å¤ä¹ æ¨è"
        description="è¯¥ç§‘ç›®è¿˜æ²¡æœ‰éœ€è¦å¤ä¹ çš„å†…å®¹æˆ–å­¦ä¹ æ•°æ®ä¸è¶³" />
      
      <!-- å‹å¥½æç¤º -->
      <view class="empty-tips">
        <text class="tips-title">ğŸ’¡ å¦‚ä½•è·å¾—å¤ä¹ æ¨è?</text>
        <view class="tips-list">
          <text class="tips-item">1. åœ¨å­¦ä¹ é—®ç­”ä¸­å¤šæé—®é¢˜,ç§¯ç´¯é”™é¢˜</text>
          <text class="tips-item">2. æ ‡è®°çŸ¥è¯†ç‚¹,å»ºç«‹çŸ¥è¯†å›¾è°±</text>
          <text class="tips-item">3. ç³»ç»Ÿä¼šæ ¹æ®æŒæ¡åº¦å’Œé—å¿˜æ›²çº¿ç”Ÿæˆæ¨è</text>
          <text class="tips-item">4. å½“å‰"æ•°å­¦"æœ‰10ä¸ªçŸ¥è¯†ç‚¹,ä½†æŒæ¡åº¦éƒ½è¾ƒé«˜</text>
        </view>
        
        <!-- è·³è½¬æŒ‰é’® -->
        <view class="empty-actions">
          <van-button type="primary" size="small" bind:click="goToLearning">
            å»å­¦ä¹ é—®ç­”
          </van-button>
          <van-button type="default" size="small" bind:click="goToKnowledgeGraph">
            æŸ¥çœ‹çŸ¥è¯†å›¾è°±
          </van-button>
        </view>
      </view>
    </view>
  </scroll-view>
</view>
