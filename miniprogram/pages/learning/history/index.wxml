<!--pages/chat/history/index.wxml - 问答历史记录页面模板-->
<view class="history-container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="title">问答历史</view>
    <view class="subtitle">共 {{statistics.totalQuestions}} 次问答</view>
  </view>

  <!-- 统计卡片 -->
  <view class="statistics-card">
    <view class="stat-item">
      <view class="stat-number">{{statistics.todayQuestions}}</view>
      <view class="stat-label">今日提问</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{statistics.weekQuestions}}</view>
      <view class="stat-label">本周提问</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{statistics.averageLength}}</view>
      <view class="stat-label">平均字数</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{statistics.mostActiveSubject}}</view>
      <view class="stat-label">热门学科</view>
    </view>
  </view>

  <!-- 搜索和筛选工具栏 -->
  <view class="toolbar">
    <view class="search-box">
      <van-search 
        value="{{searchKeyword}}"
        placeholder="搜索历史问答..."
        shape="round"
        bind:input="onSearchInput"
        bind:clear="onSearchClear"
      />
    </view>
    
    <view class="actions">
      <van-button round size="small" bind:tap="onShowFilter">
        <van-icon name="filter-o" />
        筛选
      </van-button>
      
      <van-button wx:if="!selectionMode" round size="small" bind:tap="toggleSelectionMode">
        <van-icon name="checked" />
        选择
      </van-button>
      
      <van-button wx:else round size="small" type="primary" bind:tap="toggleSelectionMode">
        取消
      </van-button>
    </view>
  </view>

  <!-- 批量操作栏 -->
  <view wx:if="{{selectionMode}}" class="batch-toolbar">
    <view class="selected-count">已选择 {{selectedItems.length}} 项</view>
    <view class="batch-actions">
      <van-button size="small" bind:tap="batchDelete">
        <van-icon name="delete-o" />
        删除
      </van-button>
      <van-button size="small" bind:tap="exportHistory">
        <van-icon name="share-o" />
        导出
      </van-button>
    </view>
  </view>

  <!-- 内容区域 -->
  <view class="content">
    <!-- 加载状态 -->
    <van-loading wx:if="{{loading}}" type="spinner" text-color="#999">
      正在加载历史记录...
    </van-loading>

    <!-- 历史记录列表 -->
    <view wx:elif="{{historyList.length > 0}}" class="history-list">
      <view wx:for="{{historyList}}" wx:key="id" 
            class="history-item {{selectedItems.includes(item.id) ? 'selected' : ''}}" 
            data-item="{{item}}"
            bind:tap="onHistoryItemTap"
            bind:longpress="onHistoryItemLongPress">
        
        <!-- 选择框 -->
        <view wx:if="{{selectionMode}}" class="selection-box">
          <van-checkbox value="{{selectedItems.includes(item.id)}}" />
        </view>

        <!-- 主要内容 -->
        <view class="item-content">
          <!-- 头部信息 -->
          <view class="item-header">
            <view class="tags">
              <view class="subject-tag subject-{{item.subject}}">
                {{getSubjectName(item.subject)}}
              </view>
              <view class="type-tag">
                {{getQuestionTypeName(item.questionType)}}
              </view>
            </view>
            
            <view class="meta-info">
              <text class="time">{{formatTime(item.timestamp)}}</text>
              <van-icon wx:if="{{item.isBookmarked}}" name="star" color="#ffd700" />
            </view>
          </view>

          <!-- 问题内容 -->
          <view class="question-content">
            <view class="question-text">{{item.question}}</view>
          </view>

          <!-- 答案预览 -->
          <view class="answer-preview">
            <text class="answer-text">{{item.answer}}</text>
          </view>

          <!-- 底部信息 -->
          <view class="item-footer">
            <view class="stats">
              <text class="stat-item">问题 {{item.questionLength}} 字</text>
              <text class="stat-item">回答 {{item.answerLength}} 字</text>
            </view>
            
            <view class="quick-actions">
              <van-icon name="chat-o" size="16px" />
              <text>继续对话</text>
            </view>
          </view>
        </view>

        <!-- 右侧箭头 -->
        <view wx:if="{{!selectionMode}}" class="item-arrow">
          <van-icon name="arrow" />
        </view>
      </view>

      <!-- 加载更多 -->
      <view wx:if="{{hasMore}}" class="load-more">
        <van-loading wx:if="{{loadingMore}}" type="spinner" size="16px">
          加载中...
        </van-loading>
        <text wx:else class="load-more-text">上拉加载更多</text>
      </view>
      
      <view wx:else class="no-more">
        <van-icon name="checked" color="#ddd" />
        没有更多历史记录了
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:else class="empty-state">
      <van-icon name="chat-o" size="60px" color="#ddd" />
      <view class="empty-text">暂无问答历史</view>
      <van-button round type="primary" size="small" 
                  bind:tap="onGoToChat">
        开始提问
      </van-button>
    </view>
  </view>

  <!-- 错误提示 -->
  <van-toast id="van-toast" />
  
  <!-- 筛选弹窗 -->
  <van-popup show="{{showFilterPopup}}" position="bottom" 
             custom-style="height: 70vh;" bind:close="onCloseFilter">
    <view class="filter-popup">
      <view class="filter-header">
        <text>筛选条件</text>
        <van-button type="primary" size="small" bind:tap="onResetFilter">
          重置
        </van-button>
      </view>

      <scroll-view scroll-y class="filter-content">
        <!-- 学科筛选 -->
        <view class="filter-section">
          <view class="section-title">学科</view>
          <view class="option-grid">
            <view wx:for="{{subjectOptions}}" wx:key="value"
                  class="option-item {{filterOptions.subject === item.value ? 'active' : ''}}"
                  data-type="subject" data-value="{{item.value}}"
                  bind:tap="onFilterSelect">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 时间范围 -->
        <view class="filter-section">
          <view class="section-title">时间范围</view>
          <view class="option-grid">
            <view wx:for="{{timeRangeOptions}}" wx:key="value"
                  class="option-item {{filterOptions.timeRange === item.value ? 'active' : ''}}"
                  data-type="timeRange" data-value="{{item.value}}"
                  bind:tap="onFilterSelect">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 问题类型 -->
        <view class="filter-section">
          <view class="section-title">问题类型</view>
          <view class="option-grid">
            <view wx:for="{{questionTypeOptions}}" wx:key="value"
                  class="option-item {{filterOptions.questionType === item.value ? 'active' : ''}}"
                  data-type="questionType" data-value="{{item.value}}"
                  bind:tap="onFilterSelect">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 排序方式 -->
        <view class="filter-section">
          <view class="section-title">排序</view>
          <view class="sort-options">
            <van-radio-group value="{{filterOptions.sortBy}}" bind:change="onFilterSelect">
              <van-radio name="time" data-type="sortBy" data-value="time">按时间</van-radio>
              <van-radio name="length" data-type="sortBy" data-value="length">按长度</van-radio>
              <van-radio name="subject" data-type="sortBy" data-value="subject">按学科</van-radio>
            </van-radio-group>
            
            <van-radio-group value="{{filterOptions.sortOrder}}" bind:change="onFilterSelect">
              <van-radio name="desc" data-type="sortOrder" data-value="desc">降序</van-radio>
              <van-radio name="asc" data-type="sortOrder" data-value="asc">升序</van-radio>
            </van-radio-group>
          </view>
        </view>
      </scroll-view>

      <view class="filter-footer">
        <van-button block type="primary" bind:tap="onApplyFilter">
          应用筛选
        </van-button>
      </view>
    </view>
  </van-popup>
</view>