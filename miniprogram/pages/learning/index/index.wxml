<!--pages/chat/index/index.wxml-->
<view class="chat-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="chat-header">
    <view class="header-content">
      <!-- AIåŠ©æ‰‹å¤´åƒ -->
      <image class="ai-avatar" src="/assets/images/ai-avatar.png" mode="aspectFill" />
      <view class="header-info">
        <text class="ai-name">äº”å¥½AIåŠ©æ‰‹</text>
      </view>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="onShowHistory">
        <van-icon name="clock-o" size="16" color="#fff" />
        <text class="btn-text">å†å²</text>
      </view>
      <view class="action-btn" bindtap="onNewChat">
        <van-icon name="plus" size="16" color="#fff" />
        <text class="btn-text">æ–°å»º</text>
      </view>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
  <scroll-view class="chat-messages"
               scroll-y="{{true}}"
               scroll-top="{{scrollTop}}"
               scroll-with-animation="{{true}}"
               refresher-enabled="{{true}}"
               refresher-triggered="{{refreshing}}"
               bindrefresherrefresh="onPullDownRefresh"
               bindscrolltoupper="onLoadMore"
               bindscroll="onScrollOptimized">

    <!-- å†å²æ¶ˆæ¯åŠ è½½ -->
    <view class="load-history" wx:if="{{hasMore && messageList.length > 0}}">
      <view class="load-history-btn" bindtap="loadMoreMessages" wx:if="{{!loadingHistory}}">
        <van-icon name="arrow-up" size="16" />
        <text>æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯</text>
      </view>
      <view class="load-history-loading" wx:else>
        <van-loading size="16" />
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <view class="welcome-message" wx:if="{{!messageList.length && !loading}}">
      <!-- AIåŠ©æ‰‹å¤´åƒ -->
      <image class="welcome-avatar" src="/assets/images/ai-avatar.png" mode="aspectFill" />
      <view class="welcome-content">
        <text class="welcome-title">ä½ å¥½ï¼æˆ‘æ˜¯äº”å¥½AIåŠ©æ‰‹</text>
        <text class="welcome-desc">æˆ‘å¯ä»¥å¸®ä½ è§£ç­”å­¦ä¹ ä¸­çš„å„ç§é—®é¢˜ï¼Œå¿«æ¥é—®æˆ‘å§ï½</text>
      </view>
      
      <!-- å¿«æ·é—®é¢˜æ°”æ³¡ -->
      <view class="quick-questions-bubbles" wx:if="{{quickQuestions.length > 0}}">
        <view class="bubble-item"
              wx:for="{{quickQuestions}}"
              wx:key="*this"
              bindtap="onQuickQuestion"
              data-question="{{item}}">
          {{item}}
        </view>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list" wx:if="{{messageList.length > 0}}">
      <view class="chat-bubble {{item.sender === 'user' ? 'user' : 'ai'}}"
            wx:for="{{messageList}}" wx:key="id">
        <!-- å¤´åƒ -->
        <view class="bubble-avatar">
          <image wx:if="{{item.sender === 'user'}}"
                 src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"
                 binderror="onAvatarError"
                 mode="aspectFill" />
          <image wx:else
                 src="/assets/images/ai-avatar.png"
                 binderror="onAvatarError"
                 mode="aspectFill" />
        </view>

        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="bubble-content">
          <!-- æ¶ˆæ¯çŠ¶æ€ -->
          <view class="message-status" wx:if="{{item.sender === 'user' && item.status !== 'sent'}}">
            <van-loading wx:if="{{item.status === 'sending'}}" size="12" />
            <van-icon wx:elif="{{item.status === 'failed'}}" name="warning-o" size="12" color="#f5222d" />
          </view>

          <!-- æ¶ˆæ¯ä¸»ä½“ -->
          <view class="bubble-main">
            <!-- æ–‡æœ¬æ¶ˆæ¯ - å¯Œæ–‡æœ¬æ¸²æŸ“ -->
            <view wx:if="{{item.type === 'text'}}" class="bubble-text rich-text" selectable="{{true}}">
              <!-- ğŸ”§ æ–°å¢ï¼šå¦‚æœåŒ…å«HTMLæ ‡ç­¾ï¼ˆå¦‚æ•°å­¦å…¬å¼å›¾ç‰‡ï¼‰ï¼Œä½¿ç”¨rich-textç»„ä»¶ -->
              <rich-text wx:if="{{item.hasHtmlContent}}" 
                         nodes="{{item.content}}" 
                         class="rich-text-content"
                         bindtap="onRichTextTap"></rich-text>
              
              <!-- åŸæœ‰çš„Markdownè§£ææ¸²æŸ“ï¼ˆç”¨äºçº¯æ–‡æœ¬å†…å®¹ï¼‰ -->
              <block wx:else>
                <block wx:for="{{item.richContent || []}}" 
                       wx:for-item="block" 
                       wx:key="index">
                <!-- æ®µè½ -->
                <view wx:if="{{block.type === 'paragraph'}}" class="md-paragraph">
                  <text wx:for="{{block.content}}" 
                        wx:for-item="inline" 
                        wx:key="index" 
                        class="md-inline">
                    <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'link'}}" class="md-link">{{inline.value.text}}</text>
                    <!-- ğŸ”§ æ–°å¢ï¼šæ•°å­¦å…¬å¼æ”¯æŒ -->
                    <image wx:elif="{{inline.type === 'math-formula'}}" 
                           class="math-formula-{{inline.value.type}}"
                           src="{{inline.value.src}}" 
                           alt="{{inline.value.alt}}"
                           mode="{{inline.value.type === 'block' ? 'widthFix' : 'aspectFit'}}"
                           bindtap="onFormulaImageTap"
                           data-alt="{{inline.value.alt}}" />
                  </text>
                </view>
                
                <!-- æ ‡é¢˜ -->
                <view wx:elif="{{block.type === 'heading'}}" class="md-heading md-h{{block.level}}">
                  <text wx:for="{{block.content}}" 
                        wx:for-item="inline" 
                        wx:key="index" 
                        class="md-inline">
                    <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                    <!-- ğŸ”§ æ–°å¢ï¼šæ ‡é¢˜ä¸­çš„æ•°å­¦å…¬å¼æ”¯æŒ -->
                    <image wx:elif="{{inline.type === 'math-formula'}}" 
                           class="math-formula-{{inline.value.type}}"
                           src="{{inline.value.src}}" 
                           alt="{{inline.value.alt}}"
                           mode="aspectFit" />
                  </text>
                </view>
                
                <!-- ä»£ç å— -->
                <view wx:elif="{{block.type === 'code'}}" class="md-code-block">
                  <text>{{block.content}}</text>
                </view>
                
                <!-- åˆ—è¡¨ -->
                <view wx:elif="{{block.type === 'list'}}" class="md-list-item" style="padding-left: {{block.indent * 2}}rpx">
                  <text class="md-list-marker">{{block.ordered ? 'â€¢ ' : 'â€¢ '}}</text>
                  <view class="md-list-content">
                    <text wx:for="{{block.content}}" 
                          wx:for-item="inline" 
                          wx:key="index" 
                          class="md-inline">
                      <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                      <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                      <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                      <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                      <!-- ğŸ”§ æ–°å¢ï¼šåˆ—è¡¨ä¸­çš„æ•°å­¦å…¬å¼æ”¯æŒ -->
                      <image wx:elif="{{inline.type === 'math-formula'}}" 
                             class="math-formula-{{inline.value.type}}"
                             src="{{inline.value.src}}" 
                             alt="{{inline.value.alt}}"
                             mode="aspectFit" />
                    </text>
                  </view>
                </view>
              </block>
              </block>
            </view>

            <!-- ç”¨æˆ·æ¶ˆæ¯ä¸­çš„å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <view wx:if="{{item.sender === 'user' && item.images && item.images.length > 0}}" 
                  class="message-images">
              <image wx:for="{{item.images}}" 
                     wx:for-item="img" 
                     wx:key="tempFilePath"
                     class="message-image"
                     src="{{img.tempFilePath}}"
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{img.tempFilePath}}" />
            </view>

            <!-- å›¾ç‰‡æ¶ˆæ¯ (æ—§æ ¼å¼ä¿ç•™å…¼å®¹) -->
            <image wx:elif="{{item.type === 'image'}}"
                   class="bubble-image"
                   src="{{item.content}}"
                   mode="widthFix"
                   bindtap="previewImage"
                   data-url="{{item.content}}" />

            <!-- AIæ¶ˆæ¯é™„åŠ ä¿¡æ¯ -->
            <view wx:if="{{item.sender === 'ai' && (item.confidence || item.sources)}}" class="ai-meta">
              <view wx:if="{{item.confidence}}" class="confidence">
                ç½®ä¿¡åº¦: {{item.confidence}}%
              </view>
              <view wx:if="{{item.sources && item.sources.length > 0}}" class="sources">
                <text class="sources-title">å‚è€ƒèµ„æ–™:</text>
                <view class="source-list">
                  <text wx:for="{{item.sources}}" wx:key="*this" class="source-item">{{item}}</text>
                </view>
              </view>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="bubble-actions">
            <view class="action-btn" bindtap="onCopyMessage" data-content="{{item.content}}">
              <van-icon name="copy" size="14" />
            </view>
            <view wx:if="{{item.status === 'failed'}}" class="action-btn"
                  bindtap="onRetryMessage"
                  data-message-id="{{item.id}}">
              <van-icon name="replay" size="14" />
            </view>
          </view>

          <!-- æ—¶é—´æˆ³ -->
          <view class="bubble-time">
            {{item.formattedTime || item.timestamp}}
          </view>
        </view>
      </view>
    </view>

    <!-- AIè¾“å…¥çŠ¶æ€ -->
    <view class="typing-indicator" wx:if="{{isAITyping}}">
      <view class="typing-avatar">
        <image src="/assets/images/ai-avatar.png" mode="aspectFill" />
      </view>
      <view class="typing-content">
        <view class="typing-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text class="typing-text">AIæ­£åœ¨æ€è€ƒä¸­...</text>
      </view>
    </view>

    <!-- å ä½åŒºåŸŸï¼Œç¡®ä¿è¾“å…¥æ¡†ä¸é®æŒ¡æ¶ˆæ¯ -->
    <view class="message-spacer"></view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="chat-input-container">
    <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
    <view class="image-preview-area" wx:if="{{uploadedImages.length > 0}}">
      <scroll-view scroll-x="{{true}}" class="image-preview-scroll">
        <view class="image-preview-list">
          <view class="image-preview-item" 
                wx:for="{{uploadedImages}}" 
                wx:key="index">
            <image src="{{item.tempFilePath}}" 
                   mode="aspectFill" 
                   class="preview-image"
                   lazy-load="{{true}}"
                   binderror="onImageLoadError"
                   bindload="onImageLoad" />
            <!-- åˆ é™¤æŒ‰é’® -->
            <view class="remove-image-btn" 
                  bindtap="removeImage" 
                  data-index="{{index}}">
              <van-icon name="cross" size="12" color="#fff" />
            </view>
            <!-- ä¸Šä¼ çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <view class="upload-status" wx:if="{{!item.aiUrl}}">
              <text class="upload-text">æœªä¸Šä¼ </text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
    <view class="input-area">
      <view class="input-wrapper">
        <!-- å·¦ä¾§è¯­éŸ³æŒ‰é’® -->
        <view class="input-left">
          <view class="voice-btn-circle"
                bindtouchstart="onVoiceTouchStart"
                bindtouchend="onVoiceTouchEnd"
                bindtouchmove="onVoiceTouchMove">
            <van-icon name="volume-o" size="20" color="#7c3aed" />
          </view>
        </view>

        <!-- ä¸­é—´è¾“å…¥æ¡† -->
        <view class="input-main {{inputFocus ? 'focused' : ''}}">
          <textarea class="input-text"
                    placeholder="åœ¨è¿™é‡Œè·Ÿæˆ‘å¯¹è¯"
                    value="{{inputText}}"
                    bindinput="onInputChange"
                    bindfocus="onInputFocus"
                    bindblur="onInputBlur"
                    auto-height="{{true}}"
                    show-confirm-bar="{{false}}"
                    cursor-spacing="10"
                    maxlength="{{maxInputLength || 500}}"
                    fixed="{{true}}" />
          
          <!-- å†…åµŒå‘é€æŒ‰é’® -->
          <view class="send-btn-inner {{!hasInputContent && uploadedImages.length === 0 ? 'disabled' : ''}}"
                bindtap="sendMessage">
            <van-icon name="guide-o" size="20" color="{{hasInputContent || uploadedImages.length > 0 ? '#7c3aed' : '#ccc'}}" />
          </view>
        </view>

        <!-- å³ä¾§å›¾ç‰‡æŒ‰é’® -->
        <view class="input-right">
          <view class="action-btn-circle image-mode" bindtap="onShowImageActions">
            <van-icon name="photo-o" size="20" color="#7c3aed" />
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç½‘ç»œçŠ¶æ€æç¤º -->
  <view class="network-status" wx:if="{{networkStatus === 'offline'}}">
    <van-icon name="wifi-off" size="16" />
    <text>ç½‘ç»œè¿æ¥å·²æ–­å¼€</text>
  </view>

  <!-- ğŸ”§ [ä¿®æ”¹] è¿”å›é¡¶éƒ¨æŒ‰é’® - åœ¨åº•éƒ¨æ—¶æ˜¾ç¤º -->
  <view class="scroll-to-bottom" wx:if="{{showScrollToTop}}" bindtap="onClickScrollToTop">
    <van-icon name="arrow-up" size="16" />
  </view>

  <!-- è¯­éŸ³å½•åˆ¶çŠ¶æ€é®ç½© -->
  <view class="voice-recording-mask" wx:if="{{recordStatus === 'recording'}}">
    <view class="recording-content">
      <!-- æ³¢çº¹åŠ¨ç”» -->
      <view class="recording-wave-container">
        <view class="wave-circle wave-1"></view>
        <view class="wave-circle wave-2"></view>
        <view class="wave-circle wave-3"></view>
        <view class="recording-icon">
          <van-icon name="volume-o" size="48" color="#fff" />
        </view>
      </view>

      <!-- æç¤ºæ–‡å­— -->
      <text class="recording-text">{{cancelVoice ? 'æ¾å¼€å–æ¶ˆå‘é€' : 'æ­£åœ¨å½•éŸ³ï¼Œæ¾å¼€å‘é€'}}</text>
      <text class="recording-duration">{{recordDuration}}s / 60s</text>
    </view>
  </view>
</view>

<!-- åŠŸèƒ½èœå• -->
<van-action-sheet
  show="{{showActionSheet}}"
  title="é€‰æ‹©åŠŸèƒ½"
  bind:close="onCloseActionSheet">
  <view class="action-items">
    <view class="action-item" bindtap="onHistory">
      <van-icon name="clock-o" size="24" />
      <text>èŠå¤©è®°å½•</text>
    </view>
    <view class="action-item" bindtap="onClearChat">
      <van-icon name="delete-o" size="24" />
      <text>æ¸…ç©ºè®°å½•</text>
    </view>
    <view class="action-item" bindtap="onSettings">
      <van-icon name="setting-o" size="24" />
      <text>è®¾ç½®</text>
    </view>
  </view>
</van-action-sheet>

<!-- å›¾ç‰‡ä¸Šä¼ é€‰æ‹©èœå• -->
<van-action-sheet
  show="{{showImageActions}}"
  title="é€‰æ‹©å›¾ç‰‡"
  bind:close="onCloseImageActions">
  <view class="action-items">
    <view class="action-item" bindtap="onTakePhoto">
      <van-icon name="photograph" size="24" />
      <text>æ‹ç…§</text>
    </view>
    <view class="action-item" bindtap="onChooseImage">
      <van-icon name="photo-o" size="24" />
      <text>ä»ç›¸å†Œé€‰æ‹©</text>
    </view>
  </view>
</van-action-sheet>

<!-- å†å²ä¼šè¯å¼¹çª— -->
<van-popup
  show="{{showHistoryPopup}}"
  position="bottom"
  round="{{true}}"
  custom-style="height: 60%"
  bind:close="onCloseHistory">
  <view class="history-popup">
    <view class="history-header">
      <text class="history-title">æœ€è¿‘ä¼šè¯</text>
      <van-icon name="cross" size="20" bindtap="onCloseHistory" />
    </view>
    
    <scroll-view class="history-list" scroll-y="{{true}}">
      <!-- ç©ºçŠ¶æ€ -->
      <view class="history-empty" wx:if="{{!recentSessions.length}}">
        <van-icon name="chat-o" size="48" color="#ccc" />
        <text class="empty-text">æš‚æ— å†å²ä¼šè¯</text>
      </view>
      
      <!-- ä¼šè¯åˆ—è¡¨ -->
      <view class="history-item {{item.id === sessionId ? 'active' : ''}}"
            wx:for="{{recentSessions}}"
            wx:key="id"
            bindtap="onSelectSession"
            data-session-id="{{item.id}}">
        <view class="history-item-content">
          <view class="history-item-title">
            <van-icon name="chat-o" size="16" color="#7c3aed" />
            <text class="title-text">{{item.title}}</text>
          </view>
          <view class="history-item-meta">
            <text class="meta-count">{{item.messageCount}}æ¡æ¶ˆæ¯</text>
            <text class="meta-divider">â€¢</text>
            <text class="meta-time">{{item.timeText}}</text>
          </view>
        </view>
        <van-icon wx:if="{{item.id === sessionId}}" name="success" size="16" color="#7c3aed" />
      </view>
    </scroll-view>
  </view>
</van-popup>

<!-- å…¨å±€æç¤ºç»„ä»¶ -->
<van-toast id="van-toast" />
<van-dialog id="van-dialog" />

