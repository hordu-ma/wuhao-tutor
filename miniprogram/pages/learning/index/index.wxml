<!--pages/chat/index/index.wxml-->
<view class="chat-container">
  <!-- 头部区域 -->
  <view class="chat-header">
    <view class="header-content">
      <!-- AI助手头像 -->
      <image class="ai-avatar" src="/assets/images/ai-avatar.png" mode="aspectFill" />
      <view class="header-info">
        <text class="ai-name">五好AI助手</text>
      </view>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="onShowHistory">
        <van-icon name="clock-o" size="16" color="#fff" />
        <text class="btn-text">历史</text>
      </view>
      <view class="action-btn" bindtap="onNewChat">
        <van-icon name="plus" size="16" color="#fff" />
        <text class="btn-text">新建</text>
      </view>
    </view>
  </view>

  <!-- 聊天消息区域 -->
  <scroll-view class="chat-messages"
               scroll-y="{{true}}"
               scroll-top="{{scrollTop}}"
               scroll-with-animation="{{true}}"
               refresher-enabled="{{true}}"
               refresher-triggered="{{refreshing}}"
               bindrefresherrefresh="onPullDownRefresh"
               bindscrolltoupper="onLoadMore">

    <!-- 历史消息加载 -->
    <view class="load-history" wx:if="{{hasMore && messageList.length > 0}}">
      <view class="load-history-btn" bindtap="loadMoreMessages" wx:if="{{!loadingHistory}}">
        <van-icon name="arrow-up" size="16" />
        <text>查看更多历史消息</text>
      </view>
      <view class="load-history-loading" wx:else>
        <van-loading size="16" />
        <text>加载中...</text>
      </view>
    </view>

    <!-- 欢迎消息 -->
    <view class="welcome-message" wx:if="{{!messageList.length && !loading}}">
      <!-- AI助手头像 -->
      <image class="welcome-avatar" src="/assets/images/ai-avatar.png" mode="aspectFill" />
      <view class="welcome-content">
        <text class="welcome-title">你好！我是五好AI助手</text>
        <text class="welcome-desc">我可以帮你解答学习中的各种问题，快来问我吧～</text>
      </view>
      
      <!-- 快捷问题气泡 -->
      <view class="quick-questions-bubbles" wx:if="{{quickQuestions.length > 0}}">
        <view class="bubble-item"
              wx:for="{{quickQuestions}}"
              wx:key="*this"
              bindtap="onQuickQuestion"
              data-question="{{item}}">
          {{item}}
        </view>
      </view>
    </view>

    <!-- 消息列表 -->
    <view class="message-list" wx:if="{{messageList.length > 0}}">
      <view class="chat-bubble {{item.sender === 'user' ? 'user' : 'ai'}}"
            wx:for="{{messageList}}" wx:key="id">
        <!-- 头像 -->
        <view class="bubble-avatar">
          <image wx:if="{{item.sender === 'user'}}"
                 src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"
                 binderror="onAvatarError"
                 mode="aspectFill" />
          <image wx:else
                 src="/assets/images/ai-avatar.png"
                 binderror="onAvatarError"
                 mode="aspectFill" />
        </view>

        <!-- 消息内容 -->
        <view class="bubble-content">
          <!-- 消息状态 -->
          <view class="message-status" wx:if="{{item.sender === 'user' && item.status !== 'sent'}}">
            <van-loading wx:if="{{item.status === 'sending'}}" size="12" />
            <van-icon wx:elif="{{item.status === 'failed'}}" name="warning-o" size="12" color="#f5222d" />
          </view>

          <!-- 消息主体 -->
          <view class="bubble-main">
            <!-- 文本消息 - 富文本渲染 -->
            <view wx:if="{{item.type === 'text'}}" class="bubble-text rich-text" selectable="{{true}}">
              <block wx:for="{{item.richContent || []}}" wx:for-item="block" wx:key="index">
                <!-- 段落 -->
                <view wx:if="{{block.type === 'paragraph'}}" class="md-paragraph">
                  <text wx:for="{{block.content}}" wx:for-item="inline" wx:key="index" class="md-inline">
                    <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'link'}}" class="md-link">{{inline.value.text}}</text>
                  </text>
                </view>
                
                <!-- 标题 -->
                <view wx:elif="{{block.type === 'heading'}}" class="md-heading md-h{{block.level}}">
                  <text wx:for="{{block.content}}" wx:for-item="inline" wx:key="index" class="md-inline">
                    <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                  </text>
                </view>
                
                <!-- 代码块 -->
                <view wx:elif="{{block.type === 'code'}}" class="md-code-block">
                  <text>{{block.content}}</text>
                </view>
                
                <!-- 列表 -->
                <view wx:elif="{{block.type === 'list'}}" class="md-list-item" style="padding-left: {{block.indent * 2}}rpx">
                  <text class="md-list-marker">{{block.ordered ? '• ' : '• '}}</text>
                  <text wx:for="{{block.content}}" wx:for-item="inline" wx:key="index" class="md-inline">
                    <text wx:if="{{inline.type === 'text'}}">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'bold'}}" class="md-bold">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'italic'}}" class="md-italic">{{inline.value}}</text>
                    <text wx:elif="{{inline.type === 'code'}}" class="md-code">{{inline.value}}</text>
                  </text>
                </view>
              </block>
            </view>

            <!-- 用户消息中的图片（如果有） -->
            <view wx:if="{{item.sender === 'user' && item.images && item.images.length > 0}}" 
                  class="message-images">
              <image wx:for="{{item.images}}" 
                     wx:for-item="img" 
                     wx:key="tempFilePath"
                     class="message-image"
                     src="{{img.tempFilePath}}"
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{img.tempFilePath}}" />
            </view>

            <!-- 图片消息 (旧格式保留兼容) -->
            <image wx:elif="{{item.type === 'image'}}"
                   class="bubble-image"
                   src="{{item.content}}"
                   mode="widthFix"
                   bindtap="previewImage"
                   data-url="{{item.content}}" />

            <!-- AI消息附加信息 -->
            <view wx:if="{{item.sender === 'ai' && (item.confidence || item.sources)}}" class="ai-meta">
              <view wx:if="{{item.confidence}}" class="confidence">
                置信度: {{item.confidence}}%
              </view>
              <view wx:if="{{item.sources && item.sources.length > 0}}" class="sources">
                <text class="sources-title">参考资料:</text>
                <view class="source-list">
                  <text wx:for="{{item.sources}}" wx:key="*this" class="source-item">{{item}}</text>
                </view>
              </view>
            </view>
          </view>

          <!-- 操作按钮 -->
          <view class="bubble-actions">
            <view class="action-btn" bindtap="onCopyMessage" data-content="{{item.content}}">
              <van-icon name="copy" size="14" />
            </view>
            <view wx:if="{{item.status === 'failed'}}" class="action-btn"
                  bindtap="onRetryMessage"
                  data-message-id="{{item.id}}">
              <van-icon name="replay" size="14" />
            </view>
          </view>

          <!-- 时间戳 -->
          <view class="bubble-time">
            {{item.timestamp}}
          </view>
        </view>
      </view>
    </view>

    <!-- AI输入状态 -->
    <view class="typing-indicator" wx:if="{{isAITyping}}">
      <view class="typing-avatar">
        <image src="/assets/images/ai-avatar.png" mode="aspectFill" />
      </view>
      <view class="typing-content">
        <view class="typing-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text class="typing-text">AI正在思考中...</text>
      </view>
    </view>

    <!-- 占位区域，确保输入框不遮挡消息 -->
    <view class="message-spacer"></view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="chat-input-container">
    <!-- 图片预览区域 -->
    <view class="image-preview-area" wx:if="{{uploadedImages.length > 0}}">
      <scroll-view scroll-x="{{true}}" class="image-preview-scroll">
        <view class="image-preview-list">
          <view class="image-preview-item" 
                wx:for="{{uploadedImages}}" 
                wx:key="index">
            <image src="{{item.tempFilePath}}" 
                   mode="aspectFill" 
                   class="preview-image"
                   lazy-load="{{true}}"
                   binderror="onImageLoadError"
                   bindload="onImageLoad" />
            <!-- 删除按钮 -->
            <view class="remove-image-btn" 
                  bindtap="removeImage" 
                  data-index="{{index}}">
              <van-icon name="cross" size="12" color="#fff" />
            </view>
            <!-- 上传状态指示器 -->
            <view class="upload-status" wx:if="{{!item.aiUrl}}">
              <text class="upload-text">未上传</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 输入框区域 -->
    <view class="input-area">
      <view class="input-wrapper">
        <!-- 左侧语音按钮 -->
        <view class="input-left">
          <view class="voice-btn-circle"
                bindtouchstart="onVoiceTouchStart"
                bindtouchend="onVoiceTouchEnd"
                bindtouchmove="onVoiceTouchMove">
            <van-icon name="volume-o" size="20" color="#7c3aed" />
          </view>
        </view>

        <!-- 中间输入框 -->
        <view class="input-main {{inputFocus ? 'focused' : ''}}">
          <textarea class="input-text"
                    placeholder="在这里跟我对话"
                    value="{{inputText}}"
                    bindinput="onInputChange"
                    bindfocus="onInputFocus"
                    bindblur="onInputBlur"
                    auto-height="{{true}}"
                    show-confirm-bar="{{false}}"
                    cursor-spacing="10"
                    maxlength="{{maxInputLength || 500}}"
                    fixed="{{true}}" />
          
          <!-- 内嵌发送按钮 -->
          <view class="send-btn-inner {{!hasInputContent && uploadedImages.length === 0 ? 'disabled' : ''}}"
                bindtap="sendMessage">
            <van-icon name="guide-o" size="20" color="{{hasInputContent || uploadedImages.length > 0 ? '#7c3aed' : '#ccc'}}" />
          </view>
        </view>

        <!-- 右侧图片按钮 -->
        <view class="input-right">
          <view class="action-btn-circle image-mode" bindtap="onShowImageActions">
            <van-icon name="photo-o" size="20" color="#7c3aed" />
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 网络状态提示 -->
  <view class="network-status" wx:if="{{networkStatus === 'offline'}}">
    <van-icon name="wifi-off" size="16" />
    <text>网络连接已断开</text>
  </view>

  <!-- 滚动到底部按钮 -->
  <view class="scroll-to-bottom" wx:if="{{showScrollToBottom}}" bindtap="scrollToBottom">
    <van-icon name="arrow-down" size="16" />
  </view>

  <!-- 语音录制状态遮罩 -->
  <view class="voice-recording-mask" wx:if="{{recordStatus === 'recording'}}">
    <view class="recording-content">
      <!-- 波纹动画 -->
      <view class="recording-wave-container">
        <view class="wave-circle wave-1"></view>
        <view class="wave-circle wave-2"></view>
        <view class="wave-circle wave-3"></view>
        <view class="recording-icon">
          <van-icon name="volume-o" size="48" color="#fff" />
        </view>
      </view>

      <!-- 提示文字 -->
      <text class="recording-text">{{cancelVoice ? '松开取消发送' : '正在录音，松开发送'}}</text>
      <text class="recording-duration">{{recordDuration}}s / 60s</text>
    </view>
  </view>
</view>

<!-- 功能菜单 -->
<van-action-sheet
  show="{{showActionSheet}}"
  title="选择功能"
  bind:close="onCloseActionSheet">
  <view class="action-items">
    <view class="action-item" bindtap="onHistory">
      <van-icon name="clock-o" size="24" />
      <text>聊天记录</text>
    </view>
    <view class="action-item" bindtap="onClearChat">
      <van-icon name="delete-o" size="24" />
      <text>清空记录</text>
    </view>
    <view class="action-item" bindtap="onSettings">
      <van-icon name="setting-o" size="24" />
      <text>设置</text>
    </view>
  </view>
</van-action-sheet>

<!-- 图片上传选择菜单 -->
<van-action-sheet
  show="{{showImageActions}}"
  title="选择图片"
  bind:close="onCloseImageActions">
  <view class="action-items">
    <view class="action-item" bindtap="onTakePhoto">
      <van-icon name="photograph" size="24" />
      <text>拍照</text>
    </view>
    <view class="action-item" bindtap="onChooseImage">
      <van-icon name="photo-o" size="24" />
      <text>从相册选择</text>
    </view>
  </view>
</van-action-sheet>

<!-- 历史会话弹窗 -->
<van-popup
  show="{{showHistoryPopup}}"
  position="bottom"
  round="{{true}}"
  custom-style="height: 60%"
  bind:close="onCloseHistory">
  <view class="history-popup">
    <view class="history-header">
      <text class="history-title">最近会话</text>
      <van-icon name="cross" size="20" bindtap="onCloseHistory" />
    </view>
    
    <scroll-view class="history-list" scroll-y="{{true}}">
      <!-- 空状态 -->
      <view class="history-empty" wx:if="{{!recentSessions.length}}">
        <van-icon name="chat-o" size="48" color="#ccc" />
        <text class="empty-text">暂无历史会话</text>
      </view>
      
      <!-- 会话列表 -->
      <view class="history-item {{item.id === sessionId ? 'active' : ''}}"
            wx:for="{{recentSessions}}"
            wx:key="id"
            bindtap="onSelectSession"
            data-session-id="{{item.id}}">
        <view class="history-item-content">
          <view class="history-item-title">
            <van-icon name="chat-o" size="16" color="#7c3aed" />
            <text class="title-text">{{item.title}}</text>
          </view>
          <view class="history-item-meta">
            <text class="meta-count">{{item.messageCount}}条消息</text>
            <text class="meta-divider">•</text>
            <text class="meta-time">{{item.timeText}}</text>
          </view>
        </view>
        <van-icon wx:if="{{item.id === sessionId}}" name="success" size="16" color="#7c3aed" />
      </view>
    </scroll-view>
  </view>
</van-popup>

<!-- 全局提示组件 -->
<van-toast id="van-toast" />
<van-dialog id="van-dialog" />

