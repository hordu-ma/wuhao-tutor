<!--pages/index/index.wxml - 五好伴学小程序首页模板-->
<view class="container">
  <!-- 刷新状态指示器 -->
  <view wx:if="{{refreshing}}" class="refresh-indicator">
    <van-loading type="spinner" size="16px" />
    <text class="refresh-text">正在刷新...</text>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <van-loading type="spinner" size="24px" />
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 用户信息区域 -->
    <view class="user-section bg-primary">
      <view class="user-info flex-between">
        <view class="user-detail flex">
          <image
            class="avatar rounded-full"
            src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"
            mode="aspectFill"
          />
          <view class="user-text">
            <text class="user-name text-white font-bold">
              {{isLoggedIn ? (userInfo.nickName || userInfo.name || '学生') : '未登录'}}
            </text>
            <text class="user-role text-white opacity-75">
              {{role === 'student' ? '学生' : role === 'parent' ? '家长' : '教师'}}
            </text>
          </view>
        </view>
        <view class="user-actions">
          <van-icon name="setting-o" size="20px" color="#ffffff" bind:click="onSettingsTap" />
        </view>
      </view>

      <!-- 统计数据 -->
      <view class="stats-section">
        <view class="stats-grid">
          <view class="stat-item" wx:if="{{role === 'student'}}">
            <text class="stat-number text-white font-bold">{{stats.homeworkCount}}</text>
            <text class="stat-label text-white opacity-75">待完成作业</text>
          </view>
          <view class="stat-item" wx:if="{{role === 'student'}}">
            <text class="stat-number text-white font-bold">{{stats.questionCount}}</text>
            <text class="stat-label text-white opacity-75">今日问答</text>
          </view>
          <view class="stat-item">
            <text class="stat-number text-white font-bold">{{stats.reportCount}}</text>
            <text class="stat-label text-white opacity-75">学习报告</text>
          </view>
          <view class="stat-item" wx:if="{{role === 'student'}}">
            <text class="stat-number text-white font-bold">{{formatStudyTime(stats.todayStudyTime)}}</text>
            <text class="stat-label text-white opacity-75">今日学习</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 消息通知区域 -->
    <view class="notifications-section" wx:if="{{notifications.length > 0}}">
      <view class="section-header flex-between">
        <view class="notifications-title-wrapper flex">
          <text class="section-title font-bold">最新消息</text>
          <view wx:if="{{unreadNotificationCount > 0}}" class="unread-badge">
            {{unreadNotificationCount}}
          </view>
        </view>
        <view class="notifications-actions flex">
          <text 
            wx:if="{{unreadNotificationCount > 0}}" 
            class="mark-all-btn text-secondary text-sm"
            bind:tap="markAllNotificationsRead"
          >
            全部已读
          </text>
          <text class="more-btn text-primary" bind:tap="onMoreNotificationsTap">查看更多</text>
        </view>
      </view>
      <view class="notifications-list">
        <view
          class="notification-item card {{!item.isRead ? 'unread' : ''}}"
          wx:for="{{notifications}}"
          wx:key="id"
          data-notification="{{item}}"
          bind:tap="onNotificationTap"
        >
          <view class="notification-header flex-between">
            <view class="notification-title-wrapper flex">
              <text class="notification-title font-bold">{{item.title}}</text>
              <view wx:if="{{item.priority === 'high'}}" class="priority-badge high">
                紧急
              </view>
              <view wx:elif="{{item.priority === 'medium'}}" class="priority-badge medium">
                重要
              </view>
            </view>
            <view class="notification-meta flex">
              <view wx:if="{{!item.isRead}}" class="unread-dot bg-error"></view>
              <text class="notification-time text-secondary text-sm">
                {{item.createdAt}}
              </text>
            </view>
          </view>
          <text class="notification-content text-secondary">{{item.content}}</text>
          <view class="notification-footer flex-between">
            <text class="notification-sender text-secondary text-sm">来自: {{item.sender}}</text>
            <van-icon wx:if="{{!item.isRead}}" name="arrow" size="12px" color="#999" />
          </view>
        </view>
      </view>
    </view>

    <!-- 个性化推荐区域 -->
    <view class="recommendations-section" wx:if="{{recommendations.length > 0}}">
      <view class="section-header">
        <text class="section-title font-bold">为您推荐</text>
      </view>
      <view class="recommendations-list">
        <view
          class="recommendation-item card"
          wx:for="{{recommendations}}"
          wx:key="id"
          data-recommendation="{{item}}"
          bind:tap="onRecommendationTap"
        >
          <view class="recommendation-header flex">
            <view class="recommendation-icon" style="background-color: {{item.color}}20">
              <van-icon name="{{item.icon}}" size="20px" color="{{item.color}}" />
            </view>
            <view class="recommendation-content">
              <text class="recommendation-title font-bold">{{item.title}}</text>
              <text class="recommendation-text text-secondary">{{item.content}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 待办事项区域 -->
    <view class="todo-section" wx:if="{{todoItems.length > 0}}">
      <view class="section-header">
        <text class="section-title font-bold">待办事项</text>
      </view>
      <view class="todo-list">
        <view
          class="todo-item card"
          wx:for="{{todoItems}}"
          wx:key="id"
          data-todo="{{item}}"
          bind:tap="onTodoItemTap"
        >
          <view class="todo-header flex-between">
            <view class="todo-content">
              <text class="todo-title font-bold">{{item.title}}</text>
              <text class="todo-description text-secondary">{{item.description}}</text>
              <view class="todo-meta flex">
                <text class="todo-deadline text-sm" 
                      style="color: {{item.priority === 'high' ? '#f5222d' : item.priority === 'medium' ? '#faad14' : '#52c41a'}}">
                  {{item.deadline}}
                </text>
                <view class="todo-priority {{item.priority}}-priority">
                  {{item.priority === 'high' ? '紧急' : item.priority === 'medium' ? '一般' : '不急'}}
                </view>
              </view>
            </view>
            <view class="todo-actions">
              <van-button
                wx:if="{{!item.completed}}"
                type="primary"
                size="mini"
                round
                data-todo="{{item}}"
                bind:tap="onCompleteTodoItem"
              >
                完成
              </van-button>
              <van-icon wx:else name="success" size="24px" color="#52c41a" />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 学习建议区域 (仅学生可见) - 保留原有功能但简化 -->
    <view class="suggestions-section" wx:if="{{role === 'student' && recommendations.length === 0}}">
      <view class="section-header">
        <text class="section-title font-bold">AI学习建议</text>
      </view>
      <view class="suggestion-card card">
        <view class="suggestion-header flex">
          <van-icon name="bulb-o" size="16px" color="#faad14" />
          <text class="suggestion-title font-bold">今日建议</text>
        </view>
        <text class="suggestion-content text-secondary">
          根据您的学习情况，建议重点复习数学函数章节，并完成3道相关练习题。
        </text>
        <view class="suggestion-actions">
          <van-button type="primary" size="small" round>开始学习</van-button>
        </view>
      </view>
    </view>

    <!-- 学习进度区域 (仅家长可见) -->
    <view class="progress-section" wx:if="{{role === 'parent'}}">
      <view class="section-header">
        <text class="section-title font-bold">孩子学习进度</text>
      </view>
      <view class="progress-card card">
        <view class="progress-item">
          <text class="progress-label">本周完成率</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: 75%"></view>
          </view>
          <text class="progress-value">75%</text>
        </view>
        <view class="progress-item">
          <text class="progress-label">平均成绩</text>
          <view class="progress-score">
            <text class="score-value font-bold text-success">85</text>
            <text class="score-unit text-secondary">分</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 班级概况区域 (仅教师可见) -->
    <view class="class-overview-section" wx:if="{{role === 'teacher'}}">
      <view class="section-header">
        <text class="section-title font-bold">班级概况</text>
      </view>
      <view class="overview-grid">
        <view class="overview-item card">
          <text class="overview-number font-bold text-primary">32</text>
          <text class="overview-label text-secondary">班级人数</text>
        </view>
        <view class="overview-item card">
          <text class="overview-number font-bold text-success">28</text>
          <text class="overview-label text-secondary">已提交作业</text>
        </view>
        <view class="overview-item card">
          <text class="overview-number font-bold text-warning">4</text>
          <text class="overview-label text-secondary">待批改</text>
        </view>
        <view class="overview-item card">
          <text class="overview-number font-bold text-error">2</text>
          <text class="overview-label text-secondary">异常学情</text>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty" wx:if="{{!hasUserInfo}}">
      <image class="empty-image" src="/assets/images/empty-user.png" mode="aspectFit" />
      <text class="empty-text">请先完成登录</text>
      <van-button type="primary" round bind:click="onLoginTap">立即登录</van-button>
    </view>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-area"></view>
</view>

<!-- 引入Vant组件样式 -->
<van-toast id="van-toast" />
<van-dialog id="van-dialog" />
