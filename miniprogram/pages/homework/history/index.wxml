<!--pages/homework/history/index.wxml - 作业历史记录页面模板-->
<view class="history-container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="title">作业历史</view>
    <view class="subtitle">共完成 {{statistics.totalCount}} 次作业</view>
  </view>

  <!-- 统计卡片 -->
  <view class="statistics-card">
    <view class="stat-item">
      <view class="stat-number">{{statistics.correctedCount}}</view>
      <view class="stat-label">已批改</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{statistics.averageScore}}</view>
      <view class="stat-label">平均分</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{statistics.excellentCount}}</view>
      <view class="stat-label">优秀作业</view>
    </view>
    <view class="stat-item" bind:tap="onViewStatistics">
      <van-icon name="chart-trending-o" size="20px" color="#1989fa" />
      <view class="stat-label">详细统计</view>
    </view>
  </view>

  <!-- 工具栏 -->
  <view class="toolbar">
    <view class="view-mode">
      <view class="mode-item {{viewMode === 'list' ? 'active' : ''}}" 
            data-mode="list" bind:tap="onViewModeChange">
        <van-icon name="list-switch" />
        <text>列表</text>
      </view>
      <view class="mode-item {{viewMode === 'chart' ? 'active' : ''}}" 
            data-mode="chart" bind:tap="onViewModeChange">
        <van-icon name="chart-trending-o" />
        <text>图表</text>
      </view>
    </view>
    
    <view class="actions">
      <van-button round size="small" bind:tap="onShowFilter">
        <van-icon name="filter-o" />
        筛选
      </van-button>
      <van-button round size="small" bind:tap="onExportHistory">
        <van-icon name="share-o" />
        导出
      </van-button>
    </view>
  </view>

  <!-- 内容区域 -->
  <view class="content">
    <!-- 列表模式 -->
    <view wx:if="{{viewMode === 'list'}}">
      <!-- 加载状态 -->
      <van-loading wx:if="{{loading}}" type="spinner" text-color="#999">
        正在加载历史记录...
      </van-loading>

      <!-- 历史记录列表 -->
      <view wx:elif="{{historyList.length > 0}}" class="history-list">
        <view wx:for="{{historyList}}" wx:key="id" 
              class="history-item" 
              data-item="{{item}}"
              bind:tap="onHistoryItemTap">
          
          <!-- 左侧图标 -->
          <view class="item-icon">
            <view class="subject-tag" style="background-color: {{item.subject === '数学' ? '#ff6b6b' : item.subject === '语文' ? '#4ecdc4' : item.subject === '英语' ? '#45b7d1' : item.subject === '物理' ? '#96ceb4' : '#ffeaa7'}}">
              {{item.subject}}
            </view>
          </view>

          <!-- 中间内容 -->
          <view class="item-content">
            <view class="item-title">{{item.title}}</view>
            <view class="item-meta">
              <text class="submit-time">提交时间：{{formatTime(item.submittedAt)}}</text>
              <text wx:if="{{item.correctedAt}}" class="correct-time">
                批改时间：{{formatTime(item.correctedAt)}}
              </text>
            </view>
            
            <!-- 成绩信息 -->
            <view wx:if="{{item.status === 'corrected'}}" class="score-info">
              <view class="score">{{item.score}}/{{item.totalScore}}</view>
              <view class="grade grade-{{item.grade}}">{{item.grade}}</view>
              <view wx:if="{{item.isExcellent}}" class="excellent-badge">
                <van-icon name="medal-o" color="#ffd700" />
                优秀
              </view>
            </view>
          </view>

          <!-- 右侧状态 -->
          <view class="item-status">
            <view wx:if="{{item.status === 'submitted'}}" class="status-tag pending">
              待批改
            </view>
            <view wx:elif="{{item.status === 'corrected'}}" class="status-tag completed">
              已批改
            </view>
            <van-icon name="arrow" />
          </view>
        </view>

        <!-- 加载更多 -->
        <view wx:if="{{hasMore}}" class="load-more">
          <van-loading wx:if="{{loadingMore}}" type="spinner" size="16px">
            加载中...
          </van-loading>
          <text wx:else class="load-more-text">上拉加载更多</text>
        </view>
        
        <view wx:else class="no-more">
          <van-icon name="checked" color="#ddd" />
          没有更多历史记录了
        </view>
      </view>

      <!-- 空状态 -->
      <view wx:else class="empty-state">
        <van-icon name="notes-o" size="60px" color="#ddd" />
        <view class="empty-text">暂无作业历史记录</view>
        <van-button round type="primary" size="small" 
                    bind:tap="onGoToHomework">
          去做作业
        </van-button>
      </view>
    </view>

    <!-- 图表模式 -->
    <view wx:elif="{{viewMode === 'chart'}}" class="chart-view">
      <!-- 图表占位 -->
      <view class="chart-placeholder">
        <van-icon name="chart-trending-o" size="80px" color="#ddd" />
        <view class="placeholder-text">图表功能开发中...</view>
      </view>
    </view>
  </view>

  <!-- 错误提示 -->
  <van-toast id="van-toast" />
  
  <!-- 筛选弹窗 -->
  <van-popup show="{{showFilterPopup}}" position="bottom" 
             custom-style="height: 70vh;" bind:close="onCloseFilter">
    <view class="filter-popup">
      <view class="filter-header">
        <text>筛选条件</text>
        <van-button type="primary" size="small" bind:tap="onResetFilter">
          重置
        </van-button>
      </view>

      <scroll-view scroll-y class="filter-content">
        <!-- 时间范围 -->
        <view class="filter-section">
          <view class="section-title">时间范围</view>
          <view class="option-grid">
            <view wx:for="{{timeRangeOptions}}" wx:key="value"
                  class="option-item {{filterOptions.timeRange === item.value ? 'active' : ''}}"
                  data-value="{{item.value}}"
                  bind:tap="onTimeRangeSelect">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 科目筛选 -->
        <view class="filter-section">
          <view class="section-title">科目</view>
          <view class="option-grid">
            <view wx:for="{{subjectOptions}}" wx:key="*this"
                  class="option-item {{filterOptions.subject === (item === '全部科目' ? 'all' : item) ? 'active' : ''}}"
                  data-subject="{{item}}"
                  bind:tap="onSubjectSelect">
              {{item}}
            </view>
          </view>
        </view>

        <!-- 状态筛选 -->
        <view class="filter-section">
          <view class="section-title">状态</view>
          <view class="option-grid">
            <view wx:for="{{statusOptions}}" wx:key="value"
                  class="option-item {{filterOptions.status === item.value ? 'active' : ''}}"
                  data-value="{{item.value}}"
                  bind:tap="onStatusSelect">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 排序方式 -->
        <view class="filter-section">
          <view class="section-title">排序</view>
          <view class="sort-options">
            <view class="sort-item">
              <text>排序字段：</text>
              <van-radio-group value="{{filterOptions.sortBy}}" bind:change="onSortSelect">
                <van-radio name="time" data-sort-by="time">时间</van-radio>
                <van-radio name="score" data-sort-by="score">分数</van-radio>
                <van-radio name="subject" data-sort-by="subject">科目</van-radio>
              </van-radio-group>
            </view>
            
            <view class="sort-item">
              <text>排序顺序：</text>
              <van-radio-group value="{{filterOptions.sortOrder}}" bind:change="onSortSelect">
                <van-radio name="desc" data-sort-order="desc">降序</van-radio>
                <van-radio name="asc" data-sort-order="asc">升序</van-radio>
              </van-radio-group>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="filter-footer">
        <van-button block type="primary" bind:tap="onApplyFilter">
          应用筛选
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- 日期选择器 -->
  <van-datetime-picker
    show="{{showDatePicker}}"
    type="date"
    title="{{datePickerType === 'start' ? '选择开始日期' : '选择结束日期'}}"
    bind:confirm="onDateConfirm"
    bind:cancel="{{() => setData({showDatePicker: false})}}"
  />
</view>