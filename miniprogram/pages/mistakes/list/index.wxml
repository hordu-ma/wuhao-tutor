<!--pages/mistakes/list/index.wxml-->
<view class="mistakes-list-container">
  <!-- å¤´éƒ¨ç­›é€‰åŒºåŸŸ -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view class="filter-tab {{activeTab === 'all' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="all">
        å…¨éƒ¨
      </view>
      <view class="filter-tab {{activeTab === 'not_mastered' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="not_mastered">
        æœªæŒæ¡
      </view>
      <view class="filter-tab {{activeTab === 'reviewing' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="reviewing">
        å¤ä¹ ä¸­
      </view>
      <view class="filter-tab {{activeTab === 'mastered' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="mastered">
        å·²æŒæ¡
      </view>
    </view>

    <!-- ç­›é€‰å’Œæœç´¢æŒ‰é’® -->
    <view class="filter-actions">
      <van-icon name="filter-o" size="20px" bindtap="onOpenFilter" />
      <van-icon name="search" size="20px" bindtap="onOpenSearch" />
    </view>
  </view>

  <!-- æœç´¢åŒºåŸŸ -->
  <view class="search-section" wx:if="{{showSearch}}">
    <van-search
      value="{{searchKeyword}}"
      placeholder="æœç´¢é”™é¢˜å†…å®¹æˆ–çŸ¥è¯†ç‚¹"
      use-action-slot
      bind:change="onSearchChange"
      bind:search="onSearch"
      bind:clear="onSearchClear">
      <view slot="action" bindtap="onCloseSearch">å–æ¶ˆ</view>
    </van-search>
  </view>

  <!-- é”™é¢˜åˆ—è¡¨åŒºåŸŸ -->
  <scroll-view class="mistakes-scroll"
               scroll-y="{{true}}"
               refresher-enabled="{{true}}"
               refresher-triggered="{{refreshing}}"
               bindrefresherrefresh="onRefresh"
               bindscrolltolower="onLoadMore">

    <!-- åŠ è½½çŠ¶æ€ -->
    <loading wx:if="{{loading && !mistakesList.length}}" />

    <!-- ç©ºçŠ¶æ€ -->
    <empty-state wx:if="{{!loading && !mistakesList.length}}"
                 type="default"
                 text="æš‚æ— é”™é¢˜"
                 description="{{getEmptyDescription(activeTab)}}" />

    <!-- é”™é¢˜åˆ—è¡¨ -->
    <view class="mistakes-list" wx:if="{{mistakesList.length > 0}}">
      <mistake-card
        wx:for="{{mistakesList}}"
        wx:key="id"
        mistake="{{item}}"
        mode="list"
        showActions="{{true}}"
        bind:tap="onMistakeTap"
        bind:delete="onMistakeDelete"
        bind:review="onMistakeReview" />
    </view>

    <!-- åŠ è½½æ›´å¤šçŠ¶æ€ -->
    <view class="load-more" wx:if="{{hasMore && mistakesList.length > 0}}">
      <view class="load-more-loading" wx:if="{{loadingMore}}">
        <van-loading size="20rpx" />
        <text class="load-more-text">åŠ è½½ä¸­...</text>
      </view>
      <view class="load-more-text" wx:else>ä¸Šæ‹‰åŠ è½½æ›´å¤š</view>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:if="{{!hasMore && mistakesList.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šé”™é¢˜äº†</text>
    </view>
  </scroll-view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® - å·²ç§»é™¤æ‰‹åŠ¨æ·»åŠ åŠŸèƒ½ -->
  <!-- ğŸ“Œ AIé©±åŠ¨é”™é¢˜æœ¬ï¼šé”™é¢˜å°†ä»å­¦ä¹ é—®ç­”è‡ªåŠ¨åˆ›å»º -->

  <!-- é”™é¢˜ç­›é€‰å¼¹çª— -->
  <van-popup show="{{showFilterPopup}}"
             position="bottom"
             round="{{true}}"
             bind:close="onCloseFilter">
    <view class="filter-popup">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <van-icon name="cross" bindtap="onCloseFilter" />
      </view>

      <view class="filter-content">
        <!-- ğŸ¯ é”™é¢˜ç±»å‹ç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-label">é”™é¢˜ç±»å‹</text>
          <view class="filter-options">
            <view class="filter-option {{selectedCategory === item.value ? 'selected' : ''}}"
                  wx:for="{{categoryOptions}}"
                  wx:key="value"
                  bindtap="onCategorySelect"
                  data-category="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- ğŸ¯ æ¥æºç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-label">æ¥æº</text>
          <view class="filter-options">
            <view class="filter-option {{selectedSource === item.value ? 'selected' : ''}}"
                  wx:for="{{sourceOptions}}"
                  wx:key="value"
                  bindtap="onSourceSelect"
                  data-source="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- ç§‘ç›®ç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-label">ç§‘ç›®</text>
          <view class="filter-options">
            <view class="filter-option {{selectedSubject === item ? 'selected' : ''}}"
                  wx:for="{{subjectOptions}}"
                  wx:key="*this"
                  bindtap="onSubjectSelect"
                  data-subject="{{item}}">
              {{item}}
            </view>
          </view>
        </view>

        <!-- çŸ¥è¯†ç‚¹ç­›é€‰ -->
        <view class="filter-group" wx:if="{{knowledgePointOptions.length > 0}}">
          <text class="filter-label">çŸ¥è¯†ç‚¹</text>
          <view class="filter-options">
            <view class="filter-option {{selectedKnowledgePoint === item.name ? 'selected' : ''}}"
                  wx:for="{{knowledgePointOptions}}"
                  wx:key="name"
                  bindtap="onKnowledgePointSelect"
                  data-knowledge-point="{{item.name}}">
              {{item.name}}
              <text class="option-count" wx:if="{{item.mistake_count > 0}}">({{item.mistake_count}})</text>
            </view>
          </view>
        </view>

        <!-- éš¾åº¦ç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-label">éš¾åº¦</text>
          <view class="filter-options">
            <view class="filter-option {{selectedDifficulty === item.value ? 'selected' : ''}}"
                  wx:for="{{difficultyOptions}}"
                  wx:key="value"
                  bindtap="onDifficultySelect"
                  data-difficulty="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>
      </view>

      <view class="filter-actions">
        <van-button plain bindtap="onResetFilter">é‡ç½®</van-button>
        <van-button type="primary" bindtap="onConfirmFilter">ç¡®å®š</van-button>
      </view>
    </view>
  </van-popup>
</view>
