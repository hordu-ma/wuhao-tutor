<!--pages/mistakes/review/index.wxml-->
<view class="review-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-wrapper" wx:if="{{loading}}">
    <van-loading type="spinner" size="48rpx" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- å¤ä¹ å†…å®¹ -->
  <view class="review-content" wx:if="{{!loading && !showResult}}">
    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <view class="progress-section">
      <view class="stage-steps">
        <view 
          wx:for="{{stageSteps}}" 
          wx:key="index" 
          class="stage-step {{index < currentStage ? 'completed' : ''}} {{index === currentStage - 1 ? 'active' : ''}}">
          <view class="step-circle">
            <text class="step-number" wx:if="{{index >= currentStage}}">{{index + 1}}</text>
            <van-icon wx:if="{{index < currentStage}}" name="success" color="#52c41a" size="20px" />
            <view wx:if="{{index === currentStage - 1}}" class="step-dot"></view>
          </view>
          <view class="step-content">
            <text class="step-title">{{item.text}}</text>
            <text class="step-desc">{{item.desc}}</text>
          </view>
        </view>
      </view>
      <view class="stage-info">
        <text class="stage-name">{{stageName}}</text>
        <text class="stage-desc">ç¬¬ {{currentStage}} / 3 é˜¶æ®µ</text>
      </view>
    </view>

    <!-- é¢˜ç›®å†…å®¹ -->
    <view class="question-section">
      <view class="section-title">
        <van-icon name="question-o" size="20px" color="#1890ff" />
        <text>é¢˜ç›®å†…å®¹</text>
      </view>
      
      <!-- OCRæ–‡å­—å†…å®¹ -->
      <view class="question-content" wx:if="{{questionContent && questionContent.indexOf('æš‚æ— ') === -1 && questionContent.indexOf('è¯·æŸ¥çœ‹') === -1}}">
        {{questionContent}}
      </view>
      
      <!-- ğŸ¯ [Phase 1] åŸé¢˜å›¾ç‰‡è½®æ’­ -->
      <view class="question-images" wx:if="{{hasImages && imageUrls.length > 0}}">
        <swiper 
          class="image-swiper"
          indicator-dots="{{imageUrls.length > 1}}"
          indicator-color="rgba(255, 255, 255, 0.5)"
          indicator-active-color="#1890ff"
          autoplay="{{false}}"
          duration="300"
          circular="{{imageUrls.length > 1}}">
          <swiper-item wx:for="{{imageUrls}}" wx:key="index">
            <image 
              src="{{item}}" 
              mode="widthFix"
              class="question-image"
              bindtap="onPreviewImage"
              data-url="{{item}}"
              data-urls="{{imageUrls}}"
              lazy-load="{{true}}" />
          </swiper-item>
        </swiper>
        <view class="image-count" wx:if="{{imageUrls.length > 1}}">
          <van-icon name="photo-o" size="14px" />
          <text>å…± {{imageUrls.length}} å¼ å›¾ç‰‡ï¼Œç‚¹å‡»å¯æ”¾å¤§æŸ¥çœ‹</text>
        </view>
      </view>
      
      <!-- æ— å†…å®¹æç¤º -->
      <view class="no-content-tip" wx:if="{{!questionContent && !hasImages}}">
        <van-icon name="info-o" size="32px" color="#ff9800" />
        <text class="tip-text">æš‚æ— é¢˜ç›®å†…å®¹</text>
        <text class="tip-hint">è¯·è”ç³»è€å¸ˆè¡¥å……é¢˜ç›®ä¿¡æ¯</text>
      </view>

      <!-- çŸ¥è¯†ç‚¹æ ‡ç­¾ -->
      <view class="knowledge-points" wx:if="{{knowledgePoints.length > 0}}">
        <van-tag 
          wx:for="{{knowledgePoints}}" 
          wx:key="index" 
          type="primary" 
          plain 
          size="medium"
          custom-class="knowledge-tag">
          {{item}}
        </van-tag>
      </view>
    </view>

    <!-- ç­”æ¡ˆè¾“å…¥åŒº -->
    <view class="answer-section">
      <view class="section-title">
        <van-icon name="edit" size="20px" color="#52c41a" />
        <text>ä½ çš„ç­”æ¡ˆ</text>
      </view>
      <textarea
        class="answer-textarea"
        value="{{userAnswer}}"
        placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."
        placeholder-style="color: #999;"
        auto-height
        bindinput="onAnswerInput"
        maxlength="-1"
      />
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-section">
      <view class="action-buttons">
        <van-button 
          type="primary" 
          size="large" 
          custom-class="submit-btn"
          loading="{{submitting}}"
          disabled="{{!userAnswer || !userAnswer.trim()}}"
          bindtap="onSubmitAnswer">
          æäº¤ç­”æ¡ˆ
        </van-button>
        <van-button 
          type="default" 
          size="large" 
          custom-class="skip-btn"
          disabled="{{submitting}}"
          bindtap="onSkipQuestion">
          ä¸ä¼šåšï¼ŒæŸ¥çœ‹ç­”æ¡ˆ
        </van-button>
      </view>

      <view class="tips">
        <van-icon name="info-o" size="14px" />
        <text class="tips-text">AIå°†æ™ºèƒ½åˆ¤æ–­ä½ çš„ç­”æ¡ˆå‡†ç¡®æ€§</text>
      </view>
    </view>
  </view>

  <!-- ç»“æœå¼¹çª— -->
  <van-dialog
    use-slot
    show="{{ showResultDialog }}"
    bind:close="onResultDialogConfirm">
    <view class="result-dialog">
      <!-- å¯æ»šåŠ¨å†…å®¹åŒº -->
      <scroll-view class="dialog-scroll-content" scroll-y>
        <view class="result-icon">
          <van-icon 
            name="{{resultData.correct ? 'passed' : 'close'}}" 
            size="60px" 
            color="{{resultData.correct ? '#52c41a' : '#ff4d4f'}}" 
          />
        </view>
        <text class="result-title">{{resultData.message}}</text>

        <!-- ç­”é”™æˆ–è·³è¿‡æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -->
        <view wx:if="{{!resultData.correct}}" class="result-detail">
          <!-- ç”¨æˆ·ç­”æ¡ˆï¼ˆéskipæ—¶æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{!resultData.skip && resultData.user_answer}}" class="answer-block">
            <text class="block-title">ä½ çš„ç­”æ¡ˆï¼š</text>
            <text class="block-content">{{resultData.user_answer}}</text>
          </view>

          <!-- æ ‡å‡†ç­”æ¡ˆ -->
          <view class="answer-block">
            <text class="block-title">å‚è€ƒç­”æ¡ˆï¼š</text>
            <text class="block-content">{{resultData.standard_answer}}</text>
          </view>

          <!-- AIåé¦ˆï¼ˆéskipæ—¶æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{!resultData.skip && resultData.ai_feedback}}" class="answer-block">
            <text class="block-title">AIè¯„ä»·ï¼š</text>
            <text class="block-content feedback">{{resultData.ai_feedback}}</text>
          </view>

          <!-- çŸ¥è¯†ç‚¹ -->
          <view wx:if="{{resultData.knowledge_points}}" class="answer-block">
            <text class="block-title">ç›¸å…³çŸ¥è¯†ç‚¹ï¼š</text>
            <text class="block-content">{{resultData.knowledge_points}}</text>
          </view>
        </view>

        <!-- ç­”å¯¹æ—¶æ˜¾ç¤ºåé¦ˆ -->
        <view wx:if="{{resultData.correct && resultData.ai_feedback}}" class="result-detail">
          <view class="answer-block">
            <text class="block-title">AIè¯„ä»·ï¼š</text>
            <text class="block-content feedback success">{{resultData.ai_feedback}}</text>
          </view>
          <view wx:if="{{resultData.score}}" class="score-badge">
            <text>å¾—åˆ†ï¼š{{resultData.score}}</text>
          </view>
        </view>
      </scroll-view>

      <!-- å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰é’® -->
      <view class="dialog-footer">
        <van-button 
          type="primary" 
          size="large" 
          block
          bind:click="onResultDialogConfirm">
          {{resultDialogBtn}}
        </van-button>
      </view>
    </view>
  </van-dialog>

  <!-- å®Œæˆç»“æœ -->
  <view class="result-wrapper" wx:if="{{showResult}}">
    <view class="result-content">
      <van-icon 
        name="{{resultData.success ? 'passed' : 'close'}}" 
        size="80px" 
        color="{{resultData.success ? '#52c41a' : '#ff4d4f'}}" 
      />
      <text class="result-title">{{resultData.title}}</text>
      <text class="result-message">{{resultData.message}}</text>

      <van-button 
        type="primary" 
        size="large" 
        custom-class="result-btn"
        bindtap="onBackToList">
        è¿”å›åˆ—è¡¨
      </van-button>
    </view>
  </view>
</view>

<!-- Toast æç¤º -->
<van-toast id="van-toast" />

<!-- Dialog å¯¹è¯æ¡† -->
<van-dialog id="van-dialog" />
