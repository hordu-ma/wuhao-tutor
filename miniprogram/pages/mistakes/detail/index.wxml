<!--pages/mistakes/detail/index.wxml-->
<wxs module="utils">
  var toPercent = function(value) {
    if (!value) return 0;
    return Math.round(value * 100);
  };
  
  var isStringArray = function(arr) {
    if (!arr || arr.length === 0) return false;
    return typeof arr[0] === 'string';
  };
  
  module.exports = {
    toPercent: toPercent,
    isStringArray: isStringArray
  };
</wxs>

<view class="mistake-detail-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <loading wx:if="{{loading}}" />

  <!-- é”™é¢˜è¯¦æƒ… -->
  <view class="mistake-detail" wx:if="{{!loading && mistakeDetail}}">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="detail-header">
      <view class="header-info">
        <van-tag type="primary">{{mistakeDetail.subject}}</van-tag>
        <van-tag type="{{getMasteryStatusTag(mistakeDetail.mastery_status).type}}" plain>
          {{getMasteryStatusTag(mistakeDetail.mastery_status).text}}
        </van-tag>
        <van-tag type="warning" plain>éš¾åº¦: {{getDifficultyText(mistakeDetail.difficulty_level)}}</van-tag>
      </view>
      <view class="header-time">
        åˆ›å»ºæ—¶é—´: {{mistakeDetail.created_at}}
      </view>
    </view>

    <!-- é¢˜ç›®å›¾ç‰‡ -->
    <view class="detail-section" wx:if="{{mistakeDetail.image_urls && mistakeDetail.image_urls.length}}">
      <view class="section-title">é¢˜ç›®å›¾ç‰‡</view>
      <view class="image-container">
        <image wx:for="{{mistakeDetail.image_urls}}" 
               wx:key="*this" 
               src="{{item}}" 
               mode="widthFix" 
               class="question-image"
               bindtap="onPreviewImage"
               data-url="{{item}}" 
               data-urls="{{mistakeDetail.image_urls}}" />
      </view>
    </view>

    <!-- é¢˜ç›®å†…å®¹ -->
    <view class="detail-section">
      <view class="section-title">é¢˜ç›®å†…å®¹</view>
      <view class="section-content">
        <text class="content-text" wx:if="{{mistakeDetail.question_content && mistakeDetail.question_content != 'æš‚æ— é¢˜ç›®å†…å®¹'}}">{{mistakeDetail.question_content}}</text>
        <text class="placeholder-text" wx:else>æš‚æ— æ–‡å­—å†…å®¹ï¼Œè¯·æŸ¥çœ‹é¢˜ç›®å›¾ç‰‡</text>
      </view>
    </view>

    <!-- æˆ‘çš„ç­”æ¡ˆ -->
    <view class="detail-section" wx:if="{{mistakeDetail.student_answer}}">
      <view class="section-title">æˆ‘çš„ç­”æ¡ˆ</view>
      <view class="section-content error-answer">
        <text class="content-text">{{mistakeDetail.student_answer}}</text>
      </view>
    </view>

    <!-- æ­£ç¡®ç­”æ¡ˆ -->
    <view class="detail-section" wx:if="{{mistakeDetail.correct_answer}}">
      <view class="section-title">æ­£ç¡®ç­”æ¡ˆ</view>
      <view class="section-content correct-answer">
        <text class="content-text">{{mistakeDetail.correct_answer}}</text>
      </view>
    </view>

    <!-- è§£æ -->
    <view class="detail-section" wx:if="{{mistakeDetail.explanation}}">
      <view class="section-title">è§£æ</view>
      <view class="section-content">
        <text class="content-text">{{mistakeDetail.explanation}}</text>
      </view>
    </view>

    <!-- çŸ¥è¯†ç‚¹åˆ†æï¼ˆæ–°ç‰ˆ - æ¥è‡ªçŸ¥è¯†å›¾è°±ï¼‰ -->
    <view class="detail-section" wx:if="{{knowledgeAnalysis && knowledgeAnalysis.knowledge_points && knowledgeAnalysis.knowledge_points.length}}">
      <view class="section-title">
        ğŸ“š çŸ¥è¯†ç‚¹åˆ†æ
        <van-tag type="primary" plain size="small" style="margin-left: 8px;">
          å…± {{knowledgeAnalysis.total_count}} ä¸ª
        </van-tag>
      </view>
      
      <view class="knowledge-points-list">
        <view class="knowledge-point-item" 
              wx:for="{{knowledgeAnalysis.knowledge_points}}" 
              wx:key="id">
          <view class="kp-header">
            <view class="kp-name-wrapper">
              <text class="kp-name">{{item.knowledge_point_name}}</text>
              <van-tag 
                type="primary" 
                plain 
                size="mini"
                wx:if="{{item.is_primary}}">
                ä¸»è¦
              </van-tag>
            </view>
            <van-tag 
              type="{{item.mastery_level >= 0.7 ? 'success' : item.mastery_level >= 0.4 ? 'warning' : 'danger'}}" 
              plain>
              æŒæ¡åº¦: {{utils.toPercent(item.mastery_level)}}%
            </van-tag>
          </view>
          
          <view class="kp-info">
            <view class="info-row" wx:if="{{item.error_type}}">
              <van-icon name="warning-o" size="14px" color="#faad14" />
              <text class="info-label">é”™è¯¯ç±»å‹:</text>
              <text class="info-value">{{item.error_type}}</text>
            </view>
            
            <view class="info-row" wx:if="{{item.relevance_score}}">
              <van-icon name="star" size="14px" color="#1890ff" />
              <text class="info-label">ç›¸å…³åº¦:</text>
              <text class="info-value">{{utils.toPercent(item.relevance_score)}}%</text>
            </view>
            
            <view class="info-row" wx:if="{{item.review_count > 0}}">
              <van-icon name="replay" size="14px" color="#52c41a" />
              <text class="info-label">å¤ä¹ æ¬¡æ•°:</text>
              <text class="info-value">{{item.review_count}} æ¬¡</text>
            </view>
          </view>
          
          <view class="kp-error-reason" wx:if="{{item.error_reason}}">
            <text class="reason-label">âŒ é”™è¯¯åŸå› :</text>
            <text class="reason-text">{{item.error_reason}}</text>
          </view>
          
          <view class="kp-status" wx:if="{{item.mastered}}">
            <van-tag type="success" size="small">
              <van-icon name="checked" size="12px" /> å·²æŒæ¡
            </van-tag>
          </view>
        </view>
      </view>
    </view>

    <!-- çŸ¥è¯†ç‚¹ï¼ˆæ—§ç‰ˆ - å…¼å®¹æ—§æ•°æ®ï¼‰ -->
    <view class="detail-section" wx:elif="{{mistakeDetail.knowledge_points && mistakeDetail.knowledge_points.length}}">
      <view class="section-title">ç›¸å…³çŸ¥è¯†ç‚¹</view>
      
      <!-- ç®€å•å­—ç¬¦ä¸²æ ¼å¼ï¼ˆæ—§æ•°æ®ï¼‰ -->
      <view class="knowledge-tags" wx:if="{{utils.isStringArray(mistakeDetail.knowledge_points)}}">
        <van-tag wx:for="{{mistakeDetail.knowledge_points}}" wx:key="*this" plain>
          {{item}}
        </van-tag>
      </view>

      <!-- è¯¦ç»†çŸ¥è¯†ç‚¹ä¿¡æ¯ï¼ˆæ–°æ•°æ®ï¼‰ -->
      <view class="knowledge-points-list" wx:else>
        <view class="knowledge-point-item" 
              wx:for="{{mistakeDetail.knowledge_points}}" 
              wx:key="name">
          <view class="kp-header">
            <text class="kp-name">{{item.name}}</text>
            <van-tag 
              type="{{item.mastery_level >= 0.7 ? 'success' : item.mastery_level >= 0.4 ? 'warning' : 'danger'}}" 
              plain 
              wx:if="{{item.mastery_level !== undefined}}">
              æŒæ¡åº¦: {{utils.toPercent(item.mastery_level)}}%
            </van-tag>
          </view>
          <view class="kp-relevance" wx:if="{{item.relevance}}">
            <van-icon name="star" size="12px" />
            <text>ç›¸å…³åº¦: {{utils.toPercent(item.relevance)}}%</text>
          </view>
          <view class="kp-suggestions" wx:if="{{item.suggestions && item.suggestions.length}}">
            <view class="suggestion-title">ğŸ’¡ å­¦ä¹ å»ºè®®ï¼š</view>
            <text class="suggestion-text" wx:for="{{item.suggestions}}" wx:for-item="suggestion" wx:key="*this">
              â€¢ {{suggestion}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¤ä¹ è®°å½• -->
    <view class="detail-section" wx:if="{{mistakeDetail.review_history && mistakeDetail.review_history.length}}">
      <view class="section-title">å¤ä¹ è®°å½• ({{mistakeDetail.review_count}}æ¬¡)</view>
      <view class="review-history">
        <view class="review-item" wx:for="{{mistakeDetail.review_history}}" wx:key="id">
          <view class="review-date">{{item.review_date}}</view>
          <view class="review-result {{item.is_correct ? 'correct' : 'wrong'}}">
            {{item.is_correct ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯'}}
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸‹æ¬¡å¤ä¹ æ—¶é—´ -->
    <view class="next-review" wx:if="{{mistakeDetail.next_review_date}}">
      <van-icon name="clock-o" />
      <text>ä¸‹æ¬¡å¤ä¹ : {{mistakeDetail.next_review_date}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="detail-footer" wx:if="{{!loading && mistakeDetail}}">
    <van-button plain type="danger" bindtap="onDelete">åˆ é™¤</van-button>
    <van-button type="primary" bindtap="onStartReview">å¼€å§‹å¤ä¹ </van-button>
  </view>
</view>
