<!--components/mistake-card/index.wxml-->
<!-- ✅ 引入 WXS 模块 -->
<wxs src="./utils.wxs" module="utils" />

<view class="mistake-card {{mode}}"
      bindtap="onCardTap"
      data-mistake="{{mistake}}">

  <!-- 卡片头部 -->
  <view class="card-header">
    <view class="subject-info">
      <view class="subject-tag" data-subject="{{mistake.subject}}">
        {{mistake.subject}}
      </view>
      <view class="difficulty-tag difficulty-{{mistake.difficulty_level}}">
        <van-icon name="{{utils.getDifficultyIcon(mistake.difficulty_level)}}" size="12" />
        <text>{{utils.getDifficultyText(mistake.difficulty_level)}}</text>
      </view>
      <!-- 🎯 错题类型标签 -->
      <view class="category-tag category-{{mistake.category}}" wx:if="{{mistake.category}}">
        <text>{{utils.getCategoryText(mistake.category)}}</text>
      </view>
    </view>

    <view class="status-info">
      <!-- 🎯 来源标识 -->
      <view class="source-tag source-{{mistake.source}}" wx:if="{{mistake.source}}">
        <van-icon name="{{utils.getSourceIcon(mistake.source)}}" size="10" />
      </view>
      <!-- 🎯 AI分析徽章 -->
      <view class="ai-badge" wx:if="{{mistake.ai_analysis}}">
        <van-icon name="bulb-o" size="10" />
      </view>
      <view class="status-tag {{mistake.mastery_status}}">
        {{utils.getMasteryStatusText(mistake.mastery_status)}}
      </view>
    </view>
  </view>

  <!-- 卡片内容 -->
  <view class="card-content">
    <!-- 题目标题 -->
    <view class="question-title" wx:if="{{mistake.title}}">
      {{mistake.title}}
    </view>
    
    <!-- 题目内容预览 -->
    <view class="question-content">
      {{utils.getContentPreview(mistake.question_content) || '暂无题目内容，点击查看详情'}}
    </view>

    <!-- 知识点标签 -->
    <view class="knowledge-points" wx:if="{{mistake.knowledge_points && mistake.knowledge_points.length > 0}}">
      <van-tag
        wx:for="{{mistake.knowledge_points.slice(0, 3)}}"
        wx:key="*this"
        plain
        size="small">
        {{item}}
      </van-tag>
      <van-tag wx:if="{{mistake.knowledge_points.length > 3}}" plain size="small">
        +{{mistake.knowledge_points.length - 3}}
      </van-tag>
    </view>

    <!-- 复习进度 -->
    <view class="review-progress" wx:if="{{mistake.review_count > 0}}">
      <view class="progress-info">
        <van-icon name="replay" size="14" />
        <text>已复习 {{mistake.review_count}} 次</text>
      </view>
      <view class="progress-rate" wx:if="{{mistake.correct_rate}}">
        <text class="rate-value {{utils.getRateClass(mistake.correct_rate)}}">
          正确率 {{mistake.correct_rate}}%
        </text>
      </view>
    </view>

    <!-- 下次复习时间 -->
    <view class="next-review" wx:if="{{mistake.next_review_date && mode !== 'review'}}">
      <van-icon name="clock-o" size="12" />
      <text class="{{utils.getNextReviewClass(mistake.next_review_date)}}">
        {{utils.getNextReviewText(mistake.next_review_date)}}
      </text>
    </view>
    
    <!-- 复习模式下显示复习轮次 -->
    <view class="review-round-info" wx:if="{{mode === 'review' && mistake.review_count}}">
      <van-icon name="replay" size="12" />
      <text>第 {{mistake.review_count + 1}} 轮复习</text>
    </view>
  </view>

  <!-- 时间信息（非复习模式下显示，且有时间数据时才显示） -->
  <view class="time-info" wx:if="{{mode !== 'review' && (mistake.created_at || mistake.updated_at)}}">
    <view class="create-time" wx:if="{{mistake.created_at}}">
      <van-icon name="clock-o" size="12" />
      <text>{{utils.formatTime(mistake.created_at)}}</text>
    </view>

    <view class="update-time" wx:if="{{mistake.updated_at && mistake.updated_at !== mistake.created_at}}">
      <van-icon name="edit" size="12" />
      <text>更新于 {{utils.formatTime(mistake.updated_at)}}</text>
    </view>
  </view>

  <!-- 图片预览 -->
  <view class="image-preview" wx:if="{{mistake.image_urls && mistake.image_urls.length > 0}}">
    <image 
      class="preview-image" 
      src="{{mistake.image_urls[0]}}" 
      mode="aspectFill"
      bindtap="onImagePreview"
      data-urls="{{mistake.image_urls}}"
      data-index="0"
    />
    <view class="image-count" wx:if="{{mistake.image_urls.length > 1}}">
      <van-icon name="photo-o" size="10" />
      <text>{{mistake.image_urls.length}}张</text>
    </view>
  </view>

  <!-- 操作按钮区域 -->
  <view class="card-actions" wx:if="{{showActions}}">
    <!-- 查看详情 -->
    <van-button size="small"
                plain
                bindtap="onViewDetail"
                data-mistake="{{mistake}}">
      查看详情
    </van-button>

    <!-- 开始复习 -->
    <van-button size="small"
                type="primary"
                wx:if="{{mistake.mastery_status !== 'mastered'}}"
                bindtap="onStartReview"
                data-mistake="{{mistake}}">
      开始复习
    </van-button>

    <!-- 编辑 -->
    <van-button size="small"
                plain
                bindtap="onEdit"
                data-mistake="{{mistake}}">
      编辑
    </van-button>

    <!-- 删除 -->
    <van-button size="small"
                plain
                type="danger"
                bindtap="onDelete"
                data-mistake="{{mistake}}">
      删除
    </van-button>
  </view>

  <!-- 复习模式标识 -->
  <view class="review-mode-badge" wx:if="{{mode === 'review'}}">
    <van-icon name="thumb-circle-o" size="12" />
    <text>待复习</text>
  </view>

  <!-- 已掌握标识 -->
  <view class="mastered-badge" wx:if="{{mistake.mastery_status === 'mastered'}}">
    <van-icon name="success" size="12" />
    <text>已掌握</text>
  </view>

  <!-- 需要复习标识 -->
  <view class="need-review-badge" wx:if="{{utils.isNeedReview(mistake.next_review_date)}}">
    <van-icon name="warning-o" size="12" />
    <text>需复习</text>
  </view>
</view>
