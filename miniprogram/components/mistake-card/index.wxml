<!--components/mistake-card/index.wxml-->
<view class="mistake-card {{mode}}"
      bindtap="onCardTap"
      data-mistake="{{mistake}}">

  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <view class="card-header">
    <view class="subject-info">
      <view class="subject-tag" data-subject="{{mistake.subject}}">
        {{mistake.subject}}
      </view>
      <view class="difficulty-tag difficulty-{{mistake.difficulty_level}}">
        <van-icon name="{{getDifficultyIcon(mistake.difficulty_level)}}" size="12" />
        <text>{{getDifficultyText(mistake.difficulty_level)}}</text>
      </view>
      <!-- ğŸ¯ é”™é¢˜ç±»å‹æ ‡ç­¾ -->
      <view class="category-tag category-{{mistake.category}}" wx:if="{{mistake.category}}">
        <text>{{getCategoryText(mistake.category)}}</text>
      </view>
    </view>

    <view class="status-info">
      <!-- ğŸ¯ æ¥æºæ ‡è¯† -->
      <view class="source-tag source-{{mistake.source}}" wx:if="{{mistake.source}}">
        <van-icon name="{{getSourceIcon(mistake.source)}}" size="10" />
      </view>
      <!-- ğŸ¯ AIåˆ†æå¾½ç«  -->
      <view class="ai-badge" wx:if="{{mistake.ai_analysis}}">
        <van-icon name="bulb-o" size="10" />
      </view>
      <view class="status-tag {{mistake.mastery_status}}">
        {{getMasteryStatusText(mistake.mastery_status)}}
      </view>
    </view>
  </view>

  <!-- å¡ç‰‡å†…å®¹ -->
  <view class="card-content">
    <!-- é¢˜ç›®å†…å®¹é¢„è§ˆ -->
    <view class="question-content">
      {{getContentPreview(mistake.question_content)}}
    </view>

    <!-- çŸ¥è¯†ç‚¹æ ‡ç­¾ -->
    <view class="knowledge-points" wx:if="{{mistake.knowledge_points && mistake.knowledge_points.length > 0}}">
      <van-tag
        wx:for="{{mistake.knowledge_points.slice(0, 3)}}"
        wx:key="*this"
        plain
        size="small">
        {{item}}
      </van-tag>
      <van-tag wx:if="{{mistake.knowledge_points.length > 3}}" plain size="small">
        +{{mistake.knowledge_points.length - 3}}
      </van-tag>
    </view>

    <!-- å¤ä¹ è¿›åº¦ -->
    <view class="review-progress" wx:if="{{mistake.review_count > 0}}">
      <view class="progress-info">
        <van-icon name="replay" size="14" />
        <text>å·²å¤ä¹  {{mistake.review_count}} æ¬¡</text>
      </view>
      <view class="progress-rate" wx:if="{{mistake.correct_rate}}">
        <text class="rate-value {{getRateClass(mistake.correct_rate)}}">
          æ­£ç¡®ç‡ {{mistake.correct_rate}}%
        </text>
      </view>
    </view>

    <!-- ä¸‹æ¬¡å¤ä¹ æ—¶é—´ -->
    <view class="next-review" wx:if="{{mistake.next_review_date && mode !== 'review'}}">
      <van-icon name="clock-o" size="12" />
      <text class="{{getNextReviewClass(mistake.next_review_date)}}">
        {{getNextReviewText(mistake.next_review_date)}}
      </text>
    </view>
  </view>

  <!-- æ—¶é—´ä¿¡æ¯ -->
  <view class="time-info">
    <view class="create-time">
      <van-icon name="clock-o" size="12" />
      <text>{{formatTime(mistake.created_at)}}</text>
    </view>

    <view class="update-time" wx:if="{{mistake.updated_at && mistake.updated_at !== mistake.created_at}}">
      <van-icon name="edit" size="12" />
      <text>æ›´æ–°äº {{formatTime(mistake.updated_at)}}</text>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="card-actions" wx:if="{{showActions}}">
    <!-- æŸ¥çœ‹è¯¦æƒ… -->
    <van-button size="small"
                plain
                bindtap="onViewDetail"
                data-mistake="{{mistake}}">
      æŸ¥çœ‹è¯¦æƒ…
    </van-button>

    <!-- å¼€å§‹å¤ä¹  -->
    <van-button size="small"
                type="primary"
                wx:if="{{mistake.mastery_status !== 'mastered'}}"
                bindtap="onStartReview"
                data-mistake="{{mistake}}">
      å¼€å§‹å¤ä¹ 
    </van-button>

    <!-- ç¼–è¾‘ -->
    <van-button size="small"
                plain
                bindtap="onEdit"
                data-mistake="{{mistake}}">
      ç¼–è¾‘
    </van-button>

    <!-- åˆ é™¤ -->
    <van-button size="small"
                plain
                type="danger"
                bindtap="onDelete"
                data-mistake="{{mistake}}">
      åˆ é™¤
    </van-button>
  </view>

  <!-- å¤ä¹ æ¨¡å¼æ ‡è¯† -->
  <view class="review-mode-badge" wx:if="{{mode === 'review'}}">
    <van-icon name="thumb-circle-o" size="12" />
    <text>å¾…å¤ä¹ </text>
  </view>

  <!-- å·²æŒæ¡æ ‡è¯† -->
  <view class="mastered-badge" wx:if="{{mistake.mastery_status === 'mastered'}}">
    <van-icon name="success" size="12" />
    <text>å·²æŒæ¡</text>
  </view>

  <!-- éœ€è¦å¤ä¹ æ ‡è¯† -->
  <view class="need-review-badge" wx:if="{{isNeedReview(mistake.next_review_date)}}">
    <van-icon name="warning-o" size="12" />
    <text>éœ€å¤ä¹ </text>
  </view>
</view>
