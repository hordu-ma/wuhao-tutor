<!--components/mistake-card/index.wxml-->
<!-- âœ… å¼•å…¥ WXS æ¨¡å— -->
<wxs src="./utils.wxs" module="utils" />

<view class="mistake-card {{mode}}"
      catchtap="onCardTap"
      data-mistake="{{mistake}}">

  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <view class="card-header">
    <view class="subject-info">
      <view class="subject-tag" data-subject="{{mistake.subject}}">
        {{mistake.subject}}
      </view>
      <view class="difficulty-tag difficulty-{{mistake.difficulty_level}}">
        <van-icon name="{{utils.getDifficultyIcon(mistake.difficulty_level)}}" size="12" />
        <text>{{utils.getDifficultyText(mistake.difficulty_level)}}</text>
      </view>
      <!-- ğŸ¯ é”™é¢˜ç±»å‹æ ‡ç­¾ -->
      <view class="category-tag category-{{mistake.category}}" wx:if="{{mistake.category}}">
        <text>{{utils.getCategoryText(mistake.category)}}</text>
      </view>
    </view>

    <view class="status-info">
      <!-- ğŸ¯ æ¥æºæ ‡è¯† -->
      <view class="source-tag source-{{mistake.source}}" wx:if="{{mistake.source}}">
        <van-icon name="{{utils.getSourceIcon(mistake.source)}}" size="10" />
      </view>
      <!-- ğŸ¯ AIåˆ†æå¾½ç«  -->
      <view class="ai-badge" wx:if="{{mistake.ai_analysis}}">
        <van-icon name="bulb-o" size="10" />
      </view>
      <view class="status-tag {{mistake.mastery_status}}">
        {{utils.getMasteryStatusText(mistake.mastery_status)}}
      </view>
    </view>
  </view>

  <!-- å¡ç‰‡å†…å®¹ -->
  <view class="card-content">
    <!-- é¢˜ç›®æ ‡é¢˜ -->
    <view class="question-title" wx:if="{{mistake.title}}">
      {{mistake.title}}
    </view>
    
    <!-- é¢˜ç›®å†…å®¹é¢„è§ˆ -->
    <view class="question-content">
      {{utils.getContentPreview(mistake.question_content) || 'æš‚æ— é¢˜ç›®å†…å®¹ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}}
    </view>

    <!-- çŸ¥è¯†ç‚¹æ ‡ç­¾ï¼ˆä¼˜å…ˆæ˜¾ç¤ºå…³è”æ•°æ®ï¼Œå¦åˆ™æ˜¾ç¤ºç®€å•åˆ—è¡¨ï¼‰ -->
    <view class="knowledge-points" wx:if="{{mistake.knowledge_point_associations && mistake.knowledge_point_associations.length > 0}}">
      <van-tag
        wx:for="{{mistake.knowledge_point_associations.slice(0, 3)}}"
        wx:key="association_id"
        type="{{item.mastery_level >= 0.7 ? 'success' : item.mastery_level >= 0.4 ? 'warning' : 'danger'}}"
        plain
        size="small">
        {{item.knowledge_point_name}}
        <text wx:if="{{item.is_primary}}" class="primary-mark">â­</text>
      </van-tag>
      <van-tag wx:if="{{mistake.knowledge_point_associations.length > 3}}" plain size="small">
        +{{mistake.knowledge_point_associations.length - 3}}
      </van-tag>
    </view>
    <view class="knowledge-points" wx:elif="{{mistake.knowledge_points && mistake.knowledge_points.length > 0}}">
      <van-tag
        wx:for="{{mistake.knowledge_points.slice(0, 3)}}"
        wx:key="*this"
        plain
        size="small">
        {{item}}
      </van-tag>
      <van-tag wx:if="{{mistake.knowledge_points.length > 3}}" plain size="small">
        +{{mistake.knowledge_points.length - 3}}
      </van-tag>
    </view>

    <!-- å¤ä¹ è¿›åº¦ -->
    <view class="review-progress" wx:if="{{mistake.review_count > 0}}">
      <view class="progress-info">
        <van-icon name="replay" size="14" />
        <text>å·²å¤ä¹  {{mistake.review_count}} æ¬¡</text>
      </view>
      <view class="progress-rate" wx:if="{{mistake.correct_rate}}">
        <text class="rate-value {{utils.getRateClass(mistake.correct_rate)}}">
          æ­£ç¡®ç‡ {{mistake.correct_rate}}%
        </text>
      </view>
    </view>

    <!-- ä¸‹æ¬¡å¤ä¹ æ—¶é—´ -->
    <view class="next-review" wx:if="{{mistake.next_review_date && mode !== 'review'}}">
      <van-icon name="clock-o" size="12" />
      <text class="{{utils.getNextReviewClass(mistake.next_review_date)}}">
        {{utils.getNextReviewText(mistake.next_review_date)}}
      </text>
    </view>
    
    <!-- å¤ä¹ æ¨¡å¼ä¸‹æ˜¾ç¤ºå¤ä¹ è½®æ¬¡ -->
    <view class="review-round-info" wx:if="{{mode === 'review' && mistake.review_count}}">
      <van-icon name="replay" size="12" />
      <text>ç¬¬ {{mistake.review_count + 1}} è½®å¤ä¹ </text>
    </view>
  </view>

  <!-- æ—¶é—´ä¿¡æ¯ï¼ˆéå¤ä¹ æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œä¸”æœ‰æ—¶é—´æ•°æ®æ—¶æ‰æ˜¾ç¤ºï¼‰ -->
  <view class="time-info" wx:if="{{mode !== 'review' && (mistake.created_at || mistake.updated_at)}}">
    <view class="create-time" wx:if="{{mistake.created_at}}">
      <van-icon name="clock-o" size="12" />
      <text>{{utils.formatTime(mistake.created_at)}}</text>
    </view>

    <view class="update-time" wx:if="{{mistake.updated_at && mistake.updated_at !== mistake.created_at}}">
      <van-icon name="edit" size="12" />
      <text>æ›´æ–°äº {{utils.formatTime(mistake.updated_at)}}</text>
    </view>
  </view>

  <!-- å›¾ç‰‡é¢„è§ˆ -->
  <view class="image-preview" wx:if="{{mistake.image_urls && mistake.image_urls.length > 0}}">
    <image 
      class="preview-image" 
      src="{{mistake.image_urls[0]}}" 
      mode="aspectFill"
      bindtap="onImagePreview"
      data-urls="{{mistake.image_urls}}"
      data-index="0"
    />
    <view class="image-count" wx:if="{{mistake.image_urls.length > 1}}">
      <van-icon name="photo-o" size="10" />
      <text>{{mistake.image_urls.length}}å¼ </text>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="card-actions" wx:if="{{showActions}}">
    <!-- æŸ¥çœ‹è¯¦æƒ… -->
    <van-button size="small"
                plain
                bindtap="onViewDetail"
                data-mistake="{{mistake}}">
      æŸ¥çœ‹è¯¦æƒ…
    </van-button>

    <!-- å¼€å§‹å¤ä¹  -->
    <van-button size="small"
                type="primary"
                wx:if="{{mistake.mastery_status !== 'mastered'}}"
                bindtap="onStartReview"
                data-mistake="{{mistake}}">
      å¼€å§‹å¤ä¹ 
    </van-button>

    <!-- ç¼–è¾‘ -->
    <van-button size="small"
                plain
                bindtap="onEdit"
                data-mistake="{{mistake}}">
      ç¼–è¾‘
    </van-button>

    <!-- åˆ é™¤ -->
    <van-button size="small"
                plain
                type="danger"
                bindtap="onDelete"
                data-mistake="{{mistake}}">
      åˆ é™¤
    </van-button>
  </view>

  <!-- å¤ä¹ æ¨¡å¼æ ‡è¯† -->
  <view class="review-mode-badge" wx:if="{{mode === 'review'}}">
    <van-icon name="thumb-circle-o" size="12" />
    <text>å¾…å¤ä¹ </text>
  </view>

  <!-- å·²æŒæ¡æ ‡è¯† -->
  <view class="mastered-badge" wx:if="{{mistake.mastery_status === 'mastered'}}">
    <van-icon name="success" size="12" />
    <text>å·²æŒæ¡</text>
  </view>

  <!-- éœ€è¦å¤ä¹ æ ‡è¯† -->
  <view class="need-review-badge" wx:if="{{utils.isNeedReview(mistake.next_review_date)}}">
    <van-icon name="warning-o" size="12" />
    <text>éœ€å¤ä¹ </text>
  </view>
</view>
