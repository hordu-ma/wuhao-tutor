<!-- components/ocr-progress/index.wxml -->
<view class="progress-container" wx:if="{{show}}">
  <!-- é®ç½©å±‚ -->
  <view class="progress-mask" bindtap="onClose"></view>
  
  <!-- å†…å®¹åŒº -->
  <view class="progress-content" catchtap="stopPropagation">
    <!-- æ ‡é¢˜æ  -->
    <view class="progress-header">
      <text class="header-title">OCRè¯†åˆ«è¿›åº¦</text>
      <view class="header-stats">
        <text class="stats-text">{{images.length}}å¼ å›¾ç‰‡</text>
      </view>
      <view class="header-close" bindtap="onClose">
        <text class="close-icon">âœ•</text>
      </view>
    </view>

    <!-- æ€»ä½“è¿›åº¦æ¡ -->
    <view class="overall-progress">
      <view class="progress-info">
        <text class="progress-label">æ€»ä½“è¿›åº¦</text>
        <text class="progress-percent">{{progress}}%</text>
      </view>
      <view class="progress-bar-wrapper">
        <view class="progress-bar" style="width: {{progress}}%"></view>
      </view>
      <view class="progress-stats">
        <text class="stat-item success">âœ“ {{images.filter(img => img.status === 'success').length}}å¼ æˆåŠŸ</text>
        <text class="stat-item failed" wx:if="{{images.filter(img => img.status === 'failed').length > 0}}">
          âœ• {{images.filter(img => img.status === 'failed').length}}å¼ å¤±è´¥
        </text>
      </view>
    </view>

    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <scroll-view class="images-list" scroll-y>
      <view 
        wx:for="{{images}}" 
        wx:key="id"
        class="image-item {{item.status}}"
      >
        <!-- å›¾ç‰‡å¡ç‰‡å¤´éƒ¨ -->
        <view class="item-header" bindtap="toggleExpand" data-image-id="{{item.id}}">
          <image class="item-thumbnail" src="{{item.path}}" mode="aspectFill" bindtap="onPreview" data-image-path="{{item.path}}" data-index="{{index}}" catchtap="onPreview"></image>
          
          <view class="item-info">
            <view class="info-row">
              <text class="item-index">å›¾ç‰‡ {{index + 1}}</text>
              <view class="status-badge {{item.status}}">
                <text class="status-icon">{{statusIcons[item.status]}}</text>
                <text class="status-text">{{statusTexts[item.status]}}</text>
              </view>
            </view>
            
            <!-- ç½®ä¿¡åº¦ (ä»…æˆåŠŸæ—¶æ˜¾ç¤º) -->
            <view wx:if="{{item.status === 'success' && item.confidence}}" class="confidence-row">
              <text class="confidence-label">ç½®ä¿¡åº¦:</text>
              <text class="confidence-value" style="color: {{getConfidenceLevel(item.confidence).color}}">
                {{formatConfidence(item.confidence)}}
              </text>
              <text class="confidence-level" style="color: {{getConfidenceLevel(item.confidence).color}}">
                ({{getConfidenceLevel(item.confidence).level}})
              </text>
            </view>

            <!-- é”™è¯¯ä¿¡æ¯ (ä»…å¤±è´¥æ—¶æ˜¾ç¤º) -->
            <text wx:if="{{item.status === 'failed' && item.error}}" class="error-message">
              {{item.error}}
            </text>
          </view>

          <view class="item-actions">
            <text class="expand-icon {{expandedIds.indexOf(item.id) > -1 ? 'expanded' : ''}}">â–¼</text>
          </view>
        </view>

        <!-- å±•å¼€å†…å®¹ -->
        <view wx:if="{{expandedIds.indexOf(item.id) > -1}}" class="item-detail">
          <!-- OCRè¯†åˆ«æ–‡æœ¬ -->
          <view wx:if="{{item.status === 'success' && item.ocrText}}" class="ocr-text-section">
            <view class="section-header">
              <text class="section-title">è¯†åˆ«å†…å®¹</text>
              <view class="section-actions">
                <button class="action-btn" size="mini" bindtap="onCopyText" data-text="{{item.ocrText}}">
                  å¤åˆ¶
                </button>
                <button class="action-btn" size="mini" bindtap="onEditText" data-image-id="{{item.id}}" data-text="{{item.ocrText}}">
                  ç¼–è¾‘
                </button>
              </view>
            </view>
            <view class="ocr-text-content">
              <text class="ocr-text">{{item.ocrText}}</text>
            </view>
          </view>

          <!-- å¤±è´¥æ—¶æ˜¾ç¤ºé‡è¯•æŒ‰é’® -->
          <view wx:if="{{item.status === 'failed'}}" class="error-actions">
            <button class="retry-btn" bindtap="onRetry" data-image-id="{{item.id}}">
              <text class="btn-icon">ğŸ”„</text>
              <text class="btn-text">é‡æ–°è¯†åˆ«</text>
            </button>
            <button class="delete-btn" bindtap="onDelete" data-image-id="{{item.id}}">
              <text class="btn-icon">ğŸ—‘ï¸</text>
              <text class="btn-text">åˆ é™¤å›¾ç‰‡</text>
            </button>
          </view>

          <!-- å¤„ç†ä¸­æ˜¾ç¤ºåŠ è½½åŠ¨ç”» -->
          <view wx:if="{{item.status === 'processing'}}" class="processing-animation">
            <view class="spinner"></view>
            <text class="processing-text">æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{images.length === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ“„</text>
        <text class="empty-text">æš‚æ— å›¾ç‰‡</text>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="progress-footer">
      <button class="footer-btn secondary" bindtap="onClose">å…³é—­</button>
      <button 
        wx:if="{{images.filter(img => img.status === 'failed').length > 0}}" 
        class="footer-btn primary" 
        bindtap="onRetryAll"
      >
        é‡è¯•æ‰€æœ‰å¤±è´¥é¡¹
      </button>
    </view>
  </view>
</view>
