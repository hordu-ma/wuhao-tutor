<!-- components/ocr-progress/index.wxml -->
<view class="progress-container" wx:if="{{show}}">
  <!-- 遮罩层 -->
  <view class="progress-mask" bindtap="onClose"></view>
  
  <!-- 内容区 -->
  <view class="progress-content" catchtap="stopPropagation">
    <!-- 标题栏 -->
    <view class="progress-header">
      <text class="header-title">OCR识别进度</text>
      <view class="header-stats">
        <text class="stats-text">{{images.length}}张图片</text>
      </view>
      <view class="header-close" bindtap="onClose">
        <text class="close-icon">✕</text>
      </view>
    </view>

    <!-- 总体进度条 -->
    <view class="overall-progress">
      <view class="progress-info">
        <text class="progress-label">总体进度</text>
        <text class="progress-percent">{{progress}}%</text>
      </view>
      <view class="progress-bar-wrapper">
        <view class="progress-bar" style="width: {{progress}}%"></view>
      </view>
      <view class="progress-stats">
        <text class="stat-item success">✓ {{images.filter(img => img.status === 'success').length}}张成功</text>
        <text class="stat-item failed" wx:if="{{images.filter(img => img.status === 'failed').length > 0}}">
          ✕ {{images.filter(img => img.status === 'failed').length}}张失败
        </text>
      </view>
    </view>

    <!-- 图片列表 -->
    <scroll-view class="images-list" scroll-y>
      <view 
        wx:for="{{images}}" 
        wx:key="id"
        class="image-item {{item.status}}"
      >
        <!-- 图片卡片头部 -->
        <view class="item-header" bindtap="toggleExpand" data-image-id="{{item.id}}">
          <image class="item-thumbnail" src="{{item.path}}" mode="aspectFill" bindtap="onPreview" data-image-path="{{item.path}}" data-index="{{index}}" catchtap="onPreview"></image>
          
          <view class="item-info">
            <view class="info-row">
              <text class="item-index">图片 {{index + 1}}</text>
              <view class="status-badge {{item.status}}">
                <text class="status-icon">{{statusIcons[item.status]}}</text>
                <text class="status-text">{{statusTexts[item.status]}}</text>
              </view>
            </view>
            
            <!-- 置信度 (仅成功时显示) -->
            <view wx:if="{{item.status === 'success' && item.confidence}}" class="confidence-row">
              <text class="confidence-label">置信度:</text>
              <text class="confidence-value" style="color: {{getConfidenceLevel(item.confidence).color}}">
                {{formatConfidence(item.confidence)}}
              </text>
              <text class="confidence-level" style="color: {{getConfidenceLevel(item.confidence).color}}">
                ({{getConfidenceLevel(item.confidence).level}})
              </text>
            </view>

            <!-- 错误信息 (仅失败时显示) -->
            <text wx:if="{{item.status === 'failed' && item.error}}" class="error-message">
              {{item.error}}
            </text>
          </view>

          <view class="item-actions">
            <text class="expand-icon {{expandedIds.indexOf(item.id) > -1 ? 'expanded' : ''}}">▼</text>
          </view>
        </view>

        <!-- 展开内容 -->
        <view wx:if="{{expandedIds.indexOf(item.id) > -1}}" class="item-detail">
          <!-- OCR识别文本 -->
          <view wx:if="{{item.status === 'success' && item.ocrText}}" class="ocr-text-section">
            <view class="section-header">
              <text class="section-title">识别内容</text>
              <view class="section-actions">
                <button class="action-btn" size="mini" bindtap="onCopyText" data-text="{{item.ocrText}}">
                  复制
                </button>
                <button class="action-btn" size="mini" bindtap="onEditText" data-image-id="{{item.id}}" data-text="{{item.ocrText}}">
                  编辑
                </button>
              </view>
            </view>
            <view class="ocr-text-content">
              <text class="ocr-text">{{item.ocrText}}</text>
            </view>
          </view>

          <!-- 失败时显示重试按钮 -->
          <view wx:if="{{item.status === 'failed'}}" class="error-actions">
            <button class="retry-btn" bindtap="onRetry" data-image-id="{{item.id}}">
              <text class="btn-icon">🔄</text>
              <text class="btn-text">重新识别</text>
            </button>
            <button class="delete-btn" bindtap="onDelete" data-image-id="{{item.id}}">
              <text class="btn-icon">🗑️</text>
              <text class="btn-text">删除图片</text>
            </button>
          </view>

          <!-- 处理中显示加载动画 -->
          <view wx:if="{{item.status === 'processing'}}" class="processing-animation">
            <view class="spinner"></view>
            <text class="processing-text">正在识别中，请稍候...</text>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view wx:if="{{images.length === 0}}" class="empty-state">
        <text class="empty-icon">📄</text>
        <text class="empty-text">暂无图片</text>
      </view>
    </scroll-view>

    <!-- 底部操作栏 -->
    <view class="progress-footer">
      <button class="footer-btn secondary" bindtap="onClose">关闭</button>
      <button 
        wx:if="{{images.filter(img => img.status === 'failed').length > 0}}" 
        class="footer-btn primary" 
        bindtap="onRetryAll"
      >
        重试所有失败项
      </button>
    </view>
  </view>
</view>
