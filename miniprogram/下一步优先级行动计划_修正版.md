# 五好伴学小程序 - 下一步优先级行动计划（修正版）

**生成日期**: 2025-10-17  
**基于**: 微信小程序开发状态诊断报告  
**修正说明**: 确认生产环境配置已就绪，调整优先级

---

## ✅ 配置状态确认

经过核实，以下配置**已经正确且可用**：

1. ✅ **API地址**: `https://121.199.173.244` - 生产环境正常运行（测试返回307重定向）
2. ✅ **AppID**: `wx2a8b340606664785` - 正式可用的微信小程序ID
3. ✅ **文件上传**: 直接走后端API `/api/v1/files/upload`，无需OSS配置
4. ✅ **测试账号**: 已有3个生产环境测试账号可用

**结论**: 配置层面已经就绪，可以直接开展功能开发和测试。

---

## 🎯 立即优先（本周内完成）

### ✅ Priority 1: 错题手册AI分析功能 - **已完成** (2025-10-17)

**为什么最重要**: 这是您的**核心差异化功能**，直接影响产品竞争力。

#### 完成情况

- ✅ 前端UI完整（4个页面：列表、详情、添加、今日复习）
- ✅ API接口已对齐（7个端点）
- ✅ 后端AI分析已实现（`src/services/mistake_service.py:analyze_mistake_with_ai`）
- ✅ 集成阿里云百炼AI服务
- ✅ 实现智能知识点提取、错误原因分析、学习建议生成
- ✅ JSON解析支持正则fallback
- ✅ 降级方案（AI失败时返回通用建议）
- ✅ SQLite/PostgreSQL双数据库兼容
- ✅ 创建测试数据和端到端测试脚本
- ✅ 真实AI调用测试通过（响应时间1.55秒，Token使用462个）
- ⚠️ 前后端未进行真实数据联调（下一步）

#### 行动步骤

**第1步：后端AI分析功能完善** (2-3小时)

```python
# src/services/mistake_service.py:529
async def analyze_mistake_with_ai(self, mistake_content: str) -> dict:
    """
    集成百炼AI服务分析知识点和错误原因

    当前状态: TODO
    建议实现:
    1. 调用 BailianService 分析题目
    2. 提取知识点列表
    3. 分析错误原因
    4. 生成学习建议
    """
    # TODO: 集成百炼AI服务分析知识点和错误原因
```

**快速实现方案**：

````python
from src.services.bailian_service import BailianService

async def analyze_mistake_with_ai(self, mistake_content: str) -> dict:
    """使用百炼AI分析错题"""
    try:
        bailian = BailianService()

        # 构造分析提示词
        prompt = f"""
        请分析以下错题，提取关键信息：

        题目内容：{mistake_content}

        请返回JSON格式：
        {{
            "knowledge_points": ["知识点1", "知识点2"],
            "error_reason": "错误原因分析",
            "suggestions": "学习建议"
        }}
        """

        result = await bailian.chat(
            messages=[{"role": "user", "content": prompt}],
            stream=False
        )

        # 解析AI返回的JSON
        import json
        analysis = json.loads(result.get("content", "{}"))

        return {
            "knowledge_points": analysis.get("knowledge_points", []),
            "error_reason": analysis.get("error_reason", ""),
            "suggestions": analysis.get("suggestions", "")
        }
    except Exception as e:
        logger.error(f"AI分析失败: {e}")
        # 降级方案：返回默认值
        return {
            "knowledge_points": [],
            "error_reason": "分析失败",
            "suggestions": ""
        }
#### 实现细节

**已实现功能**：

```python
# src/services/mistake_service.py
async def analyze_mistake_with_ai(
    self, mistake_id: UUID, user_id: UUID
) -> MistakeAnalysisResponse:
    """
    使用百炼AI分析错题

    实现特性：
    - 智能提示词构建（包含学科、难度、题目内容）
    - JSON格式解析（支持正则表达式fallback）
    - 降级方案（AI失败时返回通用建议）
    - Token统计和耗时记录
    - 自动更新错题记录的知识点和错误原因

    返回格式：
    {
        "knowledge_points": ["知识点1", "知识点2", ...],  # 3-5个
        "error_reason": "错误原因分析",  # 100字以内
        "suggestions": "学习建议",  # 150字以内
        "token_usage": 462,  # Token使用量
        "analysis_time": 1.55  # 分析耗时（秒）
    }
    """
````

**测试结果**（2025-10-17）：

- ✅ 测试科目：语文（汉字读音辨析）
- ✅ AI响应时间：1.55秒
- ✅ Token使用：462个
- ✅ 知识点提取：5个（多音字读音、常见汉字读音、形近字辨析、声调规则、词语整体读音）
- ✅ 错误原因：精准分析（多音字掌握不牢固）
- ✅ 学习建议：具体可行（朗读、听写、专项练习）

**下一步行动**：

**第1步：小程序前后端联调测试** (2-3小时)

测试清单：

```
□ 1. 创建错题
   - 填写题目内容、学科、难度
   - 上传题目图片（如有）
   - 提交成功，返回错题ID
   - ✅ 验证AI分析自动触发

□ 2. 错题列表
   - 分页加载（默认20条/页）
   - 标签页切换（全部、未掌握、复习中、已掌握）
   - 学科筛选
   - 难度筛选
   - 关键词搜索

□ 3. 错题详情
   - 查看完整信息
   - ✅ 查看AI生成的知识点标签
   - 查看复习记录时间线
   - 编辑错题
   - 删除错题

□ 4. 今日复习
   - 获取今日复习任务（基于艾宾浩斯曲线）
   - 卡片式展示（问题、答案、解析）
   - 复习进度追踪
   - 提交复习反馈（已掌握、部分掌握、仍需复习）
   - 更新错题掌握状态

□ 5. 数据一致性
   - 前端显示的数据与后端数据库一致
   - 状态更新实时同步
   - 统计数据准确
```

**测试工具**：

- 微信开发者工具（实时预览和调试）
- 生产测试账号（见 `生产环境测试账号.md`）
- 后端日志（观察API调用情况）
- 测试数据脚本：`scripts/create_test_mistakes.py`（已创建4个学科的测试错题）

**第2步：边界情况测试** (1小时)

```
□ 空数据状态（无错题）
□ 网络错误处理（断网、超时）
□ 权限控制（学生/家长/教师）
□ 并发操作（快速切换标签页）
□ 数据量测试（>100条错题时的性能）
□ AI分析超时处理（>30秒）
□ AI分析失败降级（返回通用建议）
```

**预期成果**：

- ✅ 错题手册全流程可用
- ✅ AI分析功能正常工作且用户体验流畅
- ✅ 前后端数据完全对齐
- ✅ 边界情况处理完善

---

### 🔴 Priority 2: 实现错误上报功能

**为什么重要**: 生产环境没有错误监控，问题无法追踪和诊断。

#### 当前状态

```javascript
// miniprogram/app.js:417
reportError(error) {
  try {
    // TODO: 实现错误上报逻辑
    console.log('错误上报:', error);
  } catch (e) {
    console.error('错误上报失败:', e);
  }
}
```

#### 推荐方案A：微信官方实时日志 (最快，30分钟)

```javascript
// app.js 中添加
onLaunch() {
  // 初始化实时日志
  this.realtimeLogManager = wx.getRealtimeLogManager();
},

reportError(error) {
  try {
    const log = this.realtimeLogManager;

    // 记录错误信息
    log.error('错误上报', {
      message: error.message || error,
      stack: error.stack,
      userInfo: this.globalData.userInfo?.id,
      page: getCurrentPages()[getCurrentPages().length - 1]?.route,
      timestamp: new Date().toISOString(),
      platform: wx.getSystemInfoSync().platform,
      version: this.globalData.version,
    });

    // 也可以添加到用户日志（用于排查个别用户问题）
    log.addFilterMsg('user_' + this.globalData.userInfo?.id);

  } catch (e) {
    console.error('错误上报失败:', e);
  }
}
```

**查看日志**：

1. 登录微信公众平台
2. 进入 "开发 -> 运维中心 -> 实时日志"
3. 选择时间范围和过滤条件查看

#### 推荐方案B：发送到后端API (更灵活，1小时)

**第1步：后端添加错误日志端点**

```python
# src/api/v1/endpoints/logs.py (新建)
from fastapi import APIRouter, Depends
from pydantic import BaseModel

router = APIRouter()

class ErrorLogRequest(BaseModel):
    message: str
    stack: Optional[str] = None
    user_id: Optional[str] = None
    page: Optional[str] = None
    platform: Optional[str] = None
    timestamp: str

@router.post("/error")
async def log_error(request: ErrorLogRequest):
    """接收小程序错误日志"""
    logger.error(
        f"小程序错误: {request.message}",
        extra={
            "user_id": request.user_id,
            "page": request.page,
            "platform": request.platform,
            "stack": request.stack,
        }
    )
    return {"success": True}
```

**第2步：小程序发送错误**

```javascript
// miniprogram/app.js
reportError(error) {
  try {
    const errorInfo = {
      message: error.message || String(error),
      stack: error.stack,
      user_id: this.globalData.userInfo?.id,
      page: getCurrentPages()[getCurrentPages().length - 1]?.route,
      platform: wx.getSystemInfoSync().platform,
      timestamp: new Date().toISOString(),
    };

    // 发送到后端（不阻塞主流程）
    wx.request({
      url: `${config.api.baseUrl}/api/v1/logs/error`,
      method: 'POST',
      data: errorInfo,
      success: () => console.log('错误已上报'),
      fail: (err) => console.error('上报失败:', err)
    });

  } catch (e) {
    console.error('错误上报失败:', e);
  }
}
```

**推荐**: 方案A + 方案B 结合使用，实时日志用于快速查看，后端API用于持久化和统计分析。

---

### 🔴 Priority 3: 实现用户反馈功能

**为什么重要**: 用户有问题时需要反馈渠道，收集用户反馈可以改进产品。

#### 当前状态

```javascript
// miniprogram/pages/profile/help/index.js:190, 211
// TODO: 发送反馈到后端
```

#### 实现步骤

**第1步：后端添加反馈端点** (30分钟)

```python
# src/api/v1/endpoints/feedback.py (新建)
from fastapi import APIRouter, Depends
from src.api.v1.endpoints.auth import get_current_user_id

router = APIRouter()

class FeedbackRequest(BaseModel):
    type: str  # faq_helpful | faq_not_helpful | general_feedback
    content: str
    faq_id: Optional[str] = None
    contact: Optional[str] = None

@router.post("/feedback")
async def submit_feedback(
    request: FeedbackRequest,
    user_id: UUID = Depends(get_current_user_id)
):
    """提交用户反馈"""
    # 保存到数据库或发送到企业微信/邮件
    logger.info(f"用户反馈: {user_id} - {request.type} - {request.content}")

    # TODO: 保存到feedback表

    return {
        "success": True,
        "message": "感谢您的反馈！"
    }
```

**第2步：小程序调用API** (30分钟)

```javascript
// miniprogram/pages/profile/help/index.js

const api = require('../../../api/index.js');

// 标记有帮助
markHelpful(event) {
  const index = event.currentTarget.dataset.index;
  wx.showToast({
    title: '感谢反馈！',
    icon: 'success',
    duration: 1500,
  });

  // 发送反馈到后端
  this.submitFeedback(this.data.faqs[index].id, true);
},

// 标记无帮助
markNotHelpful(event) {
  const index = event.currentTarget.dataset.index;
  const faq = this.data.faqs[index];

  wx.showModal({
    title: '问题反馈',
    content: '请告诉我们如何改进这个答案',
    editable: true,
    placeholderText: '请输入您的建议...',
    success: res => {
      if (res.confirm) {
        wx.showToast({
          title: '感谢反馈！',
          icon: 'success',
          duration: 1500,
        });
        // 发送反馈到后端
        this.submitFeedback(faq.id, false, res.content);
      }
    },
  });
},

// 提交反馈
async submitFeedback(faqId, isHelpful, content = '') {
  try {
    await api.user.submitFeedback({
      type: isHelpful ? 'faq_helpful' : 'faq_not_helpful',
      content: content,
      faq_id: faqId,
    });
  } catch (error) {
    console.error('提交反馈失败:', error);
  }
},

// 提交一般反馈
async submitGeneralFeedback() {
  const { feedbackType, feedbackContent, contactInfo } = this.data;

  if (!feedbackContent) {
    wx.showToast({
      title: '请输入反馈内容',
      icon: 'none'
    });
    return;
  }

  try {
    this.setData({ submitting: true });

    await api.user.submitFeedback({
      type: 'general_feedback',
      content: `[${feedbackType}] ${feedbackContent}`,
      contact: contactInfo,
    });

    wx.showToast({
      title: '提交成功',
      icon: 'success'
    });

    // 清空表单
    this.setData({
      feedbackContent: '',
      contactInfo: '',
      feedbackType: '问题反馈',
    });

  } catch (error) {
    wx.showToast({
      title: '提交失败，请重试',
      icon: 'none'
    });
  } finally {
    this.setData({ submitting: false });
  }
}
```

**第3步：在user.js添加API方法**

```javascript
// miniprogram/api/user.js

/**
 * 提交用户反馈
 * @param {Object} params - 反馈参数
 * @param {string} params.type - 反馈类型
 * @param {string} params.content - 反馈内容
 * @param {string} [params.faq_id] - FAQ ID（如果是FAQ反馈）
 * @param {string} [params.contact] - 联系方式
 */
submitFeedback(params, config = {}) {
  return request.post('api/v1/feedback', params, {
    showLoading: true,
    loadingText: '提交中...',
    showError: true,
    ...config,
  });
}
```

---

## 🟡 第二优先级（2周内完成）

### 4. 通知系统API集成

**当前状态**:

```javascript
// pages/index/index.js:974, 1004
// TODO: 调用API标记通知为已读
// TODO: 调用API标记所有通知为已读
```

**影响**: 通知功能无法真正使用，只有Mock数据。

**实现要点**:

1. 后端实现通知CRUD API
2. 小程序调用真实API
3. 支持推送通知（如使用微信模板消息）

---

### 5. 补充关键测试用例

**目标**: API模块80%覆盖率，工具函数90%覆盖率

**测试框架推荐**:

```bash
# 安装测试依赖
npm install --save-dev miniprogram-simulate @miniprogram-component-plus/jest-adapter jest
```

**优先测试模块**:

1. `api/mistakes.js` - 错题API（7个方法）
2. `utils/request.js` - 网络请求核心（重试、去重、拦截器）
3. `utils/auth.js` - Token刷新机制
4. 错题手册E2E流程

**示例测试**:

```javascript
// tests/unit/api/mistakes.test.js
const mistakesAPI = require('../../../api/mistakes.js');

describe('错题手册API', () => {
  test('获取错题列表 - 成功', async () => {
    const result = await mistakesAPI.getMistakeList({
      page: 1,
      page_size: 20,
    });

    expect(result.success).toBe(true);
    expect(result.data).toBeDefined();
    expect(Array.isArray(result.data.items)).toBe(true);
  });

  test('创建错题 - 参数验证', async () => {
    await expect(mistakesAPI.createMistake({})).rejects.toMatchObject({
      code: 'VALIDATION_ERROR',
    });
  });
});
```

---

### 6. 统计数据真实API对接

**当前状态**:

```javascript
// pages/index/index.js:443, 467
// TODO: 调用API获取用户统计数据
// TODO: 调用API获取通知数据
```

**实现**:

1. 调用 `/api/v1/analytics/user-stats` 获取真实统计
2. 替换首页的Mock数据
3. 添加数据刷新机制

---

## 🟢 第三优先级（1个月内）

### 7. 性能优化和监控

**行动项**:

- [ ] 添加性能监控埋点（页面加载时间、API响应时间）
- [ ] 优化首屏加载（骨架屏、预加载）
- [ ] 图片懒加载和压缩
- [ ] 分析和优化包体积

### 8. 代码质量提升

**行动项**:

- [ ] 关键.js文件迁移到TypeScript
- [ ] 代码审查和重构
- [ ] 性能热点优化
- [ ] 内存泄漏排查

### 9. 文档完善

**行动项**:

- [ ] 错题手册使用指南
- [ ] 组件开发规范和示例
- [ ] 性能优化指南
- [ ] 部署和发布流程

---

## 🚀 每日目标功能（未来规划）

**当前状态**: 后端已完成，前端未开发

**API端点** (已可用):

- `GET /api/v1/goals/today` - 获取今日目标
- `POST /api/v1/goals` - 创建目标
- `PUT /api/v1/goals/{id}/progress` - 更新进度

**UI设计要点**:

1. 首页展示今日目标卡片
2. 进度环形图（学习时长、提问次数、错题复习）
3. 完成后的鼓励动画
4. 目标历史记录

**预计工作量**: 3-4天（设计1天 + 开发2天 + 测试1天）

---

## 📋 本周工作计划（推荐）

### Day 1-2: 错题手册联调

- [ ] 完成后端AI分析功能（2-3小时）
- [ ] 小程序端到端测试（2-3小时）
- [ ] 边界情况测试（1小时）
- [ ] 修复发现的问题

### Day 3: 错误监控和反馈

- [ ] 实现错误上报（微信实时日志 + 后端API）（2小时）
- [ ] 实现用户反馈功能（2小时）
- [ ] 测试验证（1小时）

### Day 4: 测试和优化

- [ ] 补充错题手册测试用例
- [ ] 修复bug
- [ ] 性能优化

### Day 5: 文档和发布准备

- [ ] 更新文档
- [ ] 准备发布清单
- [ ] 生产环境测试

---

## ✅ 成功标准

完成以上优先级1-3的所有任务后：

1. ✅ 错题手册全流程可用，AI分析正常工作
2. ✅ 错误自动上报，可以在后台查看日志
3. ✅ 用户可以提交反馈，开发团队可以收到
4. ✅ 核心功能经过完整测试，边界情况都有处理
5. ✅ 生产环境运行稳定，没有阻塞性问题

**届时项目状态**: 🎉 **生产就绪，可以正式发布！**

---

## 📞 需要帮助？

如果在实施过程中遇到问题，可以：

1. **技术问题**: 查看项目文档 `/docs/`
2. **API问题**: 参考 `/docs/api/` 和 `/docs/miniprogram/api-integration.md`
3. **架构问题**: 参考 `/docs/architecture/`
4. **调试技巧**: 查看 `miniprogram/开发调试指南.md`

---

**祝开发顺利！🚀**
