# 小程序端知识图谱功能部署指南

## 📋 部署概述

本指南用于部署小程序端的知识图谱功能到生产环境。

**部署日期**: 2025-11-03  
**功能版本**: v1.0  
**涉及模块**: 错题列表、错题详情、知识图谱、复习推荐

---

## 🔧 部署前准备

### 1. 确认后端 API 已部署

确保以下 API 端点已在生产环境部署并可用:

```bash
# 在生产服务器上测试API
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://wuhao.guomaspace.com/api/v1/knowledge-graph/knowledge-points?subject=数学"

curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://wuhao.guomaspace.com/api/v1/knowledge-graph/snapshot?subject=数学"

curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://wuhao.guomaspace.com/api/v1/knowledge-graph/weak-chains?subject=数学"

curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://wuhao.guomaspace.com/api/v1/knowledge-graph/review-recommendations?subject=数学"
```

### 2. 检查小程序代码

确认以下文件已正确更新:

**API 模块**:

- ✅ `miniprogram/api/mistakes.js` - 添加了 4 个知识图谱 API 方法

**页面文件**:

- ✅ `miniprogram/pages/mistakes/list/` - 错题列表增强

  - `index.js` - 添加知识点筛选逻辑
  - `index.wxml` - 添加知识点筛选 UI
  - `index.wxss` - 添加筛选样式

- ✅ `miniprogram/pages/mistakes/detail/` - 错题详情增强

  - `index.wxml` - 增强知识点展示
  - `index.wxss` - 添加知识点样式

- ✅ `miniprogram/pages/knowledge-graph/` - 新建知识图谱页面

  - `index.js` (163 行)
  - `index.wxml` (125 行)
  - `index.wxss` (194 行)
  - `index.json` (14 行)

- ✅ `miniprogram/pages/review-recommendations/` - 新建复习推荐页面
  - `index.js` (101 行)
  - `index.wxml` (104 行)
  - `index.wxss` (137 行)
  - `index.json` (14 行)

**应用配置**:

- ✅ `miniprogram/app.json` - 注册了 2 个新页面

---

## 📱 小程序部署步骤

### Step 1: 打开微信开发者工具

1. 启动微信开发者工具
2. 登录小程序管理员账号
3. 打开项目: `/Users/liguoma/my-devs/python/wuhao-tutor/miniprogram`

### Step 2: 编译预览

1. 点击顶部"编译"按钮
2. 检查控制台是否有错误
3. 在模拟器中预览各个页面:
   - 错题列表 → 测试知识点筛选
   - 错题详情 → 查看知识点展示
   - 知识图谱 → 测试数据加载
   - 复习推荐 → 测试推荐列表

### Step 3: 真机调试

1. 点击顶部"预览"按钮
2. 使用手机微信扫码
3. 在真机上测试核心功能:
   ```
   ✓ 页面加载正常
   ✓ API调用成功
   ✓ 数据展示正确
   ✓ 页面跳转流畅
   ✓ 交互体验良好
   ```

### Step 4: 上传代码

1. 确认所有测试通过
2. 点击顶部"上传"按钮
3. 填写版本信息:
   - **版本号**: `1.6.0`
   - **项目备注**: `新增知识图谱和智能复习推荐功能`
   - **详细描述**:
     ```
     1. 错题列表支持按知识点筛选
     2. 错题详情展示知识点掌握度和AI建议
     3. 新增知识图谱页面,可视化学情分析
     4. 新增智能复习推荐页面,优先级推荐
     ```

### Step 5: 提交审核

1. 登录微信小程序后台: https://mp.weixin.qq.com
2. 进入"版本管理"
3. 找到刚上传的版本
4. 点击"提交审核"
5. 填写审核信息:
   - **版本描述**: 同上传时的描述
   - **测试账号**: 提供测试学生账号
   - **功能页面**: 截图展示知识图谱和复习推荐页面

### Step 6: 审核通过后发布

1. 等待微信审核(通常 1-3 个工作日)
2. 审核通过后,在后台点击"发布"
3. 确认发布,代码将在 1-2 小时内生效

---

## 🧪 部署后验证

### 1. API 连接测试

使用测试脚本验证 API 连接:

```bash
cd /Users/liguoma/my-devs/python/wuhao-tutor

# 编辑脚本,设置TEST_TOKEN
vim scripts/test_knowledge_graph_api.py

# 运行测试
python3 scripts/test_knowledge_graph_api.py
```

### 2. 小程序功能验证

参考 `小程序端知识图谱功能测试清单.md` 进行完整测试:

```bash
# 查看测试清单
cat /Users/liguoma/my-devs/python/wuhao-tutor/小程序端知识图谱功能测试清单.md
```

**核心测试项**:

- ✅ 错题列表知识点筛选
- ✅ 错题详情知识点展示
- ✅ 知识图谱数据加载
- ✅ 薄弱知识链识别
- ✅ 智能复习推荐
- ✅ 页面跳转和参数传递
- ✅ 空状态和错误处理

### 3. 性能监控

在微信小程序后台查看性能数据:

1. 进入"运维中心" → "性能监控"
2. 关注指标:
   - 启动耗时
   - 页面加载时间
   - API 请求成功率
   - 错误率

---

## 🔄 回滚方案

如果部署后发现严重问题,可以快速回滚:

### 方案 1: 小程序后台回滚

1. 登录微信小程序后台
2. 进入"版本管理"
3. 找到上一个稳定版本
4. 点击"回退"

### 方案 2: 重新上传旧版本

1. 在本地切换到上一个稳定的 Git 分支
2. 使用微信开发者工具重新上传
3. 提交紧急审核

---

## 📊 监控指标

部署后需要持续监控以下指标:

### 业务指标

- 知识图谱页面访问量
- 复习推荐使用率
- 知识点筛选使用频率
- 用户留存率变化

### 技术指标

- API 错误率 (< 1%)
- 页面加载时间 (< 2s)
- 崩溃率 (< 0.5%)
- 网络请求成功率 (> 99%)

### 用户反馈

- 用户评分
- 客服反馈
- 用户建议

---

## 🐛 常见问题处理

### Q1: API 返回 404 错误

**原因**: 后端 API 未部署或路径错误

**解决**:

```bash
# 检查后端服务状态
ssh root@121.199.173.244
systemctl status wuhao-tutor

# 查看API日志
journalctl -u wuhao-tutor -f
```

### Q2: 知识图谱页面空白

**原因**: 用户没有错题数据

**解决**: 这是正常情况,已有空状态提示

### Q3: 知识点筛选不生效

**原因**: URL 参数传递问题

**解决**: 检查跳转 URL 是否正确编码:

```javascript
const url = `/pages/mistakes/list/index?knowledge_point=${encodeURIComponent(kp)}`
```

### Q4: 掌握度显示异常

**原因**: 后端数据格式问题

**解决**: 检查 API 返回的 mastery_level 字段是否在 0-1 范围内

---

## 📝 部署检查清单

部署前请确认:

- [ ] 后端 API 已部署并测试通过
- [ ] 小程序代码本地编译无错误
- [ ] 真机调试功能正常
- [ ] 测试清单中核心功能已验证
- [ ] 版本号已更新
- [ ] 上传备注已填写完整
- [ ] 回滚方案已准备

部署后请确认:

- [ ] 审核资料已提交
- [ ] 测试账号可用
- [ ] 监控指标正常
- [ ] 用户反馈渠道畅通

---

## 🎉 部署完成

恭喜!知识图谱功能已成功部署到生产环境。

**下一步**:

1. 持续监控性能指标
2. 收集用户反馈
3. 优化用户体验
4. 规划下一阶段功能

**文档更新**: 2025-11-03  
**部署人**: AI 助手  
**审核人**: ****\_\_\_****
