# 五好伴学小程序端功能对齐设计

## 项目概述

### 项目背景

五好伴学是一个基于阿里云百炼智能体的 K12 智能学习支持平台，通过智能作业批改、个性化学习问答和全面学情分析为学生提供学习支持。当前项目已实现前端、API、后端、数据库的全链条对齐开发，但小程序端代码仍为早期版本，缺乏与最新后端功能的对齐。

### 对齐目标

本设计旨在将小程序端与最新的后端 API 和业务功能实现完全对齐，确保小程序端用户能够享受与前端 Web 版本相同的功能体验，包括：

- 智能作业批改功能的完整实现
- 个性化学习问答的流畅体验
- 学情分析数据的可视化展示
- 用户认证和权限管理的统一
- 错误处理和用户体验的优化

### 设计原则

1. **功能对齐优先**：确保小程序端功能与后端 API 完全对应
2. **用户体验一致**：保持与前端 Web 版本的交互逻辑一致性
3. **性能优化**：充分利用小程序特性优化加载速度和响应时间
4. **向后兼容**：保持现有页面结构，最大化复用已有代码
5. **渐进增强**：分阶段实现功能对齐，确保每个阶段都可独立验证

## 技术架构

### 当前小程序技术栈

- **框架**：微信小程序原生框架
- **UI 组件库**：Vant Weapp 1.x
- **状态管理**：基于页面级别的数据管理
- **网络请求**：自定义 Request 类封装
- **构建工具**：微信开发者工具原生构建

### 对齐后技术架构

``mermaid
graph TB
subgraph "小程序端架构"
A[页面层] --> B[API 层]
B --> C[工具层]
C --> D[核心服务层]

        A1[作业页面] --> A
        A2[学习问答页面] --> A
        A3[学情分析页面] --> A
        A4[个人中心页面] --> A

        B1[作业API模块] --> B
        B2[学习API模块] --> B
        B3[分析API模块] --> B
        B4[用户API模块] --> B

        C1[请求封装] --> C
        C2[认证管理] --> C
        C3[缓存管理] --> C
        C4[错误处理] --> C

        D1[网络监控] --> D
        D2[性能监控] --> D
        D3[日志服务] --> D
    end

    subgraph "后端API层"
        E[FastAPI后端]
        E1[作业批改API] --> E
        E2[学习问答API] --> E
        E3[学情分析API] --> E
        E4[用户认证API] --> E
    end

    B --> E

```

### 核心对齐策略

#### API接口对齐

| 功能模块 | 小程序当前状态 | 后端API状态 | 对齐策略 |
|---------|---------------|------------|----------|
| 用户认证 | 基础实现 | JWT双Token机制 | 升级认证流程，支持refresh_token |
| 作业批改 | 早期版本API | 完整重构完成 | 更新API调用，适配新数据结构 |
| 学习问答 | 基础对话功能 | MCP上下文增强 | 集成个性化上下文服务 |
| 学情分析 | 静态图表 | 动态数据分析 | 重构分析页面，接入实时数据 |
| 错题本 | 未实现 | 开发中 | 预留接口，同步开发 |

#### 数据流对齐

``mermaid
sequenceDiagram
    participant MP as 小程序
    participant API as 后端API
    participant DB as 数据库
    participant AI as AI服务

    Note over MP,AI: 作业批改流程
    MP->>API: 提交作业图片
    API->>DB: 保存提交记录
    API->>AI: OCR识别+AI批改
    AI-->>API: 返回批改结果
    API->>DB: 保存批改结果
    API-->>MP: 返回批改ID
    MP->>API: 轮询批改状态
    API-->>MP: 返回完整批改结果

    Note over MP,AI: 学习问答流程
    MP->>API: 发送学习问题
    API->>DB: 查询学习上下文
    API->>AI: 带上下文的AI问答
    AI-->>API: 返回个性化回答
    API->>DB: 保存问答记录
    API-->>MP: 返回答案内容
```

## 功能模块设计

### 用户认证模块

#### 认证流程优化

基于后端已完成的 JWT 双 Token 认证机制，升级小程序端的认证系统：

**对齐方案**：

```
| 认证组件 | 当前状态 | 目标状态 | 实现策略 |
|---------|---------|---------|----------|
| Token管理 | 单access_token | 双Token机制 | 实现refresh_token自动续期 |
| 登录流程 | 基础登录 | 角色识别登录 | 支持学生/教师/家长角色 |
| 状态管理 | 页面级管理 | 全局状态管理 | 统一的用户状态缓存 |
| 权限控制 | 简单验证 | 细粒度权限 | 基于角色的功能访问控制 |
```

### 作业批改模块

#### API 接口全面对齐

基于后端完整重构的作业 API，更新小程序端的作业功能：

**核心对齐点**：

1. **提交接口更新**

   - 支持多图片批量上传
   - 统一的表单数据结构
   - 完善的上传进度反馈
   - 错误重试机制

2. **批改结果展示**

   - 多维度评分展示（总分、知识点分、解题思路）
   - 详细的逐题分析反馈
   - 薄弱知识点识别和建议
   - 进步趋势可视化

3. **数据结构对齐**

```
| 数据字段 | 原结构 | 新结构 | 适配策略 |
|---------|--------|--------|----------|
| 作业提交 | template_id | subject/grade_level | 更新提交参数 |
| 批改结果 | 简单分数 | 多维度评价 | 重构结果展示 |
| 作业列表 | 静态数据 | 动态分页 | 接入真实API |
| 状态管理 | 基础状态 | 详细状态流转 | 完善状态处理 |
```

### 学习问答模块

#### MCP 上下文服务集成

将后端已完成的 MCP 个性化上下文服务集成到小程序端：

**核心功能对齐**：

1. **个性化上下文传递**

   - 学习偏好分析（5 个维度）
   - 薄弱知识点识别（时间衰减算法）
   - 历史错题关联分析
   - 学习进度上下文

2. **智能问答增强**
   - 基于学情的个性化回答
   - 多模态输入支持（文字、语音、图片）
   - 数学公式渲染支持
   - 会话上下文管理

### 学情分析模块

#### 数据可视化重构

基于后端新上线的 Analytics API，重构分析页面：

**分析功能对齐**：

```
| 分析类型 | API端点 | 展示形式 | 交互功能 |
|---------|---------|---------|----------|
| 学习进度 | /analytics/learning-progress | 时间序列图 | 时间范围选择 |
| 知识点掌握 | /analytics/knowledge-points | 雷达图 | 知识点下钻 |
| 学科统计 | /analytics/subject-stats | 饼图+柱图 | 学科对比 |
| 错题分析 | /analytics/error-analysis | 热力图 | 错题分类 |
```

### 错题本模块（预留）

为配合后端正在开发的错题本功能（TD-009），预留相应的接口和页面结构：

**预留设计**：

- 错题列表页面结构
- 错题详情展示模板
- 复习模式交互逻辑
- 错题统计分析框架

## 页面结构优化

### 路由配置更新

基于功能对齐需求，优化小程序页面路由：

```
{
  "pages": [
    "pages/index/index",           // 首页 - 功能导航
    "pages/login/index",           // 登录页 - 双Token认证
    "pages/homework/list/index",   // 作业列表 - 真实数据
    "pages/homework/detail/index", // 作业详情 - 完整结果
    "pages/homework/submit/index", // 作业提交 - 多图上传
    "pages/chat/index/index",      // 问答列表 - 会话管理
    "pages/chat/detail/index",     // 问答详情 - MCP增强
    "pages/analysis/report/index", // 分析报告 - 实时数据
    "pages/profile/index/index"    // 个人中心 - 权限管理
  ]
}
```

### 组件复用策略

**现有组件升级**：

- homework-card 组件：适配新数据结构
- ec-canvas 组件：升级 ECharts 版本
- loading 组件：统一加载状态管理

**新增通用组件**：

- api-status 组件：统一 API 状态展示
- error-boundary 组件：统一错误处理
- empty-state 组件：统一空状态展示

## 数据管理架构

### 状态管理优化

设计全局状态管理机制：

```
// 全局数据管理结构
const GlobalState = {
  user: {
    profile: null,
    permissions: [],
    preferences: {}
  },
  auth: {
    accessToken: null,
    refreshToken: null,
    tokenExpiry: null
  },
  cache: {
    homeworkList: [],
    analyticsSummary: {},
    sessionHistory: []
  }
};
```

### 缓存策略设计

实现多层缓存机制：

```
| 缓存类型 | 存储位置 | 过期策略 | 更新机制 |
|---------|---------|---------|----------|
| 用户信息 | Storage | 24小时 | 登录更新 |
| 作业列表 | Memory | 5分钟 | 下拉刷新 |
| 分析数据 | Storage | 10分钟 | 主动更新 |
| 会话记录 | Storage | 7天 | 容量控制 |
```

## 用户体验优化

### 加载状态管理

统一的加载状态设计：

- **骨架屏**：主要列表页面
- **进度指示器**：文件上传和处理
- **状态提示**：操作反馈
- **错误恢复**：网络异常处理

### 性能优化策略

**关键性能指标**：

```
| 性能指标 | 目标值 | 优化策略 |
|---------|--------|----------|
| 首屏加载 | <3秒 | 分包加载+预加载 |
| 页面切换 | <1秒 | 路由优化+缓存 |
| 图片上传 | <5秒 | 压缩+并发控制 |
| API响应 | <2秒 | 请求优化+重试 |
```

## 开发实施计划

### 第一阶段：基础设施对齐（Week 1-2）

**核心任务**：

1. **认证系统升级**

   - 实现双 Token 机制
   - 更新登录流程
   - 完善权限验证

2. **API 封装重构**

   - 升级 request 模块
   - 统一错误处理
   - 实现请求缓存

3. **基础组件更新**
   - 升级 UI 组件库
   - 统一样式规范
   - 完善交互反馈

### 第二阶段：核心功能对齐（Week 3-4）

**核心任务**：

1. **作业模块重构**

   - 更新提交流程
   - 重构结果展示
   - 对接真实 API

2. **问答模块增强**
   - 集成 MCP 服务
   - 优化会话管理
   - 增强输入方式

### 第三阶段：分析功能对齐（Week 5-6）

**核心任务**：

1. **数据可视化重构**

   - 对接 Analytics API
   - 重构图表组件
   - 实现交互分析

2. **个性化功能**
   - 学情诊断报告
   - 学习建议推荐
   - 进步跟踪分析

### 第四阶段：体验优化完善（Week 7-8）

**核心任务**：

1. **性能优化**

   - 加载速度优化
   - 内存使用优化
   - 网络请求优化

2. **用户体验完善**
   - 错误处理完善
   - 操作反馈优化
   - 离线功能支持

## 测试验证策略

### 功能测试覆盖

**测试重点**：

```
| 测试模块 | 测试范围 | 验证标准 |
|---------|---------|----------|
| 认证流程 | 登录/登出/刷新 | Token正确管理 |
| 作业功能 | 提交/查看/批改 | 数据完整传递 |
| 问答功能 | 提问/回答/历史 | MCP上下文生效 |
| 分析功能 | 数据/图表/交互 | 实时数据展示 |
```

### 兼容性验证

**验证范围**：

- 微信版本：7.0.0+
- 系统版本：iOS 10.0+, Android 6.0+
- 屏幕适配：4.0" - 6.7"
- 网络环境：2G/3G/4G/5G/WiFi

## 监控运维体系

### 错误监控

实现全链路错误监控：

- JavaScript 错误捕获
- API 调用异常监控
- 用户操作异常追踪
- 性能瓶颈识别

### 数据统计

建立用户行为分析：

- 页面访问统计
- 功能使用分析
- 学习行为追踪
- 错误分布分析

通过这个全面的对齐设计，小程序端将能够与当前的后端 API 和业务功能实现完全对齐，为用户提供一致且优质的学习体验。整个实施过程采用分阶段推进的策略，确保每个阶段的成果都能独立验证和部署，最大程度降低开发风险并保证项目质量.
