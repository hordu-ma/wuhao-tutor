<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
      }
      .preview {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
      }
      .preview-item {
        position: relative;
        width: 150px;
        height: 150px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }
      .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
      }
      .send-btn {
        background: #409eff;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>

    <div class="upload-area">
      <input type="file" id="fileInput" accept="image/*" multiple style="display: none" />
      <button
        onclick="document.getElementById('fileInput').click()"
        style="padding: 10px 20px; font-size: 16px"
      >
        ğŸ“ é€‰æ‹©å›¾ç‰‡
      </button>
      <p>æ”¯æŒå¤šå›¾ä¸Šä¼ ï¼Œæœ€å¤š5å¼ </p>
    </div>

    <div id="preview" class="preview"></div>

    <div>
      <textarea
        id="questionInput"
        placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
        style="width: 100%; min-height: 100px; padding: 10px; font-size: 14px"
      ></textarea>
    </div>

    <div style="margin-top: 20px">
      <button id="sendBtn" class="send-btn" disabled>å‘é€åˆ°ç”Ÿäº§ç¯å¢ƒ</button>
    </div>

    <div class="log" id="log">ç­‰å¾…æ“ä½œ...</div>

    <script>
      const uploadedImages = []
      const log = document.getElementById('log')
      const preview = document.getElementById('preview')
      const sendBtn = document.getElementById('sendBtn')
      const questionInput = document.getElementById('questionInput')

      function addLog(message) {
        const timestamp = new Date().toLocaleTimeString()
        log.textContent += `[${timestamp}] ${message}\n`
        log.scrollTop = log.scrollHeight
      }

      document.getElementById('fileInput').addEventListener('change', function (e) {
        const files = Array.from(e.target.files)
        addLog(`ğŸ–¼ï¸  é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`)

        files.forEach((file, index) => {
          if (!file.type.startsWith('image/')) {
            addLog(`âŒ ${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`)
            return
          }

          if (file.size > 10 * 1024 * 1024) {
            addLog(`âŒ ${file.name} æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(2)}MB)`)
            return
          }

          if (uploadedImages.length >= 5) {
            addLog(`âŒ æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡`)
            return
          }

          const reader = new FileReader()
          reader.onload = (e) => {
            const previewUrl = e.target.result
            uploadedImages.push({ file, previewUrl })
            addLog(`âœ… ${file.name} è¯»å–æˆåŠŸ (${uploadedImages.length}/5)`)

            renderPreview()
            updateSendButton()
          }
          reader.onerror = (error) => {
            addLog(`âŒ ${file.name} è¯»å–å¤±è´¥: ${error}`)
          }
          reader.readAsDataURL(file)
        })

        // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        e.target.value = ''
      })

      function renderPreview() {
        preview.innerHTML = ''
        uploadedImages.forEach((img, index) => {
          const item = document.createElement('div')
          item.className = 'preview-item'
          item.innerHTML = `
                    <img src="${img.previewUrl}" alt="é¢„è§ˆ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})">Ã—</button>
                `
          preview.appendChild(item)
        })
      }

      function removeImage(index) {
        const removed = uploadedImages.splice(index, 1)[0]
        addLog(`ğŸ—‘ï¸  åˆ é™¤äº†å›¾ç‰‡: ${removed.file.name}`)
        renderPreview()
        updateSendButton()
      }

      function updateSendButton() {
        const hasImages = uploadedImages.length > 0
        const hasQuestion = questionInput.value.trim().length > 0
        sendBtn.disabled = !(hasImages && hasQuestion)
      }

      questionInput.addEventListener('input', updateSendButton)

      sendBtn.addEventListener('click', async () => {
        if (uploadedImages.length === 0) {
          addLog('âŒ è¯·å…ˆä¸Šä¼ å›¾ç‰‡')
          return
        }

        addLog('ğŸš€ å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ°ç”Ÿäº§ç¯å¢ƒ...')
        sendBtn.disabled = true

        try {
          // 1. ä¸Šä¼ å›¾ç‰‡åˆ°AIåˆ†æç«¯ç‚¹
          const uploadPromises = uploadedImages.map(async (img) => {
            const formData = new FormData()
            formData.append('file', img.file)

            addLog(`ğŸ“¤ ä¸Šä¼  ${img.file.name}...`)

            const response = await fetch('https://121.199.173.244/api/v1/files/upload-for-ai', {
              method: 'POST',
              body: formData,
              credentials: 'include',
            })

            if (!response.ok) {
              throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`)
            }

            const result = await response.json()
            addLog(`âœ… ${img.file.name} ä¸Šä¼ æˆåŠŸ`)
            addLog(`   AIè®¿é—®URL: ${result.ai_accessible_url}`)

            return result.ai_accessible_url
          })

          const imageUrls = await Promise.all(uploadPromises)
          addLog(`\nâœ… æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å®Œæˆï¼Œå…± ${imageUrls.length} å¼ \n`)

          // 2. å‘é€é—®é¢˜åˆ°å­¦ä¹ é—®ç­”æ¥å£
          const questionText = questionInput.value.trim()
          addLog(`ğŸ“ å‘é€é—®é¢˜: "${questionText}"`)

          const requestData = {
            content: questionText,
            question_type: 'general_inquiry',
            image_urls: imageUrls,
            use_context: true,
            include_history: true,
            max_history: 10,
          }

          addLog(`\nğŸ“¦ è¯·æ±‚æ•°æ®:\n${JSON.stringify(requestData, null, 2)}\n`)

          const askResponse = await fetch('https://121.199.173.244/api/v1/learning/ask', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
            credentials: 'include',
          })

          if (!askResponse.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${askResponse.status} ${askResponse.statusText}`)
          }

          const askResult = await askResponse.json()
          addLog(`\nâœ… AIå“åº”æˆåŠŸ!\n`)
          addLog(`ğŸ’¬ AIå›ç­”:\n${askResult.answer}\n`)
        } catch (error) {
          addLog(`\nâŒ é”™è¯¯: ${error.message}\n`)
          console.error(error)
        } finally {
          sendBtn.disabled = false
        }
      })

      addLog('âœ… æµ‹è¯•é¡µé¢å·²å°±ç»ª')
      addLog('ğŸ“Œ è¯·ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡"æŒ‰é’®ä¸Šä¼ å›¾ç‰‡')
    </script>
  </body>
</html>
