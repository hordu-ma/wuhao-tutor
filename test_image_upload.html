<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片上传测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
      }
      .preview {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
      }
      .preview-item {
        position: relative;
        width: 150px;
        height: 150px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }
      .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
      }
      .send-btn {
        background: #409eff;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>🧪 图片上传功能测试</h1>

    <div class="upload-area">
      <input type="file" id="fileInput" accept="image/*" multiple style="display: none" />
      <button
        onclick="document.getElementById('fileInput').click()"
        style="padding: 10px 20px; font-size: 16px"
      >
        📎 选择图片
      </button>
      <p>支持多图上传，最多5张</p>
    </div>

    <div id="preview" class="preview"></div>

    <div>
      <textarea
        id="questionInput"
        placeholder="输入你的问题..."
        style="width: 100%; min-height: 100px; padding: 10px; font-size: 14px"
      ></textarea>
    </div>

    <div style="margin-top: 20px">
      <button id="sendBtn" class="send-btn" disabled>发送到生产环境</button>
    </div>

    <div class="log" id="log">等待操作...</div>

    <script>
      const uploadedImages = []
      const log = document.getElementById('log')
      const preview = document.getElementById('preview')
      const sendBtn = document.getElementById('sendBtn')
      const questionInput = document.getElementById('questionInput')

      function addLog(message) {
        const timestamp = new Date().toLocaleTimeString()
        log.textContent += `[${timestamp}] ${message}\n`
        log.scrollTop = log.scrollHeight
      }

      document.getElementById('fileInput').addEventListener('change', function (e) {
        const files = Array.from(e.target.files)
        addLog(`🖼️  选择了 ${files.length} 个文件`)

        files.forEach((file, index) => {
          if (!file.type.startsWith('image/')) {
            addLog(`❌ ${file.name} 不是图片文件`)
            return
          }

          if (file.size > 10 * 1024 * 1024) {
            addLog(`❌ ${file.name} 文件过大 (${(file.size / 1024 / 1024).toFixed(2)}MB)`)
            return
          }

          if (uploadedImages.length >= 5) {
            addLog(`❌ 最多只能上传5张图片`)
            return
          }

          const reader = new FileReader()
          reader.onload = (e) => {
            const previewUrl = e.target.result
            uploadedImages.push({ file, previewUrl })
            addLog(`✅ ${file.name} 读取成功 (${uploadedImages.length}/5)`)

            renderPreview()
            updateSendButton()
          }
          reader.onerror = (error) => {
            addLog(`❌ ${file.name} 读取失败: ${error}`)
          }
          reader.readAsDataURL(file)
        })

        // 清空input，允许重复选择同一文件
        e.target.value = ''
      })

      function renderPreview() {
        preview.innerHTML = ''
        uploadedImages.forEach((img, index) => {
          const item = document.createElement('div')
          item.className = 'preview-item'
          item.innerHTML = `
                    <img src="${img.previewUrl}" alt="预览${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})">×</button>
                `
          preview.appendChild(item)
        })
      }

      function removeImage(index) {
        const removed = uploadedImages.splice(index, 1)[0]
        addLog(`🗑️  删除了图片: ${removed.file.name}`)
        renderPreview()
        updateSendButton()
      }

      function updateSendButton() {
        const hasImages = uploadedImages.length > 0
        const hasQuestion = questionInput.value.trim().length > 0
        sendBtn.disabled = !(hasImages && hasQuestion)
      }

      questionInput.addEventListener('input', updateSendButton)

      sendBtn.addEventListener('click', async () => {
        if (uploadedImages.length === 0) {
          addLog('❌ 请先上传图片')
          return
        }

        addLog('🚀 开始上传图片到生产环境...')
        sendBtn.disabled = true

        try {
          // 1. 上传图片到AI分析端点
          const uploadPromises = uploadedImages.map(async (img) => {
            const formData = new FormData()
            formData.append('file', img.file)

            addLog(`📤 上传 ${img.file.name}...`)

            const response = await fetch('https://121.199.173.244/api/v1/files/upload-for-ai', {
              method: 'POST',
              body: formData,
              credentials: 'include',
            })

            if (!response.ok) {
              throw new Error(`上传失败: ${response.status} ${response.statusText}`)
            }

            const result = await response.json()
            addLog(`✅ ${img.file.name} 上传成功`)
            addLog(`   AI访问URL: ${result.ai_accessible_url}`)

            return result.ai_accessible_url
          })

          const imageUrls = await Promise.all(uploadPromises)
          addLog(`\n✅ 所有图片上传完成，共 ${imageUrls.length} 张\n`)

          // 2. 发送问题到学习问答接口
          const questionText = questionInput.value.trim()
          addLog(`📝 发送问题: "${questionText}"`)

          const requestData = {
            content: questionText,
            question_type: 'general_inquiry',
            image_urls: imageUrls,
            use_context: true,
            include_history: true,
            max_history: 10,
          }

          addLog(`\n📦 请求数据:\n${JSON.stringify(requestData, null, 2)}\n`)

          const askResponse = await fetch('https://121.199.173.244/api/v1/learning/ask', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
            credentials: 'include',
          })

          if (!askResponse.ok) {
            throw new Error(`请求失败: ${askResponse.status} ${askResponse.statusText}`)
          }

          const askResult = await askResponse.json()
          addLog(`\n✅ AI响应成功!\n`)
          addLog(`💬 AI回答:\n${askResult.answer}\n`)
        } catch (error) {
          addLog(`\n❌ 错误: ${error.message}\n`)
          console.error(error)
        } finally {
          sendBtn.disabled = false
        }
      })

      addLog('✅ 测试页面已就绪')
      addLog('📌 请点击"选择图片"按钮上传图片')
    </script>
  </body>
</html>
