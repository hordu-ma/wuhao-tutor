# Copilot Instructions for 五好伴学 (Wuhao Tutor)

## Project Overview

A modern AI-powered K12 education platform built with FastAPI + Vue3 + WeChat Miniprogram, featuring homework grading, learning Q&A, and analytics using Alibaba Cloud Bailian AI services.

## Architecture Patterns

### Layered Backend (src/)

```
api/ → services/ → repositories/ → models/
```

- **Never** bypass layers (e.g., API calling Repository directly)
- **Always** use type hints and async/await patterns
- **Repository pattern**: Use `BaseRepository[Model]` with generics for CRUD
- **Service layer**: Handle business logic, compose repositories, manage transactions

### Core Infrastructure (src/core/)

- `config.py`: Pydantic Settings with environment validation
- `database.py`: Async SQLAlchemy 2.x session factory
- `monitoring.py`: Custom metrics collection (request timing, slow queries)
- `security.py`: Rate limiting with token bucket + sliding window
- `performance.py`: Query listener for N+1 detection and caching

### AI Service Integration

- **Unified interface**: `BailianService` in `src/services/bailian_service.py`
- **Error handling**: Specific exception types, never bare `except:`
- **Timeout patterns**: All external calls have configurable timeouts

## Development Workflows

### Quick Start Commands

```bash
# Environment setup and diagnostics
uv sync && uv run python scripts/diagnose.py

# Development servers (both frontend + backend)
./scripts/start-dev.sh

# Database operations
make db-reset    # Reset with sample data
make db-backup   # PostgreSQL backup with rotation

# Testing and quality
make test        # pytest with coverage
make lint        # black + flake8 + mypy
```

### Environment Configuration

- **Development**: Uses SQLite, minimal dependencies
- **Production**: PostgreSQL + Redis, full monitoring
- **Scripts**: `scripts/env_manager.py` manages environment switching
- **Secrets**: Stored in `secrets/` directory, never committed

### Multi-Frontend Architecture

- **Web Frontend**: Vue3 + TypeScript + Vite (port 5173)
- **WeChat Miniprogram**: Vanilla JS + TypeScript declarations
- **Shared API**: All clients use `/api/v1/` REST endpoints

## Project-Specific Conventions

### Model Design

```python
# All models inherit from BaseModel in src/models/base.py
class HomeworkModel(BaseModel):
    __tablename__ = "homework"
    # UUID primary keys, automatic timestamps
    # Soft delete with deleted_at column
```

### Repository Pattern

```python
# Extend BaseRepository for type safety
class HomeworkRepository(BaseRepository[HomeworkModel]):
    async def find_by_student_id(self, student_id: UUID) -> List[HomeworkModel]:
        # Complex queries go in repositories, not services
```

### Error Handling

```python
# Use specific exception types from src/core/exceptions.py
raise HomeworkNotFoundError(f"Homework {homework_id} not found")
# Never: raise Exception("Homework not found")
```

### Performance Monitoring

- **Slow queries**: Automatically logged when >500ms
- **Rate limiting**: 100 req/min per IP, 1000 req/hour per user
- **Metrics collection**: Built-in middleware tracks response times by endpoint

### Frontend Integration

- **API Client**: Auto-generated from OpenAPI spec
- **State Management**: Pinia stores with async actions
- **WeChat Integration**: Custom network layer in `miniprogram/utils/request.js`

## File Organization

- **Configuration**: Environment templates in `config/templates/`
- **Database**: Migrations in `alembic/versions/`, sample data in `scripts/sql/`
- **Documentation**: Comprehensive docs in `docs/` with architecture diagrams
- **Scripts**: Development automation in `scripts/` (all use `uv run`)
- **Monitoring**: Prometheus config in `monitoring/`

## Common Pitfalls

- **Don't** use `scripts/start-dev.sh` for production (Docker only)
- **Don't** modify `src/core/` without understanding middleware stack
- **Always** test AI service calls with mock data first
- **Remember** to update Alembic migrations for model changes
- **Important** ALWAYS use `./scripts/deploy_to_production.sh` start the server

## Integration Points

- **AI Services**: Bailian APIs wrapped in `src/services/bailian_service.py`
- **File Storage**: Local uploads (dev) or OSS (production)
- **Database**: Async PostgreSQL with connection pooling
- **Cache**: Redis for rate limiting and session storage
- **Frontend Build**: Vite with proxy to backend API during development

## Testing Strategy

- **Unit Tests**: Focus on services and repositories
- **Integration Tests**: API endpoints with test database
- **Performance Tests**: Load testing scripts in `tests/performance/`
- **Mock Data**: Generated by `scripts/init_database.py`
